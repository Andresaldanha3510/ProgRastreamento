{% extends "base.html" %}
{% block title %}Unidades de Negócio - TrackBras{% endblock %}

{% block styles %}
<style>
/* Adicionando alguns estilos que podem não estar no base.html para garantir o visual dos modais e botões */
.modal {
    display: none; position: fixed; z-index: 1000; left: 0; top: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
}
.modal-content {
    background: white; margin: 8% auto; padding: 0; border-radius: 16px;
    width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: modalSlide 0.3s ease-out;
}
@keyframes modalSlide { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-header {
    background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); color: white;
    padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;
    border-top-left-radius: 16px; border-top-right-radius: 16px;
}
.modal-title { font-size: 1.25rem; font-weight: 600; }
.close { color: white; font-size: 1.75rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
.close:hover { opacity: 0.7; }

.modal-body { padding: 2rem; }
.modal-footer {
    padding: 1rem 1.5rem; background-color: #f8fafc; text-align: right;
    border-top: 1px solid #e2e8f0; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
}
.btn-green, .btn-secondary, .btn-table { text-decoration: none; }
.btn-green:hover, .btn-secondary:hover { color: white; }

/* Estilos específicos que já estavam no seu base.html para consistência */
:root { --primary-green: #2e7d32; --primary-green-dark: #1b5e20; }
.nfe-container {
    background: #ffffff; border-radius: 16px; padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
}
.nfe-table-container {
    border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;
}
.nfe-table { width: 100%; border-collapse: collapse; }
.nfe-table th {
    background: linear-gradient(135deg, var(--primary-green-dark) 0%, var(--primary-green) 100%);
    color: white; padding: 1rem; text-align: left; font-size: 0.875rem; text-transform: uppercase;
}
.nfe-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; }
.nfe-table tr:hover { background: #f8fafc; }

.status-badge {
    padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
    text-transform: uppercase; display: inline-flex; align-items: center; gap: 6px;
}
.status-badge.processado { background: linear-gradient(135deg, #16a34a 0%, #2e7d32 100%); color: white; }
.status-badge.novo { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; }

.btn-table {
    padding: 6px 12px; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 500;
    cursor: pointer; margin-right: 4px; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s;
}
.btn-table.btn-view { background: #ffc107; color: #1e293b; }
.btn-table.btn-view:hover { background: #f59e0b; }
.btn-table.btn-delete { background: #dc2626; color: white; }
.btn-table.btn-delete:hover { background: #b91c1c; }

.form-group { margin-bottom: 1.5rem; }
.form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #334155; }
.form-control {
    width: 100%; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 8px;
    font-size: 1rem; transition: all 0.2s;
}
.form-control:focus { outline: none; border-color: var(--primary-green); box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1); }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg p-6 shadow-lg">
        <h1 class="text-3xl font-bold flex items-center gap-3"><i class="fas fa-building"></i> Unidades de Negócio</h1>
        <p class="text-green-100 mt-2">Gerencie suas empresas, filiais ou centros de custo.</p>
    </div>

    <div class="nfe-container">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Unidades Cadastradas</h2>
            <button class="btn-green" onclick="abrirModal()"><i class="fas fa-plus"></i> Nova Unidade</button>
        </div>
        
        <div class="nfe-table-container">
            <table class="nfe-table">
                <thead>
                    <tr>
                        <th>Nome da Unidade</th>
                        <th>CNPJ</th>
                        <th>Tipo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="unidadesTableBody">
                    {% for unidade in unidades %}
                    <tr id="unidade-row-{{ unidade.id }}">
                        <td class="font-semibold">{{ unidade.nome }}</td>
                        <td>{{ unidade.cnpj | format_cnpj if unidade.cnpj else '-' }}</td>
                        <td>
                            {% if unidade.is_matriz %}
                                <span class="status-badge processado"><i class="fas fa-star"></i> Matriz</span>
                            {% else %}
                                <span class="status-badge novo">Filial</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-table btn-view" onclick='abrirModal({{ unidade | tojson | safe }})'><i class="fas fa-edit"></i> Editar</button>
                            {% if not unidade.is_matriz %}
                                <button class="btn-table btn-delete" onclick="excluirUnidade({{ unidade.id }})"><i class="fas fa-trash"></i> Excluir</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="unidadeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle"><i class="fas fa-building"></i> Nova Unidade de Negócio</h2>
            <span class="close" onclick="fecharModal()">&times;</span>
        </div>
        <form id="unidadeForm" onsubmit="salvarUnidade(event)">
            <div class="modal-body">
                <input type="hidden" id="unidadeId">
                <div class="form-group">
                    <label class="form-label" for="unidadeNome">Nome da Unidade *</label>
                    <input type="text" id="unidadeNome" class="form-control" placeholder="Ex: Filial Curitiba" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="unidadeRazaoSocial">Razão Social</label>
                    <input type="text" id="unidadeRazaoSocial" class="form-control" placeholder="Razão Social completa">
                </div>
                <div class="form-group">
                    <label class="form-label" for="unidadeCnpj">CNPJ</label>
                    <input type="text" id="unidadeCnpj" class="form-control" placeholder="00.000.000/0000-00">
                </div>
                <div class="form-group">
                    <div class="flex items-center">
                        <input type="checkbox" id="unidadeIsMatriz" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="unidadeIsMatriz" class="ml-2 block text-sm text-gray-900">Marcar como Matriz (principal)</label>
                    </div>
                    <small class="text-gray-500">Apenas uma unidade pode ser a matriz. Marcar esta desmarcará a anterior.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button type="submit" class="btn-green">
                    <span class="loading-spinner" style="display: none;"></span> Salvar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('unidadeModal');
    const form = document.getElementById('unidadeForm');
    const tableBody = document.getElementById('unidadesTableBody');

    function abrirModal(unidade = null) {
        form.reset();
        document.getElementById('modalTitle').textContent = unidade ? 'Editar Unidade de Negócio' : 'Nova Unidade de Negócio';
        document.getElementById('unidadeId').value = unidade ? unidade.id : '';
        document.getElementById('unidadeNome').value = unidade ? unidade.nome : '';
        document.getElementById('unidadeRazaoSocial').value = unidade ? unidade.razao_social : '';
        document.getElementById('unidadeCnpj').value = unidade ? unidade.cnpj : '';
        document.getElementById('unidadeIsMatriz').checked = unidade ? unidade.is_matriz : false;
        modal.style.display = 'block';
    }

    function fecharModal() {
        modal.style.display = 'none';
    }

    // ==========================================================
    // ▼▼▼ FUNÇÃO SALVAR ATUALIZADA PARA SER DINÂMICA ▼▼▼
    // ==========================================================
    async function salvarUnidade(event) {
        event.preventDefault();
        const btn = event.target.querySelector('button[type="submit"]');
        const spinner = btn.querySelector('.loading-spinner');
        spinner.style.display = 'inline-block';
        btn.disabled = true;

        const payload = {
            id: document.getElementById('unidadeId').value || null,
            nome: document.getElementById('unidadeNome').value,
            razao_social: document.getElementById('unidadeRazaoSocial').value,
            cnpj: document.getElementById('unidadeCnpj').value,
            is_matriz: document.getElementById('unidadeIsMatriz').checked
        };
        
        const response = await fetch('/api/financeiro/unidade_negocio/salvar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        // A função showNotification() deve vir do seu base.html
        if(typeof showNotification === 'function') {
            showNotification(result.message, result.success ? 'success' : 'error');
        } else { // Fallback caso a função não exista
            alert(result.message);
        }
        
        if (result.success) {
            const unidadeData = result.unidade;
            // Se for uma edição, atualiza a linha. Se for novo, adiciona.
            if (payload.id) {
                atualizarLinhaTabela(unidadeData);
            } else {
                adicionarLinhaTabela(unidadeData);
            }
            fecharModal();
        }

        spinner.style.display = 'none';
        btn.disabled = false;
    }

    function formatarCnpj(cnpj) {
        if (!cnpj || cnpj.length !== 14) return cnpj || '-';
        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
    }

    // Função para criar/atualizar o HTML de uma linha
    function criarHtmlLinha(unidade) {
        const tipoBadge = unidade.is_matriz 
            ? `<span class="status-badge processado"><i class="fas fa-star"></i> Matriz</span>`
            : `<span class="status-badge novo">Filial</span>`;
        
        const botaoExcluir = !unidade.is_matriz
            ? `<button class="btn-table btn-delete" onclick="excluirUnidade(${unidade.id})"><i class="fas fa-trash"></i> Excluir</button>`
            : '';

        return `
            <td class="font-semibold">${unidade.nome}</td>
            <td>${formatarCnpj(unidade.cnpj)}</td>
            <td>${tipoBadge}</td>
            <td>
                <button class="btn-table btn-view" onclick='abrirModal(${JSON.stringify(unidade)})'><i class="fas fa-edit"></i> Editar</button>
                ${botaoExcluir}
            </td>
        `;
    }

    // Função para adicionar uma nova linha na tabela
    function adicionarLinhaTabela(unidade) {
        const newRow = document.createElement('tr');
        newRow.id = `unidade-row-${unidade.id}`;
        newRow.innerHTML = criarHtmlLinha(unidade);
        tableBody.appendChild(newRow);
    }

    // Função para atualizar uma linha existente na tabela
    function atualizarLinhaTabela(unidade) {
        const row = document.getElementById(`unidade-row-${unidade.id}`);
        if (row) {
            row.innerHTML = criarHtmlLinha(unidade);
        }
    }


    async function excluirUnidade(id) {
        if (!confirm('Tem certeza que deseja excluir esta unidade? Esta ação não pode ser desfeita.')) return;
        
        const response = await fetch(`/api/financeiro/unidade_negocio/excluir/${id}`, { method: 'DELETE' });
        const result = await response.json();

        if(typeof showNotification === 'function') {
            showNotification(result.message, result.success ? 'success' : 'error');
        } else {
            alert(result.message);
        }
        
        if (result.success) {
            // Remove a linha da tabela dinamicamente
            const row = document.getElementById(`unidade-row-${id}`);
            if (row) {
                row.remove();
            }
        }
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            fecharModal();
        }
    }
</script>
{% endblock %}