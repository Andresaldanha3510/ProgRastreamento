{% extends "base.html" %}

{% block title %}Borracharia - Dashboard{% endblock %}

{% block styles %}
<style>
    /* Estilos customizados para a Borracharia */
    .kpi-card {
        border: none;
        border-left: 5px solid var(--bs-primary);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .kpi-card .card-body {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .kpi-card .kpi-icon {
        font-size: 2.5rem;
        opacity: 0.3;
    }
    .kpi-card .kpi-value {
        font-size: 2.2rem;
        font-weight: 600;
    }
    .kpi-card.border-info { border-left-color: var(--bs-info); }
    .kpi-card.border-warning { border-left-color: var(--bs-warning); }
    .kpi-card.border-secondary { border-left-color: var(--bs-secondary); }

    /* Estilo do Mapa de Pneus */
    .vehicle-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        min-width: 280px;
    }
    .axle {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
    }
    .tire-position {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.8em;
        position: relative;
    }
    .tire-position.filled {
        background-color: #198754; /* Verde (sucesso) */
        cursor: pointer;
    }
    .tire-position.empty {
        background-color: #6c757d; /* Cinza (secundário) */
        border: 2px dashed #555;
    }
    .tire-position-group {
        display: flex;
        gap: 5px;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-dot-circle me-2"></i>Dashboard da Borracharia
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#novoPneuModal">
                <i class="fas fa-plus-circle me-1"></i> Cadastrar Pneu
            </button>
            <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#importarPneusModal">
                <i class="fas fa-file-csv me-1"></i> Importar em Lote
            </button>
            <a href="{{ url_for('borracharia_configuracoes') }}" class="btn btn-secondary">
                <i class="fas fa-cog me-1"></i> Configurações
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card kpi-card border-primary">
                <div class="card-body">
                    <div>
                        <h5 class="card-title text-primary">Em Estoque</h5>
                        <div class="kpi-value">{{ kpis.em_estoque }}</div>
                    </div>
                    <i class="fas fa-box-open kpi-icon text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card kpi-card border-info">
                <div class="card-body">
                    <div>
                        <h5 class="card-title text-info">Em Uso</h5>
                        <div class="kpi-value">{{ kpis.em_uso }}</div>
                    </div>
                    <i class="fas fa-truck-moving kpi-icon text-info"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card kpi-card border-warning">
                <div class="card-body">
                    <div>
                        <h5 class="card-title text-warning">Recapando</h5>
                        <div class="kpi-value">{{ kpis.recapando }}</div>
                    </div>
                    <i class="fas fa-tools kpi-icon text-warning"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4">
             <div class="card kpi-card border-secondary">
                <div class="card-body">
                    <div>
                        <h5 class="card-title text-secondary">Descartados</h5>
                        <div class="kpi-value">{{ kpis.descartados }}</div>
                    </div>
                    <i class="fas fa-trash-alt kpi-icon text-secondary"></i>
                </div>
            </div>
        </div>
    </div>

    {% if alertas %}
    <div class="alert alert-light border-start border-danger border-4" role="alert">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle text-danger"></i> Alertas de Pneus</h4>
        <div class="list-group">
            {% for alerta in alertas %}
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div>
                    <strong>Pneu <a href="{{ url_for('pneu_historico', pneu_id=alerta.pneu.id) }}">{{ alerta.pneu.numero_fogo }}</a>:</strong> {{ alerta.tipo }}
                    <small class="d-block text-muted">{{ alerta.mensagem }}</small>
                </div>
                <span class="badge bg-{{ 'danger' if alerta.gravidade == 'vermelho' else 'warning text-dark' }} rounded-pill fs-6">
                    {{ 'Crítico' if alerta.gravidade == 'vermelho' else 'Atenção' }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#frota" type="button"><i class="fas fa-truck me-2"></i>Gestão da Frota</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#estoque" type="button"><i class="fas fa-boxes me-2"></i>Pneus em Estoque <span class="badge rounded-pill bg-primary ms-2">{{ kpis.em_estoque }}</span></button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#recapagem" type="button"><i class="fas fa-tools me-2"></i>Pneus em Recapagem <span class="badge rounded-pill bg-warning text-dark ms-2">{{ kpis.recapando }}</span></button></li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="borrachariaTabsContent">
                <div class="tab-pane fade show active" id="frota" role="tabpanel" aria-labelledby="frota-tab">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Veículo</th>
                                    <th>Placa</th>
                                    <th>KM Atual</th>
                                    <th class="text-center">Mapa de Pneus</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for veiculo in veiculos %}
                                <tr>
                                    <td><strong>{{ veiculo.marca }} {{ veiculo.modelo }}</strong></td>
                                    <td><span class="badge bg-secondary">{{ veiculo.placa }}</span></td>
                                    <td>{{ "%.0f"|format(veiculo.km_atual or 0) }} km</td>
                                    <td>
                                        <div class="vehicle-layout mx-auto">
                                            <div class="axle">
                                                {% set pneu_e1de = veiculo.pneus.filter_by(posicao='Eixo 1 - Dianteiro Esquerdo').first() %}
                                                <div class="tire-position {{ 'filled' if pneu_e1de else 'empty' }}" data-bs-toggle="tooltip" title="{{ pneu_e1de.numero_fogo if pneu_e1de else 'Vazio' }}">DE</div>
                                                
                                                {% set pneu_e1dd = veiculo.pneus.filter_by(posicao='Eixo 1 - Dianteiro Direito').first() %}
                                                <div class="tire-position {{ 'filled' if pneu_e1dd else 'empty' }}" data-bs-toggle="tooltip" title="{{ pneu_e1dd.numero_fogo if pneu_e1dd else 'Vazio' }}">DD</div>
                                            </div>
                                            <div class="axle">
                                                <div class="tire-position-group">
                                                    {% set pneu_e2tee = veiculo.pneus.filter_by(posicao='Eixo 2 - Traseiro Esquerdo Externo').first() %}
                                                    <div class="tire-position {{ 'filled' if pneu_e2tee else 'empty' }}" data-bs-toggle="tooltip" title="{{ pneu_e2tee.numero_fogo if pneu_e2tee else 'Vazio' }}">TEE</div>
                                                    {% set pneu_e2tei = veiculo.pneus.filter_by(posicao='Eixo 2 - Traseiro Esquerdo Interno').first() %}
                                                    <div class="tire-position {{ 'filled' if pneu_e2tei else 'empty' }}" data-bs-toggle="tooltip" title="{{ pneu_e2tei.numero_fogo if pneu_e2tei else 'Vazio' }}">TEI</div>
                                                </div>
                                                <div class="tire-position-group">
                                                    {% set pneu_e2tde = veiculo.pneus.filter_by(posicao='Eixo 2 - Traseiro Direito Externo').first() %}
                                                    <div class="tire-position {{ 'filled' if pneu_e2tde else 'empty' }}" data-bs-toggle="tooltip" title="{{ pneu_e2tde.numero_fogo if pneu_e2tde else 'Vazio' }}">TDE</div>
                                                    {% set pneu_e2tdi = veiculo.pneus.filter_by(posicao='Eixo 2 - Traseiro Direito Interno').first() %}
                                                    <div class="tire-position {{ 'filled' if pneu_e2tdi else 'empty' }}" data-bs-toggle="tooltip" title="{{ pneu_e2tdi.numero_fogo if pneu_e2tdi else 'Vazio' }}">TDI</div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="abrirModalInstalar({{ veiculo.id }}, '{{ veiculo.placa }}')"><i class="fas fa-plus"></i> Instalar</button>
                                            <button class="btn btn-sm btn-warning" onclick="abrirModalRemover({{ veiculo.id }}, '{{ veiculo.placa }}')"><i class="fas fa-minus"></i> Remover</button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                

                <div class="tab-pane fade" id="estoque" role="tabpanel" aria-labelledby="estoque-tab">
                     <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nº Fogo</th>
                                    <th>Marca/Modelo</th>
                                    <th>Dimensão</th>
                                    <th>Data Compra</th>
                                    <th>Valor</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pneu in pneus_em_estoque %}
                                <tr>
                                    <td><strong>{{ pneu.numero_fogo }}</strong></td>
                                    <td>{{ pneu.marca }} / {{ pneu.modelo }}</td>
                                    <td>{{ pneu.dimensao }}</td>
                                    <td>{{ pneu.data_compra.strftime('%d/%m/%Y') }}</td>
                                    <td>R$ {{ "%.2f"|format(pneu.valor_compra)|replace('.', ',') }}</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-info" onclick="abrirModalMedicao({{ pneu.id }}, '{{ pneu.numero_fogo }}')"><i class="fas fa-ruler-combined"></i> Medir Sulco</button>
                                        <a href="{{ url_for('pneu_historico', pneu_id=pneu.id) }}" class="btn btn-sm btn-secondary"><i class="fas fa-history"></i> Histórico</a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">Nenhum pneu em estoque.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="recapagem" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nº Fogo</th>
                                    <th>Marca/Modelo</th>
                                    <th>Dimensão</th>
                                    <th>Histórico de Recapagens</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pneu in pneus_recapando %}
                                <tr>
                                    <td><strong>{{ pneu.numero_fogo }}</strong></td>
                                    <td>{{ pneu.marca }} / {{ pneu.modelo }}</td>
                                    <td>{{ pneu.dimensao }}</td>
                                    <td>{{ pneu.numero_recapagens }} vez(es)</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-success" onclick="abrirModalRetorno({{ pneu.id }}, '{{ pneu.numero_fogo }}')">
                                            <i class="fas fa-check-circle me-1"></i> Registrar Retorno
                                        </button>
                                        <a href="{{ url_for('pneu_historico', pneu_id=pneu.id) }}" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-history"></i> Histórico
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">Nenhum pneu em processo de recapagem.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'borracharia_modals.html' %}

{% endblock %}

{% block scripts %}
<script>
// Garante que o código só rode depois que a página carregar
document.addEventListener('DOMContentLoaded', function() {

    // Inicializar Tooltips do Bootstrap para o mapa de pneus
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Criar instâncias dos modais
    const instalarPneuModal = new bootstrap.Modal(document.getElementById('instalarPneuModal'));
    const removerPneuModal = new bootstrap.Modal(document.getElementById('removerPneuModal'));
    const medicaoPneuModal = new bootstrap.Modal(document.getElementById('medicaoPneuModal'));
    const retornoRecapagemModal = new bootstrap.Modal(document.getElementById('retornoRecapagemModal')); // <-- NOVO

    // --- ABRIR MODAL INSTALAR ---
    window.abrirModalInstalar = function(veiculoId, veiculoPlaca) {
        document.getElementById('instalarVeiculoId').value = veiculoId;
        document.getElementById('instalarPneuModalLabel').innerText = `Instalar Pneu no Veículo: ${veiculoPlaca}`;
        instalarPneuModal.show();
    }

    // --- ABRIR MODAL REMOVER ---
    window.abrirModalRemover = async function(veiculoId, veiculoPlaca) {
        document.getElementById('removerVeiculoId').value = veiculoId;
        document.getElementById('removerPneuModalLabel').innerText = `Remover Pneu do Veículo: ${veiculoPlaca}`;
        const response = await fetch(`/api/veiculo/${veiculoId}/pneus`);
        const data = await response.json();
        const selectPneu = document.getElementById('removerPneuId');
        selectPneu.innerHTML = '<option selected disabled value="">Selecione um pneu...</option>';
        if (data.success && data.pneus.length > 0) {
            data.pneus.forEach(pneu => {
                const option = new Option(`${pneu.posicao} - (Nº Fogo: ${pneu.numero_fogo})`, pneu.id);
                selectPneu.add(option);
            });
            document.getElementById('removerKmVeiculo').value = data.km_atual || '';
        } else {
            selectPneu.innerHTML = '<option selected disabled>Nenhum pneu instalado</option>';
        }
        removerPneuModal.show();
    }

    window.abrirModalRetorno = function(pneuId, pneuFogo) {
        document.getElementById('retornoPneuId').value = pneuId;
        document.getElementById('retornoRecapagemModalLabel').innerText = `Retorno do Pneu: ${pneuFogo}`;
        document.getElementById('formRetornoRecapagem').reset();
        retornoRecapagemModal.show();
    };

    // --- ABRIR MODAL MEDIÇÃO ---
    window.abrirModalMedicao = function(pneuId, pneuFogo) {
        document.getElementById('medicaoPneuId').value = pneuId;
        document.getElementById('medicaoPneuModalLabel').innerText = `Medir Sulco do Pneu: ${pneuFogo}`;
        document.getElementById('formMedicaoPneu').reset(); // Limpa o formulário
        medicaoPneuModal.show();
    }

    // --- SUBMISSÃO DOS FORMULÁRIOS ---
    document.getElementById('formInstalarPneu').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/pneu/instalar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pneu_id: this.pneu_id.value,
                veiculo_id: this.veiculo_id.value,
                posicao: this.posicao.value,
                km_veiculo: this.km_veiculo.value,
            })
        });
        if (response.ok) window.location.reload();
        else alert('Erro ao instalar o pneu.');
    });

    document.getElementById('formRemoverPneu').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/pneu/remover', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pneu_id: this.pneu_id.value,
                km_veiculo: this.km_veiculo.value,
                destino: this.destino.value,
                motivo_descarte: this.motivo_descarte.value,
            })
        });
        if (response.ok) window.location.reload();
        else alert('Erro ao remover o pneu.');
    });

    document.getElementById('formMedicaoPneu').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/pneu/registrar_medicao', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pneu_id: this.pneu_id.value,
                sulco_mm: this.sulco_mm.value,
                observacoes: this.observacoes.value,
            })
        });
        if (response.ok) {
            medicaoPneuModal.hide();
            alert('Medição registrada com sucesso!');
        } else {
            alert('Erro ao registrar medição.');
        }
    });

    // ===== SUBMISSÃO DO NOVO FORMULÁRIO DE RETORNO =====
    document.getElementById('formRetornoRecapagem').addEventListener('submit', async function(e) {
        e.preventDefault();
        const response = await fetch('/api/pneu/retorno_recapagem', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                pneu_id: this.pneu_id.value,
                sulco_mm: this.sulco_mm.value, // <-- DADO NOVO ADICIONADO
                custo: this.custo.value,
                fornecedor: this.fornecedor.value,
                observacoes: this.observacoes.value,
            })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao registrar retorno de recapagem.');
        }
    });

});
</script>
{% endblock %}