{% extends "base.html" %} {% block title %}Importação NFe SEFAZ - TrackBras{%
endblock %} {% block styles %}
<style>
  :root {
    --primary-green: #2e7d32;
    --primary-green-dark: #1b5e20;
    --primary-green-light: #4caf50;
    --accent-yellow: #ffc107;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-900: #0f172a;
    --red-600: #dc2626;
    --red-100: #fee2e2;
    --green-600: #16a34a;
    --green-100: #dcfce7;
    --blue-600: #2563eb;
    --blue-100: #dbeafe;
  }

  /* ========== SISTEMA DE NOTIFICAÇÕES FLUTUANTES ========== */
  #notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 420px;
    width: 100%;
    pointer-events: none;
  }

  .notification-toast {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    pointer-events: all;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 4px solid;
    overflow: hidden;
  }

  .notification-toast:hover {
    transform: translateX(-5px);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
  }

  .notification-toast.success {
    border-left-color: var(--green-600);
    background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
  }

  .notification-toast.error {
    border-left-color: var(--red-600);
    background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
  }

  .notification-toast.info {
    border-left-color: var(--blue-600);
    background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
  }

  .notification-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 16px;
  }

  .notification-toast.success .notification-icon {
    background: var(--green-100);
    color: var(--green-600);
  }

  .notification-toast.error .notification-icon {
    background: var(--red-100);
    color: var(--red-600);
  }

  .notification-toast.info .notification-icon {
    background: var(--blue-100);
    color: var(--blue-600);
  }

  .notification-content {
    flex: 1;
    color: var(--gray-900);
    font-size: 14px;
    line-height: 1.5;
    font-weight: 500;
  }

  .notification-close {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--gray-600);
    background: transparent;
    border: none;
    flex-shrink: 0;
    font-size: 18px;
    line-height: 1;
  }

  .notification-close:hover {
    background: rgba(0, 0, 0, 0.05);
    color: var(--gray-900);
  }

  .notification-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: currentColor;
    border-radius: 0 0 0 12px;
    animation: notificationProgress 5s linear forwards;
  }

  .notification-toast.success .notification-progress {
    color: var(--green-600);
  }

  .notification-toast.error .notification-progress {
    color: var(--red-600);
  }

  .notification-toast.info .notification-progress {
    color: var(--blue-600);
  }

  @keyframes notificationProgress {
    from {
      width: 100%;
    }
    to {
      width: 0%;
    }
  }

  @keyframes slideInRight {
    from {
      transform: translateX(120%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(120%);
      opacity: 0;
    }
  }

  .notification-toast.entering {
    animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .notification-toast.exiting {
    animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  /* Duração da animação de progresso aumentada para 8 segundos */
  .notification-toast .notification-progress {
    animation-duration: 8s;
  }

  /* ========== ESTILOS GERAIS ========== */
  .nfe-container {
    background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--gray-200);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1.5rem;
    color: var(--primary-green-dark);
    font-size: 1.25rem;
    font-weight: 600;
  }

  .section-header i {
    color: var(--primary-green);
    font-size: 1.5rem;
  }

  .btn-green {
    background: linear-gradient(
      135deg,
      var(--primary-green) 0%,
      var(--primary-green-dark) 100%
    );
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
  }

  .btn-green:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
  }

  .btn-green:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  .btn-secondary {
    background: linear-gradient(
      135deg,
      var(--gray-600) 0%,
      var(--gray-700) 100%
    );
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-warning {
    background: linear-gradient(135deg, var(--accent-yellow) 0%, #ff9800 100%);
    color: var(--gray-900);
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
  }

  .stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--gray-200);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-green);
    display: block;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-top: 0.5rem;
    font-weight: 500;
  }

  .search-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--gray-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .search-controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .search-box {
    position: relative;
    flex: 1;
    min-width: 300px;
  }

  .search-box input {
    width: 100%;
    padding: 12px 16px 12px 48px;
    border: 2px solid var(--gray-200);
    border-radius: 25px;
    font-size: 1rem;
    transition: all 0.3s;
    background: white;
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
  }

  .search-box i {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-600);
    font-size: 1.125rem;
  }

  .form-select {
    padding: 10px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    background: white;
    font-size: 0.875rem;
    min-width: 150px;
  }

  .form-select:focus {
    outline: none;
    border-color: var(--primary-green);
  }

  .empresa-filter {
    position: relative;
    min-width: 200px;
  }

  .empresa-filter select {
    padding: 10px 16px;
    padding-left: 40px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    background: white;
    font-size: 0.875rem;
    width: 100%;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 12px center;
    background-repeat: no-repeat;
    background-size: 16px;
  }

  .empresa-filter i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--blue-600);
    font-size: 1rem;
    pointer-events: none;
  }

  .progress-bar {
    background: var(--gray-200);
    border-radius: 10px;
    overflow: hidden;
    height: 8px;
    margin: 1rem 0;
    display: none;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(
      135deg,
      var(--primary-green) 0%,
      var(--primary-green-light) 100%
    );
    width: 0%;
    transition: width 0.3s ease;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
  }

  .modal-content {
    background: white;
    margin: 2% auto;
    padding: 0;
    border-radius: 16px;
    width: 95%;
    max-width: 800px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    animation: modalSlide 0.3s ease-out;
    overflow: hidden;
    max-height: 95vh;
    overflow-y: auto;
  }

  @keyframes modalSlide {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    background: linear-gradient(
      135deg,
      var(--primary-green-dark) 0%,
      var(--primary-green) 100%
    );
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .close {
    color: white;
    font-size: 1.75rem;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.3s;
    line-height: 1;
  }

  .close:hover {
    opacity: 0.7;
  }

  .modal-body {
    padding: 2rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--gray-900);
  }

  .form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
  }

  .tipo-movimento-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .radio-option {
    position: relative;
  }

  .radio-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
  }

  .radio-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 1rem;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
    text-align: center;
  }

  .radio-label:hover {
    border-color: var(--primary-green);
    background: var(--gray-50);
  }

  .radio-label i {
    font-size: 2rem;
    margin-bottom: 0.75rem;
  }

  .radio-label span {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }

  .radio-label small {
    font-size: 0.75rem;
    color: var(--gray-600);
    line-height: 1.2;
  }

  .radio-label.despesa i {
    color: var(--red-600);
  }

  .radio-option input[type="radio"]:checked + .radio-label {
    border-color: var(--primary-green);
    background: linear-gradient(
      135deg,
      var(--primary-green) 0%,
      var(--primary-green-light) 100%
    );
    color: white;
  }

  .radio-option input[type="radio"]:checked + .radio-label i {
    color: white;
  }

  .radio-option input[type="radio"]:checked + .radio-label small {
    color: rgba(255, 255, 255, 0.9);
  }

  .parcelamento-container {
    background: var(--gray-50);
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .parcelamento-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
    font-weight: 600;
    color: var(--gray-700);
    justify-content: space-between;
  }

  .parcela-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    display: grid;
    grid-template-columns: auto 1fr 1fr;
    gap: 1rem;
    align-items: center;
    transition: all 0.3s ease;
  }

  .parcela-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .parcela-numero {
    background: var(--primary-green);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .parcela-input-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .parcela-input-group label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .parcela-input-group input {
    padding: 8px 12px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 0.875rem;
  }

  .parcela-input-group input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.1);
  }

  .validation-error {
    background: #fef2f2;
    border: 2px solid #fecaca;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    display: none;
  }

  .validation-error.show {
    display: block;
    animation: shake 0.5s ease-in-out;
  }

  .validation-error-content {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #dc2626;
    font-weight: 500;
  }

  .validation-error i {
    font-size: 1.25rem;
  }

  @keyframes shake {
    0%,
    20%,
    40%,
    60%,
    80% {
      transform: translateX(0);
    }
    10%,
    30%,
    50%,
    70% {
      transform: translateX(-5px);
    }
    90% {
      transform: translateX(5px);
    }
    100% {
      transform: translateX(0);
    }
  }

  .totalizacao {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f9f0 100%);
    border: 2px solid var(--primary-green);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .totalizacao-content {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    text-align: center;
  }

  .totalizacao-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .totalizacao-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--gray-600);
    font-weight: 500;
  }

  .totalizacao-valor {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary-green);
  }

  .totalizacao-diferenca {
    color: #dc2626;
  }

  .totalizacao-ok {
    color: var(--primary-green);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 1.5rem;
    color: var(--gray-600);
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    color: var(--gray-300);
  }

  .empty-state h3 {
    margin-bottom: 0.75rem;
    color: var(--gray-700);
    font-size: 1.25rem;
  }

  .chave-input {
    font-family: "Courier New", monospace;
    letter-spacing: 1px;
  }

  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .pulse {
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(46, 125, 50, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(46, 125, 50, 0);
    }
  }

  .nfe-table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--gray-200);
  }

  .nfe-table {
    width: 100%;
    border-collapse: collapse;
  }

  .nfe-table th {
    background: linear-gradient(
      135deg,
      var(--primary-green-dark) 0%,
      var(--primary-green) 100%
    );
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .nfe-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-100);
    vertical-align: middle;
    font-size: 0.875rem;
  }

  .nfe-table tr:hover {
    background: var(--gray-50);
  }

  .nfe-table tr.processed {
    background: linear-gradient(135deg, #f0f9f0 0%, #e8f5e8 100%);
  }

  .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
  }

  .status-badge.novo {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
  }

  .status-badge.processado {
    background: linear-gradient(
      135deg,
      var(--primary-green) 0%,
      var(--primary-green-light) 100%
    );
    color: white;
  }

  .empresa-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, var(--blue-600) 0%, #1e40af 100%);
    color: white;
    border-radius: 16px;
    font-size: 0.75rem;
    font-weight: 500;
    font-family: "Courier New", monospace;
  }

  .empresa-badge i {
    font-size: 0.875rem;
  }

  .btn-table {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    margin-right: 4px;
    margin-bottom: 4px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.3s;
  }

  .btn-table.btn-launch {
    background: var(--primary-green);
    color: white;
  }

  .btn-table.btn-launch:hover {
    background: var(--primary-green-dark);
  }

  .btn-table.btn-processed {
    background: #4caf50;
    color: white;
    cursor: not-allowed;
  }

  .btn-table.btn-view {
    background: #17a2b8;
    color: white;
  }

  .btn-table.btn-view:hover {
    background: #138496;
  }

  .chave-display {
    font-family: "Courier New", monospace;
    font-size: 0.75rem;
    color: var(--gray-600);
    word-break: break-all;
  }

  .valor-cell {
    font-weight: 600;
    color: var(--primary-green);
    font-size: 0.875rem;
  }

  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
  }

  .pagination-info {
    color: var(--gray-600);
    font-size: 0.875rem;
  }

  .pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .pagination-btn {
    padding: 8px 12px;
    border: 1px solid var(--gray-300);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .pagination-btn:hover:not(.disabled) {
    background: var(--primary-green);
    color: white;
    border-color: var(--primary-green);
  }

  .pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination-btn.active {
    background: var(--primary-green);
    color: white;
    border-color: var(--primary-green);
  }

  .per-page-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .per-page-selector select {
    padding: 4px 8px;
    border: 1px solid var(--gray-300);
    border-radius: 4px;
    font-size: 0.875rem;
  }

  .veiculo-rateio-item {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    position: relative;
  }

  .veiculo-rateio-item:hover {
    border-color: var(--primary-green);
    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
  }

  .veiculo-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    gap: 12px;
  }

  .veiculo-numero {
    background: linear-gradient(135deg, var(--blue-600) 0%, #1e40af 100%);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .veiculo-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .veiculo-nome {
    font-weight: 600;
    color: var(--gray-900);
    font-size: 0.95rem;
  }

  .veiculo-percentual {
    font-size: 0.75rem;
    color: var(--primary-green);
    font-weight: 600;
    background: var(--green-100);
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
    width: fit-content;
  }

  .btn-delete-veiculo {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    flex-shrink: 0;
  }

  .btn-delete-veiculo:hover {
    background: #dc2626;
    transform: scale(1.1);
  }

  .veiculo-valores {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .valor-input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .valor-input-group label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .rateio-valor-input,
  .rateio-percentual-input {
    padding: 10px 12px;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.3s;
    text-align: right;
  }

  .rateio-valor-input:focus,
  .rateio-percentual-input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
  }

  .rateio-valor-input {
    color: var(--primary-green);
  }

  .rateio-percentual-input {
    color: var(--blue-600);
  }

  .text-green-600 {
    color: var(--green-600);
  }
  .text-red-600 {
    color: var(--red-600);
  }
  .text-orange-600 {
    color: #ea580c;
  }
  .ml-auto {
    margin-left: auto;
  }
  .ml-2 {
    margin-left: 0.5rem;
  }
  .text-xs {
    font-size: 0.75rem;
  }

  .underline {
    text-decoration: underline;
    cursor: pointer;
  }

  .underline:hover {
    color: var(--primary-green);
  }

  #rateioControles {
    display: flex;
    gap: 0.5rem;
  }

  #rateioControles .btn-secondary {
    white-space: nowrap;
  }

  #rateioStatusContainer {
    background: var(--gray-50);
    border-radius: 8px;
    padding: 1rem;
  }

  /* Modal de Loading para importação de XMLs */
  .loading-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    align-items: center;
    justify-content: center;
  }

  .loading-modal.show {
    display: flex;
  }

  .loading-modal-content {
    background: white;
    border-radius: 20px;
    padding: 3rem 4rem;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalBounce 0.4s ease-out;
    max-width: 500px;
  }

  @keyframes modalBounce {
    0% {
      transform: scale(0.8);
      opacity: 0;
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .loading-spinner-large {
    width: 80px;
    height: 80px;
    border: 6px solid var(--gray-200);
    border-radius: 50%;
    border-top-color: var(--primary-green);
    animation: spin 1s linear infinite;
    margin: 0 auto 2rem;
  }

  .loading-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
  }

  .loading-modal-text {
    font-size: 1rem;
    color: var(--gray-600);
    line-height: 1.5;
  }

  .loading-modal-details {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: 10px;
    font-size: 0.875rem;
    color: var(--gray-700);
  }

  .loading-modal-details strong {
    color: var(--primary-green);
    font-size: 1.125rem;
  }

  @media (max-width: 768px) {
    #notifications {
      right: 10px;
      left: 10px;
      max-width: none;
    }

    .loading-modal-content {
      margin: 1rem;
      padding: 2rem;
      max-width: 90%;
    }

    .loading-spinner-large {
      width: 60px;
      height: 60px;
      border-width: 4px;
    }

    .search-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .search-box,
    .empresa-filter {
      min-width: auto;
    }

    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .nfe-table-container {
      overflow-x: auto;
    }

    .pagination-container {
      flex-direction: column;
      gap: 1rem;
    }

    .tipo-movimento-container {
      grid-template-columns: 1fr;
    }

    .modal-content {
      width: 98%;
      margin: 1% auto;
    }

    .parcela-item {
      grid-template-columns: 1fr;
      gap: 0.75rem;
      text-align: center;
    }

    .totalizacao-content {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
  }

  .detail-row:last-child {
    border-bottom: none;
  }

  .detail-label {
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
  }

  .detail-value {
    color: var(--gray-900);
    font-size: 0.875rem;
  }

  .valor-destaque {
    font-weight: 700;
    color: var(--primary-green);
    font-size: 1rem;
  }
</style>
{% endblock %} {% block content %}
<div class="space-y-6">
  <div
    class="bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg p-6 shadow-lg"
  >
    <h1 class="text-3xl font-bold flex items-center gap-3">
      <i class="fas fa-file-invoice"></i>
      Importação de Notas Fiscais SEFAZ
    </h1>
    <p class="text-green-100 mt-2">
      Consulte, importe e gerencie suas notas fiscais eletrônicas
    </p>
  </div>

  <div id="notifications"></div>

  <div class="nfe-container">
    <div class="section-header">
      <i class="fas fa-cloud-download-alt"></i>
      Consultar SEFAZ
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number" id="totalNotas"
          >{{ notas|length if notas else 0 }}</span
        >
        <span class="stat-label">Notas Importadas</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="notasProcessadas">
          {{ notas|selectattr('status', 'equalto', 'PROCESSADA')|list|length if
          notas else 0 }}
        </span>
        <span class="stat-label">Processadas</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="valorTotal">
          R$ {{ "%.2f"|format(notas|sum(attribute='valor_total') if notas else
          0)|replace('.', ',')|replace(',', '.', 1) }}
        </span>
        <span class="stat-label">Valor Total</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalEmpresas">0</span>
        <span class="stat-label">Empresas Consultadas</span>
      </div>
    </div>

    <div class="flex flex-wrap gap-4 items-center">
      <button class="btn-green" id="btnConsultarSefaz">
        <i class="fas fa-search"></i>
        <span class="loading-spinner" id="loadingConsulta"></span>
        Buscar Novas NFe na SEFAZ
      </button>

      <a href="{{ url_for('configuracao_fiscal') }}" class="btn-secondary">
        <i class="fas fa-cog"></i>
        Configurar Certificado
      </a>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <div class="nfe-container">
    <div class="section-header">
      <i class="fas fa-bolt"></i>
      Lançamento Rápido
    </div>

    <div class="flex gap-4 flex-wrap items-end mb-4">
      <div class="flex-1 min-w-0">
        <label class="form-label">Chave de Acesso (44 dígitos)</label>
        <div class="search-box">
          <input
            type="text"
            id="chaveAcessoInput"
            placeholder="Digite ou escaneie a chave de acesso da NFe..."
            class="chave-input"
            maxlength="44"
          />
          <i class="fas fa-key"></i>
        </div>
      </div>

      <button class="btn-warning" id="btnLancarRapido">
        <i class="fas fa-rocket"></i>
        Lançar Nota
      </button>
    </div>

    <div class="text-sm text-gray-600">
      <i class="fas fa-info-circle"></i>
      Digite a chave de acesso de 44 dígitos ou use um leitor de código para
      capturar automaticamente
    </div>
  </div>

  <div class="nfe-container">
    <div class="section-header">
      <i class="fas fa-folder-open"></i>
      Importar Arquivos XML
    </div>
    <div class="flex gap-4 flex-wrap items-end mb-4">
      <div class="flex-1 min-w-0">
        <label for="xmlFilesInput" class="form-label"
          >Selecione os arquivos XML</label
        >
        <input
          type="file"
          id="xmlFilesInput"
          class="form-control"
          multiple
          accept=".xml"
        />
      </div>
      <button class="btn-green" id="btnImportarXmls">
        <i class="fas fa-upload"></i>
        <span class="loading-spinner" id="loadingImportarXml"></span>
        Importar Arquivos Selecionados
      </button>
    </div>
    <div class="text-sm text-gray-600">
      <i class="fas fa-info-circle"></i>
      Selecione um ou mais arquivos .xml da sua pasta. O sistema irá verificar e
      adicionar apenas as notas que ainda não foram importadas.
    </div>
  </div>

  <div class="search-section">
    <div class="section-header">
      <i class="fas fa-filter"></i>
      Buscar e Filtrar Notas
    </div>

    <div class="search-controls">
      <div class="search-box">
        <input
          type="text"
          id="searchInput"
          placeholder="Buscar por CNPJ, nome, chave..."
          class="search-input"
        />
        <i class="fas fa-search"></i>
      </div>

      <div class="empresa-filter">
        <i class="fas fa-building"></i>
        <select id="empresaFilter">
          <option value="">Todas as Empresas</option>
        </select>
      </div>

      <select id="statusFilter" class="form-select">
        <option value="">Todos os Status</option>
        <option value="BAIXADA">Novas</option>
        <option value="PROCESSADA">Processadas</option>
      </select>

      <div class="flex items-center gap-2">
        <label for="startDateFilter" class="text-sm font-medium text-gray-600"
          >De:</label
        >
        <input
          type="date"
          id="startDateFilter"
          class="form-select"
          style="padding: 8px"
        />
      </div>
      <div class="flex items-center gap-2">
        <label for="endDateFilter" class="text-sm font-medium text-gray-600"
          >Até:</label
        >
        <input
          type="date"
          id="endDateFilter"
          class="form-select"
          style="padding: 8px"
        />
      </div>

      <button class="btn-secondary" id="btnLimparFiltros">
        <i class="fas fa-times"></i>
        Limpar Filtros
      </button>
    </div>
  </div>

  <div class="nfe-container">
    <div class="section-header">
      <i class="fas fa-file-export"></i>
      Exportar para Contabilidade
    </div>
    <div class="flex flex-wrap gap-4 items-center">
      <div>
        <label for="tipoExportacao" class="form-label"
          >Tipo de Exportação</label
        >
        <select id="tipoExportacao" class="form-select">
          <option value="todas">Exportar seleção atual</option>
          <option value="processadas">
            Exportar apenas Processadas da seleção atual
          </option>
          <option value="nao_lancadas">
            Exportar apenas Não Lançadas da seleção atual
          </option>
        </select>
      </div>
      <button class="btn-green" id="btnExportarDocumentos">
        <i class="fas fa-download"></i>
        <span class="loading-spinner" id="loadingExportar"></span>
        Exportar Documentos (.zip)
      </button>
    </div>
    <p class="text-sm text-gray-600 mt-3">
      <i class="fas fa-info-circle"></i>
      Será gerado um arquivo .zip contendo um relatório em Excel e uma pasta com
      os arquivos XML.
    </p>
  </div>

  <div class="nfe-container">
    <div class="section-header">
      <i class="fas fa-list"></i>
      Notas Fiscais Importadas
      <span
        id="contadorNotas"
        class="text-base font-normal text-gray-600"
      ></span>
    </div>

    <div id="nfeContainer">
      {% if not notas %}
      <div class="empty-state" id="emptyState">
        <i class="fas fa-file-invoice"></i>
        <h3>Nenhuma nota encontrada</h3>
        <p>
          Clique em "Buscar Novas NFe na SEFAZ" para importar suas notas fiscais
        </p>
      </div>
      {% else %}
      <div class="nfe-table-container" id="nfeTableContainer">
        <table class="nfe-table">
          <thead>
            <tr>
              <th>Empresa Consultada</th>
              <th>Emitente</th>
              <th>CNPJ</th>
              <th>Data Emissão</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Ações</th>
              <th>Chave de Acesso</th>
            </tr>
          </thead>
          <tbody id="nfeTableBody"></tbody>
        </table>

        <div class="pagination-container">
          <div class="pagination-info">
            <span id="paginationInfo">Carregando...</span>
          </div>

          <div class="pagination-controls">
            <button class="pagination-btn" id="btnPrevPage">
              <i class="fas fa-chevron-left"></i>
              Anterior
            </button>
            <div id="pageNumbers"></div>
            <button class="pagination-btn" id="btnNextPage">
              Próxima
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="per-page-selector">
            <span>Mostrar:</span>
            <select id="itemsPerPage">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
            <span>por página</span>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de Loading para Importação de XMLs -->
<div id="loadingModal" class="loading-modal">
  <div class="loading-modal-content">
    <div class="loading-spinner-large"></div>
    <div class="loading-modal-title">Processando XMLs...</div>
    <div class="loading-modal-text">
      Por favor, aguarde enquanto processamos os arquivos.<br />
      Isso pode levar alguns instantes.
    </div>
    <div class="loading-modal-details">
      Arquivos selecionados: <strong id="loadingFileCount">0</strong>
    </div>
  </div>
</div>

<div id="modalLancamento" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">
        <i class="fas fa-edit"></i>
        Lançar Nota Fiscal no Fluxo de Caixa
      </div>
      <span class="close" onclick="fecharModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="dadosNota"></div>

      <div class="form-group">
        <label class="form-label">Categoria da Despesa *</label>
        <select id="categoriaLancamento" class="form-control">
          <option value="Fornecedores (NFe)">Fornecedores (NFe)</option>
          <option value="Combustível">Combustível</option>
          <option value="Manutenção">Manutenção</option>
          <option value="Peças e Acessórios">Peças e Acessórios</option>
          <option value="Outras Despesas">Outras Despesas</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="unidadeNegocioLancamento"
          >Unidade de Negócio *</label
        >
        <select id="unidadeNegocioLancamento" class="form-control" required>
          {% for unidade in unidades_negocio %}
          <option
            value="{{ unidade.id }}"
            {%
            if
            unidade.is_matriz
            %}selected{%
            endif
            %}
          >
            {{ unidade.nome }} {% if unidade.is_matriz %}(Matriz){% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Parcelamento do Pagamento</label>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: end;
            margin-bottom: 1rem;
          "
        >
          <div>
            <label
              for="quantidadeParcelas"
              style="font-size: 0.875rem; color: var(--gray-600)"
              >Quantidade de Parcelas</label
            >
            <input
              type="number"
              id="quantidadeParcelas"
              min="1"
              max="36"
              value="1"
              class="form-control"
              style="padding: 8px 12px"
            />
          </div>
          <button type="button" id="btnGerarParcelas" class="btn-secondary">
            <i class="fas fa-calendar-alt"></i> Gerar Parcelas
          </button>
        </div>

        <div
          class="parcelamento-container"
          id="parcelamentoContainer"
          style="display: none"
        >
          <div class="parcelamento-header">
            <i class="fas fa-calendar-check"></i>
            <span>Cronograma de Pagamento</span>
          </div>
          <div id="parcelasContainer"></div>
          <div class="totalizacao" id="totalizacaoParcelas">
            <div class="totalizacao-content">
              <div class="totalizacao-item">
                <span class="totalizacao-label">Valor da Nota</span>
                <span class="totalizacao-valor" id="valorNota">R$ 0,00</span>
              </div>
              <div class="totalizacao-item">
                <span class="totalizacao-label">Total das Parcelas</span>
                <span class="totalizacao-valor" id="totalParcelas"
                  >R$ 0,00</span
                >
              </div>
              <div class="totalizacao-item">
                <span class="totalizacao-label">Diferença</span>
                <span class="totalizacao-valor" id="diferencaValor"
                  >R$ 0,00</span
                >
              </div>
            </div>
          </div>
        </div>

        <div class="validation-error" id="validationError">
          <div class="validation-error-content">
            <i class="fas fa-exclamation-triangle"></i>
            O valor total das parcelas não confere com o valor da nota fiscal!
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Rateio da Despesa</label>
        <div class="tipo-movimento-container">
          <div class="radio-option">
            <input
              type="radio"
              id="semRateio"
              name="tipo_rateio"
              value="sem_rateio"
              checked
            />
            <label for="semRateio" class="radio-label despesa">
              <i class="fas fa-file-invoice-dollar"></i>
              <span>Despesa Geral</span>
              <small>Lançar como despesa geral da empresa</small>
            </label>
          </div>
          <div class="radio-option">
            <input
              type="radio"
              id="comRateio"
              name="tipo_rateio"
              value="com_rateio"
            />
            <label for="comRateio" class="radio-label despesa">
              <i class="fas fa-truck-moving"></i>
              <span>Ratear por Veículo</span>
              <small>Dividir o custo entre veículos específicos</small>
            </label>
          </div>
        </div>
      </div>

      <div id="containerRateio" style="display: none">
        <div class="form-group">
          <label class="form-label"
            >Buscar Veículos (Placa ou Modelo) para despesas não relacionadas a
            veiculos (ADMIN)</label
          >
          <div class="search-box">
            <input
              type="text"
              id="veiculoSearchInput"
              placeholder="Digite para buscar e adicionar múltiplos veículos..."
              autocomplete="off"
              class="form-control"
            />
            <i class="fas fa-search" style="right: 15px; left: auto"></i>
          </div>
          <div
            id="veiculoSearchResults"
            class="list-group mt-2 position-absolute bg-white shadow-lg rounded"
            style="z-index: 1001; width: calc(100% - 4rem)"
          ></div>
          <div class="text-sm text-gray-600 mt-2">
            <i class="fas fa-info-circle"></i>
            Você pode adicionar quantos veículos precisar para dividir o custo
            da nota fiscal
          </div>
        </div>

        <div class="parcelamento-container">
          <div class="parcelamento-header">
            <i class="fas fa-list-ul"></i>
            <span>Veículos para Rateio</span>
            <div class="ml-auto" id="rateioControles" style="display: none">
              <button
                type="button"
                class="btn-secondary"
                style="padding: 6px 12px; font-size: 0.75rem"
                onclick="distribuirIgualmente()"
              >
                <i class="fas fa-equals"></i> Dividir Igual
              </button>
              <button
                type="button"
                class="btn-secondary"
                style="padding: 6px 12px; font-size: 0.75rem"
                onclick="ajustarAutomaticamente()"
              >
                <i class="fas fa-magic"></i> Ajustar Auto
              </button>
              <button
                type="button"
                class="btn-secondary"
                style="padding: 6px 12px; font-size: 0.75rem"
                onclick="limparRateio()"
              >
                <i class="fas fa-trash"></i> Limpar
              </button>
            </div>
          </div>
          <div id="veiculosRateioContainer" class="mt-3">
            <div class="text-center text-gray-500 my-4" id="rateioEmpty">
              <i
                class="fas fa-truck"
                style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3"
              ></i>
              <p>Nenhum veículo selecionado</p>
              <small>Use a busca acima para adicionar veículos ao rateio</small>
            </div>
          </div>
          <div class="totalizacao mt-4" id="rateioTotalizacao">
            <div class="totalizacao-content">
              <div class="totalizacao-item">
                <span class="totalizacao-label">Valor da Nota</span>
                <span class="totalizacao-valor" id="rateioValorNota"
                  >R$ 0,00</span
                >
              </div>
              <div class="totalizacao-item">
                <span class="totalizacao-label">Total Rateado</span>
                <span class="totalizacao-valor" id="rateioTotalAlocado"
                  >R$ 0,00</span
                >
              </div>
              <div class="totalizacao-item">
                <span class="totalizacao-label">Diferença</span>
                <span class="totalizacao-valor" id="rateioDiferenca"
                  >R$ 0,00</span
                >
              </div>
            </div>
            <div class="mt-3" id="rateioStatusContainer">
              <div
                class="progress-bar"
                id="rateioProgressBar"
                style="display: block; height: 6px"
              >
                <div
                  class="progress-fill"
                  id="rateioProgressFill"
                  style="width: 0%"
                ></div>
              </div>
              <div class="text-center mt-2" id="rateioStatus">
                <small class="text-gray-600"
                  >Adicione veículos e distribua os valores para confirmar o
                  lançamento</small
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex gap-4 justify-end mt-6">
        <button type="button" class="btn-secondary" onclick="fecharModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="btn-green" id="btnSalvarLancamento">
          <i class="fas fa-save"></i>
          <span class="loading-spinner" id="loadingSalvar"></span>
          Confirmar Lançamento
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Variáveis globais
  let notasData = [];
  let notasFiltradas = [];
  let currentPage = 1;
  let itemsPerPage = 50;
  let empresasDisponiveis = new Set();
  let valorTotalNota = 0;
  let veiculosSelecionados = new Map();

  // Inicialização
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM carregado, iniciando aplicação...');
    carregarNotasDoHTML();
    configurarEventos();
    configurarFiltros();
    atualizarEstatisticas();
    popularFiltroEmpresas();
    renderizarTabela();
    console.log('Aplicação inicializada com sucesso');
  });

  // ========== SISTEMA DE NOTIFICAÇÕES FLUTUANTES ==========
  function mostrarNotificacao(tipo, mensagem) {
    const container = document.getElementById('notifications');
    const notification = document.createElement('div');

    // Extrair apenas o texto da mensagem (remover tags HTML para o conteúdo)
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = mensagem;
    const textoLimpo = tempDiv.textContent || tempDiv.innerText;

    // Determinar o ícone baseado no tipo
    const icones = {
      'success': 'fas fa-check-circle',
      'error': 'fas fa-exclamation-circle',
      'info': 'fas fa-info-circle'
    };

    notification.className = `notification-toast ${tipo} entering`;
    notification.innerHTML = `
      <div class="notification-icon">
        <i class="${icones[tipo]}"></i>
      </div>
      <div class="notification-content">${textoLimpo}</div>
      <button class="notification-close" onclick="fecharNotificacao(this)">×</button>
      <div class="notification-progress"></div>
    `;

    container.appendChild(notification);

    // Auto-remover após 8 segundos (aumentado de 5 para 8)
    setTimeout(() => {
      fecharNotificacao(notification.querySelector('.notification-close'));
    }, 8000);
  }

  function fecharNotificacao(btnClose) {
    const notification = btnClose.closest('.notification-toast');
    if (notification) {
      notification.classList.remove('entering');
      notification.classList.add('exiting');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }
  }

  function popularFiltroEmpresas() {
    const empresaSelect = document.getElementById('empresaFilter');
    empresasDisponiveis.clear();

    notasData.forEach(nota => {
      if (nota.cnpj_consultado) {
        empresasDisponiveis.add(nota.cnpj_consultado);
      }
    });

    while (empresaSelect.children.length > 1) {
      empresaSelect.removeChild(empresaSelect.lastChild);
    }

    const empresasOrdenadas = Array.from(empresasDisponiveis).sort();
    empresasOrdenadas.forEach(cnpj => {
      const option = document.createElement('option');
      option.value = cnpj;
      option.textContent = `${formatarCNPJ(cnpj)} (${contarNotasPorEmpresa(cnpj)} notas)`;
      empresaSelect.appendChild(option);
    });

    document.getElementById('totalEmpresas').textContent = empresasDisponiveis.size;
  }

  function contarNotasPorEmpresa(cnpj) {
    return notasData.filter(nota => nota.cnpj_consultado === cnpj).length;
  }

  function carregarNotasDoHTML() {
    notasData = [
      {% for nota in notas %}
      {
        "chave_acesso": "{{ nota.chave_acesso }}",
        "emitente_nome": "{{ nota.emitente_nome }}",
        "emitente_cnpj": "{{ nota.emitente_cnpj }}",
        "valor_total": {{ nota.valor_total }},
        "data_emissao": "{{ nota.data_emissao.isoformat() }}",
        "nsu": "{{ nota.nsu }}",
        "status": "{{ nota.status }}",
        "cnpj_consultado": "{{ nota.cnpj_consultado or '' }}"
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    notasFiltradas = [...notasData];
    renderizarContador();
    console.log('Notas carregadas:', notasData.length);
  }

  async function importarArquivosXML() {
    const input = document.getElementById('xmlFilesInput');
    const files = input.files;

    if (files.length === 0) {
      mostrarNotificacao('info', 'Por favor, selecione pelo menos um arquivo XML.');
      return;
    }

    // Mostrar modal de loading
    const loadingModal = document.getElementById('loadingModal');
    document.getElementById('loadingFileCount').textContent = files.length;
    loadingModal.classList.add('show');

    const btn = document.getElementById('btnImportarXmls');
    const loading = document.getElementById('loadingImportarXml');
    btn.disabled = true;
    loading.style.display = 'inline-block';

    const formData = new FormData();
    for (const file of files) {
      formData.append('xml_files', file);
    }

    try {
      const response = await fetch('/api/fiscal/importar_xmls', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      // Esconder modal de loading
      loadingModal.classList.remove('show');

      if (result.success) {
        mostrarNotificacao('success', result.message);

        if (result.novas_notas && result.novas_notas.length > 0) {
          notasData.unshift(...result.novas_notas);
          limparFiltros();
          popularFiltroEmpresas();
          atualizarEstatisticas();
        }
      } else {
        mostrarNotificacao('error', result.message);
      }

    } catch (error) {
      console.error('Erro ao importar XMLs:', error);
      loadingModal.classList.remove('show');
      mostrarNotificacao('error', 'Erro de conexão ao importar arquivos.');
    } finally {
      btn.disabled = false;
      loading.style.display = 'none';
      input.value = '';
    }
  }

  function configurarEventos() {
    console.log('Configurando eventos...');

    document.getElementById('btnConsultarSefaz').addEventListener('click', consultarSefaz);
    document.getElementById('btnLancarRapido').addEventListener('click', lancarRapido);
    document.getElementById('btnImportarXmls').addEventListener('click', importarArquivosXML);
    document.getElementById('btnSalvarLancamento').addEventListener('click', salvarLancamento);
    document.getElementById('chaveAcessoInput').addEventListener('input', formatarChaveAcesso);
    document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltros);
    document.getElementById('itemsPerPage').addEventListener('change', alterarItensPorPagina);
    document.getElementById('btnPrevPage').addEventListener('click', paginaAnterior);
    document.getElementById('btnNextPage').addEventListener('click', proximaPagina);
    document.getElementById('btnExportarDocumentos').addEventListener('click', exportarDocumentos);
    document.getElementById('semRateio').addEventListener('change', toggleRateio);
    document.getElementById('comRateio').addEventListener('change', toggleRateio);
    document.getElementById('veiculoSearchInput').addEventListener('input', buscarVeiculos);
    document.getElementById('btnGerarParcelas').addEventListener('click', gerarParcelas);

    document.getElementById('quantidadeParcelas').addEventListener('input', function () {
      if (this.value > 36) this.value = 36;
      if (this.value < 1) this.value = 1;
    });

    console.log('Eventos configurados');
  }

  function toggleRateio() {
    const tipoSelecionado = document.querySelector('input[name="tipo_rateio"]:checked').value;
    const containerRateio = document.getElementById('containerRateio');

    if (tipoSelecionado === 'com_rateio') {
      containerRateio.style.display = 'block';
      document.getElementById('rateioValorNota').textContent = formatarMoeda(valorTotalNota);
    } else {
      containerRateio.style.display = 'none';
      veiculosSelecionados.clear();
      document.getElementById('veiculoSearchInput').value = '';
      document.getElementById('veiculoSearchResults').innerHTML = '';
    }
  }

  function configurarFiltros() {
    document.getElementById('searchInput').addEventListener('input', aplicarFiltros);
    document.getElementById('statusFilter').addEventListener('change', aplicarFiltros);
    document.getElementById('empresaFilter').addEventListener('change', aplicarFiltros);
    document.getElementById('startDateFilter').addEventListener('change', aplicarFiltros);
    document.getElementById('endDateFilter').addEventListener('change', aplicarFiltros);
  }

  function gerarParcelas() {
    const quantidadeParcelas = parseInt(document.getElementById('quantidadeParcelas').value);
    const parcelamentoContainer = document.getElementById('parcelamentoContainer');
    const parcelasContainer = document.getElementById('parcelasContainer');

    if (!quantidadeParcelas || quantidadeParcelas < 1 || quantidadeParcelas > 36) {
      mostrarNotificacao('error', 'Quantidade de parcelas deve ser entre 1 e 36');
      return;
    }

    parcelamentoContainer.style.display = 'block';
    parcelasContainer.innerHTML = '';

    const valorPorParcela = valorTotalNota / quantidadeParcelas;

    for (let i = 1; i <= quantidadeParcelas; i++) {
      const parcelaDiv = document.createElement('div');
      parcelaDiv.className = 'parcela-item fade-in';

      const hoje = new Date();
      const dataVencimento = new Date(hoje.getTime() + (i * 30 * 24 * 60 * 60 * 1000));
      const dataFormatada = dataVencimento.toISOString().split('T')[0];

      parcelaDiv.innerHTML = `
        <div class="parcela-numero">${i}</div>
        <div class="parcela-input-group">
          <label>Data de Vencimento</label>
          <input type="date" class="parcela-data" data-parcela="${i}" value="${dataFormatada}" onchange="validarParcelas()">
        </div>
        <div class="parcela-input-group">
          <label>Valor (R$)</label>
          <input type="number" class="parcela-valor" data-parcela="${i}" value="${valorPorParcela.toFixed(2)}" step="0.01" min="0" onchange="validarParcelas()">
        </div>
      `;

      parcelasContainer.appendChild(parcelaDiv);
    }

    atualizarTotalizacao();
    validarParcelas();
  }

  async function buscarVeiculos(event) {
    const searchTerm = event.target.value;
    const resultsContainer = document.getElementById('veiculoSearchResults');

    if (searchTerm.length < 2) {
      resultsContainer.innerHTML = '';
      return;
    }

    try {
      const response = await fetch(`/api/veiculos/search?term=${searchTerm}`);
      const veiculos = await response.json();

      resultsContainer.innerHTML = '';

      const veiculosDisponiveis = veiculos.filter(v => !veiculosSelecionados.has(v.id));

      if (veiculosDisponiveis.length === 0) {
        resultsContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Nenhum veículo encontrado ou todos já foram adicionados</div>';
        return;
      }

      veiculosDisponiveis.forEach(veiculo => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action p-2 border-bottom d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <span>${veiculo.display}</span>
          <small class="text-green-600"><i class="fas fa-plus"></i> Adicionar</small>
        `;
        item.onclick = (e) => {
          e.preventDefault();
          adicionarVeiculoParaRateio(veiculo);
          resultsContainer.innerHTML = '';
          event.target.value = '';
          event.target.focus();
        };
        resultsContainer.appendChild(item);
      });
    } catch (error) {
      console.error("Erro ao buscar veículos:", error);
      const veiculosMock = [
        { id: 1, display: "ABC-1234 - Volvo FH 540" },
        { id: 2, display: "DEF-5678 - Scania R450" },
        { id: 3, display: "GHI-9012 - Mercedes Actros" },
        { id: 4, display: "JKL-3456 - Ford Cargo 816" },
        { id: 5, display: "MNO-7890 - Iveco Daily" }
      ];

      resultsContainer.innerHTML = '';
      const veiculosEncontrados = veiculosMock.filter(v =>
        v.display.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !veiculosSelecionados.has(v.id)
      );

      if (veiculosEncontrados.length === 0) {
        resultsContainer.innerHTML = '<div class="p-2 text-gray-500 text-sm">Nenhum veículo encontrado ou todos já foram adicionados</div>';
        return;
      }

      veiculosEncontrados.forEach(veiculo => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action p-2 border-bottom d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <span>${veiculo.display}</span>
          <small class="text-green-600"><i class="fas fa-plus"></i> Adicionar</small>
        `;
        item.onclick = (e) => {
          e.preventDefault();
          adicionarVeiculoParaRateio(veiculo);
          resultsContainer.innerHTML = '';
          event.target.value = '';
          event.target.focus();
        };
        resultsContainer.appendChild(item);
      });
    }
  }

  function adicionarVeiculoParaRateio(veiculo) {
    if (veiculosSelecionados.has(veiculo.id)) {
      mostrarNotificacao('info', 'Este veículo já foi adicionado ao rateio');
      return;
    }

    const valorInicial = veiculosSelecionados.size === 0 ? valorTotalNota : 0;

    veiculosSelecionados.set(veiculo.id, { ...veiculo, valor: valorInicial });
    renderizarVeiculosRateio();

    const quantidade = veiculosSelecionados.size;

    if (quantidade === 1) {
      mostrarNotificacao('success', 'Primeiro veículo adicionado com valor total da nota');
      setTimeout(() => {
        mostrarNotificacao('info', 'Dica: Adicione mais veículos para ratear a despesa entre eles');
      }, 2000);
    } else {
      mostrarNotificacao('success', `Veículo adicionado! Total: ${quantidade} veículo${quantidade > 1 ? 's' : ''} no rateio`);

      setTimeout(() => {
        const totalAtual = Array.from(veiculosSelecionados.values()).reduce((sum, v) => sum + v.valor, 0);
        if (Math.abs(totalAtual - valorTotalNota) > 0.01) {
          mostrarNotificacao('info', 'Use "Dividir Igual" ou "Ajustar Auto" para distribuir automaticamente');
        }
      }, 1500);
    }
  }

  function removerVeiculoDoRateio(veiculoId) {
    const veiculo = veiculosSelecionados.get(veiculoId);
    if (!veiculo) return;

    if (confirm(`Remover "${veiculo.display}" do rateio?`)) {
      veiculosSelecionados.delete(veiculoId);
      renderizarVeiculosRateio();

      const quantidade = veiculosSelecionados.size;
      mostrarNotificacao('info', `Veículo removido. ${quantidade} veículo${quantidade !== 1 ? 's' : ''} restante${quantidade !== 1 ? 's' : ''}`);
    }
  }

  function renderizarVeiculosRateio() {
    const container = document.getElementById('veiculosRateioContainer');
    const emptyState = document.getElementById('rateioEmpty');
    const controles = document.getElementById('rateioControles');

    const valoresAtuais = new Map();
    document.querySelectorAll('.rateio-valor-input').forEach(input => {
      const veiculoId = parseInt(input.dataset.id);
      valoresAtuais.set(veiculoId, parseFloat(input.value) || 0);
    });

    valoresAtuais.forEach((valor, veiculoId) => {
      if (veiculosSelecionados.has(veiculoId)) {
        veiculosSelecionados.get(veiculoId).valor = valor;
      }
    });

    container.innerHTML = '';

    if (veiculosSelecionados.size === 0) {
      if (emptyState) {
        container.appendChild(emptyState.cloneNode(true));
      }
      controles.style.display = 'none';
    } else {
      controles.style.display = 'flex';

      let index = 1;
      veiculosSelecionados.forEach(veiculo => {
        const percentual = valorTotalNota > 0 ? ((veiculo.valor / valorTotalNota) * 100) : 0;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'veiculo-rateio-item fade-in';
        itemDiv.innerHTML = `
          <div class="veiculo-header">
            <div class="veiculo-numero">${index}</div>
            <div class="veiculo-info">
              <span class="veiculo-nome">${veiculo.display}</span>
              <span class="veiculo-percentual" id="percentual-${veiculo.id}">${percentual.toFixed(1)}%</span>
            </div>
            <button type="button" class="btn-delete-veiculo" data-veiculo-id="${veiculo.id}" title="Remover veículo">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="veiculo-valores">
            <div class="valor-input-group">
              <label>Valor (R$)</label>
              <input type="number"
                     class="rateio-valor-input"
                     data-id="${veiculo.id}"
                     value="${(veiculo.valor || 0).toFixed(2)}"
                     step="0.01"
                     min="0"
                     max="${valorTotalNota}"
                     placeholder="0,00">
            </div>
            <div class="valor-input-group">
              <label>Percentual (%)</label>
              <input type="number"
                     class="rateio-percentual-input"
                     data-id="${veiculo.id}"
                     value="${percentual.toFixed(1)}"
                     step="0.1"
                     min="0"
                     max="100"
                     placeholder="0,0">
            </div>
          </div>
        `;
        container.appendChild(itemDiv);
        index++;
      });

      // Adicionar event listeners aos botões e inputs APÓS criar os elementos
      container.querySelectorAll('.btn-delete-veiculo').forEach(btn => {
        btn.addEventListener('click', function() {
          const veiculoId = parseInt(this.dataset.veiculoId);
          removerVeiculoDoRateio(veiculoId);
        });
      });

      container.querySelectorAll('.rateio-valor-input').forEach(input => {
        input.addEventListener('input', function() {
          const veiculoId = parseInt(this.dataset.id);
          atualizarValorRateio(veiculoId, this.value);
        });
        input.addEventListener('blur', function() {
          validarValorMinimo(this);
        });
      });

      container.querySelectorAll('.rateio-percentual-input').forEach(input => {
        input.addEventListener('input', function() {
          const veiculoId = parseInt(this.dataset.id);
          atualizarPercentualRateio(veiculoId, this.value);
        });
        input.addEventListener('blur', function() {
          validarPercentualMinimo(this);
        });
      });
    }
    atualizarTotalRateio();
  }

  function atualizarValorRateio(veiculoId, valor) {
    const veiculo = veiculosSelecionados.get(veiculoId);
    if (veiculo) {
      veiculo.valor = Math.max(0, Math.min(parseFloat(valor) || 0, valorTotalNota));

      const percentualInput = document.querySelector(`input.rateio-percentual-input[data-id="${veiculoId}"]`);
      if (percentualInput && valorTotalNota > 0) {
        const novoPercentual = (veiculo.valor / valorTotalNota) * 100;
        percentualInput.value = novoPercentual.toFixed(1);

        const percentualBadge = document.getElementById(`percentual-${veiculoId}`);
        if (percentualBadge) {
          percentualBadge.textContent = novoPercentual.toFixed(1) + '%';
        }
      }

      atualizarTotalRateio();
    }
  }

  function atualizarPercentualRateio(veiculoId, percentual) {
    const veiculo = veiculosSelecionados.get(veiculoId);
    if (veiculo && valorTotalNota > 0) {
      const percentualLimitado = Math.max(0, Math.min(parseFloat(percentual) || 0, 100));
      veiculo.valor = (percentualLimitado / 100) * valorTotalNota;

      const valorInput = document.querySelector(`input.rateio-valor-input[data-id="${veiculoId}"]`);
      if (valorInput) {
        valorInput.value = veiculo.valor.toFixed(2);
      }

      const percentualBadge = document.getElementById(`percentual-${veiculoId}`);
      if (percentualBadge) {
        percentualBadge.textContent = percentualLimitado.toFixed(1) + '%';
      }

      atualizarTotalRateio();
    }
  }

  function validarValorMinimo(input) {
    if (parseFloat(input.value) < 0) {
      input.value = "0.00";
      mostrarNotificacao('info', 'Valor não pode ser negativo');
    }
    if (parseFloat(input.value) > valorTotalNota) {
      input.value = valorTotalNota.toFixed(2);
      mostrarNotificacao('info', `Valor não pode exceder ${formatarMoeda(valorTotalNota)}`);
    }
  }

  function validarPercentualMinimo(input) {
    if (parseFloat(input.value) < 0) {
      input.value = "0.0";
      mostrarNotificacao('info', 'Percentual não pode ser negativo');
    }
    if (parseFloat(input.value) > 100) {
      input.value = "100.0";
      mostrarNotificacao('info', 'Percentual não pode exceder 100%');
    }
  }

  function distribuirIgualmente() {
    if (veiculosSelecionados.size === 0) {
      mostrarNotificacao('info', 'Adicione pelo menos um veículo antes de distribuir os valores');
      return;
    }

    const valorPorVeiculo = valorTotalNota / veiculosSelecionados.size;

    veiculosSelecionados.forEach(veiculo => {
      veiculo.valor = valorPorVeiculo;
    });

    document.querySelectorAll('.rateio-valor-input').forEach(input => {
      const veiculoId = parseInt(input.dataset.id);
      if (veiculosSelecionados.has(veiculoId)) {
        input.value = valorPorVeiculo.toFixed(2);
      }
    });

    document.querySelectorAll('.rateio-percentual-input').forEach(input => {
      const veiculoId = parseInt(input.dataset.id);
      if (veiculosSelecionados.has(veiculoId)) {
        input.value = (100 / veiculosSelecionados.size).toFixed(1);
      }
    });

    atualizarTotalRateio();
    mostrarNotificacao('success', `Valor distribuído igualmente: ${formatarMoeda(valorPorVeiculo)} por veículo (${(100 / veiculosSelecionados.size).toFixed(1)}% cada)`);
  }

  function ajustarAutomaticamente() {
    if (veiculosSelecionados.size === 0) {
      mostrarNotificacao('info', 'Adicione veículos primeiro');
      return;
    }

    let totalAtual = 0;
    veiculosSelecionados.forEach(v => totalAtual += v.valor);

    if (totalAtual === 0) {
      distribuirIgualmente();
      return;
    }

    const diferenca = valorTotalNota - totalAtual;

    if (Math.abs(diferenca) <= 0.01) {
      mostrarNotificacao('success', 'Valores já estão corretos!');
      return;
    }

    veiculosSelecionados.forEach(veiculo => {
      if (totalAtual > 0) {
        const proporcao = veiculo.valor / totalAtual;
        veiculo.valor = veiculo.valor + (diferenca * proporcao);
      } else {
        veiculo.valor = valorTotalNota / veiculosSelecionados.size;
      }
      veiculo.valor = Math.max(0, veiculo.valor);
    });

    renderizarVeiculosRateio();

    mostrarNotificacao('success', `Valores ajustados automaticamente! Diferença de ${formatarMoeda(Math.abs(diferenca))} distribuída proporcionalmente`);
  }

  function limparRateio() {
    if (veiculosSelecionados.size === 0) {
      return;
    }

    if (confirm(`Tem certeza que deseja remover todos os ${veiculosSelecionados.size} veículo(s) do rateio?`)) {
      veiculosSelecionados.clear();
      renderizarVeiculosRateio();
      mostrarNotificacao('info', 'Todos os veículos foram removidos do rateio');
    }
  }

  function atualizarTotalRateio() {
    let total = 0;
    const quantidadeVeiculos = veiculosSelecionados.size;

    veiculosSelecionados.forEach(v => total += v.valor);
    const diferenca = total - valorTotalNota;
    const percentualCompleto = valorTotalNota > 0 ? (total / valorTotalNota) * 100 : 0;

    document.getElementById('rateioTotalAlocado').textContent = formatarMoeda(total);
    const diferencaEl = document.getElementById('rateioDiferenca');
    const statusEl = document.getElementById('rateioStatus');
    const progressBar = document.getElementById('rateioProgressFill');

    diferencaEl.textContent = formatarMoeda(Math.abs(diferenca));

    progressBar.style.width = Math.min(percentualCompleto, 100) + '%';

    if (Math.abs(diferenca) <= 0.01) {
      progressBar.style.background = 'linear-gradient(135deg, var(--green-600) 0%, var(--primary-green-light) 100%)';
    } else if (diferenca < 0) {
      progressBar.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
    } else {
      progressBar.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    }

    veiculosSelecionados.forEach(veiculo => {
      const percentualEl = document.getElementById(`percentual-${veiculo.id}`);
      if (percentualEl && valorTotalNota > 0) {
        const percentual = (veiculo.valor / valorTotalNota) * 100;
        percentualEl.textContent = percentual.toFixed(1) + '%';
      }
    });

    if (quantidadeVeiculos === 0) {
      statusEl.innerHTML = '<small class="text-gray-600">Adicione veículos e distribua os valores para confirmar o lançamento</small>';
      document.getElementById('btnSalvarLancamento').disabled = true;
    } else if (Math.abs(diferenca) <= 0.01) {
      diferencaEl.className = 'totalizacao-valor totalizacao-ok';
      statusEl.innerHTML = `
        <small class="text-green-600">
          <i class="fas fa-check-circle"></i>
          Rateio correto entre ${quantidadeVeiculos} veículo(s) - 100% distribuído
        </small>
      `;
      document.getElementById('btnSalvarLancamento').disabled = false;
    } else {
      document.getElementById('btnSalvarLancamento').disabled = true;

      if (diferenca > 0) {
        diferencaEl.className = 'totalizacao-valor totalizacao-diferenca';
        statusEl.innerHTML = `
          <small class="text-red-600">
            <i class="fas fa-exclamation-triangle"></i>
            Valor rateado excede em ${formatarMoeda(diferenca)} (${percentualCompleto.toFixed(1)}%)
            <button type="button" onclick="ajustarAutomaticamente()" class="ml-2 text-xs underline">Ajustar automaticamente</button>
          </small>
        `;
      } else {
        diferencaEl.className = 'totalizacao-valor totalizacao-diferenca';
        const faltante = Math.abs(diferenca);
        statusEl.innerHTML = `
          <small class="text-orange-600">
            <i class="fas fa-exclamation-triangle"></i>
            Faltam ${formatarMoeda(faltante)} para completar (${percentualCompleto.toFixed(1)}% distribuído)
            <button type="button" onclick="ajustarAutomaticamente()" class="ml-2 text-xs underline">Completar automaticamente</button>
          </small>
        `;
      }
    }
  }

  function validarParcelas() {
    const parcelasValor = document.querySelectorAll('.parcela-valor');
    const validationError = document.getElementById('validationError');
    let totalParcelas = 0;

    parcelasValor.forEach(input => {
      const valor = parseFloat(input.value) || 0;
      totalParcelas += valor;
    });

    atualizarTotalizacao();

    const diferenca = Math.abs(totalParcelas - valorTotalNota);
    const tolerancia = 0.01;

    if (diferenca > tolerancia) {
      validationError.classList.add('show');
      document.getElementById('btnSalvarLancamento').disabled = true;
      return false;
    } else {
      validationError.classList.remove('show');
      document.getElementById('btnSalvarLancamento').disabled = false;
      return true;
    }
  }

  function atualizarTotalizacao() {
    const parcelasValor = document.querySelectorAll('.parcela-valor');
    let totalParcelas = 0;

    parcelasValor.forEach(input => {
      const valor = parseFloat(input.value) || 0;
      totalParcelas += valor;
    });

    const diferenca = totalParcelas - valorTotalNota;

    document.getElementById('valorNota').textContent = formatarMoeda(valorTotalNota);
    document.getElementById('totalParcelas').textContent = formatarMoeda(totalParcelas);

    const diferencaElement = document.getElementById('diferencaValor');
    diferencaElement.textContent = formatarMoeda(Math.abs(diferenca));

    if (Math.abs(diferenca) <= 0.01) {
      diferencaElement.className = 'totalizacao-valor totalizacao-ok';
    } else {
      diferencaElement.className = 'totalizacao-valor totalizacao-diferenca';
    }
  }

  function aplicarFiltros() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const empresaFilter = document.getElementById('empresaFilter').value;
    const startDate = document.getElementById('startDateFilter').value;
    const endDate = document.getElementById('endDateFilter').value;

    notasFiltradas = notasData.filter(nota => {
      const matchSearch = !searchTerm ||
        nota.emitente_nome.toLowerCase().includes(searchTerm) ||
        nota.emitente_cnpj.includes(searchTerm) ||
        nota.chave_acesso.includes(searchTerm);

      const matchStatus = !statusFilter || nota.status === statusFilter;
      const matchEmpresa = !empresaFilter || nota.cnpj_consultado === empresaFilter;

      const notaDate = nota.data_emissao.split('T')[0];
      const matchStartDate = !startDate || notaDate >= startDate;
      const matchEndDate = !endDate || notaDate <= endDate;

      return matchSearch && matchStatus && matchEmpresa && matchStartDate && matchEndDate;
    });

    currentPage = 1;
    renderizarTabela();
    renderizarContador();
  }

  function limparFiltros() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('empresaFilter').value = '';
    document.getElementById('startDateFilter').value = '';
    document.getElementById('endDateFilter').value = '';
    aplicarFiltros();
  }

  function renderizarContador() {
    const contador = document.getElementById('contadorNotas');
    const total = notasFiltradas.length;
    if (total > 0) {
      contador.textContent = `(${total} ${total === 1 ? 'nota' : 'notas'})`;
    } else {
      contador.textContent = '(0 notas)';
    }
  }

  function renderizarTabela() {
    console.log('Renderizando tabela...');
    const tbody = document.getElementById('nfeTableBody');
    if (!tbody) {
      console.log('tbody não encontrado');
      return;
    }

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const notasPagina = notasFiltradas.slice(startIndex, endIndex);

    tbody.innerHTML = '';

    const emptyState = document.getElementById('emptyState');
    const tableContainer = document.getElementById('nfeTableContainer');

    if (notasFiltradas.length === 0) {
      if (tableContainer) tableContainer.style.display = 'none';
      if (emptyState) {
        emptyState.style.display = 'block';
        emptyState.querySelector('h3').textContent = 'Nenhuma nota encontrada para os filtros aplicados';
        emptyState.querySelector('p').textContent = 'Tente ajustar sua busca ou limpar os filtros.';
      }
      return;
    }

    if (tableContainer) tableContainer.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';

    notasPagina.forEach((nota, index) => {
      const row = document.createElement('tr');
      row.className = nota.status === 'PROCESSADA' ? 'processed' : '';

      const empresaConsultada = nota.cnpj_consultado || 'N/A';

      row.innerHTML = `
        <td>
          <div class="empresa-badge">
            <i class="fas fa-building"></i>
            ${formatarCNPJ(empresaConsultada)}
          </div>
        </td>
        <td>${nota.emitente_nome}</td>
        <td>${formatarCNPJ(nota.emitente_cnpj)}</td>
        <td>${formatarData(nota.data_emissao)}</td>
        <td class="valor-cell">${formatarMoeda(nota.valor_total)}</td>
        <td>
          <span class="status-badge ${nota.status === 'PROCESSADA' ? 'processado' : 'novo'}">
            ${nota.status === 'PROCESSADA' ? 'Processada' : 'Nova'}
          </span>
        </td>
        <td>
          ${nota.status !== 'PROCESSADA' ? `
            <button class="btn-table btn-launch" data-chave="${nota.chave_acesso}">
              <i class="fas fa-plus"></i>
              Lançar
            </button>
          ` : `
            <button class="btn-table btn-processed" disabled>
              <i class="fas fa-check"></i>
              Processada
            </button>
          `}
          <button class="btn-table btn-view" data-chave="${nota.chave_acesso}">
            <i class="fas fa-eye"></i>
            Ver XML
          </button>
        </td>
        <td>
          <div class="chave-display">${nota.chave_acesso}</div>
        </td>
      `;

      tbody.appendChild(row);
    });

    adicionarEventListenersTabela();
    atualizarPaginacao();
    console.log('Tabela renderizada com', notasPagina.length, 'linhas');
  }

  function adicionarEventListenersTabela() {
    console.log('Adicionando event listeners aos botões...');

    document.querySelectorAll('.btn-launch').forEach(button => {
      button.addEventListener('click', function () {
        const chaveAcesso = this.dataset.chave;
        console.log('Clicou em lançar, chave:', chaveAcesso);
        lancarNota(chaveAcesso);
      });
    });

    document.querySelectorAll('.btn-view').forEach(button => {
      button.addEventListener('click', function () {
        const chaveAcesso = this.dataset.chave;
        console.log('Clicou em ver XML, chave:', chaveAcesso);
        visualizarXML(chaveAcesso);
      });
    });

    console.log('Event listeners adicionados:',
      document.querySelectorAll('.btn-launch').length, 'botões de lançar,',
      document.querySelectorAll('.btn-view').length, 'botões de visualizar');
  }

  function atualizarPaginacao() {
    const totalItens = notasFiltradas.length;
    const totalPaginas = Math.ceil(totalItens / itemsPerPage);

    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, totalItens);

    document.getElementById('paginationInfo').textContent =
      `Mostrando ${startIndex} a ${endIndex} de ${totalItens} ${totalItens === 1 ? 'nota' : 'notas'}`;

    const btnPrev = document.getElementById('btnPrevPage');
    const btnNext = document.getElementById('btnNextPage');

    btnPrev.classList.toggle('disabled', currentPage === 1);
    btnNext.classList.toggle('disabled', currentPage >= totalPaginas);

    const pageNumbers = document.getElementById('pageNumbers');
    pageNumbers.innerHTML = '';

    if (totalPaginas <= 7) {
      for (let i = 1; i <= totalPaginas; i++) {
        criarBotaoPagina(i, pageNumbers);
      }
    } else {
      criarBotaoPagina(1, pageNumbers);

      if (currentPage > 4) {
        pageNumbers.appendChild(criarReticencias());
      }

      let startPage = Math.max(2, currentPage - 1);
      let endPage = Math.min(totalPaginas - 1, currentPage + 1);

      if (currentPage <= 3) {
        startPage = 2;
        endPage = 4;
      }

      if (currentPage >= totalPaginas - 2) {
        startPage = totalPaginas - 3;
        endPage = totalPaginas - 1;
      }

      for (let i = startPage; i <= endPage; i++) {
        criarBotaoPagina(i, pageNumbers);
      }

      if (currentPage < totalPaginas - 3) {
        pageNumbers.appendChild(criarReticencias());
      }

      if (totalPaginas > 1) {
        criarBotaoPagina(totalPaginas, pageNumbers);
      }
    }
  }

  function criarBotaoPagina(pageNum, container) {
    const btn = document.createElement('button');
    btn.className = `pagination-btn ${pageNum === currentPage ? 'active' : ''}`;
    btn.textContent = pageNum;
    btn.onclick = () => irParaPagina(pageNum);
    container.appendChild(btn);
  }

  function criarReticencias() {
    const span = document.createElement('span');
    span.textContent = '...';
    span.style.padding = '8px';
    span.style.color = 'var(--gray-600)';
    return span;
  }

  function irParaPagina(pageNum) {
    currentPage = pageNum;
    renderizarTabela();
  }

  function paginaAnterior() {
    if (currentPage > 1) {
      currentPage--;
      renderizarTabela();
    }
  }

  function proximaPagina() {
    const totalPaginas = Math.ceil(notasFiltradas.length / itemsPerPage);
    if (currentPage < totalPaginas) {
      currentPage++;
      renderizarTabela();
    }
  }

  function alterarItensPorPagina() {
    itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
    currentPage = 1;
    renderizarTabela();
  }

  function formatarChaveAcesso(event) {
    let value = event.target.value.replace(/\D/g, '');
    event.target.value = value;

    const btnLancar = document.getElementById('btnLancarRapido');
    if (value.length === 44) {
      btnLancar.classList.add('pulse');
    } else {
      btnLancar.classList.remove('pulse');
    }
  }

  async function consultarSefaz() {
    const btn = document.getElementById('btnConsultarSefaz');
    const loading = document.getElementById('loadingConsulta');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');

    btn.disabled = true;
    loading.style.display = 'inline-block';
    progressBar.style.display = 'block';

    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += Math.random() * 30;
      if (progress > 90) progress = 90;
      progressFill.style.width = progress + '%';
    }, 500);

    try {
      const response = await fetch('/api/fiscal/consultar_sefaz', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();

      clearInterval(progressInterval);
      progressFill.style.width = '100%';

      setTimeout(() => {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
      }, 1000);

      if (result.success) {
        mostrarNotificacao('success', result.message);
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        mostrarNotificacao('error', result.message);
      }
    } catch (error) {
      clearInterval(progressInterval);
      progressBar.style.display = 'none';
      mostrarNotificacao('error', `Erro de conexão: ${error.message}`);
    } finally {
      btn.disabled = false;
      loading.style.display = 'none';
    }
  }

  async function lancarRapido() {
    const chaveAcesso = document.getElementById('chaveAcessoInput').value.trim();

    if (!chaveAcesso) {
      mostrarNotificacao('error', 'Digite a chave de acesso da NFe');
      return;
    }

    if (chaveAcesso.length !== 44) {
      mostrarNotificacao('error', 'A chave de acesso deve ter exatamente 44 dígitos');
      return;
    }

    const btn = document.getElementById('btnLancarRapido');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
    btn.disabled = true;

    try {
      await buscarDadosNota(chaveAcesso);
    } catch (error) {
      console.error('Erro no lançamento rápido:', error);
      mostrarNotificacao('error', `Erro inesperado: ${error.message}`);
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  async function buscarDadosNota(chaveAcesso) {
    console.log('Buscando dados da nota:', chaveAcesso);

    try {
      const response = await fetch(`/api/fiscal/buscar_dados_nota/${chaveAcesso}`);
      // Tenta ler a resposta da API, seja ela de sucesso ou erro
      const result = await response.json();

      // Se a resposta NÃO for OK (ex: erro 404, 409), exibe a mensagem de erro vinda da API
      if (!response.ok) {
        mostrarNotificacao('error', result.message || 'Ocorreu um erro no servidor.');
        return; // Interrompe a execução para não abrir o modal
      }

      // Se a resposta for OK (código 200), mas o sucesso for falso
      if (!result.success) {
          mostrarNotificacao('error', result.message || 'Resposta inesperada do servidor.');
          return; // Interrompe a execução
      }

      // Se tudo correu bem, abre o modal de lançamento
      abrirModalLancamento(result.nota, chaveAcesso);

    } catch (error) {
      // Este bloco agora só será ativado em caso de erro de rede (API offline)
      console.error('Erro de conexão ou de parsing na resposta:', error);
      mostrarNotificacao('error', 'Não foi possível conectar ao servidor para verificar a nota.');
    }
  }


  function abrirModalLancamento(dadosNota, chaveAcesso) {
    console.log('Abrindo modal para a nota:', dadosNota);
    const modal = document.getElementById('modalLancamento');
    const dadosContainer = document.getElementById('dadosNota');

    valorTotalNota = parseFloat(dadosNota.valor_total);

    dadosContainer.innerHTML = `
      <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
        <h4 style="color: #1b5e20; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-file-invoice"></i>
          Dados da Nota Fiscal
        </h4>
        <div style="display: grid; gap: 12px;">
          <div class="detail-row">
            <span class="detail-label">Emitente:</span>
            <span class="detail-value">${dadosNota.emitente_nome}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">CNPJ:</span>
            <span class="detail-value">${formatarCNPJ(dadosNota.emitente_cnpj)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Data de Emissão:</span>
            <span class="detail-value">${formatarData(dadosNota.data_emissao)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Valor Total:</span>
            <span class="detail-value valor-destaque">${formatarMoeda(dadosNota.valor_total)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Chave de Acesso:</span>
            <span class="detail-value" style="font-family: monospace; font-size: 12px;">${chaveAcesso}</span>
          </div>
        </div>
      </div>
    `;

    document.getElementById('categoriaLancamento').value = 'Fornecedores (NFe)';
    document.getElementById('quantidadeParcelas').value = '1';
    document.getElementById('semRateio').checked = true;

    document.getElementById('parcelamentoContainer').style.display = 'none';
    document.getElementById('parcelasContainer').innerHTML = '';
    document.getElementById('containerRateio').style.display = 'none';
    document.getElementById('validationError').classList.remove('show');

    veiculosSelecionados.clear();
    document.getElementById('veiculoSearchInput').value = '';
    document.getElementById('veiculoSearchResults').innerHTML = '';

    modal.dataset.chaveAcesso = chaveAcesso;
    modal.dataset.dadosNota = JSON.stringify(dadosNota);

    toggleRateio();

    modal.style.display = 'block';
    document.getElementById('chaveAcessoInput').value = '';
  }

  async function salvarLancamento() {
    const modal = document.getElementById('modalLancamento');
    const chaveAcesso = modal.dataset.chaveAcesso;
    const categoria = document.getElementById('categoriaLancamento').value;
    const tipoRateio = document.querySelector('input[name="tipo_rateio"]:checked')?.value;
    const btn = document.getElementById('btnSalvarLancamento');
    const loading = document.getElementById('loadingSalvar');

    let parcelas = [];

    if (!categoria) {
      mostrarNotificacao('error', 'Selecione a categoria da despesa');
      return;
    }

    const parcelasData = document.querySelectorAll('.parcela-data');
    const parcelasValor = document.querySelectorAll('.parcela-valor');

    if (parcelasData.length === 0) {
      mostrarNotificacao('error', 'Configure as parcelas do pagamento');
      return;
    }

    if (!validarParcelas()) {
      mostrarNotificacao('error', 'O valor total das parcelas não confere com o valor da nota');
      return;
    }

    let datasValidas = true;
    parcelasData.forEach(input => {
      if (!input.value) datasValidas = false;
    });

    if (!datasValidas) {
      mostrarNotificacao('error', 'Todas as parcelas devem ter data de vencimento');
      return;
    }

    if (tipoRateio === 'com_rateio') {
      if (veiculosSelecionados.size === 0) {
        mostrarNotificacao('error', 'Selecione pelo menos um veículo para o rateio');
        return;
      }
      let totalRateio = 0;
      veiculosSelecionados.forEach(v => totalRateio += v.valor);
      if (Math.abs(totalRateio - valorTotalNota) > 0.01) {
        mostrarNotificacao('error', 'O valor total do rateio não confere com o valor da nota');
        return;
      }
    }

    btn.disabled = true;
    loading.style.display = 'inline-block';

    try {
      for (let i = 0; i < parcelasData.length; i++) {
        parcelas.push({
          data_vencimento: parcelasData[i].value,
          valor: parseFloat(parcelasValor[i].value) || 0
        });
      }

      const unidadeNegocioId = document.getElementById('unidadeNegocioLancamento').value;

      let payload = {
        chave_acesso: chaveAcesso,
        categoria: categoria,
        parcelas: parcelas,
        tem_rateio: tipoRateio === 'com_rateio',
        unidade_negocio_id: unidadeNegocioId
      };

      // IMPORTANTE: Enviar os veículos como um array de rateios
      // O backend deve criar UM lançamento com MÚLTIPLOS rateios associados
      if (tipoRateio === 'com_rateio') {
        payload.rateios = Array.from(veiculosSelecionados.values()).map(v => ({
          veiculo_id: v.id,
          valor: v.valor,
          percentual: (v.valor / valorTotalNota) * 100
        }));

        console.log('Payload com rateio:', JSON.stringify(payload, null, 2));
        console.log(`Enviando 1 lançamento com ${payload.rateios.length} rateios de veículos`);
      } else {
        console.log('Payload sem rateio:', JSON.stringify(payload, null, 2));
      }

      const response = await fetch('/api/fiscal/salvar_lancamento', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorResult = await response.json();
        throw new Error(errorResult.message || `Erro ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        let mensagem = 'Lançamento criado com sucesso! ';
        if (tipoRateio === 'com_rateio') {
          mensagem += `${parcelas.length} parcela(s) com rateio entre ${veiculosSelecionados.size} veículo(s).`;
        } else {
          mensagem += `${parcelas.length} parcela(s) de pagamento gerada(s).`;
        }
        mostrarNotificacao('success', mensagem);
        fecharModal();
        setTimeout(() => { window.location.reload(); }, 2000);
      } else {
        mostrarNotificacao('error', result.message);
      }
    } catch (error) {
      console.error('Erro ao salvar lançamento:', error);
      mostrarNotificacao('error', `Erro ao salvar: ${error.message}`);
    } finally {
      btn.disabled = false;
      loading.style.display = 'none';
    }
  }

  function fecharModal() {
    const modal = document.getElementById('modalLancamento');
    modal.style.display = 'none';

    document.getElementById('dadosNota').innerHTML = '';

    document.getElementById('categoriaLancamento').value = 'Fornecedores (NFe)';
    document.getElementById('quantidadeParcelas').value = '1';
    document.getElementById('semRateio').checked = true;

    document.getElementById('parcelamentoContainer').style.display = 'none';
    document.getElementById('parcelasContainer').innerHTML = '';
    document.getElementById('validationError').classList.remove('show');

    document.getElementById('containerRateio').style.display = 'none';
    veiculosSelecionados.clear();
    document.getElementById('veiculoSearchInput').value = '';
    document.getElementById('veiculoSearchResults').innerHTML = '';

    valorTotalNota = 0;
    delete modal.dataset.chaveAcesso;
    delete modal.dataset.dadosNota;

    document.getElementById('btnSalvarLancamento').disabled = false;
  }

  async function lancarNota(chaveAcesso) {
    console.log('Clicou em lançar nota:', chaveAcesso);

    if (!chaveAcesso || chaveAcesso.length !== 44) {
      mostrarNotificacao('error', 'Chave de acesso inválida');
      return;
    }

    const btn = document.querySelector(`button[data-chave="${chaveAcesso}"]`);
    if (btn) {
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
      btn.disabled = true;

      try {
        await buscarDadosNota(chaveAcesso);
      } catch (error) {
        console.error('Erro ao lançar nota:', error);
        mostrarNotificacao('error', 'Erro ao carregar dados da nota');

        setTimeout(() => {
          mostrarNotificacao('info', 'Tentando com dados básicos...');
          const dadosBasicos = {
            chave_acesso: chaveAcesso,
            emitente_nome: 'Fornecedor da Nota',
            emitente_cnpj: '00.000.000/0000-00',
            valor_total: 1000.00,
            data_emissao: new Date().toISOString()
          };
          abrirModalLancamento(dadosBasicos, chaveAcesso);
        }, 1000);
      } finally {
        setTimeout(() => {
          if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        }, 1000);
      }
    } else {
      await buscarDadosNota(chaveAcesso);
    }
  }

  function visualizarXML(chaveAcesso) {
    console.log('Visualizando XML:', chaveAcesso);
    window.open(`/fiscal/xml/${chaveAcesso}`, '_blank');
  }

  function atualizarEstatisticas() {
    const totalNotas = notasData.length;
    const notasProcessadas = notasData.filter(n => n.status === 'PROCESSADA').length;
    const valorTotal = notasData.reduce((sum, nota) => sum + parseFloat(nota.valor_total), 0);

    document.getElementById('totalNotas').textContent = totalNotas;
    document.getElementById('notasProcessadas').textContent = notasProcessadas;
    document.getElementById('valorTotal').textContent = formatarMoeda(valorTotal);
  }

  async function exportarDocumentos() {
    const btn = document.getElementById('btnExportarDocumentos');
    const loading = document.getElementById('loadingExportar');
    const tipoExportacao = document.getElementById('tipoExportacao').value;

    let notasParaExportar = [];
    if (tipoExportacao === 'processadas') {
      notasParaExportar = notasFiltradas.filter(nota => nota.status === 'PROCESSADA');
    }

    else if (tipoExportacao === 'nao_lancadas') {
      notasParaExportar = notasFiltradas.filter(nota => nota.status === 'BAIXADA');

    }


    else {
      notasParaExportar = [...notasFiltradas];
    }

    if (notasParaExportar.length === 0) {
      mostrarNotificacao('info', 'Nenhuma nota para exportar com os critérios selecionados.');
      return;
    }

    const chavesAcesso = notasParaExportar.map(nota => nota.chave_acesso);

    btn.disabled = true;
    loading.style.display = 'inline-block';

    try {
      const response = await fetch('/api/fiscal/exportar_documentos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ chaves_acesso: chavesAcesso })
      });

      if (response.ok) {
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = downloadUrl;

        const disposition = response.headers.get('Content-Disposition');
        let filename = 'Exportacao_Contabil.zip';
        if (disposition && disposition.indexOf('attachment') !== -1) {
          const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
          const matches = filenameRegex.exec(disposition);
          if (matches != null && matches[1]) {
            filename = matches[1].replace(/['"]/g, '');
          }
        }
        a.download = filename;

        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(downloadUrl);
        a.remove();

        mostrarNotificacao('success', `Exportação de ${chavesAcesso.length} documento(s) concluída!`);
      } else {
        const result = await response.json();
        mostrarNotificacao('error', `Erro na exportação: ${result.message}`);
      }

    } catch (error) {
      mostrarNotificacao('error', `Erro de conexão ao exportar: ${error.message}`);
    } finally {
      btn.disabled = false;
      loading.style.display = 'none';
    }
  }

  function formatarCNPJ(cnpj) {
    if (!cnpj) return '';
    return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
  }

  function formatarData(dataString) {
    const data = new Date(dataString);
    const dataCorrigida = new Date(data.valueOf() + data.getTimezoneOffset() * 60000);
    return dataCorrigida.toLocaleDateString('pt-BR');
  }

  function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(valor);
  }

  window.onclick = function (event) {
    const modal = document.getElementById('modalLancamento');
    if (event.target === modal) {
      fecharModal();
    }
  }

  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') {
      fecharModal();
    }
  });
</script>
{% endblock %}
