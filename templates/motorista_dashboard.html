{% extends "base.html" %}
{% block title %}Dashboard do Motorista{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map { 
        height: 450px; 
        width: 100%; 
        border-radius: 1rem; 
        box-shadow: 0 10px 25px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); 
    }
    
    .glass-effect {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .floating-card {
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .floating-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
    }
    
    .pulse-indicator {
        animation: pulse-glow 2s infinite;
    }
    
    @keyframes pulse-glow {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .progress-ring {
        transition: stroke-dasharray 0.5s ease-in-out;
    }

    .status-indicator {
        position: relative;
    }
    
    .status-indicator::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
        animation: pulse-dot 2s infinite;
    }
    
    @keyframes pulse-dot {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .modal-input {
        background-color: #f3f4f6; 
        border: 1px solid #d1d5db; 
        border-radius: 0.375rem;
        padding: 0.75rem; 
        width: 100%; 
        margin-top: 0.25rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .modal-input:focus {
        outline: 2px solid transparent; 
        outline-offset: 2px;
        border-color: #2563eb; 
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <!-- Header -->
    <div class="glass-effect shadow-lg border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="status-indicator">
                        <div class="h-12 w-12 bg-gradient-to-r from-green-400 to-green-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-lg"></i>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800">Olá, <span class="text-green-600">{{ current_user.nome }}</span>!</h1>
                        <p class="text-sm text-slate-500">Status: 
                            {% if viagem_ativa %}
                            <span class="text-green-600 font-medium">Em viagem ativa</span>
                            {% else %}
                            <span class="text-blue-600 font-medium">Disponível</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden sm:flex items-center space-x-2 text-sm text-slate-600">
                        <i class="fas fa-clock"></i>
                        <span id="current-time"></span>
                    </div>
                    <a href="{{ url_for('logout') }}" class="text-slate-600 hover:text-red-600 transition-colors flex items-center space-x-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">Sair</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
        <!-- Page Title -->
        <div class="text-center">
            <h2 class="text-3xl font-extrabold text-slate-800 mb-2">
                <i class="fas fa-tachometer-alt text-blue-600 mr-3"></i>
                Meu Dashboard
            </h2>
            <p class="text-slate-600">Gerencie sua viagem e acompanhe suas atividades</p>
        </div>

        <!-- Active Trip Section -->
        {% if viagem_ativa %}
        <div id="active-trip-section" class="space-y-6">
            <!-- Map Card -->
            <div class="floating-card bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="pulse-indicator h-3 w-3 bg-green-400 rounded-full"></div>
                            <h3 class="text-xl font-bold text-white">Viagem em Andamento</h3>
                        </div>
                        <div class="text-white text-sm">
                            Iniciada às {{ viagem_ativa.data_inicio.strftime('%H:%M') if viagem_ativa.data_inicio }}
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="map" data-route-geometry="{{ viagem_ativa.route_geometry }}" class="relative">
                        <button id="recenter-map-btn" class="absolute bottom-4 right-4 z-[1000] bg-white p-3 rounded-full shadow-lg text-blue-600 hover:bg-blue-50 transition-all duration-300 hover:scale-110">
                            <i class="fas fa-crosshairs fa-lg"></i>
                        </button>
                        <div class="absolute top-4 left-4 z-[1000] glass-effect px-3 py-2 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <div class="h-2 w-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-sm font-medium text-slate-700">Rastreamento ativo</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trip Details Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Trip Information -->
                <div class="lg:col-span-2 floating-card bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <i class="fas fa-route text-blue-600 mr-2"></i>
                        Detalhes da Viagem
                    </h4>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div>
                                <p class="text-sm text-slate-500">Cliente</p>
                                <p class="text-lg font-semibold text-slate-800">{{ viagem_ativa.cliente }}</p>
                            </div>
                            <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-building text-blue-600"></i>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-start space-x-3">
                                <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-flag-checkered text-green-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-600">Origem</p>
                                    <p class="text-slate-800">{{ viagem_ativa.endereco_saida }}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3">
                                <div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-map-marker-alt text-blue-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-600">Destinos</p>
                                    <ol class="list-decimal list-inside mt-1 space-y-1">
                                        {% for destino in viagem_ativa.destinos|sort(attribute='ordem') %}
                                            <li class="text-slate-800">{{ destino.endereco }}</li>
                                        {% endfor %}
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="floating-card bg-white p-6 rounded-2xl shadow-lg">
                    <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                        <i class="fas fa-chart-line text-green-600 mr-2"></i>
                        Status
                    </h4>
                    
                    <div class="space-y-4">
                        <div id="location-display" class="text-sm text-slate-600 flex items-center space-x-2">
                            <img src="{{ url_for('static', filename='11188726.gif') }}" alt="Rastreamento" class="h-6">
                            <span>Iniciando rastreamento...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trip Actions -->
            <div class="space-y-4">
                <h3 class="text-xl font-semibold text-slate-800">Ações da Viagem</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button data-open-modal="abastecimentoModal" class="floating-card bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg flex items-center justify-center space-x-3 transition-all duration-300">
                        <i class="fas fa-gas-pump text-xl"></i>
                        <span>Abastecimento</span>
                    </button>
                    
                    <button data-open-modal="despesaModal" class="floating-card bg-slate-600 hover:bg-slate-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg flex items-center justify-center space-x-3 transition-all duration-300">
                        <i class="fas fa-file-invoice-dollar text-xl"></i>
                        <span>Despesas</span>
                    </button>
                </div>

                <button id="finish-trip-btn" class="w-full floating-card bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 rounded-xl shadow-xl flex items-center justify-center space-x-3 text-lg transition-all duration-300">
                    <i class="fas fa-flag-checkered text-xl"></i>
                    <span>Concluir Viagem</span>
                </button>
            </div>
        </div>
        {% else %}
        <!-- Pending Trips Section -->
        <div id="pending-trips-section">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-3">
                <i class="fas fa-clock text-blue-600"></i> 
                Viagens Pendentes
            </h2>
            <div id="pending-trips-list" class="space-y-4">
                <p class="text-center text-gray-500 py-8">Buscando viagens...</p>
            </div>
        </div>
        {% endif %}

        <!-- History Section -->
        <div id="history-section" class="floating-card bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-slate-50 to-slate-100 px-6 py-4 border-b">
                <h2 class="text-xl font-bold text-slate-800 flex items-center">
                    <i class="fas fa-history text-slate-600 mr-3"></i>
                    Histórico de Viagens
                </h2>
            </div>
            
            <div class="p-6">
                <div class="space-y-3">
                    {% for v in viagens %}
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                        <div class="flex items-center space-x-4">
                            <div class="h-10 w-10 {% if v.status == 'concluida' %}bg-green-100{% else %}bg-red-100{% endif %} rounded-full flex items-center justify-center">
                                {% if v.status == 'concluida' %}
                                    <i class="fas fa-check text-green-600"></i>
                                {% else %}
                                    <i class="fas fa-times text-red-600"></i>
                                {% endif %}
                            </div>
                            <div>
                                <p class="font-semibold text-slate-800">{{ v.cliente }}</p>
                                <p class="text-sm text-slate-500">{{ v.data_inicio.strftime('%d/%m/%Y') if v.data_inicio }} • {{ v.cidade_origem }} → {{ v.cidade_destino }}</p>
                            </div>
                        </div>
                        <span class="px-3 py-1 text-xs font-semibold rounded-full capitalize 
                            {% if v.status == 'concluida' %}bg-green-100 text-green-800
                            {% elif v.status == 'cancelada' %}bg-red-100 text-red-800
                            {% else %}bg-blue-100 text-blue-700{% endif %}">
                            {{ v.status }}
                        </span>
                    </div>
                    {% else %}
                    <p class="text-center text-gray-500 py-8">Nenhuma viagem no histórico.</p>
                    {% endfor %}
                </div>
                
                <div class="text-center mt-6">
                    <button class="text-blue-600 hover:text-blue-800 font-medium flex items-center space-x-2 mx-auto">
                        <span>Ver mais viagens</span>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Odometer Modal -->
    <div id="odometerModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h3 id="odometerModalTitle" class="text-xl font-bold mb-4 text-slate-800">Registrar Quilometragem</h3>
            <form id="odometerForm">
                <label for="odometer_km" class="block text-sm font-medium text-gray-700">Odômetro Atual (KM)</label>
                <input id="odometer_km" name="odometer_km" type="number" step="1" required class="modal-input">
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" data-close-button class="bg-gray-200 text-gray-800 font-bold px-4 py-2 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-bold px-4 py-2 rounded-md hover:bg-green-700">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="despesaModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Lançar Despesas da Viagem</h3>
                <button data-close-button class="text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <form id="despesaForm" enctype="multipart/form-data">
                <input type="hidden" name="viagem_id" value="{{ viagem_ativa.id if viagem_ativa }}">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pedágios (R$)</label>
                        <input type="number" step="0.01" name="pedagios" class="modal-input" placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Alimentação (R$)</label>
                        <input type="number" step="0.01" name="alimentacao" class="modal-input" placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hospedagem (R$)</label>
                        <input type="number" step="0.01" name="hospedagem" class="modal-input" placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Outros Gastos (R$)</label>
                        <input type="number" step="0.01" name="outros" class="modal-input" placeholder="0,00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Descrição dos Outros Gastos</label>
                        <textarea name="descricao_outros" rows="2" class="modal-input" placeholder="Ex: Manutenção leve, pernoite..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Anexar Comprovantes</label>
                        <input name="anexos_despesa" type="file" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" data-close-button class="bg-gray-200 text-gray-800 font-bold px-4 py-2 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-slate-600 text-white font-bold px-4 py-2 rounded-md hover:bg-slate-700 w-36 text-center">Salvar Despesas</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Fuel Modal -->
    <div id="abastecimentoModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Registrar Abastecimento</h3>
                <button data-close-button class="text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
            </div>
            <form id="abastecimentoForm" enctype="multipart/form-data">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Litros</label>
                            <input id="fuel-litros" type="number" step="0.01" name="litros" required class="modal-input" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Preço por Litro (R$)</label>
                            <input id="fuel-preco_litro" type="number" step="0.01" name="preco_por_litro" required class="modal-input" placeholder="0.00">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Custo Total (R$)</label>
                            <input id="fuel-custo_total" type="text" readonly class="modal-input bg-gray-200 cursor-not-allowed" placeholder="Automático">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Odômetro (KM)</label>
                            <input type="number" step="1" id="fuel-odometro" name="odometro" required class="modal-input">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Anexar Comprovante</label>
                        <input name="anexo_comprovante" type="file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" data-close-button class="bg-gray-200 text-gray-800 font-bold px-4 py-2 rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold px-4 py-2 rounded-md hover:bg-blue-700 w-32 text-center">Registrar</button>
                </div>
            </form>
        </div>
    </div>
</body>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    // === GLOBAL VARIABLES ===
    const VIAGEM_ATIVA_ID = {{ viagem_ativa.id if viagem_ativa else 'null' }};
    const DESTINOS_VIAGEM_ATIVA = {{ destinos_viagem_ativa|tojson if destinos_viagem_ativa else '[]' }};
    
    // Map state variables
    let map = null;
    let driverMarker = null;
    let autoRecenter = true; // Auto-center enabled by default

    // === UTILITY FUNCTIONS ===
    const showToast = (msg, type = 'info') => {
        const colors = {
            success: 'linear-gradient(to right, #16a34a, #6ee7b7)',
            error: 'linear-gradient(to right, #dc2626, #fb7185)',
            info: 'linear-gradient(to right, #2563eb, #60a5fa)'
        };
        Toastify({ 
            text: msg, 
            duration: 4000, 
            gravity: 'top', 
            position: 'center', 
            style: { background: colors[type] } 
        }).showToast();
    };

    function openModal(modalId) { 
        document.getElementById(modalId)?.classList.remove('hidden'); 
    }
    
    function closeModal(modalId) { 
        document.getElementById(modalId)?.classList.add('hidden'); 
    }
    
    // === MAIN INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', () => {
        // Real-time clock
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const timeEl = document.getElementById('current-time');
            if(timeEl) timeEl.textContent = timeString;
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Initialize appropriate section
        if (VIAGEM_ATIVA_ID) {
            initializeActiveTripMap();
            startRealTimeTracking();
        } else {
            loadPendingTrips();
        }
        
        // Event listeners
        document.getElementById('odometerForm')?.addEventListener('submit', handleOdometerSubmit);
        document.getElementById('despesaForm')?.addEventListener('submit', handleExpenseSubmit);
        document.getElementById('abastecimentoForm')?.addEventListener('submit', handleFuelSubmit);
        
        document.querySelectorAll('[data-open-modal]').forEach(button => 
            button.addEventListener('click', () => openModalWithData(button.dataset.openModal))
        );
        
        document.getElementById('finish-trip-btn')?.addEventListener('click', () => 
            handleFinishTripClick(VIAGEM_ATIVA_ID)
        );
        
        document.querySelectorAll('[data-close-button]').forEach(button => 
            button.addEventListener('click', () => closeModal(button.closest('.fixed').id))
        );
        
        document.querySelectorAll('.fixed.inset-0').forEach(modal => 
            modal.addEventListener('click', e => { 
                if (e.target === modal) closeModal(modal.id); 
            })
        );
        
        document.getElementById('fuel-litros')?.addEventListener('input', updateFuelCost);
        document.getElementById('fuel-preco_litro')?.addEventListener('input', updateFuelCost);
    });

    // === MAP FUNCTIONS ===
    function initializeActiveTripMap() {
        const mapElement = document.getElementById('map');
        if (!mapElement) return;

        // Recenter button functionality
        document.getElementById('recenter-map-btn')?.addEventListener('click', () => {
            autoRecenter = !autoRecenter;
            const btn = document.getElementById('recenter-map-btn');
            btn.classList.toggle('text-blue-600', autoRecenter);
            btn.classList.toggle('text-slate-600', !autoRecenter);
            showToast(`Centralização automática ${autoRecenter ? 'ativada' : 'desativada'}.`, 'info');
            if (autoRecenter && driverMarker) {
                map.panTo(driverMarker.getLatLng());
            }
        });

        // Initialize map
        const routeGeometry = mapElement.dataset.routeGeometry;
        map = L.map('map').setView([-25.4284, -49.2733], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Driver icon
        const driverIcon = L.icon({
            iconUrl: "{{ url_for('static', filename='localizacaoanimado.gif') }}",
            iconSize: [40, 40],
            iconAnchor: [20, 40],
        });

        // Draw route if available
        if (routeGeometry) {
            try {
                const decodedRoute = polyline.decode(routeGeometry);
                const routeLine = L.polyline(decodedRoute, { 
                    color: '#0055ff', 
                    weight: 5 
                }).addTo(map);
                map.fitBounds(routeLine.getBounds().pad(0.1));
                
                // Origin marker
                L.marker(decodedRoute[0]).addTo(map)
                    .bindPopup("<b>Origem</b>").openPopup();
                
                // Destination markers
                DESTINOS_VIAGEM_ATIVA.forEach((destino, index) => {
                    if (destino.latitude && destino.longitude) {
                        const isLast = index === DESTINOS_VIAGEM_ATIVA.length - 1;
                        const label = isLast ? 'Destino Final' : `Parada ${index + 1}`;
                        L.marker([destino.latitude, destino.longitude])
                            .addTo(map)
                            .bindPopup(`<b>${label}:</b><br>${destino.endereco}`);
                    }
                });
            } catch (e) { 
                console.error("Erro ao decodificar rota:", e); 
            }
        }
        
        // Real-time driver location tracking
        navigator.geolocation.watchPosition(
            position => {
                const { latitude, longitude } = position.coords;
                const latLng = [latitude, longitude];

                if (!driverMarker) {
                    driverMarker = L.marker(latLng, { icon: driverIcon })
                        .addTo(map)
                        .bindPopup("Você está aqui!");
                    map.setView(latLng, 16);
                } else {
                    driverMarker.setLatLng(latLng);
                }
                
                if (autoRecenter) {
                    map.panTo(latLng);
                }
            },
            () => {
                showToast('Não foi possível obter a sua localização para o mapa.', 'error');
            },
            { enableHighAccuracy: true }
        );
    }

    // === REAL-TIME TRACKING ===
    function startRealTimeTracking() {
        const socket = io();
        const locationDisplay = document.getElementById('location-display');
        
        socket.emit('join_trip_room', { viagem_id: VIAGEM_ATIVA_ID });
        
        socket.on('localizacao_atualizada', data => {
            if (data.viagem_id === VIAGEM_ATIVA_ID && data.endereco) {
                locationDisplay.innerHTML = `<img src="{{ url_for('static', filename='11188726.gif') }}" alt="Rastreamento" class="h-6"> <span>${data.endereco}</span>`;
            }
        });

        const sendPosition = () => {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    // Update display with coordinates immediately
                    locationDisplay.innerHTML = `<img src="{{ url_for('static', filename='11188726.gif') }}" alt="Rastreamento" class="h-6"> <span>Rastreando: ${lat}, ${lng}</span>`;
                    
                    // Send to backend
                    socket.emit('atualizar_localizacao_socket', { 
                        viagem_id: VIAGEM_ATIVA_ID, 
                        latitude: position.coords.latitude, 
                        longitude: position.coords.longitude 
                    });
                },
                (error) => {
                    locationDisplay.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500"></i> <span>Erro ao obter localização</span>`;
                    console.error('Erro de geolocalização:', error);
                }
            );
        };
        
        sendPosition();
        setInterval(sendPosition, 30000); // Send every 30 seconds
        showToast('Rastreamento da viagem iniciado.', 'info');
    }

    // === MODAL FUNCTIONS ===
    async function openModalWithData(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const form = modal.querySelector('form');
        if (form) form.reset();
        openModal(modalId);
        
        if (!VIAGEM_ATIVA_ID) return;
        
        // Load existing data for expense modal
        if (modalId === 'despesaModal') {
            try {
                const response = await fetch(`/api/viagem/${VIAGEM_ATIVA_ID}/despesas`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        form.elements['pedagios'].value = data.pedagios || '';
                        form.elements['alimentacao'].value = data.alimentacao || '';
                        form.elements['hospedagem'].value = data.hospedagem || '';
                        form.elements['outros'].value = data.outros || '';
                        form.elements['descricao_outros'].value = data.descricao_outros || '';
                    }
                }
            } catch (e) {
                console.log('Erro ao carregar despesas:', e);
            }
        } 
        // Load existing data for fuel modal
        else if (modalId === 'abastecimentoModal') {
            try {
                const response = await fetch(`/api/viagem/${VIAGEM_ATIVA_ID}/abastecimentos`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        form.elements['litros'].value = data.litros || '';
                        form.elements['preco_por_litro'].value = data.preco_por_litro || '';
                        form.elements['odometro'].value = data.odometro || '';
                        updateFuelCost();
                    }
                }
            } catch (e) {
                console.log('Erro ao carregar abastecimentos:', e);
            }
        }
    }
    
    // === PENDING TRIPS ===
    async function loadPendingTrips() {
        const list = document.getElementById('pending-trips-list');
        try {
            const response = await fetch("{{ url_for('viagens_pendentes') }}");
            const data = await response.json();
            
            if (data.success && data.viagens.length) {
                list.innerHTML = data.viagens.map(v => {
                    const destinosHtml = v.destinos.map(d => `<li>${d}</li>`).join('') || 
                                        `<li>${v.endereco_destino || 'N/A'}</li>`;
                    return `
                    <div class="bg-white p-4 rounded-xl shadow-lg space-y-3 floating-card">
                        <p class="font-bold text-lg text-slate-800">${v.cliente}</p>
                        <div class="text-sm">
                            <p class="font-semibold">De: <span class="font-normal">${v.endereco_saida}</span></p>
                            <p class="font-semibold mt-1">Para:</p>
                            <ul class="list-disc list-inside ml-4 font-normal">${destinosHtml}</ul>
                        </div>
                        <button onclick="handleStartTripClick(${v.id})" 
                                class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md text-lg transition-all duration-300">
                            Iniciar Viagem
                        </button>
                    </div>`;
                }).join('');
            } else {
                list.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhuma viagem pendente.</p>';
            }
        } catch (e) { 
            list.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao carregar viagens.</p>'; 
        }
    }

    // === TRIP ACTIONS ===
    function handleStartTripClick(tripId) {
        const modal = document.getElementById('odometerModal');
        const form = modal.querySelector('form');
        form.reset();
        form.dataset.actionType = 'start';
        form.dataset.tripId = tripId;
        modal.querySelector('#odometerModalTitle').innerText = 'KM Inicial da Viagem';
        openModal('odometerModal');
        document.getElementById('odometer_km').focus();
    }

    function handleFinishTripClick(tripId) {
        const modal = document.getElementById('odometerModal');
        const form = modal.querySelector('form');
        form.reset();
        form.dataset.actionType = 'finish';
        form.dataset.tripId = tripId;
        modal.querySelector('#odometerModalTitle').innerText = 'KM Final da Viagem';
        openModal('odometerModal');
        document.getElementById('odometer_km').focus();
    }

    async function handleOdometerSubmit(event) {
        event.preventDefault();
        const { actionType, tripId } = event.target.dataset;
        const odometer = document.getElementById('odometer_km').value;
        
        if (!odometer || odometer.trim() === '' || isNaN(parseFloat(odometer)) || parseFloat(odometer) < 0) {
            return showToast('Por favor, informe uma quilometragem numérica e válida.', 'error');
        }
        
        closeModal('odometerModal');
        
        const url = actionType === 'start' 
            ? `/viagem/${tripId}/iniciar` 
            : `/viagem/${tripId}/finalizar`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ odometer: parseFloat(odometer) })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                showToast(data.message, 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(data.message || 'Ocorreu um erro desconhecido.', 'error');
            }
        } catch (e) { 
            showToast('Erro de comunicação. Verifique sua conexão.', 'error'); 
        }
    }

    // === FUEL FUNCTIONS ===
    function updateFuelCost() {
        const litros = parseFloat(document.getElementById('fuel-litros')?.value) || 0;
        const preco = parseFloat(document.getElementById('fuel-preco_litro')?.value) || 0;
        const custoTotalEl = document.getElementById('fuel-custo_total');
        if (custoTotalEl) custoTotalEl.value = (litros * preco).toFixed(2);
    }

    async function handleFuelSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
        
        try {
            const response = await fetch("{{ url_for('registrar_abastecimento') }}", { 
                method: 'POST', 
                body: formData 
            });
            
            const data = await response.json();
            showToast(data.message, data.success ? 'success' : 'error');
            
            if (data.success) { 
                closeModal('abastecimentoModal'); 
                form.reset(); 
            }
        } catch (e) {
            showToast('Erro ao enviar dados de abastecimento.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Registrar';
        }
    }

    // === EXPENSE FUNCTIONS ===
    async function handleExpenseSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
        
        try {
            const response = await fetch("{{ url_for('salvar_custo_viagem') }}", { 
                method: 'POST', 
                body: formData 
            });
            
            const data = await response.json();
            showToast(data.message, data.success ? 'success' : 'error');
            
            if (data.success) { 
                closeModal('despesaModal'); 
            }
        } catch (e) {
            showToast('Erro ao enviar despesas.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Salvar Despesas';
        }
    }

    // === GLOBAL FUNCTIONS ===
    // Make handleStartTripClick available globally for dynamically created buttons
    window.handleStartTripClick = handleStartTripClick;
</script>
{% endblock %}