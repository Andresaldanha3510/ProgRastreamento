{% extends "base.html" %} {% block title %}Frota de Veículos - TrackGo{%
endblock %} {% block styles %} {{ super() }}
<style>
  /* Estilos adaptados de 'consultar_clientes' para consistência visual */
  :root {
    --primary-green: #2e7d32;
    --primary-green-dark: #1b5e20;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-900: #0f172a;
    --red-600: #dc2626;
  }

  .veiculos-container {
    background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--gray-200);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 1.5rem;
    color: var(--primary-green-dark);
    font-size: 1.25rem;
    font-weight: 600;
  }

  .section-header i {
    color: var(--primary-green);
    font-size: 1.5rem;
  }

  .btn-green {
    background: linear-gradient(
      135deg,
      var(--primary-green) 0%,
      var(--primary-green-dark) 100%
    );
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    text-decoration: none;
  }
  .btn-green:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
    color: white;
    text-decoration: none;
  }

  .btn-secondary {
    background: linear-gradient(
      135deg,
      var(--gray-600) 0%,
      var(--gray-700) 100%
    );
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
  }
  .btn-secondary:hover {
    color: white;
    text-decoration: none;
  }

  .search-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--gray-200);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .search-box {
    position: relative;
    flex: 1;
    min-width: 300px;
  }
  .search-box input {
    width: 100%;
    padding: 12px 16px 12px 48px;
    border: 2px solid var(--gray-200);
    border-radius: 25px;
    font-size: 1rem;
    transition: all 0.3s;
    background: white;
  }
  .search-box input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
  }
  .search-box i {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-600);
    font-size: 1.125rem;
  }

  .veiculos-table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--gray-200);
  }
  .veiculos-table {
    width: 100%;
    border-collapse: collapse;
  }
  .veiculos-table th {
    background: linear-gradient(
      135deg,
      var(--primary-green-dark) 0%,
      var(--primary-green) 100%
    );
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .veiculos-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-100);
    vertical-align: middle;
    font-size: 0.875rem;
  }
  .veiculos-table tr:hover {
    background: var(--gray-50);
  }

  .btn-table {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    margin-right: 4px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.3s;
    text-decoration: none;
  }
  .btn-table.btn-view {
    background: var(--primary-green);
    color: white;
  }
  .btn-table.btn-view:hover {
    background: var(--primary-green-dark);
    color: white;
    text-decoration: none;
  }
  .btn-table.btn-dashboard {
    background: #3b82f6;
    color: white;
  }
  .btn-table.btn-dashboard:hover {
    background: #1d4ed8;
    color: white;
    text-decoration: none;
  }
  .btn-table.btn-edit {
    background: #6366f1;
    color: white;
  }
  .btn-table.btn-edit:hover {
    background: #4338ca;
    color: white;
    text-decoration: none;
  }

  .status-badge {
    padding: 0.375rem 1rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    color: white;
  }
  .status-disponivel {
    background: linear-gradient(135deg, #10b981, #059669);
  }
  .status-em-rota {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
  }
  .status-em-manutencao {
    background: linear-gradient(135deg, #f59e0b, #d97706);
  }
  .status-inativo {
    background: linear-gradient(135deg, #ef4444, #dc2626);
  }
  .status-vendido {
    background: linear-gradient(135deg, #6b7280, #4b5563);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 1.5rem;
    color: var(--gray-600);
  }
  .empty-state i {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    color: var(--gray-200);
  }

  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilos do Modal */
  .tab-button.active {
    border-bottom: 2px solid var(--primary-green);
    color: var(--primary-green);
    font-weight: 600;
  }
  .attachment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-radius: 8px;
    transition: background-color 0.2s;
  }
  .attachment-item:hover {
    background-color: var(--gray-100);
  }
  .attachment-icon {
    color: var(--gray-600);
    margin-right: 0.75rem;
  }
  .attachment-name {
    color: var(--gray-900);
    text-decoration: none;
    font-weight: 500;
  }
  .attachment-name:hover {
    text-decoration: underline;
    color: var(--primary-green);
  }
  .btn-delete-attachment {
    background: none;
    border: none;
    color: var(--gray-600);
    cursor: pointer;
    font-size: 1rem;
  }
  .btn-delete-attachment:hover {
    color: var(--red-600);
  }
</style>
{% endblock %} {% block content %} {% set stats = { 'total': veiculos|length,
'disponivel': veiculos|selectattr('status', 'equalto',
'Disponível')|list|length, 'em_rota': veiculos|selectattr('status', 'equalto',
'Em Rota')|list|length, 'em_manutencao': veiculos|selectattr('status',
'equalto', 'Em Manutenção')|list|length } %}
<div class="space-y-6">
  <div
    class="bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg p-6 shadow-lg"
  >
    <h1 class="text-3xl font-bold flex items-center gap-3">
      <i class="fas fa-truck"></i>
      Frota de Veículos
    </h1>
    <p class="text-green-100 mt-2">
      Gerencie todos os veículos da sua frota de forma eficiente.
    </p>
  </div>

  <div class="veiculos-container fade-in">
    <div class="flex flex-col md:flex-row justify-between items-center">
      <div class="section-header !mb-4 md:!mb-0">
        <i class="fas fa-chart-bar"></i>
        Visão Geral da Frota
      </div>
      <div class="flex gap-2 w-full md:w-auto">
        <a
          href="{{ url_for('cadastrar_veiculo') }}"
          class="btn-green flex-grow md:flex-grow-0"
        >
          <i class="fas fa-plus"></i> Novo Veículo
        </a>
        <button id="export-btn" class="btn-secondary flex-grow md:flex-grow-0">
          <i class="fas fa-file-excel"></i> Exportar para Excel
        </button>
      </div>
    </div>
    <div
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mt-4 text-center"
    >
      <div class="bg-indigo-100 p-4 rounded-lg">
        <p class="text-2xl font-bold text-indigo-800">{{ stats.total }}</p>
        <p class="text-sm text-indigo-600">Total de Veículos</p>
      </div>
      <div class="bg-green-100 p-4 rounded-lg">
        <p class="text-2xl font-bold text-green-800">{{ stats.disponivel }}</p>
        <p class="text-sm text-green-600">Disponíveis</p>
      </div>
      <div class="bg-blue-100 p-4 rounded-lg">
        <p class="text-2xl font-bold text-blue-800">{{ stats.em_rota }}</p>
        <p class="text-sm text-blue-600">Em Rota</p>
      </div>
      <div class="bg-yellow-100 p-4 rounded-lg">
        <p class="text-2xl font-bold text-yellow-800">
          {{ stats.em_manutencao }}
        </p>
        <p class="text-sm text-yellow-600">Em Manutenção</p>
      </div>
    </div>
  </div>

  <div class="search-section fade-in">
    <div class="section-header">
      <i class="fas fa-filter"></i>
      Buscar e Filtrar Veículos
    </div>
    <form method="GET">
      <div class="flex flex-col md:flex-row gap-4 items-center">
        <div class="search-box w-full">
          <input
            type="text"
            name="search"
            value="{{ search_query or '' }}"
            placeholder="Buscar por Placa, Modelo ou Categoria..."
            class="w-full"
          />
          <i class="fas fa-search"></i>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <button type="submit" class="btn-green w-full md:w-auto">
            <i class="fas fa-search"></i> Filtrar
          </button>
          <a
            href="{{ url_for('consultar_veiculos') }}"
            class="btn-secondary w-full md:w-auto"
            ><i class="fas fa-times"></i> Limpar</a
          >
        </div>
      </div>
    </form>
  </div>

  <div class="veiculos-container fade-in">
    <div class="section-header">
      <i class="fas fa-list"></i>
      Lista de Veículos {% if veiculos %}<span
        class="text-base font-normal text-gray-600"
        >({{ veiculos|length }} veículo{{ 's' if veiculos|length != 1 }})</span
      >{% endif %}
    </div>

    {% if not veiculos %}
    <div class="empty-state">
      <i class="fas fa-truck"></i>
      <h3>Nenhum veículo encontrado</h3>
      <p>Clique em "Novo Veículo" para adicionar o primeiro da sua frota.</p>
    </div>
    {% else %}
    <div class="veiculos-table-container">
      <table class="veiculos-table">
        <thead>
          <tr>
            <th>Placa</th>
            <th>Veículo</th>
            <th>Ano</th>
            <th>Quilometragem</th>
            <th class="text-center">Status</th>
            <th class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for veiculo in veiculos %}
          <tr
            class="fade-in"
            style="animation-delay: {{ loop.index0 * 0.05 }}s"
          >
            <td>
              <div
                class="font-bold text-gray-900 font-mono bg-gray-100 px-3 py-1 rounded inline-block"
              >
                {{ veiculo.placa }}
              </div>
            </td>
            <td>
              <div>
                <div class="font-semibold text-gray-900">
                  {{ veiculo.modelo }}
                </div>
                <div class="text-sm text-gray-500">
                  {{ veiculo.marca or 'Marca não informada' }}
                </div>
              </div>
            </td>
            <td>{{ veiculo.ano or 'N/A' }}</td>
            <td>
              <div class="flex items-center gap-2">
                <i class="fas fa-tachometer-alt text-gray-400"></i>
                <span
                  >{{ "{:,.0f}".format(veiculo.quilometragem).replace(",", ".")
                  if veiculo.quilometragem else 'Não informado' }} km</span
                >
              </div>
            </td>
            <td class="text-center">
              <span
                class="status-badge {% if veiculo.status == 'Disponível' %}status-disponivel {% elif veiculo.status == 'Em Rota' %}status-em-rota {% elif veiculo.status == 'Em Manutenção' %}status-em-manutencao {% elif veiculo.status == 'Inativo' %}status-inativo {% elif veiculo.status == 'Vendido' %}status-vendido {% endif %}"
              >
                {{ veiculo.status }}
              </span>
            </td>
            <td class="p-4">
              <div class="flex gap-2 justify-center">
                <button
                  onclick="openVehicleModal({{ veiculo.id }})"
                  class="btn-table btn-view"
                  title="Ver Detalhes e Anexos"
                >
                  <i class="fas fa-eye"></i>
                </button>
                <a
                  href="{{ url_for('veiculo_dashboard', veiculo_id=veiculo.id) }}"
                  class="btn-table btn-dashboard"
                  title="Dashboard Financeiro e Despesas"
                >
                  <i class="fas fa-chart-line"></i>
                </a>
                <a
                  href="{{ url_for('editar_veiculo', veiculo_id=veiculo.id) }}"
                  class="btn-table btn-edit"
                  title="Editar Cadastro"
                >
                  <i class="fas fa-edit"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
</div>

<div
  id="vehicleModal"
  class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden"
>
  <div
    class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"
  >
    <header class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold text-gray-800">
        Detalhes do Veículo: <span id="modal-vehicle-plate"></span>
      </h2>
      <button
        onclick="closeModal('vehicleModal')"
        class="text-gray-400 hover:text-gray-700 text-3xl"
      >
        &times;
      </button>
    </header>
    <div class="border-b">
      <nav class="flex px-4">
        <button
          id="tab-kpis"
          class="tab-button py-3 px-4"
          onclick="switchTab('kpis')"
        >
          KPIs
        </button>
        <button
          id="tab-historico"
          class="tab-button py-3 px-4"
          onclick="switchTab('historico')"
        >
          Histórico
        </button>
        <button
          id="tab-anexos"
          class="tab-button py-3 px-4"
          onclick="switchTab('anexos')"
        >
          Anexos (Fotos)
        </button>
      </nav>
    </div>
    <div class="p-6 overflow-y-auto">
      <div id="content-kpis" class="tab-content"></div>
      <div id="content-historico" class="tab-content hidden"></div>
      <div id="content-anexos" class="tab-content hidden"></div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<!-- Adicionar a biblioteca SheetJS via CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  document.getElementById('export-btn').addEventListener('click', function() {
      const veiculos = {{ veiculos|tojson|safe }};

      if (!veiculos || veiculos.length === 0) {
          alert('Não há dados para exportar.');
          return;
      }

      const exportData = veiculos.map(v => ({
          'Placa': v.placa,
          'Veículo': v.modelo,
          'Marca': v.marca || 'N/A',
          'Ano': v.ano || 'N/A',
          'Quilometragem (km)': v.quilometragem || 0,
          'Status': v.status,
          'Data de Cadastro': v.created_at ? new Date(v.created_at).toLocaleDateString('pt-BR') : 'N/A'
      }));

      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Frota de Veículos");

      const today = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(workbook, `Relatorio_Frota_${today}.xlsx`);
  });

  // --- Lógica do Modal ---
  function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
  function switchTab(tabName) {
      document.querySelectorAll('#vehicleModal .tab-content').forEach(c => c.classList.add('hidden'));
      document.querySelectorAll('#vehicleModal .tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('active');
  }

  async function openVehicleModal(veiculoId) {
      const modal = document.getElementById('vehicleModal');
      modal.classList.remove('hidden');
      switchTab('kpis');

      const kpisContainer = document.getElementById('content-kpis');
      const historicoContainer = document.getElementById('content-historico');
      const anexosContainer = document.getElementById('content-anexos');

      kpisContainer.innerHTML = '<p class="text-center text-gray-500">Carregando KPIs...</p>';
      historicoContainer.innerHTML = '<p class="text-center text-gray-500">Carregando histórico...</p>';
      anexosContainer.innerHTML = '<p class="text-center text-gray-500">Carregando anexos...</p>';

      document.getElementById('modal-vehicle-plate').innerText = 'Carregando...';

      try {
          const response = await fetch(`/api/veiculo/${veiculoId}/details`);
          if (!response.ok) throw new Error('Falha ao buscar dados do veículo.');
          const data = await response.json();

          document.getElementById('modal-vehicle-plate').innerText = data.veiculo.placa;

          // Render KPIs
          const kpis = data.kpis;
          kpisContainer.innerHTML = `
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                  <div class="bg-blue-100 p-4 rounded-lg"><p class="text-2xl font-bold text-blue-800">${kpis.total_viagens}</p><p class="text-sm text-blue-600">Total de Viagens</p></div>
                  <div class="bg-indigo-100 p-4 rounded-lg"><p class="text-2xl font-bold text-indigo-800">${kpis.total_km.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".")} km</p><p class="text-sm text-indigo-600">KM Rodados</p></div>
                  <div class="bg-red-100 p-4 rounded-lg"><p class="text-2xl font-bold text-red-800">R$ ${kpis.custo_geral.toFixed(2).replace('.', ',')}</p><p class="text-sm text-red-600">Custo Geral</p></div>
                  <div class="bg-yellow-100 p-4 rounded-lg"><p class="text-2xl font-bold text-yellow-800">R$ ${kpis.custo_por_km.toFixed(2).replace('.', ',')}</p><p class="text-sm text-yellow-600">Custo por KM</p></div>
              </div>`;

          // Render History
          const manutencoes = data.manutencoes;
          if (manutencoes.length > 0) {
              let historyHtml = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2 text-left">Data</th><th class="p-2 text-left">Tipo</th><th class="p-2 text-left">Descrição</th><th class="p-2 text-right">Custo</th></tr></thead><tbody>';
              manutencoes.forEach(m => {
                  historyHtml += `<tr class="border-b"><td class="p-2">${m.data}</td><td class="p-2">${m.tipo}</td><td class="p-2">${m.descricao}</td><td class="p-2 text-right">R$ ${m.custo ? m.custo.toFixed(2).replace('.', ',') : '0,00'}</td></tr>`;
              });
              historyHtml += '</tbody></table></div>';
              historicoContainer.innerHTML = historyHtml;
          } else {
              historicoContainer.innerHTML = '<p class="text-center text-gray-500">Nenhum histórico de manutenção encontrado.</p>';
          }

          // Render Attachments
          renderAnexos(veiculoId, data.anexos, anexosContainer);

      } catch (error) {
          console.error("Erro no modal do veículo:", error);
          kpisContainer.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
          historicoContainer.innerHTML = '';
          anexosContainer.innerHTML = '';
      }
  }

  function renderAnexos(veiculoId, anexos, container) {
      if (anexos && anexos.length > 0) {
          let anexosHtml = '<div class="space-y-2">';
          anexos.forEach(anexoUrl => {
              const fileName = anexoUrl.split('/').pop().split('-').slice(1).join('-') || 'Arquivo de imagem';
              anexosHtml += `
                  <div class="attachment-item" id="anexo-${btoa(anexoUrl)}">
                      <div class="flex items-center">
                           <i class="fas fa-image attachment-icon"></i>
                           <a href="${anexoUrl}" target="_blank" class="attachment-name" title="${fileName}">${fileName}</a>
                      </div>
                      <button onclick="deleteVehicleAttachment(${veiculoId}, '${anexoUrl}')" class="btn-delete-attachment" title="Excluir anexo">
                          <i class="fas fa-times"></i>
                      </button>
                  </div>
              `;
          });
          anexosHtml += '</div><p class="text-xs text-gray-500 mt-4">Para adicionar novas fotos, acesse a tela de <a href="/editar_veiculo/' + veiculoId + '" class="text-blue-600 hover:underline">edição de veículo</a>.</p>';
          container.innerHTML = anexosHtml;
      } else {
          container.innerHTML = '<p class="text-center text-gray-500">Nenhuma foto ou anexo encontrado. Você pode adicionar na tela de edição do veículo.</p>';
      }
  }

  async function deleteVehicleAttachment(veiculoId, fotoUrl) {
      if (!confirm('Tem certeza que deseja excluir esta foto/anexo? A ação não pode ser desfeita.')) {
          return;
      }

      try {
          const response = await fetch('/api/veiculo/excluir_foto', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ veiculo_id: veiculoId, foto_url: fotoUrl })
          });
          const result = await response.json();

          if (response.ok && result.success) {
              const elementId = btoa(fotoUrl);
              document.getElementById(`anexo-${elementId}`).remove();
              // Opcional: mostrar uma notificação de sucesso
              alert('Anexo excluído com sucesso!');
          } else {
              throw new Error(result.message || 'Erro ao excluir anexo.');
          }
      } catch (error) {
          console.error("Erro ao excluir anexo:", error);
          alert(error.message);
      }
  }
</script>
{% endblock %}
