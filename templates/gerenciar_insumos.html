{% extends "base.html" %}

{% block title %}Gerenciar Insumos da Oficina{% endblock %}

{% block styles %}
{{ super() }} {# Mantém os estilos do base.html, se houver #}
<style>
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 50;
        animation: fadeIn 0.2s ease-out;
    }
    .modal.flex {
        display: flex;
    }
    .modal-content {
        background-color: white;
        padding: 1.5rem 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease-out;
        width: 90%;
        max-width: 500px;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* ### CSS PARA RESPONSIVIDADE ### */
    .header-actions {
        display: flex;
        flex-wrap: wrap; /* Permite que os botões quebrem a linha */
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 1rem; /* Espaçamento entre os itens */
    }
    .main-grid {
        display: grid;
        grid-template-columns: 1fr; /* Uma coluna por padrão */
        gap: 2rem;
    }
    .table-container {
        overflow-x: auto; /* Permite rolagem horizontal na tabela em telas pequenas */
    }

    @media (min-width: 1024px) { /* Em telas grandes (lg), usa 3 colunas */
        .main-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        .form-column {
            grid-column: span 1 / span 1;
        }
        .table-column {
            grid-column: span 2 / span 2;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h1 class="text-2xl font-bold text-gray-800">Catálogo de Insumos</h1>
        <a href="{{ url_for('oficina') }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
            &larr; Voltar para a Oficina
        </a>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <div class="w-full lg:w-1/3">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Adicionar Novo Insumo</h2>
                <form id="form-novo-insumo" class="space-y-4">
                    <div>
                        <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição*</label>
                        <input type="text" id="descricao" name="descricao" class="w-full mt-1 p-2 border rounded-md shadow-sm" placeholder="Ex: Filtro de Ar Volvo FH" required>
                    </div>
                    <div>
                        <label for="codigo_peca" class="block text-sm font-medium text-gray-700">Código da Peça (Part Number)</label>
                        <input type="text" id="codigo_peca" name="codigo_peca" class="w-full mt-1 p-2 border rounded-md shadow-sm" placeholder="Ex: 21707133">
                    </div>
                    <div>
                        <label for="custo_unitario_medio" class="block text-sm font-medium text-gray-700">Custo Unitário Médio (R$)</label>
                        <input type="number" step="0.01" id="custo_unitario_medio" name="custo_unitario_medio" class="w-full mt-1 p-2 border rounded-md shadow-sm" placeholder="Ex: 150.75">
                    </div>
                    <div>
                        <label for="quantidade_em_estoque" class="block text-sm font-medium text-gray-700">Quantidade Inicial em Estoque</label>
                        <input type="number" step="1" id="quantidade_em_estoque" name="quantidade_em_estoque" class="w-full mt-1 p-2 border rounded-md shadow-sm" placeholder="0">
                    </div>
                    <div>
                        <label for="ponto_ressuprimento" class="block text-sm font-medium text-gray-700">Estoque Mínimo (para alerta)</label>
                        <input type="number" step="1" id="ponto_ressuprimento" name="ponto_ressuprimento" class="w-full mt-1 p-2 border rounded-md shadow-sm" placeholder="Ex: 5">
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition">
                            <i class="fas fa-plus mr-2"></i>Salvar Insumo
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="w-full lg:w-2/3">
            <div class="bg-white rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mínimo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for insumo in insumos %}
                            <tr id="insumo-{{ insumo.id }}">
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{{ insumo.descricao }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">{{ insumo.codigo_peca or 'N/A' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center font-bold {% if insumo.ponto_ressuprimento and insumo.quantidade_em_estoque <= insumo.ponto_ressuprimento %}text-red-600{% endif %} stock-quantity">
                                    {{ insumo.quantidade_em_estoque|int }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-gray-500">{{ insumo.ponto_ressuprimento|int if insumo.ponto_ressuprimento is not none else 'N/A' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">R$ {{ "%.2f"|format(insumo.custo_unitario_medio or 0)|replace('.', ',') }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                    <button onclick="abrirModalEntrada({{ insumo.id }}, '{{ insumo.descricao }}')" class="text-green-600 hover:text-green-800 mr-3" title="Registrar Entrada no Estoque">
                                        <i class="fas fa-plus-circle"></i>
                                    </button>
                                    <button onclick="deletarInsumo({{ insumo.id }})" class="text-red-500 hover:text-red-700" title="Excluir Insumo">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhum insumo cadastrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-entrada-estoque" class="modal">
    <div class="modal-content max-w-md">
        <h2 class="text-2xl font-bold mb-2">Registrar Entrada de Estoque</h2>
        <p class="mb-4 text-gray-600">Insumo: <strong id="entrada-insumo-nome"></strong></p>
        <form id="form-entrada-estoque">
            <input type="hidden" id="entrada-insumo-id">
            <div>
                <label for="entrada-quantidade" class="block text-sm font-medium text-gray-700">Quantidade a Adicionar*</label>
                <input type="number" id="entrada-quantidade" class="w-full mt-1 p-2 border rounded-md" required>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" onclick="fecharModal('modal-entrada-estoque')" class="bg-gray-300 text-black px-4 py-2 rounded-md">Cancelar</button>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">Confirmar Entrada</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Funções de Modal ---
    function fecharModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('flex');
    }

    function abrirModal(modalId) {
        document.querySelectorAll('.modal.flex').forEach(m => fecharModal(m.id));
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('flex');
    }

    // --- Lógica do Formulário de Novo Insumo ---
    document.getElementById('form-novo-insumo').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch("{{ url_for('api_criar_insumo') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message);
            }
            alert(result.message);
            window.location.reload();
        } catch (error) {
            alert('Erro: ' + error.message);
        }
    });

    // --- Lógica para Deletar Insumo ---
    async function deletarInsumo(insumoId) {
        if (!confirm('Tem certeza que deseja excluir este insumo? Ele não poderá ser removido se estiver em uso por um plano.')) {
            return;
        }
        try {
            const response = await fetch(`/oficina/api/insumos/${insumoId}`, { method: 'DELETE' });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message);
            }
            alert(result.message);
            document.getElementById(`insumo-${insumoId}`).remove();
        } catch (error) {
            alert('Erro: ' + error.message);
        }
    }

    // --- Lógica para Entrada de Estoque ---
    function abrirModalEntrada(insumoId, insumoNome) {
        document.getElementById('form-entrada-estoque').reset();
        document.getElementById('entrada-insumo-id').value = insumoId;
        document.getElementById('entrada-insumo-nome').textContent = insumoNome;
        abrirModal('modal-entrada-estoque');
    }

    document.getElementById('form-entrada-estoque').addEventListener('submit', async function(e) {
    e.preventDefault();
    const insumoId = document.getElementById('entrada-insumo-id').value;
    const quantidade = document.getElementById('entrada-quantidade').value;
    const submitButton = this.querySelector('button[type="submit"]');

    // Desabilita o botão para evitar cliques duplos
    submitButton.disabled = true;
    submitButton.textContent = 'Salvando...';
    
    try {
        const response = await fetch(`/oficina/api/insumos/${insumoId}/entrada`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantidade: quantidade })
        });
        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message);
        }

        // ### LÓGICA CORRIGIDA ###
        
        // 1. Fecha o modal sozinho
        fecharModal('modal-entrada-estoque');

        // 2. Atualiza o valor na tabela sem recarregar a página
        const linhaDoInsumo = document.getElementById(`insumo-${insumoId}`);
        if (linhaDoInsumo) {
            const celulaEstoque = linhaDoInsumo.querySelector('.stock-quantity');
            if (celulaEstoque) {
                // Atualiza o número
                celulaEstoque.textContent = Math.floor(result.novo_estoque);
                
                // (Opcional) Efeito visual para destacar a célula atualizada
                celulaEstoque.style.backgroundColor = '#d1fae5'; // Tom de verde claro
                setTimeout(() => {
                    celulaEstoque.style.backgroundColor = ''; // Remove a cor após 2 segundos
                }, 2000);
            }
        }
        
    } catch (error) {
        alert('Erro: ' + error.message);
    } finally {
        // Reabilita o botão, independentemente do resultado
        submitButton.disabled = false;
        submitButton.textContent = 'Confirmar Entrada';
    }
});
</script>
{% endblock %}