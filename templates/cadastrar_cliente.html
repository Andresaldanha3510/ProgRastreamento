{% extends "base.html" %} {% block title %}Cadastrar Cliente - TrackGo{%
endblock %} {% block styles %}
<style>
  /* Estilos padronizados, baseados no 'cadastrar_veiculo.html' */
  .form-container {
    background-color: #e9ecef;
    padding: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    margin: 0;
  }

  .form-container h1 {
    text-align: center;
  }

  .form-section {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #2e7d32;
  }

  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-input,
  .form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: #2e7d32;
    box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
  }
  .form-input[readonly] {
    background-color: #f3f4f6;
    cursor: not-allowed;
  }
  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.375rem;
    text-decoration: none;
    color: white;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .btn-submit {
    background-color: #2563eb;
  }
  .btn-submit:hover {
    background-color: #1d4ed8;
  }
  .btn-back {
    background-color: #6b7280;
  }
  .btn-back:hover {
    background-color: #4b5563;
  }
  .btn-secondary {
    background-color: #4b5563;
  }
  .btn-secondary:hover {
    background-color: #374151;
  }
</style>
{% endblock %} {% block content %}
<div class="form-container" x-data="anexosManager()">
  <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">
    Cadastrar Novo Cliente
  </h1>

  <form method="POST" enctype="multipart/form-data">
    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-user-circle"></i>
        Dados Gerais
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
        <div class="md:col-span-2">
          <label for="pessoa_tipo" class="block text-gray-700 font-medium mb-2"
            >Pessoa Física ou Jurídica</label
          >
          <select
            id="pessoa_tipo"
            name="pessoa_tipo"
            required
            class="form-select"
          >
            <option value="fisica">Pessoa Física</option>
            <option value="juridica" selected>Pessoa Jurídica</option>
          </select>
        </div>
        <div>
          <label
            for="nome_razao_social"
            class="block text-gray-700 font-medium mb-2"
            >Nome / Razão Social</label
          >
          <input
            type="text"
            id="nome_razao_social"
            name="nome_razao_social"
            required
            class="form-input"
            placeholder="Nome completo ou razão social"
          />
        </div>
        <div id="campo_nome_fantasia">
          <label
            for="nome_fantasia"
            class="block text-gray-700 font-medium mb-2"
            >Nome Fantasia</label
          >
          <input
            type="text"
            id="nome_fantasia"
            name="nome_fantasia"
            class="form-input"
            placeholder="Nome fantasia da empresa"
          />
        </div>
        <div>
          <label
            id="cpf_cnpj_label"
            for="cpf_cnpj"
            class="block text-gray-700 font-medium mb-2"
            >CNPJ</label
          >
          <input
            type="text"
            id="cpf_cnpj"
            name="cpf_cnpj"
            required
            class="form-input"
            placeholder="Apenas números"
          />
        </div>
        <div id="campo_ie">
          <label
            for="inscricao_estadual"
            class="block text-gray-700 font-medium mb-2"
            >Inscrição Estadual</label
          >
          <input
            type="text"
            name="inscricao_estadual"
            id="inscricao_estadual"
            class="form-input"
            placeholder="Apenas números ou 'ISENTO'"
          />
        </div>
      </div>
    </div>

    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-map-marker-alt"></i>
        Endereço
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">
        <div class="md:col-span-1">
          <label for="cep" class="block text-gray-700 font-medium mb-2"
            >CEP</label
          >
          <input
            type="text"
            id="cep"
            name="cep"
            required
            class="form-input"
            placeholder="Apenas números"
            maxlength="8"
          />
        </div>
        <div class="md:col-span-3">
          <label for="logradouro" class="block text-gray-700 font-medium mb-2"
            >Endereço (Logradouro)</label
          >
          <input
            type="text"
            id="logradouro"
            name="logradouro"
            class="form-input"
            readonly
          />
        </div>
        <div class="md:col-span-1">
          <label for="numero" class="block text-gray-700 font-medium mb-2"
            >Número</label
          >
          <input type="text" id="numero" name="numero" class="form-input" />
        </div>
        <div class="md:col-span-3">
          <label for="complemento" class="block text-gray-700 font-medium mb-2"
            >Complemento</label
          >
          <input
            type="text"
            id="complemento"
            name="complemento"
            class="form-input"
            placeholder="Apto, Bloco, etc."
          />
        </div>
        <div class="md:col-span-2">
          <label for="bairro" class="block text-gray-700 font-medium mb-2"
            >Bairro</label
          >
          <input
            type="text"
            id="bairro"
            name="bairro"
            class="form-input"
            readonly
          />
        </div>
        <div class="md:col-span-1">
          <label for="cidade" class="block text-gray-700 font-medium mb-2"
            >Cidade</label
          >
          <input
            type="text"
            id="cidade"
            name="cidade"
            class="form-input"
            readonly
          />
        </div>
        <div class="md:col-span-1">
          <label for="estado" class="block text-gray-700 font-medium mb-2"
            >Estado (UF)</label
          >
          <input
            type="text"
            id="estado"
            name="estado"
            class="form-input"
            readonly
          />
        </div>
      </div>
    </div>

    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-phone-alt"></i>
        Contato e Documentos
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
        <div>
          <label for="email" class="block text-gray-700 font-medium mb-2"
            >E-mail</label
          >
          <input
            type="email"
            id="email"
            name="email"
            class="form-input"
            placeholder="principal@email.com"
          />
        </div>
        <div>
          <label for="telefone" class="block text-gray-700 font-medium mb-2"
            >Telefone/WhatsApp</label
          >
          <input
            type="text"
            id="telefone"
            name="telefone"
            class="form-input"
            placeholder="DDD + Número"
            maxlength="11"
          />
        </div>
        <div class="md:col-span-2">
          <label
            for="contato_principal"
            class="block text-gray-700 font-medium mb-2"
            >Contato Principal na Empresa</label
          >
          <input
            type="text"
            id="contato_principal"
            name="contato_principal"
            class="form-input"
            placeholder="Nome da pessoa de referência"
          />
        </div>

        <div class="md:col-span-2">
          <label class="block text-gray-700 font-medium mb-2"
            >Documentos (Contrato Social, etc.)</label
          >
          <button
            type="button"
            @click="isAnexosModalOpen = true"
            class="btn btn-secondary w-full sm:w-auto"
          >
            <i class="fas fa-paperclip mr-2"></i>
            Anexar Documentos (<span x-text="files.length">0</span>)
          </button>
        </div>
      </div>
    </div>

    <div class="mt-8 flex justify-end gap-4">
      <a
        href="{{ url_for('consultar_clientes') }}"
        class="btn btn-back px-4 py-2 rounded"
        >Voltar</a
      >
      <button type="submit" class="btn-submit px-4 py-2 rounded">
        Cadastrar Cliente
      </button>
    </div>

    <div
      x-show="isAnexosModalOpen"
      x-transition:enter="ease-out duration-300"
      enter-start-class="opacity-0"
      enter-end-class="opacity-100"
      x-transition:leave="ease-in duration-200"
      leave-start-class="opacity-100"
      leave-end-class="opacity-0"
      class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"
      style="display: none"
    >
      <div
        @click.away="isAnexosModalOpen = false"
        class="bg-white rounded-lg shadow-xl w-full max-w-2xl"
      >
        <header class="flex justify-between items-center p-4 border-b">
          <h2 class="text-xl font-bold text-gray-800">
            Anexar Documentos do Cliente
          </h2>
          <button
            type="button"
            @click="isAnexosModalOpen = false"
            class="text-gray-400 hover:text-gray-700 text-3xl"
          >
            &times;
          </button>
        </header>

        <div class="p-6 max-h-[60vh] overflow-y-auto">
          <label
            for="anexos-input"
            class="btn bg-blue-600 hover:bg-blue-700 w-full cursor-pointer"
          >
            <i class="fas fa-plus mr-2"></i> Adicionar um ou vários arquivos
          </label>
          <input
            type="file"
            name="anexos"
            id="anexos-input"
            @change="addFiles($event)"
            multiple
            class="hidden"
            accept=".pdf,.jpg,.jpeg,.png"
          />

          <p class="text-sm text-gray-500 mt-4 mb-2">
            Arquivos selecionados para envio:
          </p>
          <ul class="space-y-2">
            <template x-if="files.length === 0">
              <li class="text-center text-gray-500 py-4">
                Nenhum arquivo selecionado.
              </li>
            </template>
            <template x-for="(file, index) in files" :key="index">
              <li
                class="flex justify-between items-center bg-gray-50 p-2 rounded-md border"
              >
                <span
                  class="text-gray-700 truncate pr-2"
                  x-text="file.name"
                ></span>
                <button
                  type="button"
                  @click="removeFile(index)"
                  class="text-red-500 hover:text-red-700"
                  title="Remover Anexo"
                >
                  <i class="fas fa-times-circle"></i>
                </button>
              </li>
            </template>
          </ul>
        </div>

        <footer class="p-4 bg-gray-50 border-t text-right">
          <button
            type="button"
            @click="isAnexosModalOpen = false"
            class="btn bg-gray-500 hover:bg-gray-600"
          >
            Fechar
          </button>
        </footer>
      </div>
    </div>
  </form>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
  // LÓGICA DO MODAL DE ANEXOS ADICIONADA AQUI
  function anexosManager() {
    return {
      isAnexosModalOpen: false,
      files: [],
      addFiles(event) {
        const newFiles = Array.from(event.target.files);
        // Limita a quantidade de arquivos se necessário
        // const MAX_FILES = 5;
        // this.files = [...this.files, ...newFiles].slice(0, MAX_FILES);
        this.files.push(...newFiles);
        this.updateFileInput();
      },
      removeFile(index) {
        this.files.splice(index, 1);
        this.updateFileInput();
      },
      updateFileInput() {
        // Sincroniza os arquivos gerenciados pelo AlpineJS com o <input type="file"> real
        const dataTransfer = new DataTransfer();
        this.files.forEach((file) => dataTransfer.items.add(file));
        document.getElementById("anexos-input").files = dataTransfer.files;
      },
    };
  }

  document.addEventListener("DOMContentLoaded", function () {
    // A LÓGICA EXISTENTE FOI MANTIDA INTACTA
    const pessoaTipo = document.getElementById("pessoa_tipo");
    const cpfCnpjLabel = document.getElementById("cpf_cnpj_label");
    const cpfCnpjInput = document.getElementById("cpf_cnpj");
    const campoNomeFantasia = document.getElementById("campo_nome_fantasia");
    const campoIE = document.getElementById("campo_ie");

    function togglePessoaFields() {
      if (pessoaTipo.value === "fisica") {
        cpfCnpjLabel.textContent = "CPF";
        cpfCnpjInput.placeholder = "Digite o CPF (11 dígitos)";
        cpfCnpjInput.maxLength = 11;
        campoNomeFantasia.classList.add("hidden");
        campoIE.classList.add("hidden");
      } else {
        cpfCnpjLabel.textContent = "CNPJ";
        cpfCnpjInput.placeholder = "Digite o CNPJ (14 dígitos)";
        cpfCnpjInput.maxLength = 14;
        campoNomeFantasia.classList.remove("hidden");
        campoIE.classList.remove("hidden");
      }
    }
    pessoaTipo.addEventListener("change", togglePessoaFields);
    togglePessoaFields();

    const cepInput = document.getElementById("cep");
    const logradouroInput = document.getElementById("logradouro");
    const bairroInput = document.getElementById("bairro");
    const cidadeInput = document.getElementById("cidade");
    const estadoInput = document.getElementById("estado");
    const numeroInput = document.getElementById("numero");

    const preencherFormulario = (endereco) => {
      logradouroInput.value = endereco.logradouro || "";
      bairroInput.value = endereco.bairro || "";
      cidadeInput.value = endereco.localidade || "";
      estadoInput.value = endereco.uf || "";
      if (endereco.logradouro) numeroInput.focus();
    };

    const consultarCEP = async () => {
      const cep = cepInput.value.replace(/\D/g, "");
      if (cep.length !== 8) return;

      [logradouroInput, bairroInput, cidadeInput, estadoInput].forEach(
        (c) => (c.value = "Buscando...")
      );
      const url = `https://viacep.com.br/ws/${cep}/json/`;

      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.erro) {
          alert("CEP não encontrado.");
          [logradouroInput, bairroInput, cidadeInput, estadoInput].forEach(
            (c) => (c.value = "")
          );
        } else {
          preencherFormulario(data);
        }
      } catch (error) {
        alert("Não foi possível consultar o CEP. Verifique sua conexão.");
        [logradouroInput, bairroInput, cidadeInput, estadoInput].forEach(
          (c) => (c.value = "")
        );
      }
    };
    cepInput.addEventListener("blur", consultarCEP);

    ["telefone", "cpf_cnpj", "cep"].forEach((id) => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener("input", function (e) {
          e.target.value = e.target.value.replace(/\D/g, "");
        });
      }
    });
  });
</script>
{% endblock %}
