{% extends "base.html" %}
{% block title %}Fluxo de Caixa - TrackBras{% endblock %}

{% block styles %}
<style>
    :root {
        --primary-green: #2e7d32;
        --primary-green-dark: #1b5e20;
        --primary-green-light: #4caf50;
        --accent-yellow: #ffc107;
        --red-600: #dc2626;
        --red-100: #fee2e2;
        --green-600: #16a34a;
        --green-100: #dcfce7;
        --blue-600: #2563eb;
        --blue-100: #dbeafe;
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-900: #0f172a;
    }
    .fluxo-container {
        background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        border: 1px solid var(--gray-200);
        margin-bottom: 2rem;
    }
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        color: var(--primary-green-dark);
        font-size: 1.25rem;
        font-weight: 600;
    }
    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .section-title i {
        color: var(--primary-green);
        font-size: 1.5rem;
    }
    .btn-green {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-dark) 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }
    .btn-green:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
        color: white;
        text-decoration: none;
    }
    .btn-green:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }
    .btn-secondary {
        background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
    }
    .btn-secondary:hover {
        color: white;
        text-decoration: none;
        opacity: 0.9;
    }
    /* KPIs Dashboard */
    .kpis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .kpi-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        border: 1px solid var(--gray-200);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
    }
    .kpi-card.receitas::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--green-600) 0%, var(--primary-green-light) 100%);
    }
    .kpi-card.despesas::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--red-600) 0%, #ef4444 100%);
    }
    .kpi-card.saldo::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--blue-600) 0%, #3b82f6 100%);
    }
    .kpi-card.vencido::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #f59e0b 0%, var(--accent-yellow) 100%);
    }
    .kpi-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    .kpi-card.receitas .kpi-icon {
        color: var(--green-600);
    }
    .kpi-card.despesas .kpi-icon {
        color: var(--red-600);
    }
    .kpi-card.saldo .kpi-icon {
        color: var(--blue-600);
    }
    .kpi-card.vencido .kpi-icon {
        color: #f59e0b;
    }
    .kpi-value {
        font-size: 1.75rem;
        font-weight: 700;
        display: block;
        margin-bottom: 0.25rem;
    }
    .kpi-card.receitas .kpi-value {
        color: var(--green-600);
    }
    .kpi-card.despesas .kpi-value {
        color: var(--red-600);
    }
    .kpi-card.saldo .kpi-value {
        color: var(--blue-600);
    }
    .kpi-card.vencido .kpi-value {
        color: #f59e0b;
    }
    .kpi-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        font-weight: 500;
    }
    .kpi-subtitle {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }
    /* Filtros e Busca */
    .filtros-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--gray-200);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .search-container {
        position: relative;
        margin-bottom: 1rem;
    }
    .search-input {
        width: 100%;
        padding: 12px 45px 12px 16px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.3s;
    }
    .search-input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }
    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 1rem;
    }
    .filtros-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-900);
        font-size: 0.875rem;
    }
    .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.3s;
    }
    .form-control:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }
    .form-select {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        background: white;
        font-size: 0.875rem;
        cursor: pointer;
    }
    .form-select:focus {
        outline: none;
        border-color: var(--primary-green);
    }
    .filtros-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: flex-end;
        align-items: center;
    }
    /* Tabela do Fluxo */
    .fluxo-table-container {
        background: white;
        border-radius: 12px;
        overflow-x: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid var(--gray-200);
    }
    .fluxo-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px;
    }
    .fluxo-table th {
        background: linear-gradient(135deg, var(--primary-green-dark) 0%, var(--primary-green) 100%);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .fluxo-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
        font-size: 0.875rem;
    }
    .fluxo-table tr:hover {
        background: var(--gray-50);
    }
    .fluxo-table tr.vencido {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }
    .fluxo-table tr.vencido:hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
    }
    .fluxo-table tr.pago {
        background: linear-gradient(135deg, var(--green-100) 0%, #bbf7d0 100%);
    }
    .fluxo-table tr.hoje {
        background: linear-gradient(135deg, var(--blue-100) 0%, #bfdbfe 100%);
        border-left: 4px solid var(--blue-600);
    }
    /* Badges de status */
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }
    .status-badge.pendente {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    .status-badge.vencido {
        background: linear-gradient(135deg, #f59e0b 0%, var(--accent-yellow) 100%);
        color: white;
    }
    .status-badge.pago {
        background: linear-gradient(135deg, var(--green-600) 0%, var(--primary-green-light) 100%);
        color: white;
    }
    .status-badge.a-pagar {
        background: linear-gradient(135deg, #ef4444 0%, var(--red-600) 100%);
        color: white;
    }
    /* Tipos de movimento */
    .tipo-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .tipo-badge.receita {
        background: var(--green-100);
        color: var(--green-600);
    }
    .tipo-badge.despesa {
        background: var(--red-100);
        color: var(--red-600);
    }
    /* Valores monetários */
    .valor-receita {
        color: var(--green-600);
        font-weight: 600;
    }
    .valor-despesa {
        color: var(--red-600);
        font-weight: 600;
    }
    .valor-neutral {
        color: var(--gray-900);
        font-weight: 600;
    }
    /* Origem dos dados */
    .origem-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .origem-badge.nfe {
        background: #e0f2fe;
        color: #0277bd;
    }
    .origem-badge.manual {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    /* Forma de Pagamento */
    .pagamento-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
        display: inline-block;
    }
    .pagamento-badge.pix {
        background: #e8f5e8;
        color: #2e7d32;
    }
    .pagamento-badge.deposito {
        background: #e3f2fd;
        color: #1976d2;
    }
    .pagamento-badge.transferencia {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    .pagamento-badge.dinheiro {
        background: #fff3e0;
        color: #f57c00;
    }
    .pagamento-badge.cartao {
        background: #fce4ec;
        color: #c2185b;
    }
    /* Botões de ação */
    .btn-table {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        margin-right: 4px;
        margin-bottom: 4px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.3s;
    }
    .btn-table.btn-pagar {
        background: var(--primary-green);
        color: white;
    }
    .btn-table.btn-pagar:hover {
        background: var(--primary-green-dark);
    }
    .btn-table.btn-rateio {
        background: #6f42c1;
        color: white;
    }
    .btn-table.btn-rateio:hover {
        background: #5a2c9b;
    }
    .btn-table.btn-rateio.has-rateio {
        background: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
    }
    .btn-table.btn-view {
        background: #17a2b8;
        color: white;
    }
    .btn-table.btn-view:hover {
        background: #138496;
    }
    .btn-table.btn-edit {
        background: #ffc107;
        color: #212529;
    }
    .btn-table.btn-edit:hover {
        background: #e0a800;
    }
    .btn-table.btn-delete {
        background: #dc3545;
        color: white;
    }
    .btn-table.btn-delete:hover {
        background: #c82333;
    }
    .btn-table.btn-estornar {
        background: #6c757d;
        color: white;
    }
    .btn-table.btn-estornar:hover {
        background: #5a6268;
    }
    .btn-table.btn-details {
        background: #007bff;
        color: white;
    }
    .btn-table.btn-details:hover {
        background: #0056b3;
    }
    .btn-table.btn-duplicar {
        background: #007bff;
        color: white;
    }
    .btn-table:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Ações em Massa */
    #barraAcoesMassa {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-700) 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        z-index: 999;
        transition: bottom 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    #barraAcoesMassa.visible {
        bottom: 20px;
    }
    #contadorSelecionados {
        font-weight: 600;
    }
    .btn-massa {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
    }
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: white;
        margin: 2% auto;
        padding: 0;
        border-radius: 16px;
        width: 95%;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        animation: modalSlide 0.3s ease-out;
        overflow: hidden;
        max-height: 95vh;
        display: flex;
        flex-direction: column;
    }
    .modal-content.small { max-width: 500px; }
    .modal-content.large { max-width: 700px; }
    .modal-content.extra-large { max-width: 900px; }
    
    .modal-body {
        overflow-y: auto;
        padding: 2rem;
    }

    @keyframes modalSlide {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
        background: linear-gradient(135deg, var(--primary-green-dark) 0%, var(--primary-green) 100%);
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .close {
        color: white;
        font-size: 1.75rem;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s;
        line-height: 1;
    }
    .close:hover {
        opacity: 0.7;
    }
    
    .modal-footer {
        padding: 1rem 2rem;
        background-color: var(--gray-50);
        text-align: right;
        flex-shrink: 0;
        border-top: 1px solid var(--gray-200);
    }
    /* Detalhes do lançamento no modal */
    .detail-row {
        display: flex;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-100);
    }
    .detail-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .detail-label {
        font-weight: 600;
        color: var(--gray-700);
        min-width: 140px;
    }
    .detail-value {
        color: var(--gray-900);
        flex: 1;
    }
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 4rem 1.5rem;
        color: var(--gray-600);
    }
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        color: var(--gray-300);
    }
    .empty-state h3 {
        margin-bottom: 0.75rem;
        color: var(--gray-700);
        font-size: 1.25rem;
    }

    /* Estilos para Tipo de Movimento */
    .tipo-movimento-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .radio-option {
        position: relative;
    }

    .radio-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }

    .radio-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
        text-align: center;
    }

    .radio-label:hover {
        border-color: var(--primary-green);
        background: var(--gray-50);
    }

    .radio-label i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }

    .radio-label span {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .radio-label small {
        font-size: 0.75rem;
        color: var(--gray-600);
        line-height: 1.2;
    }

    .radio-label.receita i {
        color: var(--green-600);
    }

    .radio-label.despesa i {
        color: var(--red-600);
    }

    .radio-option input[type="radio"]:checked + .radio-label {
        border-color: var(--primary-green);
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-light) 100%);
        color: white;
    }

    .radio-option input[type="radio"]:checked + .radio-label i {
        color: white;
    }

    .radio-option input[type="radio"]:checked + .radio-label small {
        color: rgba(255, 255, 255, 0.9);
    }

    /* Estilos do sistema de rateio (copiados de importar_notas_fiscais) */
    .veiculo-rateio-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }
    .veiculo-rateio-item:hover {
        border-color: var(--primary-green);
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
    }
    .veiculo-header { display: flex; align-items: center; margin-bottom: 1rem; gap: 12px; }
    .veiculo-numero { background: linear-gradient(135deg, var(--blue-600) 0%, #1e40af 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; }
    .veiculo-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .veiculo-nome { font-weight: 600; color: var(--gray-900); font-size: 0.95rem; }
    .veiculo-percentual { font-size: 0.75rem; color: var(--primary-green); font-weight: 600; background: var(--green-100); padding: 2px 8px; border-radius: 12px; display: inline-block; width: fit-content; }
    .btn-delete-veiculo { background: #ef4444; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; flex-shrink: 0; }
    .btn-delete-veiculo:hover { background: #dc2626; transform: scale(1.1); }
    .veiculo-valores { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .valor-input-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .valor-input-group label { font-size: 0.75rem; font-weight: 600; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; }
    .rateio-valor-input, .rateio-percentual-input { padding: 10px 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 0.95rem; font-weight: 500; transition: all 0.3s; text-align: right; }
    .rateio-valor-input:focus, .rateio-percentual-input:focus { outline: none; border-color: var(--primary-green); box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1); }
    .rateio-valor-input { color: var(--primary-green); }
    .rateio-percentual-input { color: var(--blue-600); }
    .parcelamento-container { background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .parcelamento-header { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; font-weight: 600; color: var(--gray-700); justify-content: space-between; }
    #rateioControles { display: flex; gap: 0.5rem; }
    #rateioControles .btn-secondary { white-space: nowrap; padding: 6px 12px; font-size: 0.75rem; }
    .totalizacao { background: linear-gradient(135deg, #e8f5e8 0%, #f0f9f0 100%); border: 2px solid var(--primary-green); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    .totalizacao-content { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center; }
    .totalizacao-item { display: flex; flex-direction: column; gap: 0.25rem; }
    .totalizacao-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-600); font-weight: 500; }
    .totalizacao-valor { font-size: 1.125rem; font-weight: 700; color: var(--primary-green); }
    .totalizacao-diferenca { color: var(--red-600); }
    .totalizacao-ok { color: var(--primary-green); }
    #rateioStatusContainer { background: var(--gray-50); border-radius: 8px; padding: 1rem; }
    .progress-bar { background: var(--gray-200); border-radius: 10px; overflow: hidden; height: 6px; }
    .progress-fill { height: 100%; background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-light) 100%); width: 0%; transition: width 0.3s ease; }
    .text-green-600 { color: var(--green-600); }
    .text-red-600 { color: var(--red-600); }
    .text-orange-600 { color: #ea580c; }
    .underline { text-decoration: underline; cursor: pointer; }
    .underline:hover { color: var(--primary-green); }
    .ml-2 { margin-left: 0.5rem; }
    .text-xs { font-size: 0.75rem; }
    /* Switch/Toggle Styles */
    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-green);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    /* Loading states for buttons */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }

    .btn-loading .btn-text {
        opacity: 0;
    }

    .btn-loading .loading-spinner {
        display: inline-block !important;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    /* Enhanced loading spinner */
    .loading-spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        display: none;
        color: var(--gray-600);
        font-size: 0.875rem;
        margin-left: 8px;
    }

    .btn-loading .loading-text {
        display: inline;
    }
    @media (max-width: 768px) {
        .kpis-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .filtros-grid { grid-template-columns: 1fr; }
        .filtros-actions { justify-content: stretch; }
        .fluxo-table th, .fluxo-table td { padding: 0.5rem; font-size: 0.75rem; }
        .totalizacao-content { grid-template-columns: 1fr; gap: 0.5rem; }
    }
    /* Animações */
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .loading-spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg p-6 shadow-lg">
        <h1 class="text-3xl font-bold flex items-center gap-3">
            <i class="fas fa-chart-line"></i>
            Fluxo de Caixa
        </h1>
        <p class="text-green-100 mt-2">Controle completo das suas receitas e despesas</p>
    </div>

    <div id="notifications"></div>

    <div class="kpis-grid">
        <div class="kpi-card receitas">
            <div class="kpi-icon"><i class="fas fa-arrow-up"></i></div>
            <span class="kpi-value">R$ {{ totais.total_receitas_formatado }}</span>
            <div class="kpi-label">Total Receitas</div>
            <div class="kpi-subtitle">R$ {{ totais.total_receitas_pagas_formatado }} realizadas</div>
        </div>
        <div class="kpi-card despesas">
            <div class="kpi-icon"><i class="fas fa-arrow-down"></i></div>
            <span class="kpi-value">R$ {{ totais.total_despesas_formatado }}</span>
            <div class="kpi-label">Total Despesas</div>
            <div class="kpi-subtitle">R$ {{ totais.total_despesas_pagas_formatado }} pagas</div>
        </div>
        <div class="kpi-card saldo">
            <div class="kpi-icon"><i class="fas fa-balance-scale"></i></div>
            <span class="kpi-value">R$ {{ totais.saldo_previsto_formatado }}</span>
            <div class="kpi-label">Saldo Previsto</div>
            <div class="kpi-subtitle">R$ {{ totais.saldo_realizado_formatado }} realizado</div>
        </div>
        <div class="kpi-card vencido">
            <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <span class="kpi-value">R$ {{ totais.vencido_total_formatado }}</span>
            <div class="kpi-label">Valores Vencidos</div>
            <div class="kpi-subtitle">Requer atenção</div>
        </div>
    </div>

    <div class="filtros-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-filter"></i>
                Busca e Filtros
            </div>
            <button class="btn-green" onclick="openModal('novoLancamentoModal')">
                <i class="fas fa-plus"></i>
                Novo Lançamento
            </button>
        </div>
        
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar por descrição, fornecedor, cliente, documento...">
            <i class="fas fa-search search-icon"></i>
        </div>
        
        <form method="GET" id="filtrosForm">
            <div class="filtros-grid">
                <div class="form-group"><label class="form-label">Data Início</label><input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}"></div>
                <div class="form-group"><label class="form-label">Data Fim</label><input type="date" name="data_fim" class="form-control" value="{{ data_fim }}"></div>
                <div class="form-group"><label class="form-label">Categoria</label><select name="categoria" class="form-select"><option value="">Todas</option>{% for categoria in categorias %}<option value="{{ categoria }}" {% if categoria == categoria_filtro %}selected{% endif %}>{{ categoria }}</option>{% endfor %}</select></div>
                <div class="form-group"><label class="form-label">Status</label><select name="status" class="form-select"><option value="">Todos</option><option value="PENDENTE" {% if status_filtro == 'PENDENTE' %}selected{% endif %}>Pendentes</option><option value="A Pagar" {% if status_filtro == 'A Pagar' %}selected{% endif %}>A Pagar</option><option value="PAGO" {% if status_filtro == 'PAGO' %}selected{% endif %}>Pagos</option></select></div>
            </div>
            <div class="filtros-actions">
                <a href="{{ url_for('api_exportar_fluxo_excel', **request.args) }}" class="btn-secondary"><i class="fas fa-file-excel"></i> Exportar</a>
                <button type="button" class="btn-secondary" onclick="limparFiltros()"><i class="fas fa-times"></i> Limpar</button>
                <button type="submit" class="btn-green"><i class="fas fa-search"></i> Filtrar</button>
            </div>
        </form>
    </div>

    <div class="fluxo-container">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-list-alt"></i>
                Movimentações do Período
                <span class="text-base font-normal text-gray-600">(<span id="contadorLancamentos">{{ fluxo_consolidado|length }}</span> lançamento(s))</span>
            </div>
        </div>
        {% if not fluxo_consolidado %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>Nenhuma movimentação encontrada</h3>
                <p>Não há lançamentos para o período ou filtros selecionados</p>
            </div>
        {% else %}
            <div class="fluxo-table-container">
                <table class="fluxo-table" id="fluxoTable">
                    <thead>
                        <tr>
                            <th style="width: 50px; text-align: center;"><input type="checkbox" id="selecionarTodosHeader" onchange="toggleSelecionarTodos(this.checked)"></th>
                            <th>Data Lançamento</th>
                            <th>Vencimento</th>
                            <th>Tipo / Origem</th>
                            <th>Descrição</th>
                            <th>Fornecedor/Cliente</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in fluxo_consolidado %}
                        <tr class="{% if item.is_vencido %}vencido{% elif item.status in ['PAGO', 'Pago'] %}pago{% elif item.data_vencimento == hoje %}hoje{% endif %} table-row" 
                            data-search="{{ (item.descricao or '') | lower }} {{ (item.fornecedor_cliente or '') | lower }} {{ (item.documento or '') | lower }} {{ (item.categoria or '') | lower }}">
                            <td style="width: 50px; text-align: center;">
                                {% if item.tipo_origem == 'MANUAL' and item.status not in ['PAGO', 'Pago'] %}
                                    <input type="checkbox" class="item-checkbox" value="{{ item.id }}" onchange="atualizarSelecao()">
                                {% endif %}
                            </td>
                            <td>
                                <div class="font-semibold">{{ item.data_emissao.strftime('%d/%m/%Y') if item.data_emissao else item.created_at.strftime('%d/%m/%Y') }}</div>
                                <div class="text-xs text-gray-600">Lançamento</div>
                            </td>
                            <td>
                                <div class="font-semibold">{{ item.data_vencimento.strftime('%d/%m/%Y') }}</div>
                                {% if item.data_vencimento == hoje %}<div class="text-xs text-blue-600 font-medium">HOJE</div>
                                {% elif item.is_vencido %}<div class="text-xs text-red-600 font-medium">VENCIDO ({{ (hoje - item.data_vencimento).days }} dias)</div>{% endif %}
                            </td>
                            <td>
                                <div class="tipo-badge {{ 'receita' if item.tipo_movimento == 'RECEITA' else 'despesa' }}">
                                    {% if item.tipo_movimento == 'RECEITA' %}<i class="fas fa-arrow-up"></i> Receita{% else %}<i class="fas fa-arrow-down"></i> Despesa{% endif %}
                                </div>
                                <div class="origem-badge {{ 'nfe' if item.tipo_origem == 'NFE' else 'manual' }} mt-1">{{ item.tipo_origem }}</div>
                            </td>
                            <td>
                                <div class="font-medium">
                                    {{ item.descricao }}
                                    {% if item.tem_rateio %}
                                        <i class="fas fa-truck-moving text-purple-600" title="Despesa rateada"></i>
                                    {% endif %}
                                </div>
                                {% if item.parcela %}<div class="text-xs text-gray-600"><i class="fas fa-layer-group"></i> Parcela {{ item.parcela }}</div>{% endif %}
                                {% if item.documento %}<div class="text-xs text-gray-600">Doc: {{ item.documento }}</div>{% endif %}
                            </td>
                            <td>{{ item.fornecedor_cliente or '-' }}</td>
                            <td><span class="text-sm bg-gray-100 px-2 py-1 rounded">{{ item.categoria }}</span></td>
                            <td>
                                <div class="font-semibold text-lg {{ 'valor-receita' if item.tipo_movimento == 'RECEITA' else 'valor-despesa' }}">
                                    {% if item.tipo_movimento == 'RECEITA' %}+{% else %}-{% endif %} R$ {{ item.valor_formatado }}
                                </div>
                                {% if item.data_pagamento %}<div class="text-xs text-gray-600">Pago em {{ item.data_pagamento.strftime('%d/%m/%Y') }}</div>{% endif %}
                            </td>
                            <td>
                                {% if item.is_vencido %}<span class="status-badge vencido">Vencido</span>
                                {% elif item.status in ['PAGO', 'Pago'] %}<span class="status-badge pago">Pago</span>
                                {% elif item.status == 'A Pagar' %}<span class="status-badge a-pagar">A Pagar</span>
                                {% else %}<span class="status-badge pendente">{{ item.status }}</span>{% endif %}
                                {% if item.meio_pagamento %}<span class="pagamento-badge {{ item.meio_pagamento.lower() }}">{{ item.meio_pagamento }}</span>{% endif %}
                            </td>
                            <td>
                                <button class="btn-table btn-details" data-item-id="{{ item.id }}" title="Ver detalhes"><i class="fas fa-eye"></i></button>
                                
                                {% if item.status not in ['PAGO', 'Pago'] %}
                                    <button class="btn-table btn-pagar" data-item-id="{{ item.id }}" data-item-valor="{{ item.valor }}"><i class="fas fa-check"></i></button>
                                    {% if item.tipo_origem == 'MANUAL' %}
                                        <button class="btn-table btn-edit" data-item-id="{{ item.id }}"><i class="fas fa-edit"></i></button>
                                    {% endif %}
                                    <button class="btn-table btn-rateio {% if item.tem_rateio %}has-rateio{% endif %}" data-item-id="{{ item.id }}" title="{% if item.tem_rateio %}Editar rateio existente{% else %}Ratear lançamento{% endif %}"><i class="fas fa-truck-moving"></i></button>
                                    <button class="btn-table btn-delete" data-item-id="{{ item.id }}"><i class="fas fa-trash"></i></button>
                                {% else %}
                                    <button class="btn-table btn-rateio" data-item-id="{{ item.id }}" title="Visualizar rateio" style="opacity: 0.6;"><i class="fas fa-truck-moving"></i></button>
                                    <button class="btn-table btn-estornar" data-item-id="{{ item.id }}"><i class="fas fa-undo"></i></button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>
</div>

<div id="barraAcoesMassa">
    <span id="contadorSelecionados">0 itens selecionados</span>
    <button class="btn-table btn-massa" id="btnAlterarCategoriaMassa"><i class="fas fa-tags"></i> Alterar Categoria</button>
    <button class="btn-table btn-massa" id="btnMarcarPagoMassa"><i class="fas fa-check-double"></i> Marcar como Pago</button>
    <button class="btn-table btn-massa" id="btnExcluirMassa"><i class="fas fa-trash-alt"></i> Excluir</button>
</div>

<!-- Modal Novo Lançamento -->
<div id="novoLancamentoModal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <div class="modal-title">
                <i class="fas fa-plus"></i>
                Dados do Lançamento
            </div>
            <span class="close" onclick="closeModal('novoLancamentoModal')">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Container de notificações do modal -->
            <div id="modalNotifications"></div>
            
            <form id="novoLancamentoForm">
                <!-- Tipo de Movimento -->
                <div class="form-group">
                    <label class="form-label">Tipo de Movimento *</label>
                    <div class="tipo-movimento-container">
                        <div class="radio-option">
                            <input type="radio" id="tipoReceita" name="tipo_movimento" value="RECEITA">
                            <label for="tipoReceita" class="radio-label receita">
                                <i class="fas fa-arrow-up"></i>
                                <span>Receita</span>
                                <small>Entrada de dinheiro</small>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="tipoDespesa" name="tipo_movimento" value="DESPESA" checked>
                            <label for="tipoDespesa" class="radio-label despesa">
                                <i class="fas fa-arrow-down"></i>
                                <span>Despesa</span>
                                <small>Saída de dinheiro</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Descrição e Categoria -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Descrição *</label>
                        <input type="text" name="descricao" class="form-control" placeholder="Ex: Combustível, Manutenção..." required>
                        <small style="color: var(--gray-600);">Descreva brevemente o lançamento</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select name="categoria" class="form-control" id="categoriaNovoLancamento">
                            <option value="Combustível">Combustível</option>
                            <option value="Manutenção">Manutenção</option>
                            <option value="Peças e Acessórios">Peças e Acessórios</option>
                            <option value="Outras Despesas">Outras Despesas</option>
                        </select>
                        <small style="color: var(--gray-600);">Para melhor organização e relatórios</small>
                    </div>
                </div>

                <!-- Valor e Data de Vencimento -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Valor Total *</label>
                        <input type="number" name="valor" class="form-control" placeholder="0,00" step="0.01" min="0" required id="valorNovoLancamento">
                        <small style="color: var(--gray-600);">Valor em reais (R$)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento *</label>
                        <input type="date" name="data_vencimento" class="form-control" required>
                        <small style="color: var(--gray-600);">Data prevista para pagamento/recebimento</small>
                    </div>
                </div>

                <!-- Data de Emissão e Fornecedor/Cliente -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Data de Emissão</label>
                        <input type="date" name="data_emissao" class="form-control">
                        <small style="color: var(--gray-600);">Data em que o documento foi emitido</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fornecedor/Cliente</label>
                        <input type="text" name="fornecedor_cliente" class="form-control" placeholder="Nome do fornecedor ou cliente">
                    </div>
                </div>

                <!-- Número do Documento -->
                <div class="form-group">
                    <label class="form-label">Número do Documento</label>
                    <input type="text" name="documento" class="form-control" placeholder="NF, Boleto, Contrato...">
                </div>

                <!-- Opções de Pagamento -->
                <div id="marcarPagoSection" style="background: var(--blue-100); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">
                        <i class="fas fa-calendar-check" style="color: var(--blue-600);"></i>
                        <span style="font-weight: 600; color: var(--blue-600);">Marcar como Pago Agora</span>
                        <label style="margin-left: auto;" class="switch">
                            <input type="checkbox" id="marcarPagoAgora">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--blue-700); margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        Ative esta opção se o pagamento já foi realizado
                    </div>
                    
                    <div id="dadosPagamento" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Forma de Pagamento</label>
                                <select id="formaPagamento" class="form-control" style="width: 100%;">
                                    <option value="">Selecione a forma</option>
                                    <option value="PIX">PIX</option>
                                    <option value="Depósito">Depósito</option>
                                    <option value="Transferência">Transferência</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Cartão">Cartão</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700);">Data do Pagamento</label>
                                <input type="date" id="dataPagamento" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opção de Parcelamento -->
                <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem;">
                        <i class="fas fa-layer-group" style="color: var(--gray-600);"></i>
                        <span style="font-weight: 600; color: var(--gray-700);">Parcelar Lançamento</span>
                    </div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 1rem;">
                        <input type="checkbox" id="parcelarLancamento" style="margin: 0;">
                        <span style="font-size: 0.875rem;">Dividir valor em parcelas</span>
                    </label>
                    
                    <div id="parcelamentoOptions" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Número de Parcelas:</label>
                                <input type="number" id="numeroParcelas" min="2" max="36" value="2" style="width: 100px; padding: 8px 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 0.875rem;">
                            </div>
                            <button type="button" class="btn-secondary" id="gerarParcelasBtn">
                                <i class="fas fa-magic"></i> 
                                <span class="btn-text">Gerar Parcelas</span>
                                <span class="loading-spinner" id="loadingGerar" style="display: none;"></span>
                            </button>
                        </div>
                        
                        <div style="background: var(--gray-100); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 8px; font-size: 0.875rem; color: var(--gray-700);">
                                <i class="fas fa-calendar-alt" style="color: var(--primary-green);"></i>
                                <span><strong>Intervalo:</strong> 30 dias entre cada parcela (editável após gerar)</span>
                            </div>
                        </div>

                        <!-- Prévia das Parcelas -->
                        <div id="previaParcelasContainer" style="display: none;">
                            <div style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; color: var(--green-600); font-weight: 600;">
                                    <i class="fas fa-list-alt"></i>
                                    <span>Prévia das Parcelas</span>
                                </div>
                                <div id="listaParcelasPrevia"></div>
                                <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                    <span style="font-size: 0.875rem; color: var(--gray-600);">✏️ Você pode editar as datas e valores de cada parcela</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção de Rateio -->
                <div id="secaoRateio">
                    <div class="form-group">
                        <label class="form-label">Rateio do Lançamento</label>
                        <div class="tipo-movimento-container">
                            <div class="radio-option">
                                <input type="radio" id="semRateioNovo" name="tipo_rateio" value="sem_rateio" checked>
                                <label for="semRateioNovo" class="radio-label despesa">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    <span>Lançamento Geral</span>
                                    <small>Lançar como geral da empresa</small>
                                </label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="comRateioNovo" name="tipo_rateio" value="com_rateio">
                                <label for="comRateioNovo" class="radio-label despesa">
                                    <i class="fas fa-truck-moving"></i>
                                    <span>Ratear por Veículo</span>
                                    <small>Dividir o custo entre veículos específicos</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="containerRateioNovo" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Buscar Veículos (Placa ou Modelo)</label>
                            <div class="search-container">
                                <input type="text" id="veiculoSearchInputNovo" placeholder="Digite para buscar e adicionar múltiplos veículos..." autocomplete="off" class="form-control">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <div id="veiculoSearchResultsNovo" class="list-group mt-2 position-absolute bg-white shadow-lg rounded" style="z-index: 1001; width: calc(100% - 4rem);"></div>
                        </div>
                        
                        <div class="parcelamento-container">
                            <div class="parcelamento-header">
                                <i class="fas fa-list-ul"></i>
                                <span>Veículos para Rateio</span>
                                <div id="rateioControlesNovo" style="display: none;">
                                    <button type="button" class="btn-secondary" onclick="distribuirIgualmenteNovo()"><i class="fas fa-equals"></i> Dividir Igual</button>
                                    <button type="button" class="btn-secondary" onclick="ajustarAutomaticamenteNovo()"><i class="fas fa-magic"></i> Ajustar Auto</button>
                                    <button type="button" class="btn-secondary" onclick="limparRateioNovo()"><i class="fas fa-trash"></i> Limpar</button>
                                </div>
                            </div>
                            <div id="veiculosRateioContainerNovo" class="mt-3">
                                <div class="text-center text-gray-500 my-4" id="rateioEmptyNovo">
                                    <i class="fas fa-truck" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                                    <p>Nenhum veículo selecionado</p>
                                </div>
                            </div>
                            <div class="totalizacao mt-4" id="rateioTotalizacaoNovo">
                                <div class="totalizacao-content">
                                    <div class="totalizacao-item"><span class="totalizacao-label">Valor Total</span><span class="totalizacao-valor" id="rateioValorNotaNovo">R$ 0,00</span></div>
                                    <div class="totalizacao-item"><span class="totalizacao-label">Total Rateado</span><span class="totalizacao-valor" id="rateioTotalAlocadoNovo">R$ 0,00</span></div>
                                    <div class="totalizacao-item"><span class="totalizacao-label">Diferença</span><span class="totalizacao-valor" id="rateioDiferencaNovo">R$ 0,00</span></div>
                                </div>
                                <div class="mt-3" id="rateioStatusContainerNovo">
                                    <div class="progress-bar" id="rateioProgressBarNovo" style="display: block; height: 6px;"><div class="progress-fill" id="rateioProgressFillNovo"></div></div>
                                    <div class="text-center mt-2" id="rateioStatusNovo"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observações -->
                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea name="observacoes" class="form-control" rows="3" placeholder="Informações adicionais sobre este lançamento..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeModal('novoLancamentoModal')">
                <i class="fas fa-times"></i> Voltar
            </button>
            <button class="btn-green" id="btnCriarLancamento">
                <i class="fas fa-save"></i>
                <span class="loading-spinner" style="display: none;"></span>
                <span class="btn-text">Criar Lançamento</span>
            </button>
        </div>
    </div>
</div>

{% include 'modals/fluxo_caixa_modals.html' %}

<div id="rateioModal" class="modal">
    <div class="modal-content extra-large">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-truck-moving"></i> Rateio de Despesa por Veículo</div>
            <span class="close" onclick="closeModal('rateioModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div id="dadosLancamentoRateio" style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;"></div>
            <div id="containerRateio">
                <div class="form-group">
                    <label class="form-label">Buscar Veículos (Placa ou Modelo)</label>
                    <div class="search-container">
                        <input type="text" id="veiculoSearchInput" placeholder="Digite para buscar e adicionar múltiplos veículos..." autocomplete="off" class="form-control">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div id="veiculoSearchResults" class="list-group mt-2 position-absolute bg-white shadow-lg rounded" style="z-index: 1001; width: calc(100% - 4rem);"></div>
                </div>
                <div class="parcelamento-container">
                    <div class="parcelamento-header">
                        <i class="fas fa-list-ul"></i><span>Veículos para Rateio</span>
                        <div id="rateioControles" style="display: none;">
                            <button type="button" class="btn-secondary" onclick="distribuirIgualmente()"><i class="fas fa-equals"></i> Dividir Igual</button>
                            <button type="button" class="btn-secondary" onclick="ajustarAutomaticamente()"><i class="fas fa-magic"></i> Ajustar Auto</button>
                            <button type="button" class="btn-secondary" onclick="limparRateio()"><i class="fas fa-trash"></i> Limpar</button>
                        </div>
                    </div>
                    <div id="veiculosRateioContainer" class="mt-3">
                        <div class="text-center text-gray-500 my-4" id="rateioEmpty">
                            <i class="fas fa-truck" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                            <p>Nenhum veículo selecionado</p>
                        </div>
                    </div>
                    <div class="totalizacao mt-4" id="rateioTotalizacao">
                        <div class="totalizacao-content">
                            <div class="totalizacao-item"><span class="totalizacao-label">Valor Total</span><span class="totalizacao-valor" id="rateioValorNota">R$ 0,00</span></div>
                            <div class="totalizacao-item"><span class="totalizacao-label">Total Rateado</span><span class="totalizacao-valor" id="rateioTotalAlocado">R$ 0,00</span></div>
                            <div class="totalizacao-item"><span class="totalizacao-label">Diferença</span><span class="totalizacao-valor" id="rateioDiferenca">R$ 0,00</span></div>
                        </div>
                        <div class="mt-3" id="rateioStatusContainer">
                            <div class="progress-bar" id="rateioProgressBar" style="display: block; height: 6px;"><div class="progress-fill" id="rateioProgressFill"></div></div>
                            <div class="text-center mt-2" id="rateioStatus"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="btnExcluirRateio" style="margin-right: auto; background: #dc3545;">
                <i class="fas fa-times-circle"></i> Remover Rateio
            </button>
            <button type="button" class="btn-secondary" onclick="closeModal('rateioModal')">Cancelar</button>
            <button class="btn-green" id="btnSalvarRateio">
                <i class="fas fa-save"></i>
                <span class="loading-spinner" style="display: none;"></span>
                <span class="btn-text">Salvar Rateio</span>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Variáveis globais para o sistema de rateio
    let valorTotalLancamento = 0;
    let lancamentoIdAtual = null;
    let veiculosSelecionados = new Map();
    
    // Variáveis para o novo lançamento
    let valorTotalNovoLancamento = 0;
    let veiculosSelecionadosNovo = new Map();

    // FUNÇÃO UTILITÁRIA PARA GERENCIAR LOADING STATES
    function setLoadingState(buttonId, isLoading) {
        const btn = document.getElementById(buttonId);
        if (!btn) return;
        
        const spinner = btn.querySelector('.loading-spinner');
        const btnText = btn.querySelector('.btn-text');
        
        if (isLoading) {
            btn.disabled = true;
            btn.classList.add('btn-loading');
            if (spinner) spinner.style.display = 'inline-block';
            if (btnText) btnText.style.opacity = '0';
        } else {
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            if (spinner) spinner.style.display = 'none';
            if (btnText) btnText.style.opacity = '1';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Lógica de Modais - versão simples e funcional
        window.openModal = function(id) {
            document.getElementById(id).style.display = 'block';
            // Limpar notificações se for o modal de novo lançamento
            if (id === 'novoLancamentoModal') {
                clearModalNotifications();
            }
        };
        
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
            // Reset específico para o modal de novo lançamento
            if (id === 'novoLancamentoModal') {
                resetarModalNovoLancamento();
            }
        };
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                const modalId = event.target.id;
                closeModal(modalId);
            }
        };
        
        // Lógica de Busca na Tabela
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#fluxoTable tbody tr');
            let visibleCount = 0;
            rows.forEach(row => {
                const searchData = row.dataset.search;
                if (searchData.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            document.getElementById('contadorLancamentos').textContent = visibleCount;
        });
        
        // Event delegation para todos os botões de ação na tabela
        document.getElementById('fluxoTable')?.addEventListener('click', function(e) {
            const button = e.target.closest('button.btn-table');
            if (!button) return;

            const itemId = button.dataset.itemId;
            if (button.classList.contains('btn-details')) carregarDetalhesLancamento(itemId);
            if (button.classList.contains('btn-pagar')) abrirModalPagamento(itemId, button.dataset.itemValor);
            if (button.classList.contains('btn-edit')) abrirModalEdicao(itemId);
            if (button.classList.contains('btn-rateio')) openRateioModal(itemId);
            if (button.classList.contains('btn-delete')) abrirModalExclusao(itemId);
            if (button.classList.contains('btn-estornar')) abrirModalEstorno(itemId);
            if (button.classList.contains('btn-duplicar')) abrirModalDuplicar(itemId);
        });
        
        // Forms dos Modais
        document.getElementById('pagamentoForm')?.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/marcar_pago'));
        document.getElementById('edicaoForm')?.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/salvar_edicao'));
        document.getElementById('exclusaoForm')?.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/excluir'));
        document.getElementById('estornoForm')?.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/estornar_pagamento'));
        document.getElementById('duplicarForm')?.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/duplicar'));
        document.getElementById('alterarCategoriaMassaForm')?.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/alterar_categoria_massa', true));

        // Ações em Massa
        document.getElementById('btnAlterarCategoriaMassa')?.addEventListener('click', () => {
            const selectedCount = getSelectedItems().length;
            if (selectedCount > 0) {
                 document.getElementById('contadorModalCategoria').textContent = selectedCount;
                 openModal('alterarCategoriaMassaModal');
            }
        });

        // Lógica de Rateio
        document.getElementById('veiculoSearchInput')?.addEventListener('input', buscarVeiculos);
        document.getElementById('btnSalvarRateio')?.addEventListener('click', salvarRateio);
        document.getElementById('btnExcluirRateio')?.addEventListener('click', excluirRateio);

        // Novo Lançamento
        configurarNovoLancamento();
    });

    function configurarNovoLancamento() {
        // Configurar mudanças de tipo de movimento
        document.querySelectorAll('input[name="tipo_movimento"]').forEach(radio => {
            radio.addEventListener('change', function() {
                atualizarCategoriasDisponiveis();
            });
        });

        // Configurar valor total
        document.getElementById('valorNovoLancamento')?.addEventListener('input', function() {
            valorTotalNovoLancamento = parseFloat(this.value) || 0;
            document.getElementById('rateioValorNotaNovo').textContent = formatarMoeda(valorTotalNovoLancamento);
            atualizarTotalRateioNovo();
        });

        // Configurar toggle "Marcar como Pago"
        document.getElementById('marcarPagoAgora')?.addEventListener('change', function() {
            const dadosPagamento = document.getElementById('dadosPagamento');
            if (this.checked) {
                dadosPagamento.style.display = 'block';
                // Setar data atual como padrão
                document.getElementById('dataPagamento').valueAsDate = new Date();
            } else {
                dadosPagamento.style.display = 'none';
                // Limpar campos
                document.getElementById('formaPagamento').value = '';
                document.getElementById('dataPagamento').value = '';
            }
        });

        // Configurar parcelamento
        document.getElementById('parcelarLancamento')?.addEventListener('change', function() {
            document.getElementById('parcelamentoOptions').style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                document.getElementById('previaParcelasContainer').style.display = 'none';
            }
        });

        // Botão gerar parcelas
        document.getElementById('gerarParcelasBtn')?.addEventListener('click', gerarParcelasAutomaticamente);

        // Configurar rateio no novo lançamento
        document.getElementById('semRateioNovo')?.addEventListener('change', toggleRateioNovo);
        document.getElementById('comRateioNovo')?.addEventListener('change', toggleRateioNovo);
        document.getElementById('veiculoSearchInputNovo')?.addEventListener('input', buscarVeiculosNovo);

        // Botão criar lançamento
        document.getElementById('btnCriarLancamento')?.addEventListener('click', criarLancamento);

        // Inicializar estado
        atualizarCategoriasDisponiveis();
        
        // Setar data de vencimento padrão (hoje + 30 dias)
        const hoje = new Date();
        const dataVencimento = new Date(hoje.getTime() + (30 * 24 * 60 * 60 * 1000));
        const dataVencimentoInput = document.querySelector('input[name="data_vencimento"]');
        const dataEmissaoInput = document.querySelector('input[name="data_emissao"]');
        
        if (dataVencimentoInput) dataVencimentoInput.valueAsDate = dataVencimento;
        if (dataEmissaoInput) dataEmissaoInput.valueAsDate = hoje;
    }

    function gerarParcelasAutomaticamente() {
        const numParcelas = parseInt(document.getElementById('numeroParcelas').value);
        const valor = parseFloat(document.getElementById('valorNovoLancamento').value) || 0;

        if (!numParcelas || numParcelas < 2 || numParcelas > 36) {
            showModalNotification('Número de parcelas deve ser entre 2 e 36!', 'error');
            return;
        }

        if (valor <= 0) {
            showModalNotification('Informe o valor total antes de gerar as parcelas!', 'error');
            return;
        }

        const dataBase = new Date(document.querySelector('input[name="data_vencimento"]').value);
        
        if (!dataBase || isNaN(dataBase.getTime())) {
            showModalNotification('Defina a data de vencimento antes de gerar as parcelas!', 'error');
            return;
        }

        // Mostrar loading
        setLoadingState('gerarParcelasBtn', true);

        // Simular carregamento
        setTimeout(() => {
            const valorPorParcela = valor / numParcelas;
            const listaParcelas = document.getElementById('listaParcelasPrevia');
            listaParcelas.innerHTML = '';

            for (let i = 0; i < numParcelas; i++) {
                const dataVencimento = new Date(dataBase);
                // Sempre 30 dias de intervalo
                dataVencimento.setDate(dataBase.getDate() + (i * 30));

                const parcelaDiv = document.createElement('div');
                parcelaDiv.className = 'parcela-preview-item fade-in';
                parcelaDiv.style.cssText = `
                    display: grid; 
                    grid-template-columns: auto 1fr 1fr auto; 
                    gap: 1rem; 
                    align-items: center; 
                    padding: 0.75rem; 
                    border: 1px solid var(--gray-200); 
                    border-radius: 8px; 
                    margin-bottom: 0.5rem;
                    background: white;
                `;

                parcelaDiv.innerHTML = `
                    <div style="
                        background: var(--primary-green); 
                        color: white; 
                        width: 30px; 
                        height: 30px; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-weight: bold; 
                        font-size: 0.875rem;
                    ">
                        ${i + 1}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <label style="font-size: 0.75rem; font-weight: 600; color: var(--gray-600);">Data de Vencimento</label>
                        <input type="date" value="${dataVencimento.toISOString().split('T')[0]}" 
                               style="padding: 6px 10px; border: 2px solid var(--gray-200); border-radius: 6px; font-size: 0.875rem;">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <label style="font-size: 0.75rem; font-weight: 600; color: var(--gray-600);">Valor (R$)</label>
                        <input type="number" value="${valorPorParcela.toFixed(2)}" step="0.01" min="0"
                               style="padding: 6px 10px; border: 2px solid var(--gray-200); border-radius: 6px; font-size: 0.875rem; text-align: right;">
                    </div>
                    <div style="text-align: center;">
                        <span style="font-size: 0.75rem; color: var(--green-600); font-weight: 600;">
                            Parcela ${i + 1}
                        </span>
                        <br>
                        <span style="font-size: 0.65rem; color: var(--gray-500);">
                            ${i === 0 ? 'Base' : `+${i * 30} dias`}
                        </span>
                    </div>
                `;

                listaParcelas.appendChild(parcelaDiv);
            }

            document.getElementById('previaParcelasContainer').style.display = 'block';
            
            showModalNotification(`${numParcelas} parcelas geradas com sucesso! Intervalo de 30 dias entre cada uma.`, 'success');

            // Remover loading
            setLoadingState('gerarParcelasBtn', false);
        }, 800); // Simulação de 800ms de carregamento
    }

    function atualizarCategoriasDisponiveis() {
        const tipoDespesa = document.getElementById('tipoDespesa')?.checked;
        const select = document.getElementById('categoriaNovoLancamento');
        
        if (!select) return;
        
        select.innerHTML = '';
        
        if (tipoDespesa) {
            const categoriasDespesa = [
                'Combustível', 'Manutenção', 'Peças e Acessórios', 
                'Fornecedores (NFe)', 'Outras Despesas'
            ];
            categoriasDespesa.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        } else {
            const categoriasReceita = [
                'Frete', 'Serviços de Transporte', 'Outras Receitas'
            ];
            categoriasReceita.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }
    }

    function toggleRateioNovo() {
        const tipoSelecionado = document.querySelector('input[name="tipo_rateio"]:checked')?.value;
        const containerRateio = document.getElementById('containerRateioNovo');
        
        if (tipoSelecionado === 'com_rateio') {
            containerRateio.style.display = 'block';
            document.getElementById('rateioValorNotaNovo').textContent = formatarMoeda(valorTotalNovoLancamento);
        } else {
            containerRateio.style.display = 'none';
            veiculosSelecionadosNovo.clear();
            document.getElementById('veiculoSearchInputNovo').value = '';
            document.getElementById('veiculoSearchResultsNovo').innerHTML = '';
        }
    }

    async function buscarVeiculosNovo(event) {
        const searchTerm = event.target.value;
        const resultsContainer = document.getElementById('veiculoSearchResultsNovo');
        if (searchTerm.length < 2) { resultsContainer.innerHTML = ''; return; }
        try {
            // Simular busca por veículos
            const veiculos = [
                { id: 1, display: "ABC-1234 - Scania R440" },
                { id: 2, display: "DEF-5678 - Volvo FH" },
                { id: 3, display: "GHI-9012 - Mercedes Actros" }
            ].filter(v => v.display.toLowerCase().includes(searchTerm.toLowerCase()));
            
            resultsContainer.innerHTML = '';
            const veiculosDisponiveis = veiculos.filter(v => !veiculosSelecionadosNovo.has(v.id));
            
            if (veiculosDisponiveis.length === 0) {
                resultsContainer.innerHTML = '<div class="list-group-item text-muted">Nenhum veículo encontrado ou já adicionado</div>'; 
                return;
            }
            
            veiculosDisponiveis.forEach(veiculo => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.textContent = veiculo.display;
                item.onclick = (e) => { 
                    e.preventDefault(); 
                    adicionarVeiculoParaRateioNovo(veiculo); 
                    resultsContainer.innerHTML = ''; 
                    event.target.value = ''; 
                };
                resultsContainer.appendChild(item);
            });
        } catch (error) { 
            handleError(error); 
        }
    }

    function adicionarVeiculoParaRateioNovo(veiculo) {
        if (veiculosSelecionadosNovo.has(veiculo.id)) return;
        const valorInicial = veiculosSelecionadosNovo.size === 0 ? valorTotalNovoLancamento : 0;
        veiculosSelecionadosNovo.set(veiculo.id, { ...veiculo, valor: valorInicial });
        renderizarVeiculosRateioNovo();
    }

    function removerVeiculoDoRateioNovo(veiculoId) {
        veiculosSelecionadosNovo.delete(veiculoId);
        renderizarVeiculosRateioNovo();
    }

    function renderizarVeiculosRateioNovo() {
        const container = document.getElementById('veiculosRateioContainerNovo');
        const emptyState = document.getElementById('rateioEmptyNovo');
        const controles = document.getElementById('rateioControlesNovo');
        
        if (!container) return;
        
        container.innerHTML = '';
        
        if (veiculosSelecionadosNovo.size === 0) {
            container.innerHTML = emptyState.outerHTML;
            controles.style.display = 'none';
        } else {
            controles.style.display = 'flex';
            let index = 1;
            veiculosSelecionadosNovo.forEach(veiculo => {
                const percentual = valorTotalNovoLancamento > 0 ? ((veiculo.valor / valorTotalNovoLancamento) * 100) : 0;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'veiculo-rateio-item';
                itemDiv.innerHTML = `
                    <div class="veiculo-header">
                        <div class="veiculo-numero">${index}</div>
                        <div class="veiculo-info"><span class="veiculo-nome">${veiculo.display}</span></div>
                        <button type="button" class="btn-delete-veiculo" onclick="removerVeiculoDoRateioNovo(${veiculo.id})"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="veiculo-valores">
                        <div class="valor-input-group"><label>Valor (R$)</label><input type="number" class="rateio-valor-input" data-id="${veiculo.id}" value="${(veiculo.valor || 0).toFixed(2)}" oninput="atualizarValorRateioNovo(${veiculo.id}, this.value)"></div>
                        <div class="valor-input-group"><label>Percentual (%)</label><input type="number" class="rateio-percentual-input" data-id="${veiculo.id}" value="${percentual.toFixed(1)}" oninput="atualizarPercentualRateioNovo(${veiculo.id}, this.value)"></div