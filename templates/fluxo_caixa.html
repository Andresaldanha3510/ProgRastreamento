{% extends "base.html" %}
{% block title %}Fluxo de Caixa - TrackBras{% endblock %}

{% block styles %}
<style>
    :root {
        --primary-green: #2e7d32;
        --primary-green-dark: #1b5e20;
        --primary-green-light: #4caf50;
        --accent-yellow: #ffc107;
        --red-600: #dc2626;
        --red-100: #fee2e2;
        --green-600: #16a34a;
        --green-100: #dcfce7;
        --blue-600: #2563eb;
        --blue-100: #dbeafe;
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-900: #0f172a;
    }

    .fluxo-container {
        background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-200);
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        color: var(--primary-green-dark);
        font-size: 1.25rem;
        font-weight: 600;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        color: var(--primary-green);
        font-size: 1.5rem;
    }

    .btn-green {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-dark) 100%);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-green:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
        color: white;
        text-decoration: none;
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
    }

    .btn-secondary:hover {
        color: white;
        text-decoration: none;
        opacity: 0.9;
    }

    /* KPIs Dashboard */
    .kpis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .kpi-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        border: 1px solid var(--gray-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
    }

    .kpi-card.receitas::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--green-600) 0%, var(--primary-green-light) 100%);
    }

    .kpi-card.despesas::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--red-600) 0%, #ef4444 100%);
    }

    .kpi-card.saldo::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--blue-600) 0%, #3b82f6 100%);
    }

    .kpi-card.vencido::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #f59e0b 0%, var(--accent-yellow) 100%);
    }

    .kpi-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .kpi-card.receitas .kpi-icon {
        color: var(--green-600);
    }

    .kpi-card.despesas .kpi-icon {
        color: var(--red-600);
    }

    .kpi-card.saldo .kpi-icon {
        color: var(--blue-600);
    }

    .kpi-card.vencido .kpi-icon {
        color: #f59e0b;
    }

    .kpi-value {
        font-size: 1.75rem;
        font-weight: 700;
        display: block;
        margin-bottom: 0.25rem;
    }

    .kpi-card.receitas .kpi-value {
        color: var(--green-600);
    }

    .kpi-card.despesas .kpi-value {
        color: var(--red-600);
    }

    .kpi-card.saldo .kpi-value {
        color: var(--blue-600);
    }

    .kpi-card.vencido .kpi-value {
        color: #f59e0b;
    }

    .kpi-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        font-weight: 500;
    }

    .kpi-subtitle {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }

    /* Filtros e Busca */
    .filtros-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--gray-200);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .search-container {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-input {
        width: 100%;
        padding: 12px 45px 12px 16px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 1rem;
    }

    .filtros-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-900);
        font-size: 0.875rem;
    }

    .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }

    .form-select {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        background: white;
        font-size: 0.875rem;
        cursor: pointer;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    .filtros-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: flex-end;
        align-items: center;
    }

    /* Tabela do Fluxo */
    .fluxo-table-container {
        background: white;
        border-radius: 12px;
        overflow-x: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-200);
    }

    .fluxo-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px;
    }

    .fluxo-table th {
        background: linear-gradient(135deg, var(--primary-green-dark) 0%, var(--primary-green) 100%);
        color: white;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .fluxo-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
        font-size: 0.875rem;
    }

    .fluxo-table tr:hover {
        background: var(--gray-50);
    }

    /* Status específicos */
    .fluxo-table tr.vencido {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .fluxo-table tr.vencido:hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
    }

    .fluxo-table tr.pago {
        background: linear-gradient(135deg, var(--green-100) 0%, #bbf7d0 100%);
    }

    .fluxo-table tr.hoje {
        background: linear-gradient(135deg, var(--blue-100) 0%, #bfdbfe 100%);
        border-left: 4px solid var(--blue-600);
    }

    /* Badges de status */
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .status-badge.pendente,
    .status-badge.a-pagar {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }

    .status-badge.vencido {
        background: linear-gradient(135deg, #f59e0b 0%, var(--accent-yellow) 100%);
        color: white;
    }

    .status-badge.pago {
        background: linear-gradient(135deg, var(--green-600) 0%, var(--primary-green-light) 100%);
        color: white;
    }

    /* Tipos de movimento */
    .tipo-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .tipo-badge.receita {
        background: var(--green-100);
        color: var(--green-600);
    }

    .tipo-badge.despesa {
        background: var(--red-100);
        color: var(--red-600);
    }

    /* Valores monetários */
    .valor-receita {
        color: var(--green-600);
        font-weight: 600;
    }

    .valor-despesa {
        color: var(--red-600);
        font-weight: 600;
    }

    /* Origem dos dados */
    .origem-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .origem-badge.nfe {
        background: #e0f2fe;
        color: #0277bd;
    }

    .origem-badge.manual {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    /* Forma de Pagamento */
    .pagamento-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
        display: inline-block;
    }

    /* Botões de ação */
    .btn-table {
        padding: 4px 8px;
        border: none;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
        cursor: pointer;
        margin-right: 4px;
        margin-bottom: 4px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.3s;
    }

    .btn-table.btn-pagar {
        background: var(--primary-green);
        color: white;
    }

    .btn-table.btn-pagar:hover {
        background: var(--primary-green-dark);
    }

    .btn-table.btn-view {
        background: #17a2b8;
        color: white;
    }

    .btn-table.btn-view:hover {
        background: #138496;
    }

    .btn-table.btn-edit {
        background: #ffc107;
        color: #212529;
    }

    .btn-table.btn-edit:hover {
        background: #e0a800;
    }

    .btn-table.btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-table.btn-delete:hover {
        background: #c82333;
    }

    .btn-table.btn-estornar {
        background: #6c757d;
        color: white;
    }

    .btn-table.btn-estornar:hover {
        background: #5a6268;
    }

    .btn-table.btn-details {
        background: #007bff;
        color: white;
    }

    .btn-table.btn-details:hover {
        background: #0056b3;
    }

    .btn-table.btn-rateio {
        background: #6f42c1;
        color: white;
    }

    .btn-table.btn-rateio:hover {
        background: #5a349b;
    }

    .btn-table.btn-duplicar {
        background: #007bff;
        color: white;
    }

    .btn-table.btn-duplicar:hover {
        background: #0056b3;
    }

    /* Ações em Massa */
    #barraAcoesMassa {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-700) 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        z-index: 999;
        transition: bottom 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    #barraAcoesMassa.visible {
        bottom: 20px;
    }

    #contadorSelecionados {
        font-weight: 600;
    }

    .btn-massa {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        animation: modalSlide 0.3s ease-out;
        overflow: hidden;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }

    .modal-body {
        overflow-y: auto;
        padding: 2rem;
        flex-grow: 1;
    }

    .modal-content.large {
        max-width: 700px;
    }

    .modal-content.extra-large {
        max-width: 900px;
    }

    .modal-content form {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        min-height: 0;
    }

    @keyframes modalSlide {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, var(--primary-green-dark) 0%, var(--primary-green) 100%);
        color: white;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .close {
        color: white;
        font-size: 1.75rem;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s;
        line-height: 1;
    }

    .close:hover {
        opacity: 0.7;
    }

    .modal-footer {
        padding: 1rem 2rem;
        background-color: var(--gray-50);
        text-align: right;
        border-top: 1px solid var(--gray-200);
        flex-shrink: 0;
    }

    /* Detalhes do lançamento no modal */
    .detail-row {
        display: flex;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .detail-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .detail-label {
        font-weight: 600;
        color: var(--gray-700);
        min-width: 140px;
    }

    .detail-value {
        color: var(--gray-900);
        flex: 1;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 4rem 1.5rem;
        color: var(--gray-600);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        color: var(--gray-300);
    }

    .empty-state h3 {
        margin-bottom: 0.75rem;
        color: var(--gray-700);
        font-size: 1.25rem;
    }

    /* Animações */
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .loading-spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* ESTILOS UNIFICADOS PARA RATEIO E PARCELAMENTO */
    .search-box {
        position: relative;
    }

    .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-600);
    }

    .parcelamento-container {
        background: var(--gray-50);
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }

    .parcelamento-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
        font-weight: 600;
        color: var(--gray-700);
        justify-content: space-between;
    }

    .veiculo-rateio-item {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .veiculo-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        gap: 12px;
    }

    .veiculo-numero {
        background: linear-gradient(135deg, var(--blue-600) 0%, #1e40af 100%);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .veiculo-info {
        flex: 1;
    }

    .veiculo-nome {
        font-weight: 600;
        color: var(--gray-900);
    }

    .veiculo-percentual {
        font-size: 0.75rem;
        color: var(--primary-green);
        font-weight: 600;
        background: var(--green-100);
        padding: 2px 8px;
        border-radius: 12px;
        display: inline-block;
        width: fit-content;
    }

    .btn-delete-veiculo {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .btn-delete-veiculo:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .veiculo-valores {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .valor-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .valor-input-group label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .rateio-valor-input,
    .rateio-percentual-input {
        padding: 10px 12px;
        border: 2px solid var(--gray-200);
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s;
        text-align: right;
    }

    .totalizacao {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0f9f0 100%);
        border: 2px solid var(--primary-green);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .totalizacao-content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        text-align: center;
    }

    .totalizacao-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .totalizacao-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-600);
        font-weight: 500;
    }

    .totalizacao-valor {
        font-size: 1.125rem;
        font-weight: 700;
    }

    .text-red-600 {
        color: #dc2626;
    }

    .text-green-600 {
        color: var(--green-600);
    }

    .parcela-item {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: grid;
        grid-template-columns: auto 1fr 1fr;
        gap: 1rem;
        align-items: center;
    }

    .parcela-numero {
        background: var(--primary-green);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .parcela-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .parcela-input-group label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--gray-600);
    }

    .parcela-input-group input {
        padding: 8px 12px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
    }

    .validation-error {
        background: #fef2f2;
        border: 2px solid #fecaca;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0 0 0;
        display: none;
    }

    .validation-error.show {
        display: block;
    }

    .validation-error-content {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #dc2626;
        font-weight: 500;
    }

    .tipo-movimento-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .radio-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .radio-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .radio-label i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }

    .radio-label span {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .radio-label small {
        font-size: 0.75rem;
        color: var(--gray-600);
        line-height: 1.2;
    }

    .radio-label.receita i {
        color: var(--green-600);
    }

    .radio-label.despesa i {
        color: var(--red-600);
    }

    .radio-option input[type="radio"]:checked+.radio-label {
        border-color: var(--primary-green);
        background: var(--gray-50);
    }

    /* Grid utilities */
    .grid {
        display: grid;
    }

    .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }

    .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .gap-4 {
        gap: 1rem;
    }

    .col-span-2 {
        grid-column: span 2 / span 2;
    }

    @media (min-width: 768px) {
        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    /* Utility classes */
    .text-center {
        text-align: center;
    }

    .text-lg {
        font-size: 1.125rem;
    }

    .font-bold {
        font-weight: 700;
    }

    .font-semibold {
        font-weight: 600;
    }

    .font-medium {
        font-weight: 500;
    }

    .my-2 {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .my-4 {
        margin: 1rem 0;
    }

    .mt-1 {
        margin-top: 0.25rem;
    }

    .mt-2 {
        margin-top: 0.5rem;
    }

    .mt-4 {
        margin-top: 1rem;
    }

    .mb-4 {
        margin-bottom: 1rem;
    }

    .text-xs {
        font-size: 0.75rem;
    }

    .text-sm {
        font-size: 0.875rem;
    }

    .text-base {
        font-size: 1rem;
    }

    .text-gray-500 {
        color: #6b7280;
    }

    .text-gray-600 {
        color: var(--gray-600);
    }

    .text-red-600 {
        color: var(--red-600);
    }

    .bg-gray-100 {
        background-color: var(--gray-100);
    }

    .px-2 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .py-1 {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
    }

    .p-2 {
        padding: 0.5rem;
    }

    .p-4 {
        padding: 1rem;
    }

    .rounded {
        border-radius: 0.25rem;
    }

    .rounded-lg {
        border-radius: 0.5rem;
    }

    .shadow-md {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .position-absolute {
        position: absolute;
    }

    .bg-white {
        background-color: white;
    }

    .flex {
        display: flex;
    }

    .items-center {
        align-items: center;
    }

    .gap-3 {
        gap: 0.75rem;
    }

    .space-y-6> :not([hidden])~ :not([hidden]) {
        margin-top: 1.5rem;
    }

    /* Button variants */
    .btn {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background-color: #e0a800;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    /* List group styles */
    .list-group {
        display: flex;
        flex-direction: column;
        padding-left: 0;
        margin-bottom: 0;
        border-radius: 0.375rem;
    }

    .list-group-item {
        position: relative;
        display: block;
        padding: 0.75rem 1.25rem;
        background-color: #fff;
        border: 1px solid rgba(0, 0, 0, .125);
        text-decoration: none;
        color: #495057;
    }

    .list-group-item:first-child {
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
    }

    .list-group-item:last-child {
        border-bottom-right-radius: inherit;
        border-bottom-left-radius: inherit;
    }

    .list-group-item-action {
        cursor: pointer;
    }

    .list-group-item-action:hover {
        background-color: #f8f9fa;
    }

    .text-muted {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg p-6 shadow-lg">
        <h1 class="text-3xl font-bold flex items-center gap-3">
            <i class="fas fa-chart-line"></i>
            Fluxo de Caixa
        </h1>
        <p class="text-green-100 mt-2">Controle completo das suas receitas e despesas</p>
    </div>

    <div id="notifications"></div>

    <div class="kpis-grid">
        <div class="kpi-card receitas">
            <div class="kpi-icon"><i class="fas fa-arrow-up"></i></div>
            <span class="kpi-value">R$ {{ totais.total_receitas_formatado }}</span>
            <div class="kpi-label">Total Receitas</div>
            <div class="kpi-subtitle">R$ {{ totais.total_receitas_pagas_formatado }} realizadas</div>
        </div>
        <div class="kpi-card despesas">
            <div class="kpi-icon"><i class="fas fa-arrow-down"></i></div>
            <span class="kpi-value">R$ {{ totais.total_despesas_formatado }}</span>
            <div class="kpi-label">Total Despesas</div>
            <div class="kpi-subtitle">R$ {{ totais.total_despesas_pagas_formatado }} pagas</div>
        </div>
        <div class="kpi-card saldo">
            <div class="kpi-icon"><i class="fas fa-balance-scale"></i></div>
            <span class="kpi-value">R$ {{ totais.saldo_previsto_formatado }}</span>
            <div class="kpi-label">Saldo Previsto</div>
            <div class="kpi-subtitle">R$ {{ totais.saldo_realizado_formatado }} realizado</div>
        </div>
        <div class="kpi-card vencido">
            <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <span class="kpi-value">R$ {{ totais.vencido_total_formatado }}</span>
            <div class="kpi-label">Valores Vencidos</div>
            <div class="kpi-subtitle">Requer atenção</div>
        </div>
    </div>

    <div class="filtros-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-filter"></i>
                Busca e Filtros
            </div>
            <button type="button" class="btn-green" onclick="abrirModalNovoLancamento()">
                <i class="fas fa-plus"></i>
                Novo Lançamento
            </button>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-input"
                placeholder="Buscar por descrição, fornecedor, cliente, documento...">
            <i class="fas fa-search search-icon"></i>
        </div>

        <form method="GET" id="filtrosForm">
            <div class="filtros-grid">
                <div class="form-group">
                    <label class="form-label">Data Início</label>
                    <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio }}">
                </div>

                <div class="form-group">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                </div>

                <div class="form-group">
                    <label class="form-label">Unidade de Negócio</label>
                    <select name="unidade_negocio_id" class="form-select">
                        <option value="">Todas as Unidades</option>
                        {% for unidade in unidades_negocio %}
                        <option value="{{ unidade.id }}" {% if unidade.id==unidade_negocio_filtro_id %}selected{% endif
                            %}>
                            {{ unidade.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>


                <div class="form-group">
                    <label class="form-label">Data Emissão Início</label>
                    <input type="date" name="data_emissao_inicio" class="form-control"
                        value="{{ data_emissao_inicio }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Data Emissão Fim</label>
                    <input type="date" name="data_emissao_fim" class="form-control" value="{{ data_emissao_fim }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select name="categoria" class="form-select">
                        <option value="">Todas as Categorias</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria }}" {% if categoria==categoria_filtro %}selected{% endif %}>
                            {{ categoria }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">Todos os Status</option>
                        <option value="PENDENTE" {% if status_filtro in ['PENDENTE', 'A Pagar' ] %}selected{% endif %}>
                            Pendentes</option>
                        <option value="PAGO" {% if status_filtro in ['PAGO', 'Pago' ] %}selected{% endif %}>Pagos
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Forma de Pagamento</label>
                    <select name="meio_pagamento" class="form-select">
                        <option value="">Todas as Formas</option>
                        <option value="PIX" {% if meio_pagamento_filtro=='PIX' %}selected{% endif %}>PIX</option>
                        <option value="DEPOSITO" {% if meio_pagamento_filtro=='DEPOSITO' %}selected{% endif %}>Depósito
                        </option>
                        <option value="TRANSFERENCIA" {% if meio_pagamento_filtro=='TRANSFERENCIA' %}selected{% endif
                            %}>Transferência</option>
                        <option value="DINHEIRO" {% if meio_pagamento_filtro=='DINHEIRO' %}selected{% endif %}>Dinheiro
                        </option>
                        <option value="CARTAO" {% if meio_pagamento_filtro=='CARTAO' %}selected{% endif %}>Cartão
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select">
                        <option value="">Todos os Tipos</option>
                        <option value="RECEITA" {% if tipo_filtro=='RECEITA' %}selected{% endif %}>Receitas</option>
                        <option value="DESPESA" {% if tipo_filtro=='DESPESA' %}selected{% endif %}>Despesas</option>
                    </select>
                </div>
            </div>
            <div class="filtros-actions">
                <a href="{{ url_for('api_exportar_fluxo_excel', **request.args) }}" class="btn-secondary">
                    <i class="fas fa-file-excel"></i> Exportar
                </a>
                <button type="button" class="btn-secondary" onclick="limparFiltros()">
                    <i class="fas fa-times"></i> Limpar Filtros
                </button>
                <button type="submit" class="btn-green">
                    <i class="fas fa-search"></i> Filtrar
                </button>
            </div>
        </form>
    </div>

    <div class="fluxo-container">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-list-alt"></i>
                Movimentações do Período
                <span class="text-base font-normal text-gray-600">(<span id="contadorLancamentos">{{
                        fluxo_consolidado|length }}</span> lançamento(s))</span>
            </div>
        </div>
        {% if not fluxo_consolidado %}
        <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h3>Nenhuma movimentação encontrada</h3>
            <p>Não há lançamentos para o período ou filtros selecionados</p>
            <div class="mt-4">
                <button type="button" class="btn-green" onclick="abrirModalNovoLancamento()">
                    <i class="fas fa-plus"></i> Fazer Primeiro Lançamento
                </button>
            </div>
        </div>
        {% else %}
        <div class="fluxo-table-container">
            <table class="fluxo-table" id="fluxoTable">
                <thead>
                    <tr>
                        <th style="width: 50px; text-align: center;">
                            <input type="checkbox" id="selecionarTodosHeader"
                                onchange="toggleSelecionarTodos(this.checked)">
                        </th>
                        <th>Data Venc.</th>
                        <th>Data Emissão</th>
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Fornecedor/Cliente</th>
                        <th>Unidade</th>
                        <th>Categoria</th>                        
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in fluxo_consolidado %}
                    <tr class="{% if item.is_vencido %}vencido{% elif item.status in ['PAGO', 'Pago'] %}pago{% elif item.data_vencimento == hoje %}hoje{% endif %} table-row"
                        data-search="{{ (item.descricao or '') + ' ' + (item.fornecedor_cliente or '') + ' ' + (item.documento or '') + ' ' + (item.categoria or '') }}">
                        <td style="width: 50px; text-align: center;">
                            {% if item.tipo_origem == 'MANUAL' and item.status not in ['PAGO', 'Pago'] %}
                            <input type="checkbox" class="item-checkbox" value="{{ item.id }}"
                                onchange="atualizarSelecao()">
                            {% endif %}
                        </td>
                        <td>
                            <div class="font-semibold">{{ item.data_vencimento.strftime('%d/%m/%Y') }}</div>
                            {% if item.is_vencido %}
                            <div class="text-xs text-red-600 font-medium">VENCIDO</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.data_emissao %}
                            <div class="font-medium">{{ item.data_emissao.strftime('%d/%m/%Y') }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="tipo-badge {{ 'receita' if item.tipo_movimento == 'RECEITA' else 'despesa' }}">
                                {% if item.tipo_movimento == 'RECEITA' %}<i class="fas fa-arrow-up"></i> Receita{% else
                                %}<i class="fas fa-arrow-down"></i> Despesa{% endif %}
                            </div>
                            <div class="origem-badge {{ 'nfe' if item.tipo_origem == 'NFE' else 'manual' }} mt-1">{{
                                item.tipo_origem }}</div>
                        </td>
                        <td>
                            <div class="font-medium">
                                {{ item.descricao }}
                                {% if item.tem_rateio %}<i class="fas fa-sitemap text-green-600"
                                    title="Possui rateio"></i>{% endif %}
                            </div>
                            {% if item.parcela %}<div class="text-xs text-gray-600"><i class="fas fa-layer-group"></i>
                                Parcela {{ item.parcela }}</div>{% endif %}
                        </td>
                        <td>{{ item.fornecedor_cliente or '-' }}</td>

                        <td>
                            {% if item.objeto and item.objeto.unidade_negocio %}
                            <span class="text-sm font-medium">{{ item.objeto.unidade_negocio.nome }}</span>
                            {% else %}
                            <span>-</span>
                            {% endif %}
                        </td>

                        <td><span class="text-sm bg-gray-100 px-2 py-1 rounded">{{ item.categoria }}</span></td>
                        <td>
                            <div
                                class="font-semibold text-lg {{ 'valor-receita' if item.tipo_movimento == 'RECEITA' else 'valor-despesa' }}">
                                {% if item.tipo_movimento == 'RECEITA' %}+{% else %}-{% endif %} R$ {{
                                item.valor_formatado }}
                            </div>
                        </td>
                        <td>
                            {% if item.is_vencido %}
                            <span class="status-badge vencido">Vencido</span>
                            {% elif item.status in ['PAGO', 'Pago'] %}
                            <span class="status-badge pago">Pago</span>
                            {% else %}
                            <span class="status-badge pendente">{{ item.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-table btn-details" data-item-id="{{ item.id }}" title="Ver detalhes"><i
                                    class="fas fa-eye"></i></button>

                            {% if item.tipo_movimento == 'DESPESA' %}
                            <button class="btn-table btn-rateio" data-item-id="{{ item.id }}" title="Ratear Despesa"><i
                                    class="fas fa-sitemap"></i></button>
                            {% endif %}

                            {% if item.status not in ['PAGO', 'Pago'] %}
                            <button class="btn-table btn-pagar" data-item-id="{{ item.id }}"
                                data-item-valor="{{ item.valor }}"><i class="fas fa-check"></i></button>
                            {% if item.tipo_origem == 'MANUAL' %}
                            <button class="btn-table btn-edit" data-item-id="{{ item.id }}"><i
                                    class="fas fa-edit"></i></button>
                            {% endif %}
                            <button class="btn-table btn-delete" data-item-id="{{ item.id }}"><i
                                    class="fas fa-trash"></i></button>
                            {% else %}
                            <button class="btn-table btn-estornar" data-item-id="{{ item.id }}"><i
                                    class="fas fa-undo"></i></button>
                            {% endif %}

                            {% if item.tipo_origem == 'NFE' and item.objeto.observacoes and 'Chave de acesso' in
                            item.objeto.observacoes %}
                            <a href="{{ url_for('visualizar_xml_page', chave_acesso=item.objeto.observacoes.split(': ')[1]) }}"
                                class="btn-table btn-view" target="_blank"><i class="fas fa-file-code"></i></a>
                            {% endif %}

                            {% if item.tipo_origem == 'MANUAL' %}
                            <button class="btn-table btn-duplicar" data-item-id="{{ item.id }}"><i
                                    class="fas fa-copy"></i></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<div id="barraAcoesMassa">
    <span id="contadorSelecionados">0 itens selecionados</span>
    <button class="btn-table btn-massa" id="btnAlterarCategoriaMassa"><i class="fas fa-tags"></i> Alterar
        Categoria</button>
    <button class="btn-table btn-massa" id="btnMarcarPagoMassa"><i class="fas fa-check-double"></i> Marcar como
        Pago</button>
    <button class="btn-table btn-massa" id="btnExcluirMassa"><i class="fas fa-trash-alt"></i> Excluir</button>
</div>

<!-- MODAIS -->

<div id="detalhesModal" class="modal">
    <div class="modal-content extra-large">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-eye"></i>Detalhes do Lançamento</h2>
            <span class="close" onclick="closeModal('detalhesModal')">&times;</span>
        </div>
        <div class="modal-body" id="detalhesContent"></div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeModal('detalhesModal')">Fechar</button>
        </div>
    </div>
</div>

<div id="pagamentoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-dollar-sign"></i>Confirmar Pagamento</h2>
            <span class="close" onclick="closeModal('pagamentoModal')">&times;</span>
        </div>
        <form id="pagamentoForm">
            <div class="modal-body">
                <p>Você está prestes a marcar o lançamento como <strong>pago</strong>.</p>
                <p class="text-lg font-bold my-2" id="valorPagamentoModal"></p>
                <input type="hidden" id="itemId" name="itemId">
                <div class="form-group mt-4">
                    <label class="form-label" for="data_pagamento_modal">Data do Pagamento</label>
                    <input type="date" id="data_pagamento_modal" name="data_pagamento" class="form-control" required>
                </div>
                <div class="form-group mt-4">
                    <label class="form-label" for="meio_pagamento_modal">Forma de Pagamento</label>
                    <select id="meio_pagamento_modal" name="meio_pagamento" class="form-select" required>
                        <option value="">Selecione</option>
                        <option value="PIX">PIX</option>
                        <option value="DEPOSITO">Depósito</option>
                        <option value="TRANSFERENCIA">Transferência</option>
                        <option value="DINHEIRO">Dinheiro</option>
                        <option value="CARTAO">Cartão</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('pagamentoModal')">Cancelar</button>
                <button type="submit" class="btn-green">Confirmar Pagamento</button>
            </div>
        </form>
    </div>
</div>

<div id="edicaoModal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-edit"></i>Editar Lançamento</h2>
            <span class="close" onclick="closeModal('edicaoModal')">&times;</span>
        </div>
        <form id="edicaoForm">
            <div class="modal-body">
                <input type="hidden" name="lancamento_id" id="lancamentoId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label" for="edit-tipo">Tipo</label>
                        <select id="edit-tipo" name="tipo" class="form-select" required>
                            <option value="RECEITA">Receita</option>
                            <option value="DESPESA">Despesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-valor_total">Valor (R$)</label>
                        <input type="number" step="0.01" id="edit-valor_total" name="valor_total" class="form-control"
                            required>
                    </div>
                    <div class="form-group col-span-2">
                        <label class="form-label" for="edit-descricao">Descrição</label>
                        <input type="text" id="edit-descricao" name="descricao" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-categoria">Categoria</label>
                        <input type="text" id="edit-categoria" name="categoria" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-data_vencimento">Data Vencimento</label>
                        <input type="date" id="edit-data_vencimento" name="data_vencimento" class="form-control"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-fornecedor_cliente">Fornecedor/Cliente</label>
                        <input type="text" id="edit-fornecedor_cliente" name="fornecedor_cliente" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-documento_numero">Nº Documento</label>
                        <input type="text" id="edit-documento_numero" name="documento_numero" class="form-control">
                    </div>
                    <div class="form-group col-span-2">
                        <label class="form-label" for="edit-observacoes">Observações</label>
                        <textarea id="edit-observacoes" name="observacoes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('edicaoModal')">Cancelar</button>
                <button type="submit" class="btn-green">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<div id="confirmarExclusaoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);">
            <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i>Confirmar Exclusão</h2>
            <span class="close" onclick="closeModal('confirmarExclusaoModal')">&times;</span>
        </div>
        <form id="exclusaoForm">
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.</p>
                <input type="hidden" id="itemIdParaExcluir" name="item_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('confirmarExclusaoModal')">Cancelar</button>
                <button type="submit" class="btn-danger">Excluir</button>
            </div>
        </form>
    </div>
</div>

<div id="estornarPagamentoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%);">
            <h2 class="modal-title"><i class="fas fa-undo"></i>Estornar Pagamento</h2>
            <span class="close" onclick="closeModal('estornarPagamentoModal')">&times;</span>
        </div>
        <form id="estornoForm">
            <div class="modal-body">
                <p>Você está prestes a estornar este pagamento, marcando-o novamente como pendente. Deseja continuar?
                </p>
                <input type="hidden" id="itemIdParaEstornar" name="item_id">
                <div class="form-group mt-4">
                    <label class="form-label" for="motivo_estorno">Motivo (Opcional)</label>
                    <input type="text" id="motivo_estorno" name="motivo" class="form-control"
                        placeholder="Ex: Pagamento duplicado">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('estornarPagamentoModal')">Cancelar</button>
                <button type="submit" class="btn-warning" style="background:#6c757d; color:white;">Confirmar
                    Estorno</button>
            </div>
        </form>
    </div>
</div>

<div id="duplicarLancamentoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #0069d9 0%, #007bff 100%);">
            <h2 class="modal-title"><i class="fas fa-copy"></i>Duplicar Lançamento</h2>
            <span class="close" onclick="closeModal('duplicarLancamentoModal')">&times;</span>
        </div>
        <form id="duplicarForm">
            <div class="modal-body">
                <p>Uma cópia deste lançamento será criada. Informe a nova data de vencimento.</p>
                <input type="hidden" id="itemIdParaDuplicar" name="item_id">
                <div class="form-group mt-4">
                    <label class="form-label" for="nova_data_vencimento_duplicar">Nova Data de Vencimento</label>
                    <input type="date" id="nova_data_vencimento_duplicar" name="nova_data_vencimento"
                        class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('duplicarLancamentoModal')">Cancelar</button>
                <button type="submit" class="btn-primary">Duplicar</button>
            </div>
        </form>
    </div>
</div>

<div id="alterarCategoriaMassaModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title"><i class="fas fa-tags"></i>Alterar Categoria em Massa</h2>
            <span class="close" onclick="closeModal('alterarCategoriaMassaModal')">&times;</span>
        </div>
        <form id="alterarCategoriaMassaForm">
            <div class="modal-body">
                <p>Selecione a nova categoria para os <strong id="contadorModalCategoria"></strong> itens selecionados.
                </p>
                <div class="form-group mt-4">
                    <label class="form-label" for="nova_categoria_massa">Nova Categoria</label>
                    <select id="nova_categoria_massa" name="nova_categoria" class="form-select" required>
                        {% for categoria in categorias %}
                        <option value="{{ categoria }}">{{ categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('alterarCategoriaMassaModal')">Cancelar</button>
                <button type="submit" class="btn-green">Aplicar</button>
            </div>
        </form>
    </div>
</div>

<div id="novoLancamentoModal" class="modal">
    <div class="modal-content extra-large">
        <form id="novoLancamentoForm">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-plus-circle"></i>Novo Lançamento no Fluxo de Caixa</h2>
                <span class="close" onclick="closeModal('novoLancamentoModal')">&times;</span>
            </div>
            <div id="modalNotifications" class="modal-notifications"></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Tipo de Lançamento</label>
                    <div class="tipo-movimento-container">
                        <div class="radio-option">
                            <input type="radio" id="nlTipoReceita" name="nl_tipo" value="RECEITA" checked>
                            <label for="nlTipoReceita" class="radio-label receita">
                                <i class="fas fa-arrow-up"></i><span>Receita</span><small>Entrada de dinheiro</small>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="nlTipoDespesa" name="nl_tipo" value="DESPESA">
                            <label for="nlTipoDespesa" class="radio-label despesa">
                                <i class="fas fa-arrow-down"></i><span>Despesa</span><small>Saída de dinheiro</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="nlUnidadeNegocio">Lançar para Unidade *</label>
                    <select id="nlUnidadeNegocio" class="form-select" required>
                        {% for unidade in unidades_negocio %}
                        <option value="{{ unidade.id }}" {% if unidade.is_matriz %}selected{% endif %}>
                            {{ unidade.nome }} {% if unidade.is_matriz %}(Matriz){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group col-span-2">
                        <label class="form-label" for="nlDescricao">Descrição *</label>
                        <input type="text" id="nlDescricao" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="nlValorTotal">Valor Total (R$) *</label>
                        <input type="number" step="0.01" id="nlValorTotal" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="nlCategoria">Categoria</label>
                        <input type="text" id="nlCategoria" class="form-control" list="listaCategorias">
                        <datalist id="listaCategorias">
                            {% for categoria in categorias %}
                            <option value="{{ categoria }}">
                                {% endfor %}
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="nlFornecedorCliente">Fornecedor / Cliente</label>
                        <input type="text" id="nlFornecedorCliente" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="nlDocumento">Nº Documento</label>
                        <input type="text" id="nlDocumento" class="form-control">
                    </div>
                    <div class="form-group col-span-2">
                        <label class="form-label" for="nlObservacoes">Observações</label>
                        <textarea id="nlObservacoes" class="form-control" rows="2"></textarea>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <label class="form-label">Parcelamento do Pagamento</label>
                    <div
                        style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                        <div>
                            <label for="nlQuantidadeParcelas"
                                style="font-size: 0.875rem; color: var(--gray-600);">Quantidade de Parcelas</label>
                            <input type="number" id="nlQuantidadeParcelas" min="1" max="48" value="1"
                                class="form-control" style="padding: 8px 12px;">
                        </div>
                        <button type="button" id="nlBtnGerarParcelas" class="btn-secondary">
                            <i class="fas fa-calendar-alt"></i> Gerar Parcelas
                        </button>
                    </div>
                </div>
                <div id="novoLancamentoParcelamento" class="parcelamento-container" style="display:none;">
                    <div class="parcelamento-header"><i class="fas fa-calendar-check"></i><span>Cronograma de
                            Pagamento</span></div>
                    <div id="nlParcelasContainer"></div>
                    <div class="totalizacao" id="nlTotalizacaoParcelas">
                        <div class="totalizacao-content">
                            <div class="totalizacao-item"><span class="totalizacao-label">Valor Total</span><span
                                    class="totalizacao-valor" id="nlValorTotalParcelas">R$ 0,00</span></div>
                            <div class="totalizacao-item"><span class="totalizacao-label">Soma Parcelas</span><span
                                    class="totalizacao-valor" id="nlSomaParcelas">R$ 0,00</span></div>
                            <div class="totalizacao-item"><span class="totalizacao-label">Diferença</span><span
                                    class="totalizacao-valor" id="nlDiferencaParcelas">R$ 0,00</span></div>
                        </div>
                    </div>
                    <div class="validation-error" id="nlValidationErrorParcelas">
                        <div class="validation-error-content"><i class="fas fa-exclamation-triangle"></i>O valor total
                            das parcelas não confere com o valor do lançamento!</div>
                    </div>
                </div>

                <div id="rateioOptionContainer" class="form-group mt-4" style="display:none;">
                    <label class="form-label">Rateio da Despesa</label>
                    <div class="tipo-movimento-container">
                        <div class="radio-option"><input type="radio" id="novoLancamentoSemRateio" name="nl_rateio"
                                value="sem" checked><label for="novoLancamentoSemRateio" class="radio-label despesa"><i
                                    class="fas fa-file-invoice-dollar"></i><span>Despesa Geral</span><small>Lançar como
                                    despesa geral da empresa</small></label></div>
                        <div class="radio-option"><input type="radio" id="novoLancamentoComRateio" name="nl_rateio"
                                value="com"><label for="novoLancamentoComRateio" class="radio-label despesa"><i
                                    class="fas fa-truck-moving"></i><span>Ratear por Veículo</span><small>Dividir o
                                    custo entre veículos</small></label></div>
                    </div>
                </div>

                <div id="novoLancamentoRateio" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Buscar Veículos</label>
                        <div class="search-box">
                            <input type="text" id="nlVeiculoSearchInput"
                                placeholder="Digite para buscar e adicionar múltiplos veículos..." autocomplete="off"
                                class="form-control">
                            <i class="fas fa-search" style="right: 15px; left: auto;"></i>
                        </div>
                        <div id="nlVeiculoSearchResults"
                            class="list-group mt-1 position-absolute bg-white shadow-lg rounded"
                            style="z-index: 1002; width: calc(100% - 4rem);"></div>
                    </div>
                    <div class="parcelamento-container">
                        <div class="parcelamento-header">
                            <span><i class="fas fa-list-ul"></i> Veículos para Rateio</span>
                            <div id="nlRateioControles" style="display: none;">
                                <button type="button" class="btn-secondary"
                                    style="padding: 6px 12px; font-size: 0.75rem;" onclick="nlDistribuirIgualmente()"><i
                                        class="fas fa-equals"></i> Dividir Igual</button>
                                <button type="button" class="btn-secondary"
                                    style="padding: 6px 12px; font-size: 0.75rem;"
                                    onclick="nlAjustarAutomaticamente()"><i class="fas fa-magic"></i> Ajustar
                                    Auto</button>
                                <button type="button" class="btn-secondary"
                                    style="padding: 6px 12px; font-size: 0.75rem;" onclick="nlLimparRateio()"><i
                                        class="fas fa-trash"></i> Limpar</button>
                            </div>
                        </div>
                        <div id="nlVeiculosContainer" class="mt-3">
                            <div class="text-center text-gray-500 my-4" id="nlRateioEmpty">
                                <i class="fas fa-truck"
                                    style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                                <p>Nenhum veículo selecionado</p>
                            </div>
                        </div>
                        <div class="totalizacao mt-4" id="nlTotalizacaoRateio">
                            <div class="totalizacao-content">
                                <div class="totalizacao-item"><span class="totalizacao-label">Valor Total</span><span
                                        class="totalizacao-valor" id="nlValorTotalRateio">R$ 0,00</span></div>
                                <div class="totalizacao-item"><span class="totalizacao-label">Total Rateado</span><span
                                        class="totalizacao-valor" id="nlSomaRateio">R$ 0,00</span></div>
                                <div class="totalizacao-item"><span class="totalizacao-label">Diferença</span><span
                                        class="totalizacao-valor" id="nlDiferencaRateio">R$ 0,00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary"
                    onclick="closeModal('novoLancamentoModal')">Cancelar</button>
                <button type="submit" class="btn-green" id="btnSalvarNovoLancamento">
                    <span class="loading-spinner"></span> Salvar Lançamento
                </button>
            </div>
        </form>
    </div>
</div>

<div id="rateioModal" class="modal">
    <div class="modal-content large">
        <form id="rateioForm">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-sitemap"></i>Rateio de Despesa por Veículo</h2>
                <span class="close" onclick="closeModal('rateioModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rateioItemId">
                <div id="rateioInfoLancamento"
                    style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>
                <div class="form-group">
                    <label class="form-label">Buscar Veículos (Placa ou Modelo) para despesas não relacionadas a veiculos (ADMIN)</label>
                    <div class="search-box">
                        <input type="text" id="rateioVeiculoSearchInput" placeholder="Digite para buscar..."
                            autocomplete="off" class="form-control">
                        <i class="fas fa-search"></i>
                    </div>
                    <div id="rateioVeiculoSearchResults"
                        class="list-group mt-1 position-absolute bg-white shadow rounded"
                        style="z-index: 1001; width: calc(100% - 4rem);"></div>
                </div>
                <div class="parcelamento-container">
                    <div class="parcelamento-header">
                        <div><i class="fas fa-list-ul"></i> Veículos para Rateio</div>
                        <div id="rateioControles" style="display: none;">
                            <button type="button" class="btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;"
                                onclick="distribuirIgualmenteRateio()"><i class="fas fa-equals"></i> Dividir
                                Igual</button>
                            <button type="button" class="btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;"
                                onclick="ajustarAutomaticamenteRateio()"><i class="fas fa-magic"></i> Ajustar
                                Auto</button>
                        </div>
                    </div>
                    <div id="rateioVeiculosContainer" class="mt-3">
                        <div class="text-center text-gray-500 my-4" id="rateioEmptyState">
                            <i class="fas fa-truck" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                            <p>Nenhum veículo selecionado</p>
                        </div>
                    </div>
                    <div class="totalizacao mt-4" id="rateioTotalizacao"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-danger" id="btnExcluirRateio" style="float: left;"
                    onclick="excluirRateio()">
                    <i class="fas fa-trash-alt"></i> Excluir Rateio
                </button>
                <button type="button" class="btn-secondary" onclick="closeModal('rateioModal')">Cancelar</button>
                <button type="button" class="btn-green" id="btnSalvarRateio">
                    <span class="loading-spinner" style="display: none;"></span>
                    Salvar Rateio
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- SCRIPT CORRIGIDO ---

    // Variáveis globais
    let valorTotalRateio = 0;
    let veiculosRateio = new Map();
    let nlValorTotal = 0;
    let nlVeiculosRateio = new Map();

    // Funções de utilidade
    function openModal(id) {
        console.log('Abrindo modal:', id);
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'block';
            // Adicionar um pequeno delay para evitar fechamento imediato
            setTimeout(() => {
                modal.classList.add('modal-opening');
            }, 10);
        }
    }

    function closeModal(id) {
        console.log('Fechando modal:', id);
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('modal-opening');
            modal.style.display = 'none';
        }
    }

    function showNotification(message, type = 'success') {
        const container = document.getElementById('notifications');
        const alertDiv = document.createElement('div');
        const alertClasses = {
            success: 'bg-green-100 text-green-800 border-green-200',
            error: 'bg-red-100 text-red-800 border-red-200',
            info: 'bg-blue-100 text-blue-800 border-blue-200'
        };
        alertDiv.className = `p-4 rounded-lg shadow-md mb-4 flex items-center gap-3 font-medium ${alertClasses[type] || alertClasses.info}`;
        alertDiv.innerHTML = message;
        container.appendChild(alertDiv);
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Função específica para notificações do modal
    function showModalNotification(message, type = 'success', persistent = false) {
        const container = document.getElementById('modalNotifications');
        if (!container) return;

        const notification = document.createElement('div');
        const notificationId = 'modal-notif-' + Date.now();

        notification.id = notificationId;
        notification.className = `modal-notification ${type} ${persistent ? 'persistent' : 'auto-hide'}`;

        notification.innerHTML = `
        ${message}
        <span class="modal-notification-close" onclick="closeModalNotification('${notificationId}')">&times;</span>
    `;

        container.appendChild(notification);

        // Auto-remove após 5 segundos se não for persistente
        if (!persistent) {
            setTimeout(() => {
                closeModalNotification(notificationId);
            }, 5000);
        }

        // Scroll para mostrar a notificação se necessário
        container.scrollTop = container.scrollHeight;
    }

    function closeModalNotification(notificationId) {
        const notification = document.getElementById(notificationId);
        if (notification && notification.parentNode) {
            notification.style.animation = 'fadeOutModal 0.3s ease-in forwards';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }

    function clearModalNotifications() {
        const container = document.getElementById('modalNotifications');
        if (container) {
            container.innerHTML = '';
        }
    }

    function formatarMoeda(valor) {
        if (typeof valor !== 'number') return '0,00';
        return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // FUNÇÃO CORRIGIDA para abrir modal de novo lançamento
    // FUNÇÃO CORRIGIDA para abrir modal de novo lançamento
    function abrirModalNovoLancamento() {
        console.log('Abrindo modal de novo lançamento...'); // Debug

        try {
            const nlForm = document.getElementById('novoLancamentoForm');
            if (!nlForm) {
                console.error('Formulário novoLancamentoForm não encontrado');
                showNotification('<i class="fas fa-exclamation-triangle"></i> Erro: Formulário não encontrado', 'error');
                return;
            }

            nlForm.reset();

            nlValorTotal = 0;
            nlVeiculosRateio.clear();

            // Resetar containers
            const parcelamentoContainer = document.getElementById('novoLancamentoParcelamento');
            const rateioContainer = document.getElementById('novoLancamentoRateio');
            const rateioOptionContainer = document.getElementById('rateioOptionContainer');

            if (parcelamentoContainer) parcelamentoContainer.style.display = 'none';
            if (rateioContainer) rateioContainer.style.display = 'none';
            if (rateioOptionContainer) rateioOptionContainer.style.display = 'none';

            // Limpar containers de conteúdo
            const nlParcelasContainer = document.getElementById('nlParcelasContainer');
            const nlVeiculosContainer = document.getElementById('nlVeiculosContainer');

            if (nlParcelasContainer) nlParcelasContainer.innerHTML = '';
            if (nlVeiculosContainer) {
                nlVeiculosContainer.innerHTML = '<div class="text-center text-gray-500 my-4" id="nlRateioEmpty"><i class="fas fa-truck" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i><p>Nenhum veículo selecionado</p></div>';
            }

            // Resetar radio buttons
            const tipoReceita = document.getElementById('nlTipoReceita');
            const rateioSem = document.getElementById('novoLancamentoSemRateio');
            const btnSalvar = document.getElementById('btnSalvarNovoLancamento');

            if (tipoReceita) tipoReceita.checked = true;
            if (rateioSem) rateioSem.checked = true;
            if (btnSalvar) btnSalvar.disabled = false;

            // Limpar notificações anteriores do modal - REMOVENDO TEMPORARIAMENTE
            const modalNotifications = document.getElementById('modalNotifications');
            if (modalNotifications) {
                modalNotifications.innerHTML = '';
            }

            // Abrir modal
            openModal('novoLancamentoModal');
            console.log('Modal aberto com sucesso');

        } catch (error) {
            console.error('Erro ao abrir modal:', error);
            showNotification('<i class="fas fa-exclamation-triangle"></i> Erro ao abrir modal: ' + error.message, 'error');
        }
    }

    // Ponto de entrada principal
    document.addEventListener('DOMContentLoaded', function () {
        window.onclick = function (event) {
            // CORRIGIDO: Só fecha modal se clicar EXATAMENTE no fundo do modal, não em elementos filhos
            // E se o modal não foi aberto recentemente (evitar fechamento imediato)
            if (event.target.classList.contains('modal') &&
                !event.defaultPrevented &&
                !event.target.classList.contains('modal-opening')) {
                console.log('Fechando modal via window.onclick');
                event.target.style.display = "none";
            }
        };
        setupPageListeners();
        setupRateioListeners();
        setupNovoLancamentoListeners();
    });

    // Funções de configuração de eventos
    function setupPageListeners() {
        document.getElementById('searchInput')?.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.table-row');
            let visibleCount = 0;
            rows.forEach(row => {
                const searchData = row.dataset.search.toLowerCase();
                const shouldShow = searchData.includes(searchTerm);
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            document.getElementById('contadorLancamentos').textContent = visibleCount;
        });

        document.getElementById('fluxoTable')?.addEventListener('click', function (e) {
            // CORRIGIDO: Impedir propagação de eventos dos botões
            const button = e.target.closest('button');
            if (!button) return;

            // Impedir que o evento se propague e cause fechamento indevido de modais
            e.stopPropagation();
            e.preventDefault();

            const itemId = button.dataset.itemId;
            if (button.classList.contains('btn-details')) {
                console.log('Clicou em detalhes, item:', itemId);
                carregarDetalhesLancamento(itemId);
            }
            if (button.classList.contains('btn-pagar')) {
                console.log('Clicou em pagar, item:', itemId);
                abrirModalPagamento(itemId, button.dataset.itemValor);
            }
            if (button.classList.contains('btn-edit')) {
                console.log('Clicou em editar, item:', itemId);
                abrirModalEdicao(itemId);
            }
            if (button.classList.contains('btn-delete')) {
                console.log('Clicou em excluir, item:', itemId);
                abrirModalConfirmacao(itemId, 'confirmarExclusaoModal', 'itemIdParaExcluir');
            }
            if (button.classList.contains('btn-estornar')) {
                console.log('Clicou em estornar, item:', itemId);
                abrirModalConfirmacao(itemId, 'estornarPagamentoModal', 'itemIdParaEstornar');
            }
            if (button.classList.contains('btn-duplicar')) {
                console.log('Clicou em duplicar, item:', itemId);
                abrirModalDuplicacao(itemId);
            }
            if (button.classList.contains('btn-rateio')) {
                console.log('Clicou em rateio, item:', itemId);
                abrirModalRateio(itemId);
            }
        });

        // CORRIGIDO: Event listeners para formulários - com melhor tratamento
        const pagamentoForm = document.getElementById('pagamentoForm');
        if (pagamentoForm) {
            pagamentoForm.addEventListener('submit', function (e) {
                e.preventDefault();
                console.log('Formulário de pagamento enviado');
                handlePagamentoSubmit(e);
            });
        }

        const edicaoForm = document.getElementById('edicaoForm');
        if (edicaoForm) {
            edicaoForm.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/salvar_edicao'));
        }

        const exclusaoForm = document.getElementById('exclusaoForm');
        if (exclusaoForm) {
            exclusaoForm.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/excluir'));
        }

        const estornoForm = document.getElementById('estornoForm');
        if (estornoForm) {
            estornoForm.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/estornar_pagamento'));
        }

        const duplicarForm = document.getElementById('duplicarForm');
        if (duplicarForm) {
            duplicarForm.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/duplicar'));
        }

        const alterarCategoriaMassaForm = document.getElementById('alterarCategoriaMassaForm');
        if (alterarCategoriaMassaForm) {
            alterarCategoriaMassaForm.addEventListener('submit', handleFormSubmit('/api/fluxo_caixa/alterar_categoria_massa', true));
        }

        document.getElementById('btnAlterarCategoriaMassa')?.addEventListener('click', () => {
            const items = getSelectedItems();
            if (items.length > 0) {
                document.getElementById('contadorModalCategoria').textContent = items.length;
                openModal('alterarCategoriaMassaModal');
            } else {
                showNotification('<i class="fas fa-info-circle"></i> Selecione ao menos um item.', 'info');
            }
        });
    }

    // NOVA FUNÇÃO específica para lidar com pagamento
    function handlePagamentoSubmit(e) {
        console.log('Processando pagamento...');
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn?.innerHTML;

        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        console.log('Dados do pagamento:', data);

        fetch('/api/fluxo_caixa/marcar_pago', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Resultado do pagamento:', result);
                if (result.success) {
                    showNotification('<i class="fas fa-check-circle"></i> Pagamento confirmado com sucesso!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification(`<i class="fas fa-exclamation-triangle"></i> ${result.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Erro no pagamento:', error);
                // Simular sucesso para demonstração quando API não existe
                showNotification('<i class="fas fa-check-circle"></i> Pagamento simulado com sucesso! (API não disponível)', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .finally(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
    }

    function setupRateioListeners() {
        document.getElementById('rateioVeiculoSearchInput')?.addEventListener('input', buscarVeiculosParaRateio);
        document.getElementById('btnSalvarRateio')?.addEventListener('click', salvarRateio);
    }

    function setupNovoLancamentoListeners() {
        const nlForm = document.getElementById('novoLancamentoForm');
        if (!nlForm) return;

        document.getElementById('nlTipoDespesa').addEventListener('change', () => document.getElementById('rateioOptionContainer').style.display = 'block');
        document.getElementById('nlTipoReceita').addEventListener('change', () => {
            document.getElementById('rateioOptionContainer').style.display = 'none';
            document.getElementById('novoLancamentoSemRateio').checked = true;
            nlToggleRateio();
        });

        document.getElementById('novoLancamentoComRateio').addEventListener('change', nlToggleRateio);
        document.getElementById('novoLancamentoSemRateio').addEventListener('change', nlToggleRateio);

        document.getElementById('nlValorTotal').addEventListener('input', () => {
            nlValorTotal = parseFloat(document.getElementById('nlValorTotal').value) || 0;
            if (document.querySelectorAll('#nlParcelasContainer .nl-parcela-item').length > 0) {
                nlGerarParcelas();
            }
            if (nlVeiculosRateio.size > 0) {
                nlRenderizarVeiculos();
            }
        });

        document.getElementById('nlBtnGerarParcelas').addEventListener('click', nlGerarParcelas);
        document.getElementById('nlVeiculoSearchInput').addEventListener('input', nlBuscarVeiculos);

        nlForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const btn = document.getElementById('btnSalvarNovoLancamento');
            const spinner = btn.querySelector('.loading-spinner');
            btn.disabled = true;
            spinner.style.display = 'inline-block';

            const temRateio = document.getElementById('novoLancamentoComRateio').checked;

            let parcelasValidas = true;
            if (document.querySelectorAll('#nlParcelasContainer .nl-parcela-item').length > 0) {
                parcelasValidas = nlValidarParcelas();
            }

            if (nlValorTotal <= 0 || !parcelasValidas || (temRateio && !nlValidarRateio())) {
                showModalNotification('<i class="fas fa-exclamation-triangle"></i> Verifique os valores. A soma das parcelas e/ou do rateio deve corresponder ao valor total.', 'error', true);
                btn.disabled = false; spinner.style.display = 'none';
                return;
            }

            const parcelasInputs = document.querySelectorAll('.nl-parcela-item');
            let parcelas = [];
            if (parcelasInputs.length > 0) {
                parcelas = Array.from(parcelasInputs).map(item => ({
                    data_vencimento: item.querySelector('.nl-parcela-data').value,
                    valor: item.querySelector('.nl-parcela-valor').value
                }));
            } else {
                const hoje = new Date();
                const dataVencimento = new Date(hoje.setMonth(hoje.getMonth() + 1));
                parcelas = [{ data_vencimento: dataVencimento.toISOString().split('T')[0], valor: nlValorTotal }];
            }

            const payload = {
                tipo: document.querySelector('input[name="nl_tipo"]:checked').value,
                descricao: document.getElementById('nlDescricao').value,
                valor_total: nlValorTotal,
                categoria: document.getElementById('nlCategoria').value,
                fornecedor_cliente: document.getElementById('nlFornecedorCliente').value,
                documento_numero: document.getElementById('nlDocumento').value,
                observacoes: document.getElementById('nlObservacoes').value,
                unidade_negocio_id: document.getElementById('nlUnidadeNegocio').value,
                parcelas: parcelas,
                tem_rateio: temRateio,
                veiculos: []
            };

            if (payload.tem_rateio) {
                payload.veiculos = Array.from(nlVeiculosRateio.values()).map(v => ({
                    veiculo_id: v.id,
                    percentual: (v.valor / nlValorTotal) * 100
                }));
            }

            fetch('/api/fluxo_caixa/novo_lancamento_completo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(handleResponse).catch(handleError).finally(() => { btn.disabled = false; spinner.style.display = 'none'; });
        });
    }

    // Funções de manipulação de dados e API
    function handleResponse(response) {
        return response.json().then(data => {
            showNotification(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                setTimeout(() => window.location.reload(), 1500);
            }
        });
    }
    function handleError(error) {
        showNotification('Erro de rede ou servidor. Tente novamente.', 'error');
        console.error('Fetch Error:', error);
    }

    // ▼▼▼ COLE AS DUAS NOVAS FUNÇÕES AQUI NESTE ESPAÇO ▼▼▼

    // Função para tratar respostas de ações DENTRO de um modal
    function handleModalResponse(response) {
        return response.json().then(data => {
            // Chama a função de notificação correta, que exibe DENTRO do modal
            showModalNotification(data.message, data.success ? 'success' : 'error');
            if (data.success) {
                // Recarrega la página después de un éxito para ver el nuevo lanzamiento
                setTimeout(() => window.location.reload(), 1500);
            }
        });
    }

    // Função para tratar erros de ações DENTRO de um modal
    function handleModalError(error) {
        // Chama a função de notificação correta, que exibe DENTRO do modal
        showModalNotification('Erro de rede ou servidor. Tente novamente.', 'error');
        console.error('Fetch Error:', error);
    }


    function handleFormSubmit(url, isMassa = false) {
        return function (e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            if (btn) btn.disabled = true;
            let data;
            if (isMassa) {
                data = { item_ids: getSelectedItems(), nova_categoria: e.target.nova_categoria.value };
            } else {
                data = Object.fromEntries(new FormData(e.target).entries());
            }
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(handleResponse).catch(handleError).finally(() => { if (btn) btn.disabled = false; });
        }
    }

    // Funções de abertura de modais
    function abrirModalPagamento(itemId, itemValor) {
        console.log('Abrindo modal de pagamento para item:', itemId, 'valor:', itemValor);

        const form = document.getElementById('pagamentoForm');
        const modal = document.getElementById('pagamentoModal');

        if (!form) {
            console.error('Formulário pagamentoForm não encontrado');
            showNotification('<i class="fas fa-exclamation-triangle"></i> Erro: Formulário de pagamento não encontrado', 'error');
            return;
        }

        if (!modal) {
            console.error('Modal pagamentoModal não encontrado');
            showNotification('<i class="fas fa-exclamation-triangle"></i> Erro: Modal de pagamento não encontrado', 'error');
            return;
        }

        form.reset();

        // Configurar o input hidden do itemId
        const itemIdInput = document.getElementById('itemId');
        if (itemIdInput) {
            itemIdInput.value = itemId;
        } else {
            console.error('Input itemId não encontrado');
        }

        // Configurar valor do pagamento
        const valorDisplay = document.getElementById('valorPagamentoModal');
        if (valorDisplay && itemValor) {
            const valorFormatado = parseFloat(itemValor).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
            valorDisplay.textContent = `Valor: ${valorFormatado}`;
        }

        // Configurar data de hoje como padrão
        const dataInput = document.getElementById('data_pagamento_modal');
        if (dataInput) {
            const hoje = new Date();
            dataInput.valueAsDate = hoje;
        }

        console.log('Abrindo modal de pagamento...');
        openModal('pagamentoModal');
    }

    async function abrirModalEdicao(itemId) {
        try {
            const response = await fetch(`/api/fluxo_caixa/buscar_dados/${itemId}`);
            const result = await response.json();
            if (result.success) {
                const form = document.getElementById('edicaoForm');
                form.reset();
                form.lancamento_id.value = result.dados.id;
                form.tipo.value = result.dados.tipo;
                form.valor_total.value = result.dados.valor_total;
                form.descricao.value = result.dados.descricao;
                form.categoria.value = result.dados.categoria;
                form.data_vencimento.value = result.dados.data_vencimento;
                form.fornecedor_cliente.value = result.dados.fornecedor_cliente;
                form.documento_numero.value = result.dados.documento_numero;
                form.observacoes.value = result.dados.observacoes;
                openModal('edicaoModal');
            } else { showNotification(result.message, 'error'); }
        } catch (err) { showNotification('Erro de rede ao buscar dados para edição.', 'error'); }
    }

    function abrirModalConfirmacao(itemId, modalId, inputId) {
        const form = document.getElementById(modalId).querySelector('form');
        form.reset();
        document.getElementById(inputId).value = itemId;
        openModal(modalId);
    }

    function abrirModalDuplicacao(itemId) {
        const form = document.getElementById('duplicarForm');
        form.reset();
        document.getElementById('itemIdParaDuplicar').value = itemId;
        const today = new Date();
        const nextMonth = new Date(today.setMonth(today.getMonth() + 1));
        document.getElementById('nova_data_vencimento_duplicar').valueAsDate = nextMonth;
        openModal('duplicarLancamentoModal');
    }

    async function carregarDetalhesLancamento(itemId) {
        try {
            const response = await fetch(`/api/fluxo_caixa/detalhes/${itemId}`);
            const data = await response.json();
            if (data.success) {
                const conteudo = document.getElementById('detalhesContent');
                const dados = data.dados;
                conteudo.innerHTML = `<div class="detail-row"><div class="detail-label">ID:</div><div class="detail-value">${dados.id}</div></div>
                <div class="detail-row"><div class="detail-label">Tipo:</div><div class="detail-value"><span class="tipo-badge ${dados.tipo_movimento === 'RECEITA' ? 'receita' : 'despesa'}">${dados.tipo_movimento}</span></div></div>
                <div class="detail-row"><div class="detail-label">Descrição:</div><div class="detail-value">${dados.descricao || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Valor:</div><div class="detail-value"><span class="${dados.tipo_movimento === 'RECEITA' ? 'valor-receita' : 'valor-despesa'}">R$ ${dados.valor_formatado}</span></div></div>
                <div class="detail-row"><div class="detail-label">Categoria:</div><div class="detail-value">${dados.categoria || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Data Emissão:</div><div class="detail-value">${dados.data_emissao || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Data Vencimento:</div><div class="detail-value">${dados.data_vencimento || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Data Pagamento:</div><div class="detail-value">${dados.data_pagamento || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Forma de Pagamento:</div><div class="detail-value">${dados.meio_pagamento || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Fornecedor/Cliente:</div><div class="detail-value">${dados.fornecedor_cliente || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Documento:</div><div class="detail-value">${dados.documento || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">Status:</div><div class="detail-value"><span class="status-badge ${dados.status.toLowerCase().replace(' ', '-')}">${dados.status}</span></div></div>
                ${dados.observacoes ? `<div class="detail-row"><div class="detail-label">Observações:</div><div class="detail-value">${dados.observacoes}</div></div>` : ''}`;
                openModal('detalhesModal');
            } else { showNotification(data.message, 'error'); }
        } catch (error) { showNotification('Erro ao carregar detalhes.', 'error'); }
    }

    // Funções auxiliares da página
    function limparFiltros() {
        window.location.href = "{{ url_for('fluxo_caixa') }}";
    }

    function toggleSelecionarTodos(checked) {
        document.querySelectorAll('.item-checkbox').forEach(checkbox => checkbox.checked = checked);
        atualizarSelecao();
    }

    function atualizarSelecao() {
        const selecionados = document.querySelectorAll('.item-checkbox:checked').length;
        const barra = document.getElementById('barraAcoesMassa');
        document.getElementById('contadorSelecionados').textContent = `${selecionados} item(s) selecionado(s)`;
        barra.classList.toggle('visible', selecionados > 0);
        document.getElementById('selecionarTodosHeader').checked = selecionados > 0 && selecionados === document.querySelectorAll('.item-checkbox').length;
    }

    function getSelectedItems() {
        return Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
    }

    // Funções do Modal de Rateio (Lançamento Existente)
    async function abrirModalRateio(itemId) {
        console.log('Abrindo modal de rateio para item:', itemId);
        openModal('rateioModal');

        try {
            const response = await fetch(`/api/fluxo_caixa/rateio/${itemId}`);
            const result = await response.json();

            if (result.success) {
                // CASO 1: Despesa JÁ TEM rateio configurado
                const dados = result.dados;
                document.getElementById('rateioItemId').value = dados.id;
                valorTotalRateio = dados.valor_total;
                document.getElementById('rateioInfoLancamento').innerHTML = `
                <div style="font-weight: 600;">${dados.descricao}</div>
                <div style="font-size: 0.8rem;">Categoria: <strong>${dados.categoria}</strong></div>
                <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-green); margin-top: 8px;">
                    Valor Total do Documento: ${formatarMoeda(dados.valor_total)}
                </div>`;
                veiculosRateio.clear();
                dados.rateio_veiculos.forEach(v => {
                    veiculosRateio.set(v.veiculo_id, { id: v.veiculo_id, display: v.veiculo_nome, valor: v.valor });
                });
                renderizarVeiculosRateioModal();
            } else {
                // CASO 2: Despesa NÃO TEM rateio ainda - CONFIGURAR NOVO RATEIO
                console.log('Despesa sem rateio, configurando novo rateio...');

                // Em vez de fechar, vamos buscar os dados básicos da despesa
                await configurarNovoRateio(itemId);
            }
        } catch (error) {
            console.error('Erro ao buscar dados do rateio:', error);

            // Em caso de erro de rede, também tentar configurar novo rateio
            await configurarNovoRateio(itemId);
        }
    }

    // Nova função para configurar rateio em despesas que não têm
    async function configurarNovoRateio(itemId) {
        try {
            // Buscar dados básicos da despesa
            const response = await fetch(`/api/fluxo_caixa/buscar_dados/${itemId}`);
            const result = await response.json();

            if (result.success) {
                const dados = result.dados;
                document.getElementById('rateioItemId').value = dados.id;
                valorTotalRateio = parseFloat(dados.valor_total);

                document.getElementById('rateioInfoLancamento').innerHTML = `
                <div style="font-weight: 600;">${dados.descricao}</div>
                <div style="font-size: 0.8rem;">Categoria: <strong>${dados.categoria || 'Não informada'}</strong></div>
                <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-green); margin-top: 8px;">
                    Valor Total da Despesa: R$ ${formatarMoeda(valorTotalRateio)}
                </div>
                <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 1rem;">
                    <div style="color: #92400e; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i>
                        Esta despesa ainda não possui rateio configurado. Use a busca abaixo para adicionar veículos.
                    </div>
                </div>
            `;

                // Limpar veículos do rateio e renderizar modal vazio
                veiculosRateio.clear();
                renderizarVeiculosRateioModal();

                console.log('Modal configurado para novo rateio');
            } else {
                // Se não conseguir nem os dados básicos, usar dados mock
                console.log('Usando dados mock para o rateio');
                document.getElementById('rateioItemId').value = itemId;
                valorTotalRateio = 1000.00; // Valor mock

                document.getElementById('rateioInfoLancamento').innerHTML = `
                <div style="font-weight: 600;">Despesa para Rateio</div>
                <div style="font-size: 0.8rem;">Categoria: <strong>Despesa Geral</strong></div>
                <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-green); margin-top: 8px;">
                    Valor Estimado: R$ ${formatarMoeda(valorTotalRateio)}
                </div>
                <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 1rem;">
                    <div style="color: #92400e; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Modo demonstração - API não disponível. Configure o rateio normalmente.
                    </div>
                </div>
            `;

                veiculosRateio.clear();
                renderizarVeiculosRateioModal();
            }
        } catch (error) {
            console.error('Erro ao configurar novo rateio:', error);

            // Último fallback: dados completamente mock
            document.getElementById('rateioItemId').value = itemId;
            valorTotalRateio = 1000.00;

            document.getElementById('rateioInfoLancamento').innerHTML = `
            <div style="font-weight: 600;">Configurar Rateio da Despesa</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary-green); margin-top: 8px;">
                Valor: R$ ${formatarMoeda(valorTotalRateio)}
            </div>
            <div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; margin-top: 1rem;">
                <div style="color: #dc2626; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro de conexão. Usando modo offline para demonstração.
                </div>
            </div>
        `;

            veiculosRateio.clear();
            renderizarVeiculosRateioModal();
        }
    }

    async function buscarVeiculosParaRateio(event) {
        const searchTerm = event.target.value;
        const resultsContainer = document.getElementById('rateioVeiculoSearchResults');
        if (searchTerm.length < 2) { resultsContainer.innerHTML = ''; return; }
        const response = await fetch(`/api/veiculos/search?term=${searchTerm}`);
        const veiculos = await response.json();
        resultsContainer.innerHTML = '';
        const disponiveis = veiculos.filter(v => !veiculosRateio.has(v.id));
        if (disponiveis.length === 0) {
            resultsContainer.innerHTML = '<div class="list-group-item p-2 text-muted">Nenhum veículo encontrado.</div>';
            return;
        }
        disponiveis.forEach(veiculo => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.textContent = veiculo.display;
            item.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                adicionarVeiculoAoRateio(veiculo);
                resultsContainer.innerHTML = '';
                event.target.value = '';
            };
            resultsContainer.appendChild(item);
        });
    }

    function adicionarVeiculoAoRateio(veiculo) {
        if (veiculosRateio.has(veiculo.id)) return;
        const valorInicial = veiculosRateio.size === 0 ? valorTotalRateio : 0;
        veiculosRateio.set(veiculo.id, { ...veiculo, valor: valorInicial });
        renderizarVeiculosRateioModal();
    }

    function removerVeiculoDoRateioModal(veiculoId) {
        veiculosRateio.delete(veiculoId);
        renderizarVeiculosRateioModal();
    }

    function renderizarVeiculosRateioModal() {
        const container = document.getElementById('rateioVeiculosContainer');
        const controles = document.getElementById('rateioControles');

        if (!container) {
            console.error('Container rateioVeiculosContainer não encontrado');
            return;
        }

        // Salvar valores atuais dos inputs antes de recriar o DOM
        const valoresAtuais = new Map();
        document.querySelectorAll('.rateio-valor-input').forEach(input => {
            const veiculoId = parseInt(input.dataset.id);
            valoresAtuais.set(veiculoId, parseFloat(input.value) || 0);
        });

        // Atualizar valores no Map com os valores reais dos inputs
        valoresAtuais.forEach((valor, veiculoId) => {
            if (veiculosRateio.has(veiculoId)) {
                veiculosRateio.get(veiculoId).valor = valor;
            }
        });

        container.innerHTML = '';

        if (veiculosRateio.size === 0) {
            // CORRIGIDO: Criar o HTML do empty state diretamente em vez de clonar
            container.innerHTML = `
            <div class="text-center text-gray-500 my-4">
                <i class="fas fa-truck" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                <p>Nenhum veículo selecionado</p>
                <small>Use a busca acima para adicionar veículos ao rateio</small>
            </div>
        `;
            if (controles) controles.style.display = 'none';
        } else {
            if (controles) controles.style.display = 'flex';

            let index = 1;
            veiculosRateio.forEach(veiculo => {
                const percentual = valorTotalRateio > 0 ? ((veiculo.valor / valorTotalRateio) * 100) : 0;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'veiculo-rateio-item fade-in';
                itemDiv.innerHTML = `
                <div class="veiculo-header">
                    <div class="veiculo-numero">${index}</div>
                    <div class="veiculo-info">
                        <span class="veiculo-nome">${veiculo.display}</span>
                        <span class="veiculo-percentual">${percentual.toFixed(1)}%</span>
                    </div>
                    <button type="button" class="btn-delete-veiculo" onclick="removerVeiculoDoRateioModal(${veiculo.id})"><i class="fas fa-times"></i></button>
                </div>
                <div class="veiculo-valores">
                    <div class="valor-input-group"><label>Valor (R$)</label><input type="number" step="0.01" class="rateio-valor-input" data-id="${veiculo.id}" value="${(veiculo.valor || 0).toFixed(2)}" oninput="atualizarValorRateioModal(${veiculo.id}, this)"></div>
                    <div class="valor-input-group"><label>Percentual (%)</label><input type="number" step="0.1" class="rateio-percentual-input" data-id="${veiculo.id}" value="${percentual.toFixed(1)}" oninput="atualizarPercentualRateioModal(${veiculo.id}, this)"></div>
                </div>`;
                container.appendChild(itemDiv);
                index++;
            });
        }
        atualizarTotalRateioModal();
    }

    function atualizarValorRateioModal(veiculoId, input) {
        const veiculo = veiculosRateio.get(veiculoId);
        veiculo.valor = parseFloat(input.value) || 0;
        const percentual = valorTotalRateio > 0 ? (veiculo.valor / valorTotalRateio) * 100 : 0;
        const percentInput = document.querySelector(`#rateioModal .rateio-percentual-input[data-id="${veiculoId}"]`);
        if (percentInput) percentInput.value = percentual.toFixed(1);
        atualizarTotalRateioModal();
    }

    function atualizarPercentualRateioModal(veiculoId, input) {
        const veiculo = veiculosRateio.get(veiculoId);
        const percentual = parseFloat(input.value) || 0;
        veiculo.valor = (percentual / 100) * valorTotalRateio;
        const valorInput = document.querySelector(`#rateioModal .rateio-valor-input[data-id="${veiculoId}"]`);
        if (valorInput) valorInput.value = veiculo.valor.toFixed(2);
        atualizarTotalRateioModal();
    }

    function atualizarTotalRateioModal() {
        let totalAlocado = Array.from(veiculosRateio.values()).reduce((sum, v) => sum + v.valor, 0);
        const diferenca = totalAlocado - valorTotalRateio;
        document.getElementById('rateioTotalizacao').innerHTML = `
        <div class="totalizacao-content">
            <div class="totalizacao-item"><span class="totalizacao-label">Valor Total</span><span class="totalizacao-valor">${formatarMoeda(valorTotalRateio)}</span></div>
            <div class="totalizacao-item"><span class="totalizacao-label">Total Rateado</span><span class="totalizacao-valor">${formatarMoeda(totalAlocado)}</span></div>
            <div class="totalizacao-item"><span class="totalizacao-label">Diferença</span><span class="totalizacao-valor ${Math.abs(diferenca) > 0.01 ? 'text-red-600' : 'text-green-600'}">${formatarMoeda(diferenca)}</span></div>
        </div>`;
        document.getElementById('btnSalvarRateio').disabled = Math.abs(diferenca) > 0.01 && veiculosRateio.size > 0;
    }

    function distribuirIgualmenteRateio() {
        if (veiculosRateio.size === 0) return;
        const valorPorVeiculo = valorTotalRateio / veiculosRateio.size;
        veiculosRateio.forEach(v => v.valor = valorPorVeiculo);
        renderizarVeiculosRateioModal();
    }

    function ajustarAutomaticamenteRateio() {
        if (veiculosRateio.size === 0) return;
        let totalAlocado = Array.from(veiculosRateio.values()).reduce((sum, v) => sum + v.valor, 0);
        const diferenca = valorTotalRateio - totalAlocado;
        if (diferenca !== 0 && totalAlocado > 0) {
            veiculosRateio.forEach(v => v.valor += diferenca * (v.valor / totalAlocado));
        } else if (totalAlocado === 0) {
            distribuirIgualmenteRateio();
        }
        renderizarVeiculosRateioModal();
    }

    async function salvarRateio() {
        const itemId = document.getElementById('rateioItemId').value;
        const payload = {
            item_id: itemId,
            veiculos: Array.from(veiculosRateio.values()).map(v => ({
                veiculo_id: v.id,
                percentual: (v.valor / valorTotalRateio) * 100
            }))
        };
        fetch('/api/fluxo_caixa/salvar_rateio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(handleResponse).catch(handleError);
    }

    async function excluirRateio() {
        const itemId = document.getElementById('rateioItemId').value;
        if (!confirm('Tem certeza que deseja remover o rateio deste lançamento? A despesa se tornará geral.')) return;
        fetch('/api/fluxo_caixa/excluir_rateio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId })
        }).then(handleResponse).catch(handleError);
    }

    // Funções do Modal de Novo Lançamento (prefixo "nl") - APRIMORADAS
    function nlGerarParcelas() {
        const qtd = parseInt(document.getElementById('nlQuantidadeParcelas').value) || 1;
        const container = document.getElementById('nlParcelasContainer');

        if (nlValorTotal <= 0) {
            showModalNotification('<i class="fas fa-exclamation-triangle"></i> Informe o Valor Total do lançamento primeiro.', 'error', true);
            return;
        }

        if (qtd < 1 || qtd > 48) {
            showModalNotification('<i class="fas fa-exclamation-triangle"></i> Quantidade de parcelas deve ser entre 1 e 48', 'error');
            return;
        }

        // Mostrar container de parcelamento
        document.getElementById('novoLancamentoParcelamento').style.display = 'block';

        // Limpar parcelas existentes
        container.innerHTML = '';

        // Calcular valor por parcela
        const valorPorParcela = nlValorTotal / qtd;

        // Gerar campos para cada parcela com animação
        for (let i = 1; i <= qtd; i++) {
            // Calcular data de vencimento (primeira parcela = 30 dias, demais = +30 dias cada)
            const hoje = new Date();
            const dataVencimento = new Date(hoje.getTime() + (i * 30 * 24 * 60 * 60 * 1000));
            const dataFormatada = dataVencimento.toISOString().split('T')[0];

            const itemDiv = document.createElement('div');
            itemDiv.className = 'parcela-item nl-parcela-item fade-in';
            itemDiv.style.animationDelay = `${i * 0.1}s`;

            itemDiv.innerHTML = `
            <div class="parcela-numero">${i}</div>
            <div class="parcela-input-group">
                <label>Data de Vencimento</label>
                <input type="date" 
                       class="nl-parcela-data form-control" 
                       value="${dataFormatada}" 
                       onchange="nlValidarParcelas()" 
                       required>
            </div>
            <div class="parcela-input-group">
                <label>Valor (R$)</label>
                <input type="number" 
                       class="nl-parcela-valor form-control" 
                       value="${valorPorParcela.toFixed(2)}" 
                       step="0.01" 
                       min="0" 
                       onchange="nlValidarParcelas()"
                       onblur="nlValidarValorParcela(this)"
                       required>
            </div>
        `;

            container.appendChild(itemDiv);
        }

        // Atualizar totalização e validar
        nlAtualizarTotalizacaoParcelas();
        nlValidarParcelas();

        showModalNotification(`<i class="fas fa-calendar-check"></i> ${qtd} parcela${qtd > 1 ? 's' : ''} gerada${qtd > 1 ? 's' : ''} com sucesso!`, 'success');
    }

    function nlValidarValorParcela(input) {
        const valor = parseFloat(input.value);
        if (valor < 0) {
            input.value = "0.00";
            showModalNotification('<i class="fas fa-info-circle"></i> Valor da parcela não pode ser negativo', 'info');
        }
        if (valor > nlValorTotal) {
            input.value = nlValorTotal.toFixed(2);
            showModalNotification(`<i class="fas fa-info-circle"></i> Valor da parcela não pode exceder ${formatarMoeda(nlValorTotal)}`, 'info');
        }
        nlValidarParcelas();
    }

    function nlValidarParcelas() {
        const parcelasValor = document.querySelectorAll('.nl-parcela-valor');
        const validationError = document.getElementById('nlValidationErrorParcelas');
        let totalParcelas = 0;

        // Validar se há parcelas
        if (parcelasValor.length === 0) return false;

        // Somar valores das parcelas
        parcelasValor.forEach(input => {
            const valor = parseFloat(input.value) || 0;
            totalParcelas += valor;
        });

        // Atualizar totalização
        nlAtualizarTotalizacaoParcelas();

        // Verificar se valores batem
        const diferenca = Math.abs(totalParcelas - nlValorTotal);
        const tolerancia = 0.01; // Tolerância de 1 centavo

        if (diferenca > tolerancia) {
            validationError.classList.add('show');
            return false;
        } else {
            validationError.classList.remove('show');
            return true;
        }
    }

    function nlAtualizarTotalizacaoParcelas() {
        const parcelasValor = document.querySelectorAll('.nl-parcela-valor');
        let totalParcelas = 0;

        parcelasValor.forEach(input => {
            const valor = parseFloat(input.value) || 0;
            totalParcelas += valor;
        });

        const diferenca = totalParcelas - nlValorTotal;

        document.getElementById('nlValorTotalParcelas').textContent = formatarMoeda(nlValorTotal);
        document.getElementById('nlSomaParcelas').textContent = formatarMoeda(totalParcelas);

        const difEl = document.getElementById('nlDiferencaParcelas');
        difEl.textContent = formatarMoeda(Math.abs(diferenca));

        // Aplicar classes baseadas na diferença
        if (Math.abs(diferenca) <= 0.01) {
            difEl.className = 'totalizacao-valor text-green-600';
        } else {
            difEl.className = 'totalizacao-valor text-red-600';
        }

        return Math.abs(diferenca) <= 0.01;
    }

    function nlToggleRateio() {
        const tipoSelecionado = document.querySelector('input[name="nl_rateio"]:checked').value;
        const containerRateio = document.getElementById('novoLancamentoRateio');
        if (tipoSelecionado === 'com') {
            containerRateio.style.display = 'block';
            document.getElementById('nlValorTotalRateio').textContent = formatarMoeda(nlValorTotal);
        } else {
            containerRateio.style.display = 'none';
            nlVeiculosRateio.clear();
            nlRenderizarVeiculos();
        }
    }

    async function nlBuscarVeiculos(event) {
        const searchTerm = event.target.value;
        const resultsContainer = document.getElementById('nlVeiculoSearchResults');

        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/veiculos/search?term=${searchTerm}`);
            const veiculos = await response.json();

            resultsContainer.innerHTML = '';

            const veiculosDisponiveis = veiculos.filter(v => !nlVeiculosRateio.has(v.id));

            if (veiculosDisponiveis.length === 0) {
                resultsContainer.innerHTML = '<div class="list-group-item p-2 text-muted">Nenhum veículo encontrado ou todos já foram adicionados</div>';
                return;
            }

            veiculosDisponiveis.forEach(veiculo => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action p-2 border-bottom';
                item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${veiculo.display}</span>
                    <small class="text-green-600"><i class="fas fa-plus"></i> Adicionar</small>
                </div>
            `;
                item.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    nlAdicionarVeiculo(veiculo);
                    resultsContainer.innerHTML = '';
                    event.target.value = '';
                    event.target.focus();
                };
                resultsContainer.appendChild(item);
            });
        } catch (error) {
            console.error("Erro ao buscar veículos:", error);
            // Usar dados mock em caso de erro
            const veiculosMock = [
                { id: 1, display: "ABC-1234 - Volvo FH 540" },
                { id: 2, display: "DEF-5678 - Scania R450" },
                { id: 3, display: "GHI-9012 - Mercedes Actros" },
                { id: 4, display: "JKL-3456 - Ford Cargo 816" },
                { id: 5, display: "MNO-7890 - Iveco Daily" }
            ];

            resultsContainer.innerHTML = '';
            const veiculosEncontrados = veiculosMock.filter(v =>
                v.display.toLowerCase().includes(searchTerm.toLowerCase()) &&
                !nlVeiculosRateio.has(v.id)
            );

            if (veiculosEncontrados.length === 0) {
                resultsContainer.innerHTML = '<div class="list-group-item p-2 text-muted">Nenhum veículo encontrado ou todos já foram adicionados</div>';
                return;
            }

            veiculosEncontrados.forEach(veiculo => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action p-2 border-bottom';
                item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${veiculo.display}</span>
                    <small class="text-green-600"><i class="fas fa-plus"></i> Adicionar</small>
                </div>
            `;
                item.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    nlAdicionarVeiculo(veiculo);
                    resultsContainer.innerHTML = '';
                    event.target.value = '';
                    event.target.focus();
                };
                resultsContainer.appendChild(item);
            });
        }
    }

    function nlAdicionarVeiculo(veiculo) {
        if (nlVeiculosRateio.has(veiculo.id)) {
            showModalNotification('<i class="fas fa-info-circle"></i> Este veículo já foi adicionado ao rateio', 'info');
            return;
        }

        // Se é o primeiro veículo, atribui o valor total
        // Se não é o primeiro, inicia com valor 0 para distribuição manual
        const valorInicial = nlVeiculosRateio.size === 0 ? nlValorTotal : 0;

        nlVeiculosRateio.set(veiculo.id, { ...veiculo, valor: valorInicial });
        nlRenderizarVeiculos();

        const quantidade = nlVeiculosRateio.size;

        if (quantidade === 1) {
            showModalNotification(`<i class="fas fa-truck"></i> Primeiro veículo adicionado com valor total do lançamento`, 'success');
            setTimeout(() => {
                showModalNotification('<i class="fas fa-lightbulb"></i> Dica: Adicione mais veículos para ratear a despesa entre eles', 'info');
            }, 2000);
        } else {
            showModalNotification(`<i class="fas fa-truck"></i> Veículo adicionado! Total: ${quantidade} veículo${quantidade > 1 ? 's' : ''} no rateio`, 'success');

            // Sugestão de distribuição automática
            setTimeout(() => {
                const totalAtual = Array.from(nlVeiculosRateio.values()).reduce((sum, v) => sum + v.valor, 0);
                if (Math.abs(totalAtual - nlValorTotal) > 0.01) {
                    showModalNotification('<i class="fas fa-magic"></i> Use "Dividir Igual" ou "Ajustar Auto" para distribuir automaticamente', 'info');
                }
            }, 1500);
        }
    }

    function nlRemoverVeiculo(veiculoId) {
        const veiculo = nlVeiculosRateio.get(veiculoId);
        if (!veiculo) return;

        if (confirm(`Remover "${veiculo.display}" do rateio?`)) {
            nlVeiculosRateio.delete(veiculoId);
            nlRenderizarVeiculos();

            const quantidade = nlVeiculosRateio.size;
            showModalNotification(`<i class="fas fa-trash"></i> Veículo removido. ${quantidade} veículo${quantidade !== 1 ? 's' : ''} restante${quantidade !== 1 ? 's' : ''}`, 'info');
        }
    }

    function nlRenderizarVeiculos() {
        const container = document.getElementById('nlVeiculosContainer');
        const controles = document.getElementById('nlRateioControles');

        // Salvar valores atuais dos inputs antes de recriar o DOM
        const valoresAtuais = new Map();
        document.querySelectorAll('#novoLancamentoModal .rateio-valor-input').forEach(input => {
            const veiculoId = parseInt(input.dataset.id);
            valoresAtuais.set(veiculoId, parseFloat(input.value) || 0);
        });

        // Atualizar valores no Map com os valores reais dos inputs
        valoresAtuais.forEach((valor, veiculoId) => {
            if (nlVeiculosRateio.has(veiculoId)) {
                nlVeiculosRateio.get(veiculoId).valor = valor;
            }
        });

        container.innerHTML = '';

        if (nlVeiculosRateio.size === 0) {
            container.innerHTML = `
            <div class="text-center text-gray-500 my-4" id="nlRateioEmpty">
                <i class="fas fa-truck" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                <p>Nenhum veículo selecionado</p>
                <small>Use a busca acima para adicionar veículos ao rateio</small>
            </div>
        `;
            controles.style.display = 'none';
        } else {
            controles.style.display = 'flex';

            let index = 1;
            nlVeiculosRateio.forEach(veiculo => {
                const percentual = nlValorTotal > 0 ? ((veiculo.valor / nlValorTotal) * 100) : 0;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'veiculo-rateio-item fade-in';
                itemDiv.style.animationDelay = `${index * 0.1}s`;
                itemDiv.innerHTML = `
                <div class="veiculo-header">
                    <div class="veiculo-numero">${index}</div>
                    <div class="veiculo-info">
                        <span class="veiculo-nome">${veiculo.display}</span>
                        <span class="veiculo-percentual" id="nl-percentual-${veiculo.id}">${percentual.toFixed(1)}%</span>
                    </div>
                    <button type="button" class="btn-delete-veiculo" onclick="nlRemoverVeiculo(${veiculo.id})" title="Remover veículo">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="veiculo-valores">
                    <div class="valor-input-group">
                        <label>Valor (R$)</label>
                        <input type="number" 
                               class="rateio-valor-input" 
                               data-id="${veiculo.id}" 
                               value="${(veiculo.valor || 0).toFixed(2)}" 
                               step="0.01" 
                               min="0" 
                               max="${nlValorTotal}"
                               oninput="nlAtualizarValor(${veiculo.id}, this.value)"
                               onblur="nlValidarValorMinimo(this)"
                               placeholder="0,00">
                    </div>
                    <div class="valor-input-group">
                        <label>Percentual (%)</label>
                        <input type="number" 
                               class="rateio-percentual-input" 
                               data-id="${veiculo.id}" 
                               value="${percentual.toFixed(1)}" 
                               step="0.1" 
                               min="0" 
                               max="100"
                               oninput="nlAtualizarPercentual(${veiculo.id}, this.value)"
                               onblur="nlValidarPercentualMinimo(this)"
                               placeholder="0,0">
                    </div>
                </div>
            `;
                container.appendChild(itemDiv);
                index++;
            });
        }
        nlValidarRateio();
    }

    function nlValidarValorMinimo(input) {
        const valor = parseFloat(input.value);
        if (valor < 0) {
            input.value = "0.00";
            showModalNotification('<i class="fas fa-info-circle"></i> Valor não pode ser negativo', 'info');
        }
        if (valor > nlValorTotal) {
            input.value = nlValorTotal.toFixed(2);
            showModalNotification(`<i class="fas fa-info-circle"></i> Valor não pode exceder ${formatarMoeda(nlValorTotal)}`, 'info');
        }
        nlAtualizarValor(parseInt(input.dataset.id), input.value);
    }

    function nlValidarPercentualMinimo(input) {
        const percentual = parseFloat(input.value);
        if (percentual < 0) {
            input.value = "0.0";
            showModalNotification('<i class="fas fa-info-circle"></i> Percentual não pode ser negativo', 'info');
        }
        if (percentual > 100) {
            input.value = "100.0";
            showModalNotification('<i class="fas fa-info-circle"></i> Percentual não pode exceder 100%', 'info');
        }
        nlAtualizarPercentual(parseInt(input.dataset.id), input.value);
    }

    function nlAtualizarValor(veiculoId, valor) {
        const v = nlVeiculosRateio.get(veiculoId);
        if (!v) return;

        v.valor = Math.max(0, Math.min(parseFloat(valor) || 0, nlValorTotal));

        // Atualizar campo de percentual correspondente SEM re-renderizar
        const percentualInput = document.querySelector(`#novoLancamentoModal .rateio-percentual-input[data-id="${veiculoId}"]`);
        if (percentualInput && nlValorTotal > 0) {
            const novoPercentual = (v.valor / nlValorTotal) * 100;
            percentualInput.value = novoPercentual.toFixed(1);

            // Atualizar badge de percentual
            const percentualBadge = document.getElementById(`nl-percentual-${veiculoId}`);
            if (percentualBadge) {
                percentualBadge.textContent = novoPercentual.toFixed(1) + '%';
            }
        }

        nlValidarRateio();
    }

    function nlAtualizarPercentual(veiculoId, percentual) {
        const v = nlVeiculosRateio.get(veiculoId);
        if (!v) return;

        const percentualLimitado = Math.max(0, Math.min(parseFloat(percentual) || 0, 100));
        v.valor = (percentualLimitado / 100) * nlValorTotal;

        // Atualizar campo de valor correspondente SEM re-renderizar
        const valorInput = document.querySelector(`#novoLancamentoModal .rateio-valor-input[data-id="${veiculoId}"]`);
        if (valorInput) {
            valorInput.value = v.valor.toFixed(2);
        }

        // Atualizar badge de percentual
        const percentualBadge = document.getElementById(`nl-percentual-${veiculoId}`);
        if (percentualBadge) {
            percentualBadge.textContent = percentualLimitado.toFixed(1) + '%';
        }

        nlValidarRateio();
    }

    function nlDistribuirIgualmente() {
        if (nlVeiculosRateio.size === 0) {
            showModalNotification('<i class="fas fa-info-circle"></i> Adicione pelo menos um veículo antes de distribuir os valores', 'info');
            return;
        }

        const valorPorVeiculo = nlValorTotal / nlVeiculosRateio.size;

        nlVeiculosRateio.forEach(veiculo => {
            veiculo.valor = valorPorVeiculo;
        });

        // Atualizar todos os inputs na tela
        document.querySelectorAll('#novoLancamentoModal .rateio-valor-input').forEach(input => {
            const veiculoId = parseInt(input.dataset.id);
            if (nlVeiculosRateio.has(veiculoId)) {
                input.value = valorPorVeiculo.toFixed(2);
            }
        });

        document.querySelectorAll('#novoLancamentoModal .rateio-percentual-input').forEach(input => {
            const veiculoId = parseInt(input.dataset.id);
            if (nlVeiculosRateio.has(veiculoId)) {
                input.value = (100 / nlVeiculosRateio.size).toFixed(1);
            }
        });

        // Atualizar badges de percentual
        nlVeiculosRateio.forEach(veiculo => {
            const percentualBadge = document.getElementById(`nl-percentual-${veiculo.id}`);
            if (percentualBadge) {
                percentualBadge.textContent = (100 / nlVeiculosRateio.size).toFixed(1) + '%';
            }
        });

        nlValidarRateio();
        showModalNotification(`<i class="fas fa-check-circle"></i> Valor distribuído igualmente: ${formatarMoeda(valorPorVeiculo)} por veículo (${(100 / nlVeiculosRateio.size).toFixed(1)}% cada)`, 'success');
    }

    function nlAjustarAutomaticamente() {
        if (nlVeiculosRateio.size === 0) {
            showModalNotification('<i class="fas fa-info-circle"></i> Adicione veículos primeiro', 'info');
            return;
        }

        // Calcular total atual
        let totalAtual = 0;
        nlVeiculosRateio.forEach(v => totalAtual += v.valor);

        if (totalAtual === 0) {
            nlDistribuirIgualmente();
            return;
        }

        // Calcular diferença
        const diferenca = nlValorTotal - totalAtual;

        if (Math.abs(diferenca) <= 0.01) {
            showModalNotification('<i class="fas fa-check-circle"></i> Valores já estão corretos!', 'success');
            return;
        }

        // Distribuir a diferença proporcionalmente
        nlVeiculosRateio.forEach(veiculo => {
            if (totalAtual > 0) {
                const proporcao = veiculo.valor / totalAtual;
                veiculo.valor = Math.max(0, veiculo.valor + (diferenca * proporcao));
            } else {
                veiculo.valor = nlValorTotal / nlVeiculosRateio.size;
            }
        });

        // Atualizar inputs na tela
        nlRenderizarVeiculos();

        showModalNotification(`<i class="fas fa-magic"></i> Valores ajustados automaticamente! Diferença de ${formatarMoeda(Math.abs(diferenca))} distribuída proporcionalmente`, 'success');
    }

    function nlLimparRateio() {
        if (nlVeiculosRateio.size === 0) {
            return;
        }

        if (confirm(`Tem certeza que deseja remover todos os ${nlVeiculosRateio.size} veículo(s) do rateio?`)) {
            nlVeiculosRateio.clear();
            nlRenderizarVeiculos();
            showModalNotification('<i class="fas fa-info-circle"></i> Todos os veículos foram removidos do rateio', 'info');
        }
    }

    function nlValidarRateio() {
        let soma = Array.from(nlVeiculosRateio.values()).reduce((acc, v) => acc + v.valor, 0);
        const diferenca = soma - nlValorTotal;
        const quantidadeVeiculos = nlVeiculosRateio.size;
        const percentualCompleto = nlValorTotal > 0 ? (soma / nlValorTotal) * 100 : 0;

        // Atualizar valores na totalização
        document.getElementById('nlValorTotalRateio').textContent = formatarMoeda(nlValorTotal);
        document.getElementById('nlSomaRateio').textContent = formatarMoeda(soma);
        const diferencaEl = document.getElementById('nlDiferencaRateio');

        diferencaEl.textContent = formatarMoeda(Math.abs(diferenca));

        // Aplicar classes baseadas na diferença
        const isValid = Math.abs(diferenca) <= 0.01;
        diferencaEl.classList.toggle('text-red-600', !isValid);
        diferencaEl.classList.toggle('text-green-600', isValid);

        // Adicionar feedback visual mais detalhado se necessário
        if (quantidadeVeiculos === 0) {
            // Nada para validar ainda
        } else if (isValid) {
            // Rateio correto
            setTimeout(() => {
                if (Math.abs(diferenca) <= 0.01 && quantidadeVeiculos > 0) {
                    showNotification(`<i class="fas fa-check-circle"></i> Rateio correto entre ${quantidadeVeiculos} veículo(s) - 100% distribuído`, 'success');
                }
            }, 500);
        }

        return isValid;
    }
</script>
{% endblock %}