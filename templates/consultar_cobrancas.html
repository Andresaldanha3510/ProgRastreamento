<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Cobranças - TrackGo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Cole aqui EXATAMENTE o mesmo CSS do seu arquivo index.html */
        /* Para manter a consistência, vou colocar os principais estilos aqui */
        body {
            background: white;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            padding-top: 100px;
        }
        header.navbar {
            background: linear-gradient(135deg, #2e7d32, #2e7d32);
            box-shadow: 0px 3px 6px rgb(10, 73, 10);
            width: 100%; position: fixed; top: 0; left: 0; z-index: 30;
            height: 100px; display: flex; justify-content: space-between;
            align-items: center; padding: 0 2rem;
        }
        #menu-toggle { color: white; font-size: 1.8rem; }
        .brand-section { display: flex; align-items: center; gap: 12px; }
        .img-logo img { height: 60px; width: 60px; }
        .name-tag h1 { color: white; font-size: 1.25rem; }
        a.user-icon { color: white; font-size: 1.5rem; }

        div#sidebar {
            background-color: #2F3640;
            box-shadow: 2px 0px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease-in-out;
            position: fixed; top: 100px; left: 0;
            height: calc(100vh - 100px); z-index: 20;
            width: 14rem; padding: 1.5rem;
        }
        div#sidebar ul li a { color: white; display: block; padding: 10px 15px; border-radius: 8px; transition: background-color 0.2s; display: flex; align-items: center; gap: 10px; }
        div#sidebar ul li a:hover { background-color: #2e8b57; }
        div#sidebar ul li a.active { background-color: #2e8b57; font-weight: 600; }
        div#sidebar h1 { color: #ffffff; font-size: 1.5rem; font-weight: bold; margin-bottom: 2rem; text-align: center; }

        div.main-content {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 100px);
            transition: margin-left 0.3s ease;
            padding: 2rem;
        }
        @media (min-width: 769px) {
            div.main-content { margin-left: 14rem; }
            #menu-toggle { display: none; }
        }
        @media (max-width: 768px) {
            div#sidebar { transform: translateX(-100%); }
            div#sidebar.open { transform: translateX(0); z-index: 40; }
            .name-tag h1 { display: none; }
        }
    </style>
</head>
<body>

    <header class="navbar">
        <button id="menu-toggle" class="text-white md:hidden focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
        <div class="brand-section">
            <div class="img-logo">
                <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='brasão.png') }}" alt="Logo TrackGo"></a>
            </div>
            <div class="name-tag">
                <h1>TrackGo</h1>
            </div>
        </div>
        <div class="flex items-center gap-4 text-white">
            <div class="hidden sm:flex items-center gap-3">
                <span class="text-sm">Olá, {{ current_user.nome or current_user.email }}</span>
            </div>
            <a href="{{ url_for('configuracoes') }}" class="user-icon" title="Configurações"><i class="fas fa-user-cog"></i></a>
            <a href="{{ url_for('logout') }}" class="user-icon" title="Sair"><i class="fas fa-sign-out-alt"></i></a>
        </div>
    </header>

    <div class="flex h-screen">
        <div id="sidebar" class="sidebar">
             <h1 class="text-2xl font-bold mb-8 text-center text-white">Menu</h1>
             <ul>
                <li class="mb-4"><a href="{{ url_for('index') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="mb-4"><a href="{{ url_for('iniciar_viagem') }}"><i class="fas fa-route"></i> Iniciar Viagem</a></li>
                <li class="mb-4"><a href="{{ url_for('consultar_viagens') }}"><i class="fas fa-search"></i> Consultar Viagens</a></li>
                <li class="mb-4"><a href="{{ url_for('consultar_cobrancas') }}" class="active"><i class="fas fa-file-invoice-dollar"></i> Cobranças</a></li>
                <li class="mb-4"><a href="{{ url_for('relatorios') }}"><i class="fas fa-chart-bar"></i> Relatórios</a></li>
                <hr class="border-gray-500 my-4">
                <li class="mb-4"><a href="{{ url_for('consultar_clientes') }}"><i class="fas fa-user-tie"></i> Clientes</a></li>
                <li class="mb-4"><a href="{{ url_for('consultar_motoristas') }}"><i class="fas fa-users"></i> Motoristas</a></li>
                <li class="mb-4"><a href="{{ url_for('consultar_veiculos') }}"><i class="fas fa-truck"></i> Veículos</a></li>
            </ul>
        </div>

        <div class="flex-1 overflow-auto main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                            {{ message }}
                            <button onclick="this.parentElement.remove()" class="float-right font-bold text-lg leading-none">&times;</button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Gestão de Cobranças</h2>
                <a href="{{ url_for('gerar_cobranca') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    Gerar Nova Cobrança
                </a>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-yellow-400 text-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold">Total Pendente / Vencido</h3>
                    <p class="text-3xl font-bold">R$ {{ "%.2f"|format(total_pendente or 0.0) | replace('.', ',') }}</p>
                </div>
                <div class="bg-green-500 text-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold">Total Pago</h3>
                    <p class="text-3xl font-bold">R$ {{ "%.2f"|format(total_pago or 0.0) | replace('.', ',') }}</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left">#ID</th>
                            <th class="py-3 px-4 text-left">Cliente</th>
                            <th class="py-3 px-4 text-left">Emissão</th>
                            <th class="py-3 px-4 text-left">Vencimento</th>
                            <th class="py-3 px-4 text-right">Valor</th>
                            <th class="py-3 px-4 text-center">Status</th>
                            <th class="py-3 px-4 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">
                        {% for cobranca in cobrancas %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">{{ cobranca.id }}</td>
                            <td class="py-3 px-4">{{ cobranca.cliente.nome_razao_social }}</td>
                            <td class="py-3 px-4">{{ cobranca.data_emissao.strftime('%d/%m/%Y') }}</td>
                            <td class="py-3 px-4">{{ cobranca.data_vencimento.strftime('%d/%m/%Y') }}</td>
                            <td class="py-3 px-4 text-right font-semibold">R$ {{ "%.2f"|format(cobranca.valor_total) | replace('.', ',') }}</td>
                            <td class="py-3 px-4 text-center">
                                {# Lógica para exibir o status com cores #}
                                {% if cobranca.status == 'Paga' %}
                                    <span class="bg-green-200 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Paga</span>
                                {% elif cobranca.status == 'Vencida' %}
                                    <span class="bg-red-200 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Vencida</span>
                                {% else %}
                                    <span class="bg-yellow-200 text-yellow-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Pendente</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 text-center">
                                {# Lógica para exibir o botão ou a data de pagamento #}
                                {% if cobranca.status != 'Paga' %}
                                <button onclick="abrirModalPagamento({{ cobranca.id }})" class="bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600">
                                    <i class="fas fa-check"></i> Pagar
                                </button>
                                {% else %}
                                <span class="text-sm text-gray-500 italic">Pago em {{ cobranca.data_pagamento.strftime('%d/%m/%Y') }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">Nenhuma cobrança encontrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="pagamentoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Confirmar Pagamento</h3>
        <p class="mb-4">Selecione o meio de pagamento para confirmar o recebimento desta cobrança.</p>
        <input type="hidden" id="cobrancaIdInput">
        <div>
            <label for="meioPagamentoSelect" class="block text-sm font-medium text-gray-700">Meio de Pagamento</label>
            <select id="meioPagamentoSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                <option value="" disabled selected>Selecione...</option>
                <option value="Pix">Pix</option>
                <option value="Boleto Bancário">Boleto Bancário</option>
                <option value="Transferência Bancária (TED/DOC)">Transferência Bancária</option>
                <option value="Cartão de Crédito">Cartão de Crédito</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Outro">Outro</option>
            </select>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" onclick="fecharModalPagamento()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Cancelar</button>
          <button type="button" onclick="confirmarPagamento()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Confirmar</button>
        </div>
      </div>
    </div>

<script>
    // Script para gerenciamento da sidebar (cópia do index.html)
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    if (menuToggle) {
        menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    }
    
    // Scripts para a lógica do Modal de Pagamento
    const modal = document.getElementById('pagamentoModal');

    function abrirModalPagamento(cobrancaId) {
        document.getElementById('cobrancaIdInput').value = cobrancaId;
        modal.classList.remove('hidden');
    }

    function fecharModalPagamento() {
        modal.classList.add('hidden');
    }

    function confirmarPagamento() {
        const cobrancaId = document.getElementById('cobrancaIdInput').value;
        const meioPagamento = document.getElementById('meioPagamentoSelect').value;

        if (!meioPagamento) {
            alert('Por favor, selecione um meio de pagamento.');
            return;
        }

        fetch(`/api/cobranca/${cobrancaId}/marcar_paga`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ meio_pagamento: meioPagamento })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fecharModalPagamento();
                location.reload(); // Recarrega a página para ver a mudança
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Ocorreu um erro de comunicação com o servidor.');
        });
    }
</script>

</body>
</html>