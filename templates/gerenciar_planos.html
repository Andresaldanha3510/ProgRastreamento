{% extends "base.html" %}

{% block title %}Gerenciar Planos de Manutenção{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .modal {
        display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6);
        align-items: center; justify-content: center; z-index: 50;
    }
    .modal.flex { display: flex; }
    .modal-content {
        background-color: white; padding: 1.5rem 2rem; border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 90%; max-width: 700px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Gerenciar Planos e Kits de Peças</h1>
        <a href="{{ url_for('oficina') }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
            &larr; Voltar para a Oficina
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição do Plano</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Intervalos Padrão (KM / Meses)</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for plano in planos %}
                <tr id="plano-row-{{ plano.id }}">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{{ plano.descricao }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-500 plano-intervalos">
                        {{ "{:,.0f}".format(plano.intervalo_km_padrao).replace(",", ".") if plano.intervalo_km_padrao else 'N/A' }} km / 
                        {{ plano.intervalo_meses_padrao if plano.intervalo_meses_padrao else 'N/A' }} meses
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <button onclick="abrirModalEditarKit({{ plano.id }}, '{{ plano.descricao }}', '{{ plano.intervalo_km_padrao or '' }}', '{{ plano.intervalo_meses_padrao or '' }}')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">
                            <i class="fas fa-edit mr-2"></i>Editar Plano e Kit
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">Nenhum plano de manutenção cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="modal-editar-kit" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800" id="kit-plano-nome"></h2>
            </div>
            <button onclick="fecharModal('modal-editar-kit')" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        </div>

        <div class="border rounded-lg p-4 bg-gray-50 mb-6">
             <h3 class="font-bold text-lg mb-4">Detalhes do Plano</h3>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <div>
                    <label for="input-intervalo-km" class="block text-sm font-medium text-gray-700">Intervalo Padrão (KM)</label>
                    <input type="number" id="input-intervalo-km" placeholder="Ex: 10000" class="w-full mt-1 p-2 border rounded-md">
                 </div>
                 <div>
                    <label for="input-intervalo-meses" class="block text-sm font-medium text-gray-700">Intervalo Padrão (Meses)</label>
                    <input type="number" id="input-intervalo-meses" placeholder="Ex: 6" class="w-full mt-1 p-2 border rounded-md">
                 </div>
             </div>
        </div>
        
        <div class="border rounded-lg p-4 bg-gray-50 mb-6">
            <h3 class="font-bold text-lg mb-4">Adicionar Insumo ao Kit</h3>
            <form id="form-add-insumo-kit" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="select-insumo" class="block text-sm font-medium text-gray-700">Insumo</label>
                    <select id="select-insumo" class="w-full mt-1 p-2 border rounded-md">
                        <option value="">-- Selecione uma peça --</option>
                        {% for insumo in insumos %}
                            <option value="{{ insumo.id }}">{{ insumo.descricao }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="input-quantidade" class="block text-sm font-medium text-gray-700">Quantidade</label>
                    <input type="number" id="input-quantidade" value="1" min="0.1" step="0.1" class="w-full mt-1 p-2 border rounded-md">
                </div>
                <div class="md:col-span-3 text-right">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Adicionar</button>
                </div>
            </form>
        </div>

        <div>
            <h3 class="font-bold text-lg mb-4">Insumos Atuais no Kit</h3>
            <div id="lista-kit-insumos" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <p class="text-gray-500 text-center">Nenhum insumo neste kit ainda.</p>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button id="btn-salvar-kit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md">Salvar Plano e Kit</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function fecharModal(modalId) { document.getElementById(modalId).classList.remove('flex'); }
    function abrirModal(modalId) { document.getElementById(modalId).classList.add('flex'); }

    let kitAtual = []; 
    let planoIdAtual = null;

    async function abrirModalEditarKit(planoId, planoNome, intervaloKm, intervaloMeses) {
        planoIdAtual = planoId;
        document.getElementById('kit-plano-nome').textContent = `Editar Plano: ${planoNome}`;
        
        // ### NOVO: Preenche os campos de intervalo ###
        document.getElementById('input-intervalo-km').value = intervaloKm;
        document.getElementById('input-intervalo-meses').value = intervaloMeses;
        
        try {
            const response = await fetch(`/api/planos/${planoId}/insumos`);
            if (!response.ok) throw new Error('Falha ao buscar o kit.');
            kitAtual = await response.json();
            renderizarKit();
            abrirModal('modal-editar-kit');
        } catch (error) {
            alert('Erro: ' + error.message);
        }
    }

    function renderizarKit() {
        const container = document.getElementById('lista-kit-insumos');
        container.innerHTML = '';
        if (kitAtual.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center">Nenhum insumo neste kit ainda.</p>';
            return;
        }
        kitAtual.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-white p-2 border rounded flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <span class="font-semibold">${item.insumo_descricao}</span>
                    <span class="text-gray-600 text-sm ml-2">(Qtd: ${item.quantidade})</span>
                </div>
                <button onclick="removerInsumoDoKit(${item.insumo_id})" class="text-red-500 hover:text-red-700 text-sm">Remover</button>
            `;
            container.appendChild(div);
        });
    }

    document.getElementById('form-add-insumo-kit').addEventListener('submit', function(e) {
        e.preventDefault();
        const select = document.getElementById('select-insumo');
        const insumoId = parseInt(select.value);
        const insumoDescricao = select.options[select.selectedIndex].text;
        const quantidade = parseFloat(document.getElementById('input-quantidade').value);

        if (!insumoId || !quantidade || quantidade <= 0) {
            alert('Selecione um insumo e informe uma quantidade válida.'); return;
        }
        if (kitAtual.some(item => item.insumo_id === insumoId)) {
            alert('Este insumo já está no kit.'); return;
        }
        kitAtual.push({ insumo_id: insumoId, insumo_descricao: insumoDescricao, quantidade: quantidade });
        renderizarKit();
        this.reset();
    });

    function removerInsumoDoKit(insumoId) {
        kitAtual = kitAtual.filter(item => item.insumo_id !== insumoId);
        renderizarKit();
    }

    document.getElementById('btn-salvar-kit').addEventListener('click', async function() {
        if (planoIdAtual === null) return;
        
        // ### NOVO: Pega os valores dos intervalos ###
        const intervaloKm = document.getElementById('input-intervalo-km').value;
        const intervaloMeses = document.getElementById('input-intervalo-meses').value;

        const payload = {
            intervalo_km: intervaloKm,
            intervalo_meses: intervaloMeses,
            kit: kitAtual
        };
        
        this.disabled = true; this.textContent = 'Salvando...';

        try {
            const response = await fetch(`/api/planos/${planoIdAtual}/insumos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            alert(result.message);
            fecharModal('modal-editar-kit');

            // Atualiza a tabela na tela sem precisar recarregar a página
            const linhaPlano = document.getElementById(`plano-row-${planoIdAtual}`);
            if(linhaPlano) {
                const celulaIntervalos = linhaPlano.querySelector('.plano-intervalos');
                celulaIntervalos.innerHTML = `${intervaloKm || 'N/A'} km / ${intervaloMeses || 'N/A'} meses`;
            }

        } catch (error) {
            alert('Erro: ' + error.message);
        } finally {
            this.disabled = false; this.textContent = 'Salvar Plano e Kit';
        }
    });
</script>
{% endblock %}