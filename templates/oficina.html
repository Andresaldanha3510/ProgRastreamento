{% extends "base.html" %}

{% block title %}Dashboard de Manutenção da Frota{% endblock %}

{% block styles %}
<style>
    /* Estilos aprimorados para um look mais profissional */
    :root {
        --primary-color: #4f46e5;
        --secondary-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --gray-100: #f3f4f6;
        --gray-500: #6b7280;
        --gray-700: #374151;
        --gray-800: #1f2937;
    }

    body {
        background-color: var(--gray-100);
    }

    .kpi-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .status {
        padding: 5px 12px;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
    }

    .status-disponível {
        background-color: var(--secondary-color);
    }

    .status-em_rota {
        background-color: #3b82f6;
    }

    .status-em_manutenção {
        background-color: var(--warning-color);
        color: var(--gray-800);
    }

    .status-concluída {
        background-color: var(--gray-500);
    }

    .status-agendada {
        background-color: #6366f1;
    }

    /* CORREÇÃO ADICIONADA AQUI */
    .status-em_andamento {
        background-color: #8b5cf6;
    }

    /* Roxo sólido e opaco */


    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
        z-index: 50;
        animation: fadeIn 0.3s;
    }

    .modal.flex {
        display: flex;
    }

    .modal-content {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        padding: 1.5rem 2rem;
        width: 100%;
        animation: slideIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px) scale(0.98);
            opacity: 0;
        }

        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }

    .progress-bar-container {
        background-color: #e5e7eb;
        border-radius: 9999px;
        height: 8px;
        width: 100%;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        border-radius: 9999px;
        transition: width 0.5s ease-in-out;
    }

    /* CORREÇÃO PARA O MENU DE AÇÕES: Classe que permite o menu 'transbordar' o container da tabela */
    .overflow-visible {
        overflow: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-gray-800">Dashboard de Manutenção</h1>
        <div class="flex flex-wrap md:flex-nowrap gap-2 sm:gap-4">
            <button onclick="abrirModalHistoricoCompleto()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 text-sm sm:text-base">
                <i class="fas fa-history"></i>
                <span>Ver Histórico</span>
            </button>
            <button onclick="abrirModalNovaManutencao(null, null, null)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 text-sm sm:text-base">
                <i class="fas fa-screwdriver-wrench"></i>
                <span>Registrar Corretiva</span>
            </button>
            <a href="{{ url_for('gerenciar_insumos_page') }}" class="bg-gray-800 hover:bg-black text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 text-sm sm:text-base">
                <i class="fas fa-box-open"></i>
                <span>Gerenciar Insumos</span>
            </a>
            <a href="{{ url_for('gerenciar_planos_page') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 text-sm sm:text-base">
                <i class="fas fa-tasks"></i>
                <span>Gerenciar Planos</span>
            </a>
        <!--    <a href="{{ url_for('previsao_custos_manutencao') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 text-sm sm:text-base">
                <i class="fas fa-chart-line"></i>
                <span>Ver Previsão de Custos</span>
            </a>
            -->
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="kpi-card bg-white p-6 rounded-lg shadow-md text-center">
            <h2 class="text-lg font-semibold text-gray-500"><i
                    class="fas fa-triangle-exclamation text-yellow-500 mr-2"></i>Alertas Atuais</h2>
            <p class="text-4xl font-bold text-gray-800 mt-2">{{ alertas|length }}</p>
        </div>
        <div class="kpi-card bg-white p-6 rounded-lg shadow-md text-center">
            <h2 class="text-lg font-semibold text-gray-500"><i class="fas fa-tools text-blue-500 mr-2"></i>Em Manutenção
            </h2>
            <p class="text-4xl font-bold text-gray-800 mt-2">{{ manutencoes_em_andamento|length }}</p>
        </div>
        <div class="kpi-card bg-white p-6 rounded-lg shadow-md text-center">
            <h2 class="text-lg font-semibold text-gray-500"><i
                    class="fas fa-check-circle text-green-500 mr-2"></i>Concluídas no Mês</h2>
            <p class="text-4xl font-bold text-gray-800 mt-2">{{ kpis.concluidas_no_mes }}</p>
        </div>
        <div class="kpi-card bg-white p-6 rounded-lg shadow-md text-center">
            <h2 class="text-lg font-semibold text-gray-500"><i class="fas fa-dollar-sign text-red-500 mr-2"></i>Custo do
                Mês</h2>
            <p class="text-4xl font-bold text-gray-800 mt-2">R$ {{ "{:,.2f}".format(kpis.custo_mes_atual).replace(",",
                "X").replace(".", ",").replace("X", ".") }}</p>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Veículos em Manutenção ou Agendados</h2>
        <div id="frota-table-wrapper" class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-4 px-8 text-left">Veículo (Placa)</th>
                        <th class="py-4 px-8 text-left">Tipo</th>
                        <th class="py-4 px-8 text-left">Data de Entrada / Agendamento</th>
                        <th class="py-4 px-8 text-left">Status</th>
                        <th class="py-4 px-8 text-center">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for manutencao in manutencoes_em_andamento %}
                    <tr class="border-t hover:bg-gray-50">
                        <td class="py-5 px-8 font-semibold whitespace-nowrap">{{ manutencao.veiculo.modelo }} <span
                                class="font-mono text-gray-600">({{ manutencao.veiculo.placa }})</span></td>
                        <td class="py-5 px-8 whitespace-nowrap">{{ manutencao.tipo_manutencao }}</td>
                        <td class="py-5 px-8 whitespace-nowrap">{{ manutencao.data_entrada.strftime('%d/%m/%Y') }}</td>
                        <td class="py-5 px-8 whitespace-nowrap">
                            <span class="status status-{{ manutencao.status.lower().replace(' ', '_') }}">{{
                                manutencao.status }}</span>
                        </td>
                        <td class="py-5 px-8 text-center">
                            <button
                                onclick="abrirModalGerenciarManutencao('{{ manutencao.id }}', '{{ manutencao.veiculo.placa }}')"
                                class="bg-purple-500 hover:bg-purple-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
                                <i class="fas fa-edit mr-1"></i> Gerenciar
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="py-6 px-8 text-center text-gray-500">
                            <i class="fas fa-car-side text-green-500 text-2xl mb-2"></i>
                            <p>Nenhum veículo em manutenção no momento.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Alertas e Próximas Manutenções</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-4 px-8 text-left">Veículo (Placa)</th>
                        <th class="py-4 px-8 text-left">Plano de Manutenção</th>
                        <th class="py-4 px-8 text-left w-1/4">Progresso (KM)</th>
                        <th class="py-4 px-8 text-left">Detalhe</th>
                        <th class="py-4 px-8 text-center">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alerta in alertas %}
                    <tr class="border-t hover:bg-gray-50">
                        <td class="py-6 px-8 font-semibold whitespace-nowrap">{{ alerta.veiculo.modelo }} <span
                                class="font-mono text-gray-600">({{ alerta.veiculo.placa }})</span></td>
                        <td class="py-6 px-8 whitespace-nowrap">{{ alerta.plano.descricao }}</td>
                        <td class="py-6 px-8 whitespace-nowrap">
                            {% set km_desde_ultima = alerta.veiculo.km_rodados - (alerta.km_ultima_manutencao or 0) %}
                            {% set progresso = (km_desde_ultima * 100 / alerta.intervalo_km) | int if
                            alerta.intervalo_km and alerta.intervalo_km > 0 else 0 %}
                            {% set cor_barra = 'bg-red-500' if progresso >= 100 else ('bg-yellow-500' if progresso >= 85
                            else 'bg-blue-500') %}
                            <div class="progress-bar-container">
                                <div class="progress-bar {{ cor_barra }}" style="width: {{ progresso }}%;"></div>
                            </div>
                            <span class="text-xs text-gray-600">{{ "{:,.0f}".format(km_desde_ultima).replace(",", ".")
                                }} / {{ "{:,.0f}".format(alerta.intervalo_km).replace(",", ".") }} km</span>
                        </td>
                        <td class="py-5 px-8 text-red-600 font-semibold">{{ alerta.mensagem }}</td>
                        <td class="py-5 px-8 text-center">
                            <button
                                onclick="abrirModalNovaManutencao('{{ alerta.veiculo.id }}', '{{ alerta.veiculo.placa }}', '{{ alerta.veiculo.km_rodados }}', '{{ alerta.plano.id }}')"
                                class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
                                <i class="fas fa-calendar-plus mr-1"></i> Agendar
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="py-6 px-8 text-center text-gray-500">
                            <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                            <p>Nenhum alerta de manutenção no momento. Bom trabalho!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Alertas de Estoque Baixo</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-4 px-8 text-left">Insumo</th>
                        <th class="py-4 px-8 text-center">Estoque Atual</th>
                        <th class="py-4 px-8 text-center">Estoque Mínimo</th>
                        <th class="py-4 px-8 text-center">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for insumo in alertas_de_estoque %}
                    <tr class="border-t hover:bg-gray-50">
                        <td class="py-5 px-8 font-semibold">{{ insumo.descricao }}</td>
                        <td class="py-5 px-8 text-center font-bold text-red-600">{{ insumo.quantidade_em_estoque|int }}</td>
                        <td class="py-5 px-8 text-center text-gray-600">{{ insumo.ponto_ressuprimento|int }}</td>
                        <td class="py-5 px-8 text-center">
                            <a href="{{ url_for('gerenciar_insumos_page') }}" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
                                <i class="fas fa-dolly-flatbed mr-1"></i> Gerenciar
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="py-6 px-8 text-center text-gray-500">
                            <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                            <p>Nenhum alerta de estoque. Tudo em ordem!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="space-y-8">
        <div class="bg-white rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Gerenciamento da Frota</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Veículo</th>
                            <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden md:table-cell">Placa</th>
                            <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider lg:w-1/4">Progresso Próxima Manutenção</th>
                            <th class="py-4 px-6 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for veiculo in todos_veiculos %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-5 px-6 whitespace-nowrap font-medium text-gray-900">{{ veiculo.modelo }}</td>
                            <td class="py-5 px-6 whitespace-nowrap font-mono hidden md:table-cell">{{ veiculo.placa }}</td>
                            <td class="py-5 px-6 whitespace-nowrap">
                                <span class="status status-{{ veiculo.status.lower().replace(' ', '_') }}">{{ veiculo.status }}</span>
                            </td>
                            <td class="py-5 px-6 whitespace-nowrap">
                                {% if veiculo.proxima_manutencao %}
                                    <div class="text-sm font-medium text-gray-800">{{ veiculo.proxima_manutencao.descricao }}</div>
                                    {% set progresso = veiculo.proxima_manutencao.progresso %}
                                    {% set cor_barra = 'bg-red-500' if progresso >= 100 else ('bg-yellow-500' if progresso >= 85 else 'bg-blue-500') %}
                                    <div class="progress-bar-container mt-1">
                                        <div class="progress-bar {{ cor_barra }}" style="width: {{ progresso }}%;"></div>
                                    </div>
                                    <div class="text-xs text-gray-600 flex justify-between">
                                        <span>{{ "{:,.0f}".format(veiculo.proxima_manutencao.km_desde_ultima or 0).replace(",", ".") }} / {{ "{:,.0f}".format(veiculo.proxima_manutencao.intervalo_km or 0).replace(",", ".") }} km</span>
                                        <span class="font-bold">{{ progresso }}%</span>
                                    </div>
                                {% else %}
                                    <span class="text-xs text-gray-500">Nenhum plano definido</span>
                                {% endif %}
                            </td>
                            <td class="py-5 px-6 whitespace-nowrap text-center">
                                <button type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm" onclick='abrirModalDetalhesVeiculo({{ veiculo|tojson }})'>
                                    Detalhes
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modal-detalhes-veiculo" class="modal">
    <div class="modal-content max-w-3xl">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Painel de Detalhes do Veículo</h2>
                <p class="text-gray-600">Visualize o progresso e gerencie as ações.</p>
            </div>
            <button onclick="fecharModal('modal-detalhes-veiculo')" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        
        <div class="bg-gray-50 border rounded-lg p-4 mb-6">
            <h3 class="text-lg font-bold text-gray-900" id="detalhes-modal-modelo"></h3>
            <p class="font-mono text-gray-600" id="detalhes-modal-placa"></p>
            <div class="flex items-center gap-4 mt-2 text-sm">
                <div><strong>Status:</strong> <span id="detalhes-modal-status-badge"></span></div>
                <div><strong>KM Atual:</strong> <span id="detalhes-modal-km" class="font-semibold"></span> km</div>
            </div>
        </div>

        <div class="mb-6">
            <h4 class="font-bold text-gray-800 mb-3">Acompanhamento de Planos de Manutenção</h4>
            <div id="detalhes-planos-progresso" class="space-y-4 max-h-60 overflow-y-auto pr-2">
                </div>
        </div>

        <div class="border-t pt-6">
             <h4 class="font-bold text-gray-800 mb-3">Ações Disponíveis</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button id="detalhes-btn-planos" class="text-left bg-white hover:bg-gray-100 border p-4 rounded-lg transition">
                    <i class="fas fa-cogs text-indigo-500 text-xl mb-2"></i>
                    <h4 class="font-bold text-gray-800">Gerenciar Planos</h4>
                    <p class="text-sm text-gray-600">Atribuir ou editar planos de manutenção.</p>
                </button>
                <button id="detalhes-btn-historico" class="text-left bg-white hover:bg-gray-100 border p-4 rounded-lg transition">
                    <i class="fas fa-history text-indigo-500 text-xl mb-2"></i>
                    <h4 class="font-bold text-gray-800">Ver Histórico</h4>
                    <p class="text-sm text-gray-600">Consultar manutenções passadas.</p>
                </button>
                <div id="detalhes-container-btn-finalizar" style="display: none;">
                    <button id="detalhes-btn-finalizar" class="w-full h-full text-left bg-green-50 hover:bg-green-100 border border-green-200 p-4 rounded-lg transition">
                        <i class="fas fa-flag-checkered text-green-600 text-xl mb-2"></i>
                        <h4 class="font-bold text-green-800">Finalizar Manutenção</h4>
                        <p class="text-sm text-green-700">Registrar conclusão, serviços e custos.</p>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-nova" class="modal">
    <div class="modal-content max-w-md">
        <h2 class="text-2xl font-bold mb-4">Registrar Manutenção</h2>
        <form id="form-nova-manutencao" action="{{ url_for('iniciar_manutencao_oficina') }}" method="POST">
            <input type="hidden" id="nova-veiculo-id" name="veiculo_id">
            <input type="hidden" id="nova-plano-id" name="plano_id">
            <div id="veiculo-selecionado-display" class="mb-4" style="display: none;">
                <strong>Veículo:</strong> <span id="nova-veiculo-placa" class="font-mono"></span>
            </div>
            <div id="veiculo-selecao-dropdown" class="mb-4" style="display: none;">
                <label for="nova-veiculo-select" class="block text-gray-700">Selecione o Veículo*</label>
                <select id="nova-veiculo-select" class="w-full p-2 border rounded" required>
                    <option value="" data-hodometro="">-- Escolha um veículo --</option>
                    {% for veiculo in todos_veiculos %}
                    <option value="{{ veiculo.id }}" data-hodometro="{{ veiculo.km_rodados | int }}">{{ veiculo.modelo
                        }} ({{ veiculo.placa }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="nova-status" class="block text-gray-700">Status</label>
                <select name="status" id="nova-status" class="w-full p-2 border rounded">
                    <option value="Em Andamento">Iniciar (Em Andamento)</option>
                    <option value="Agendada">Apenas Agendar</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="nova-hodometro" class="block text-gray-700">Hodômetro de Entrada*</label>
                <input type="number" id="nova-hodometro" name="hodometro" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-4">
                <label for="nova-descricao" class="block text-gray-700">Descrição do Problema (para corretivas)</label>
                <textarea id="nova-descricao" name="descricao" rows="3" class="w-full p-2 border rounded"></textarea>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="fecharModal('modal-nova')"
                    class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
                <button type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-finalizar" class="modal">
    <div class="modal-content max-w-md">
        <h2 class="text-2xl font-bold mb-4">Finalizar Manutenção</h2>
        <form id="form-finalizar-manutencao" action="{{ url_for('finalizar_manutencao_oficina') }}" method="POST">
            <input type="hidden" id="finalizar-manutencao-id" name="manutencao_id">
            <p class="mb-4"><strong>Veículo:</strong> <span id="finalizar-veiculo-placa" class="font-mono"></span></p>
            <div class="mb-4">
                <label for="finalizar-servicos" class="block text-gray-700">Serviços Executados</label>
                <textarea id="finalizar-servicos" name="servicos_executados" rows="4" class="w-full p-2 border rounded"
                    required></textarea>
            </div>
            <div class="mb-4">
                <label for="custo_total" class="block text-gray-700">Custo Total (R$)</label>
                <input type="number" step="0.01" id="custo_total" name="custo_total" class="w-full p-2 border rounded"
                    placeholder="Ex: 150.50">
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" onclick="fecharModal('modal-finalizar')"
                    class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
                <button type="submit"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Concluir
                    Serviço</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-historico" class="modal">
    <div class="modal-content max-w-3xl">
        <h2 class="text-2xl font-bold mb-4">Histórico do Veículo: <span id="historico-veiculo-placa"
                class="font-mono"></span></h2>
        <div id="historico-content" class="max-h-96 overflow-y-auto"></div>
        <div class="mt-4 text-right">
            <button type="button" onclick="fecharModal('modal-historico')"
                class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Fechar</button>
        </div>
    </div>
</div>

<div id="modal-planos" class="modal">
    <div class="modal-content max-w-4xl">
        <h2 class="text-2xl font-bold mb-4">Gerenciar Planos para: <span id="planos-veiculo-placa"
                class="font-mono"></span></h2>
        <input type="hidden" id="planos-veiculo-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="border rounded-lg p-4 bg-gray-50">
                <h3 class="font-bold text-lg mb-2">Planos Disponíveis</h3>
                <input type="text" id="filtro-planos-disponiveis" class="w-full p-2 border rounded mb-2"
                    placeholder="Filtrar planos...">
                <div id="container-criar-plano" class="hidden mt-2">
                    <button type="button" id="btn-criar-plano" class="w-full text-left p-2 border border-dashed rounded text-sm text-green-700 hover:bg-green-50 font-semibold"></button>
                </div>
                <div id="lista-planos-disponiveis" class="space-y-2 max-h-80 overflow-y-auto pr-2"></div>
            </div>
            <div class="border rounded-lg p-4">
                <h3 class="font-bold text-lg mb-2">Planos Atribuídos ao Veículo</h3>
                <div id="lista-planos-atribuidos" class="space-y-2 max-h-80 overflow-y-auto pr-2"></div>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-4">
            <button type="button" onclick="fecharModal('modal-planos')"
                class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
            <button type="button" id="btn-salvar-planos" onclick="salvarPlanosDoVeiculo()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded w-40 text-center">
                <span class="btn-text">Salvar Alterações</span>
                <span class="spinner hidden animate-spin fas fa-spinner"></span>
            </button>
        </div>
    </div>
</div>

<div id="modal-registrar-historico-inicial" class="modal">
    <div class="modal-content max-w-md">
        <h2 class="text-2xl font-bold mb-4">Ponto de Partida do Plano</h2>
        <p class="text-sm text-gray-600 mb-4">
            Informe a data e o KM da última vez que este serviço (<strong id="hist-inicial-plano-desc"></strong>) foi realizado.
            Isso define o início da contagem para o próximo alerta.
        </p>
        <form id="form-hist-inicial">
            <input type="hidden" id="hist-inicial-plano-ref">
            
            <div class="mb-4">
                <input type="checkbox" id="hist-inicial-feito-hoje" onchange="preencherComDadosAtuais(this.checked)">
                <label for="hist-inicial-feito-hoje" class="ml-2 font-medium">Marcar como feito hoje com KM atual.</label>
            </div>

            <div class="mb-4">
                <label for="hist-inicial-data" class="block text-gray-700">Data da Última Manutenção</label>
                <input type="date" id="hist-inicial-data" class="w-full p-2 border rounded mt-1" required>
            </div>
            <div class="mb-4">
                <label for="hist-inicial-km" class="block text-gray-700">KM na Última Manutenção</label>
                <input type="number" id="hist-inicial-km" class="w-full p-2 border rounded mt-1" required>
            </div>
            
            <div class="flex justify-end gap-4">
                <button type="button" onclick="fecharModal('modal-registrar-historico-inicial')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancelar</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Confirmar Ponto de Partida</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-gerenciar-manutencao" class="modal">
    <div class="modal-content max-w-4xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Gerenciar Manutenção: <span id="gerenciar-manutencao-placa"
                    class="font-mono"></span></h2>
            <div>
                <button onclick="finalizarDesdeGerenciar()"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm mr-4">
                    <i class="fas fa-flag-checkered"></i> Finalizar Manutenção
                </button>
                <button onclick="fecharModal('modal-gerenciar-manutencao')"
                    class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
        </div>
        <input type="hidden" id="gerenciar-manutencao-id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
            <div class="bg-gray-50 p-4 rounded-lg border">
                <h3 class="font-bold text-lg mb-4">Adicionar Peça / Serviço</h3>
                <form id="form-adicionar-item" class="space-y-3">
                    <div>
                        <label for="item-data" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" id="item-data" class="w-full p-2 border rounded mt-1" required>
                    </div>
                    <div>
                        <label for="item-descricao" class="block text-sm font-medium text-gray-700">Descrição (Peça ou
                            Serviço)</label>
                        <input type="text" id="item-descricao" class="w-full p-2 border rounded mt-1"
                            placeholder="Ex: Filtro de Ar" required>
                    </div>
                    <div class="flex gap-4">
                        <div class="w-1/2">
                            <label for="item-qtd" class="block text-sm font-medium text-gray-700">Quantidade</label>
                            <input type="number" step="0.01" id="item-qtd" value="1"
                                class="w-full p-2 border rounded mt-1" required>
                        </div>
                        <div class="w-1/2">
                            <label for="item-custo" class="block text-sm font-medium text-gray-700">Custo Unit.
                                (R$)</label>
                            <input type="number" step="0.01" id="item-custo" placeholder="150.50"
                                class="w-full p-2 border rounded mt-1" required>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mt-2">
                        <i class="fas fa-plus"></i> Adicionar Item
                    </button>
                </form>
            </div>
            <div>
                <h3 class="font-bold text-lg mb-4">Itens Lançados</h3>
                <div id="lista-itens-manutencao" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                    <p class="text-gray-500">Nenhum item lançado para esta manutenção.</p>
                </div>
                <div class="mt-4 pt-4 border-t font-bold text-lg flex justify-between">
                    <span>Custo Total:</span>
                    <span id="custo-total-manutencao">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-historico-completo" class="modal">
    <div class="modal-content max-w-6xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Histórico de Manutenções Concluídas</h2>
            <button onclick="fecharModal('modal-historico-completo')"
                class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <form id="form-filtrar-historico"
            class="bg-gray-50 p-4 rounded-lg border grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="filtro-placa" class="text-sm font-medium">Placa</label>
                <input type="text" id="filtro-placa" class="w-full p-2 border rounded mt-1" placeholder="ABC1234">
            </div>
            <div>
                <label for="filtro-data-inicio" class="text-sm font-medium">Data Início</label>
                <input type="date" id="filtro-data-inicio" class="w-full p-2 border rounded mt-1">
            </div>
            <div>
                <label for="filtro-data-fim" class="text-sm font-medium">Data Fim</label>
                <input type="date" id="filtro-data-fim" class="w-full p-2 border rounded mt-1">
            </div>
            <div>
                <label for="filtro-tipo" class="text-sm font-medium">Tipo</label>
                <select id="filtro-tipo" class="w-full p-2 border rounded mt-1">
                    <option value="">Todos</option>
                    <option value="Preventiva">Preventiva</option>
                    <option value="Corretiva">Corretiva</option>
                </select>
            </div>
            <div class="md:col-span-4 text-right">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
            </div>
        </form>
        <div id="historico-completo-content" class="max-h-[60vh] overflow-y-auto"></div>
    </div>
</div>


{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // --- Funções Globais e Utilitários ---
    const hoje = new Date().toISOString().slice(0, 10);
    let todosOsPlanosGerais = [];
    let planosAtribuidosCache = [];

    document.addEventListener('keydown', (event) => {
        if (event.key === "Escape") {
            document.querySelectorAll('.modal.flex').forEach(modal => fecharModal(modal.id));
        }
    });

    // --- Funções Gerais de Modal ---
    function fecharModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('flex');
    }

    function abrirModal(modalId) {
        document.querySelectorAll('.modal.flex').forEach(m => fecharModal(m.id));
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('flex');
    }

    function abrirModalSobreposto(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('flex');
    }

    // ### FUNÇÃO MODIFICADA PARA ABRIR O NOVO MODAL DE DETALHES ###
    function abrirModalDetalhesVeiculo(veiculo) {
        // Preenche as informações estáticas do veículo
        document.getElementById('detalhes-modal-modelo').textContent = veiculo.modelo;
        document.getElementById('detalhes-modal-placa').textContent = veiculo.placa;
        document.getElementById('detalhes-modal-km').textContent = parseInt(veiculo.km_rodados).toLocaleString('pt-BR');
        
        const statusBadge = document.getElementById('detalhes-modal-status-badge');
        statusBadge.className = `status status-${veiculo.status.toLowerCase().replace(' ', '_')}`;
        statusBadge.textContent = veiculo.status;

        // Configura os botões de ação
        document.getElementById('detalhes-btn-planos').onclick = () => abrirModalGerenciarPlanos(veiculo.id, veiculo.placa);
        document.getElementById('detalhes-btn-historico').onclick = () => {
            const url = `{{ url_for('api_historico_veiculo', veiculo_id=0) }}`.replace('0', veiculo.id);
            abrirModalHistorico(veiculo.placa, url);
        };

        const containerFinalizar = document.getElementById('detalhes-container-btn-finalizar');
        if (veiculo.status === 'Em Manutenção' && veiculo.manutencao_id) {
            document.getElementById('detalhes-btn-finalizar').onclick = () => abrirModalFinalizar(veiculo.manutencao_id, veiculo.placa);
            containerFinalizar.style.display = 'block';
        } else {
            containerFinalizar.style.display = 'none';
        }

        // ### LÓGICA ADICIONADA: Popula a lista de progresso dos planos ###
        const planosContainer = document.getElementById('detalhes-planos-progresso');
        planosContainer.innerHTML = ''; // Limpa o conteúdo anterior

        if (veiculo.planos_progresso && veiculo.planos_progresso.length > 0) {
            veiculo.planos_progresso.forEach(plano => {
                const progresso = plano.progresso;
                const cor_barra = progresso >= 100 ? 'bg-red-500' : (progresso >= 85 ? 'bg-yellow-500' : 'bg-blue-500');
                const kmDesdeUltimaFmt = parseInt(plano.km_desde_ultima).toLocaleString('pt-BR');
                const intervaloKmFmt = parseInt(plano.intervalo_km).toLocaleString('pt-BR');

                const planoHTML = `
                    <div>
                        <div class="text-sm font-medium text-gray-800">${plano.descricao}</div>
                        <div class="progress-bar-container mt-1">
                            <div class="progress-bar ${cor_barra}" style="width: ${progresso}%;"></div>
                        </div>
                        <div class="text-xs text-gray-600 flex justify-between">
                            <span>${kmDesdeUltimaFmt} / ${intervaloKmFmt} km</span>
                            <span class="font-bold">${progresso}%</span>
                        </div>
                    </div>
                `;
                planosContainer.innerHTML += planoHTML;
            });
        } else {
            planosContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum plano de manutenção configurado para este veículo.</p>';
        }
        
        abrirModal('modal-detalhes-veiculo');
    }

    // --- LÓGICA PARA MODAL DE NOVA MANUTENÇÃO (Corretiva/Preventiva) ---
    function abrirModalNovaManutencao(veiculoId, veiculoPlaca, hodometro, planoId = '') {
        const form = document.getElementById('form-nova-manutencao');
        if (!form) return;
        form.reset();

        const veiculoIdInput = document.getElementById('nova-veiculo-id');
        const planoIdInput = document.getElementById('nova-plano-id');
        const hodometroInput = document.getElementById('nova-hodometro');
        const displayVeiculo = document.getElementById('veiculo-selecionado-display');
        const placaSpan = document.getElementById('nova-veiculo-placa');
        const dropdownVeiculo = document.getElementById('veiculo-selecao-dropdown');
        const selectVeiculo = document.getElementById('nova-veiculo-select');

        planoIdInput.value = planoId || '';

        if (veiculoId) { // Veículo pré-selecionado de um alerta
            displayVeiculo.style.display = 'block';
            dropdownVeiculo.style.display = 'none';
            placaSpan.textContent = veiculoPlaca;
            veiculoIdInput.value = veiculoId;
            hodometroInput.value = Math.round(hodometro || 0);
            selectVeiculo.removeAttribute('required');
        } else { // Corretiva geral, usuário precisa escolher o veículo
            displayVeiculo.style.display = 'none';
            dropdownVeiculo.style.display = 'block';
            selectVeiculo.value = '';
            veiculoIdInput.value = '';
            hodometroInput.value = '';
            selectVeiculo.setAttribute('required', 'required');
        }

        const statusSelect = document.getElementById('nova-status');
        const descricaoField = document.getElementById('nova-descricao').closest('div');
        if (!planoId) { // Corretiva
            statusSelect.value = 'Em Andamento';
            statusSelect.closest('div').style.display = 'none';
            descricaoField.style.display = 'block';
        } else { // Preventiva
            statusSelect.closest('div').style.display = 'block';
            descricaoField.style.display = 'none';
        }
        abrirModal('modal-nova');
    }

    document.getElementById('nova-veiculo-select').addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        document.getElementById('nova-veiculo-id').value = selectedOption.value;
        document.getElementById('nova-hodometro').value = selectedOption.getAttribute('data-hodometro') || '';
    });


    // --- LÓGICA PARA MODAL FINALIZAR MANUTENÇÃO ---
    function abrirModalFinalizar(manutencaoId, veiculoPlaca, custoCalculado) {
        const form = document.getElementById('form-finalizar-manutencao');
        form.reset(); 
        document.getElementById('finalizar-manutencao-id').value = manutencaoId;
        document.getElementById('finalizar-veiculo-placa').textContent = veiculoPlaca;
        const custoTotalInput = document.getElementById('custo_total');

        if (custoCalculado) {
            const valorNumerico = parseFloat(custoCalculado.replace('R$', '').trim().replace('.', '').replace(',', '.'));
            if (!isNaN(valorNumerico)) {
                custoTotalInput.value = valorNumerico.toFixed(2);
            }
        }
        abrirModal('modal-finalizar');
    }

    function finalizarDesdeGerenciar() {
        const manutencaoId = document.getElementById('gerenciar-manutencao-id').value;
        const placa = document.getElementById('gerenciar-manutencao-placa').textContent;
        const custoTexto = document.getElementById('custo-total-manutencao').textContent;
        abrirModalFinalizar(manutencaoId, placa, custoTexto);
    }

    // --- LÓGICA PARA MODAL DE HISTÓRICO INDIVIDUAL ---
    async function abrirModalHistorico(veiculoPlaca, url) {
        document.getElementById('historico-veiculo-placa').textContent = veiculoPlaca;
        const historicoContent = document.getElementById('historico-content');
        historicoContent.innerHTML = '<p class="p-4">Carregando histórico...</p>';
        abrirModal('modal-historico');

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
            const historico = await response.json();
            if (!historico || historico.length === 0) {
                historicoContent.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum histórico de manutenção encontrado.</p>';
                return;
            }
            let tableHtml = `<table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-2 px-3 text-left">Data</th><th class="py-2 px-3 text-left">Tipo</th><th class="py-2 px-3 text-left">KM</th><th class="py-2 px-3 text-left">Serviços</th><th class="py-2 px-3 text-right">Custo</th><th class="py-2 px-3 text-center">Status</th></tr></thead><tbody>`;
            historico.forEach(m => {
                const data = m.data_saida ? new Date(m.data_saida).toLocaleDateString('pt-BR') : (m.data_entrada ? new Date(m.data_entrada).toLocaleDateString('pt-BR') : 'N/A');
                const custo = m.custo_total ? 'R$ ' + parseFloat(m.custo_total).toFixed(2).replace('.', ',') : 'N/A';
                const km = m.odometro ? parseInt(m.odometro).toLocaleString('pt-BR') + ' km' : 'N/A';
                const statusClass = `status-${m.status.toLowerCase().replace(' ', '_')}`;
                tableHtml += `<tr class="border-t"><td class="py-2 px-3">${data}</td><td class="py-2 px-3 font-semibold">${m.plano_descricao || m.tipo_manutencao || 'Corretiva'}</td><td class="py-2 px-3">${km}</td><td class="py-2 px-3 text-sm text-gray-600">${m.servicos_executados || m.descricao_problema || 'N/A'}</td><td class="py-2 px-3 text-right">${custo}</td><td class="py-2 px-3 text-center"><span class="status ${statusClass}">${m.status}</span></td></tr>`;
            });
            tableHtml += '</tbody></table>';
            historicoContent.innerHTML = tableHtml;
        } catch (error) {
            console.error("Erro ao carregar histórico:", error);
            historicoContent.innerHTML = `<p class="text-center text-red-500 p-4">Erro ao carregar histórico. Tente novamente mais tarde.</p>`;
        }
    }

    // --- LÓGICA PARA MODAL GERENCIAR PLANOS ---
    async function abrirModalGerenciarPlanos(veiculoId, veiculoPlaca) {
        document.getElementById('planos-veiculo-id').value = veiculoId;
        document.getElementById('planos-veiculo-placa').textContent = veiculoPlaca;
        const listaDisponiveis = document.getElementById('lista-planos-disponiveis');
        const listaAtribuidos = document.getElementById('lista-planos-atribuidos');
        listaDisponiveis.innerHTML = '<p>Carregando...</p>';
        listaAtribuidos.innerHTML = '<p>Carregando...</p>';
        abrirModal('modal-planos');

        try {
            const [planosResponse, atribuidosResponse] = await Promise.all([
                fetch("{{ url_for('api_get_todos_planos') }}"),
                fetch(`{{ url_for('api_gerenciar_planos_veiculo', veiculo_id=0) }}`.replace('0', veiculoId))
            ]);
            todosOsPlanosGerais = await planosResponse.json();
            planosAtribuidosCache = await atribuidosResponse.json();
            renderizarListasDePlanos();
        } catch (error) {
            console.error("Erro ao carregar planos:", error);
            listaDisponiveis.innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
            listaAtribuidos.innerHTML = '';
        }
    }

    function renderizarListasDePlanos() {
        const filtroInput = document.getElementById('filtro-planos-disponiveis');
        const filtro = filtroInput.value.toLowerCase().trim();
        const descricoesAtribuidas = new Set(planosAtribuidosCache.map(p => p.descricao.toLowerCase()));

        const disponiveisContainer = document.getElementById('lista-planos-disponiveis');
        const atribuidosContainer = document.getElementById('lista-planos-atribuidos');

        disponiveisContainer.innerHTML = '';
        atribuidosContainer.innerHTML = '';

        const planosFiltrados = todosOsPlanosGerais.filter(p => !descricoesAtribuidas.has(p.descricao.toLowerCase()) && p.descricao.toLowerCase().includes(filtro));

        planosFiltrados.forEach(plano => {
            const div = document.createElement('div');
            div.className = 'bg-white p-2 border rounded flex justify-between items-center cursor-pointer hover:bg-green-50';
            div.innerHTML = `<span>${plano.descricao}</span><button class="text-green-500 font-bold text-lg">+</button>`;
            div.onclick = () => moverPlano(plano.descricao, 'atribuir');
            disponiveisContainer.appendChild(div);
        });

        const containerCriar = document.getElementById('container-criar-plano');
        const btnCriar = document.getElementById('btn-criar-plano');
        const descricoesExistentes = new Set(todosOsPlanosGerais.map(p => p.descricao.toLowerCase()));

        if (filtro && !descricoesExistentes.has(filtro)) {
            btnCriar.innerHTML = `<i class="fas fa-plus mr-2"></i> Criar novo plano: "<strong>${filtroInput.value}</strong>"`;
            containerCriar.classList.remove('hidden');
        } else {
            containerCriar.classList.add('hidden');
        }

        if (planosAtribuidosCache.length === 0) {
            atribuidosContainer.innerHTML = '<p class="text-gray-500 text-sm">Clique em um plano à esquerda para atribuí-lo.</p>';
        } else {
            planosAtribuidosCache.forEach(plano => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 border rounded shadow-sm';
                div.dataset.planoDescricao = plano.descricao;
                div.dataset.kmUltima = plano.km_ultima_manutencao || '';
                div.dataset.dataUltima = plano.data_ultima_manutencao || '';
                const uniqueId = `padrao-${plano.descricao.replace(/\s+/g, '-')}`;
                const historicoRegistrado = plano.km_ultima_manutencao != null || plano.data_ultima_manutencao != null;
                const textoBotaoHistorico = historicoRegistrado ? 'Editar Ponto de Partida' : 'Registrar Ponto de Partida';

                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <strong class="text-gray-800">${plano.descricao}</strong>
                        <div>
                            <button onclick="abrirModalRegistroInicial('${plano.descricao}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-3">${textoBotaoHistorico}</button>
                            <button onclick="moverPlano('${plano.descricao}', 'remover')" class="text-red-500 hover:text-red-700 text-sm">Remover</button>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-2">
                        <input type="number" value="${plano.intervalo_km || ''}" placeholder="Intervalo KM" class="w-1/2 p-1 border rounded text-sm interval-km">
                        <input type="number" value="${plano.intervalo_meses || ''}" placeholder="Intervalo Meses" class="w-1/2 p-1 border rounded text-sm interval-meses">
                    </div>
                    <div class="mt-2 text-right">
                        <input type="checkbox" id="${uniqueId}" class="atualizar-padrao-checkbox rounded">
                        <label for="${uniqueId}" class="text-xs text-gray-600 ml-1 select-none cursor-pointer">Sincronizar como Padrão</label>
                    </div>
                `;
                atribuidosContainer.appendChild(div);
            });
        }
    }

    document.getElementById('btn-criar-plano').addEventListener('click', function () {
        const filtroInput = document.getElementById('filtro-planos-disponiveis');
        const novaDescricao = filtroInput.value.trim();

        if (novaDescricao) {
            todosOsPlanosGerais.push({
                descricao: novaDescricao,
                intervalo_km_padrao: '',
                intervalo_meses_padrao: ''
            });
            moverPlano(novaDescricao, 'atribuir');
            filtroInput.value = '';
            renderizarListasDePlanos();
        }
    });

    function moverPlano(descricao, acao) {
        if (acao === 'atribuir') {
            // Encontra o plano completo na nossa lista de planos gerais
            const plano = todosOsPlanosGerais.find(p => p.descricao === descricao);
            
            // Adiciona ao cache, PUXANDO OS VALORES PADRÃO
            planosAtribuidosCache.push({ 
                descricao: plano.descricao, 
                // A mágica acontece aqui:
                intervalo_km: plano.intervalo_km_padrao || '', 
                intervalo_meses: plano.intervalo_meses_padrao || '' 
            });
        } else if (acao === 'remover') {
            planosAtribuidosCache = planosAtribuidosCache.filter(p => p.descricao !== descricao);
        }
        renderizarListasDePlanos();
    }

    document.getElementById('filtro-planos-disponiveis').addEventListener('input', renderizarListasDePlanos);

    async function salvarPlanosDoVeiculo() {
        const veiculoId = document.getElementById('planos-veiculo-id').value;
        const planosParaSalvar = [];

        document.querySelectorAll('#lista-planos-atribuidos > div[data-plano-descricao]').forEach(div => {
            const checkbox = div.querySelector('.atualizar-padrao-checkbox');
            planosParaSalvar.push({
                descricao: div.dataset.planoDescricao,
                intervalo_km: parseInt(div.querySelector('.interval-km').value) || null,
                intervalo_meses: parseInt(div.querySelector('.interval-meses').value) || null,
                km_ultima_manutencao: div.dataset.kmUltima ? parseInt(div.dataset.kmUltima) : null,
                data_ultima_manutencao: div.dataset.dataUltima || null,
                atualizar_padrao: checkbox ? checkbox.checked : false
            });
        });

        const button = document.getElementById('btn-salvar-planos');
        button.disabled = true;
        button.querySelector('.btn-text').classList.add('hidden');
        button.querySelector('.spinner').classList.remove('hidden');

        try {
            const response = await fetch(`{{ url_for('api_gerenciar_planos_veiculo', veiculo_id=0) }}`.replace('0', veiculoId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(planosParaSalvar)
            });
            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'Falha ao salvar os planos.');
            }
            setTimeout(() => { 
                fecharModal('modal-planos'); 
                window.location.reload(); 
            }, 500);
        } catch (error) {
            alert(error.message);
        } finally {
            button.disabled = false;
            button.querySelector('.btn-text').classList.remove('hidden');
            button.querySelector('.spinner').classList.add('hidden');
        }
    }


    // --- LÓGICA PARA MODAL GERENCIAR MANUTENÇÃO (Adicionar Itens) ---
    async function abrirModalGerenciarManutencao(manutencaoId, veiculoPlaca) {
        document.getElementById('gerenciar-manutencao-id').value = manutencaoId;
        document.getElementById('gerenciar-manutencao-placa').textContent = veiculoPlaca;
        document.getElementById('form-adicionar-item').reset();
        document.getElementById('item-data').value = hoje;
        await carregarItensManutencao(manutencaoId);
        abrirModal('modal-gerenciar-manutencao');
    }

    async function carregarItensManutencao(manutencaoId) {
        const container = document.getElementById('lista-itens-manutencao');
        const custoTotalEl = document.getElementById('custo-total-manutencao');
        container.innerHTML = '<p>Carregando itens...</p>';

        try {
            const response = await fetch(`/api/manutencao/${manutencaoId}/itens`);
            const itens = await response.json();
            container.innerHTML = '';
            let custoTotal = 0;
            if (itens.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhum item lançado para esta manutenção.</p>';
            } else {
                itens.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-white p-2 border rounded flex justify-between items-center text-sm';
                    itemDiv.innerHTML = `<div><p class="font-semibold">${item.descricao}</p><p class="text-xs text-gray-600">${item.data} - ${item.quantidade} x R$ ${item.custo_unitario.toFixed(2).replace('.', ',')}</p></div><div class="font-bold">R$ ${item.custo_total_item.toFixed(2).replace('.', ',')}</div>`;
                    container.appendChild(itemDiv);
                    custoTotal += item.custo_total_item;
                });
            }
            custoTotalEl.textContent = `R$ ${custoTotal.toFixed(2).replace('.', ',')}`;
        } catch (error) {
            console.error("Erro ao carregar itens:", error);
            container.innerHTML = '<p class="text-red-500">Erro ao carregar itens.</p>';
        }
    }

    document.getElementById('form-adicionar-item').addEventListener('submit', async function (e) {
        e.preventDefault();
        const manutencaoId = document.getElementById('gerenciar-manutencao-id').value;
        const button = this.querySelector('button[type="submit"]');
        button.disabled = true;
        button.innerHTML = 'Adicionando...';
        const itemData = {
            data: document.getElementById('item-data').value,
            descricao: document.getElementById('item-descricao').value,
            quantidade: document.getElementById('item-qtd').value,
            custo_unitario: document.getElementById('item-custo').value,
        };
        try {
            const response = await fetch(`/api/manutencao/${manutencaoId}/adicionar_item`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erro no servidor');
            this.reset();
            document.getElementById('item-data').value = hoje;
            await carregarItensManutencao(manutencaoId);
        } catch (error) {
            alert(`Erro ao adicionar item: ${error.message}`);
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-plus"></i> Adicionar Item';
        }
    });


    // --- LÓGICA PARA MODAL DE HISTÓRICO COMPLETO ---
    function abrirModalHistoricoCompleto() {
        document.getElementById('form-filtrar-historico').reset();
        document.getElementById('historico-completo-content').innerHTML = '';
        abrirModal('modal-historico-completo');
        filtrarHistoricoManutencoes();
    }

    document.getElementById('form-filtrar-historico').addEventListener('submit', function (e) {
        e.preventDefault();
        filtrarHistoricoManutencoes();
    });

    async function filtrarHistoricoManutencoes() {
        const placa = document.getElementById('filtro-placa').value;
        const data_inicio = document.getElementById('filtro-data-inicio').value;
        const data_fim = document.getElementById('filtro-data-fim').value;
        const tipo = document.getElementById('filtro-tipo').value;
        const params = new URLSearchParams({ placa, data_inicio, data_fim, tipo });
        const url = `{{ url_for('get_historico_manutencoes') }}?${params.toString()}`;
        const container = document.getElementById('historico-completo-content');
        container.innerHTML = '<p class="text-center p-4">Carregando histórico...</p>';

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro ao buscar dados.');
            const historico = await response.json();
            if (historico.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum registro encontrado para os filtros aplicados.</p>';
                return;
            }
            let tableHtml = `<table class="min-w-full bg-white text-sm"><thead class="bg-gray-100"><tr><th class="py-2 px-3 text-left">Veículo</th><th class="py-2 px-3 text-left">Data Conclusão</th><th class="py-2 px-3 text-left">Tipo</th><th class="py-2 px-3 text-left">Serviços Executados</th><th class="py-2 px-3 text-right">Custo</th></tr></thead><tbody>`;
            historico.forEach(m => {
                tableHtml += `<tr class="border-t"><td class="py-2 px-3 font-semibold">${m.veiculo}</td><td class="py-2 px-3">${m.data_saida}</td><td class="py-2 px-3">${m.tipo}</td><td class="py-2 px-3 text-gray-600">${m.servicos}</td><td class="py-2 px-3 text-right font-mono">R$ ${m.custo.toFixed(2).replace('.', ',')}</td></tr>`;
            });
            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        } catch (error) {
            console.error("Erro ao filtrar histórico:", error);
            container.innerHTML = '<p class="text-center text-red-500 p-4">Ocorreu um erro ao carregar o histórico.</p>';
        }
    }
    function abrirModalRegistroInicial(descricaoPlano) {
        document.getElementById('form-hist-inicial').reset();
        document.getElementById('hist-inicial-plano-ref').value = descricaoPlano;
        document.getElementById('hist-inicial-plano-desc').textContent = descricaoPlano;

        const planoDiv = document.querySelector(`#lista-planos-atribuidos > div[data-plano-descricao="${descricaoPlano}"]`);
        if (planoDiv) {
            document.getElementById('hist-inicial-data').value = planoDiv.dataset.dataUltima || '';
            document.getElementById('hist-inicial-km').value = planoDiv.dataset.kmUltima || '';
        }

        abrirModalSobreposto('modal-registrar-historico-inicial');
    }

    document.getElementById('form-hist-inicial').addEventListener('submit', function(e) {
        e.preventDefault();
        const descricaoPlano = document.getElementById('hist-inicial-plano-ref').value;
        const data = document.getElementById('hist-inicial-data').value;
        const km = document.getElementById('hist-inicial-km').value;
        
        const planoNoCache = planosAtribuidosCache.find(p => p.descricao === descricaoPlano);
        
        if (planoNoCache) {
            // Atualiza os dados diretamente na variável de cache
            planoNoCache.data_ultima_manutencao = data;
            planoNoCache.km_ultima_manutencao = km;
        }
        
        fecharModal('modal-registrar-historico-inicial');
        renderizarListasDePlanos(); 
    });

    function preencherComDadosAtuais(isChecked) {
        if (isChecked) {
            document.getElementById('hist-inicial-data').value = hoje;
            const veiculoId = document.getElementById('planos-veiculo-id').value;
            const veiculo = {{ todos_veiculos|tojson }}.find(v => v.id == veiculoId);
            if (veiculo) {
                document.getElementById('hist-inicial-km').value = veiculo.km_rodados;
            }
        }
    }

</script>
{% endblock %}