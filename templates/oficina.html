{% extends "base.html" %} {% block title %}Dashboard de Manutenção da Frota{%
endblock %} {% block styles %}
<style>
  :root {
    /* Paleta de Cores VERDE (do sistema) */
    --primary-green: #2e7d32;
    --primary-green-dark: #1b5e20;
    --primary-green-light: #4caf50;

    --accent-yellow: #f59e0b; /* Amarelo para Alertas */
    --danger-red: #ef4444; /* Vermelho para Perigo */
    --success-green: #10b981; /* Verde para Sucesso */
    --purple-500: #8b5cf6; /* Roxo para Em Andamento */
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #9ca3af;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-900: #0f172a;
    --red-100: #fee2e2;
    --green-100: #dcfce7;
    --blue-100: #dbeafe;
    --yellow-100: #fef3c7;
  }

  body {
    background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    color: var(--gray-900);
    line-height: 1.6;
  }

  .dashboard-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  /* Header Principal */
  .main-header {
    background: linear-gradient(
      135deg,
      var(--primary-green-dark) 0%,
      var(--primary-green) 100%
    );
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 24px 24px;
    box-shadow: 0 10px 25px rgba(46, 125, 50, 0.3);
    position: relative;
    overflow: hidden;
  }

  .main-header::before {
    content: "";
    position: absolute;
    top: 0;
    right: -50px;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(50%, -50%);
  }

  .header-content {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 1rem;
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .header-title {
    flex: 1;
  }

  .header-title h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header-subtitle {
    font-size: 1.125rem;
    opacity: 0.9;
    font-weight: 400;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  /* Botões do Header */
  .btn-header {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
  }

  .btn-header:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    color: white;
    text-decoration: none;
  }

  .btn-header.primary {
    background: var(--accent-yellow);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  .btn-header.primary:hover {
    background: #d97706; /* Amarelo mais escuro */
  }

  /* Cards de Estatísticas */
  .stats-section {
    margin-bottom: 2rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .stat-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--gray-200);
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stat-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
  }

  .stat-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
  }

  .stat-card.alertas::before {
    background: linear-gradient(90deg, var(--accent-yellow) 0%, #f97316 100%);
  }
  .stat-card.em-manutencao::before {
    background: linear-gradient(90deg, var(--purple-500) 0%, #a855f7 100%);
  }
  .stat-card.concluidas::before {
    background: linear-gradient(90deg, var(--success-green) 0%, #34d399 100%);
  }
  .stat-card.custo::before {
    background: linear-gradient(90deg, var(--danger-red) 0%, #f87171 100%);
  }

  .stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .stat-info h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-600);
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
    line-height: 1;
  }
  .stat-number.currency {
    font-size: 2.25rem;
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
  }

  .stat-icon.alertas {
    background: linear-gradient(135deg, var(--accent-yellow) 0%, #f97316 100%);
  }
  .stat-icon.em-manutencao {
    background: linear-gradient(135deg, var(--purple-500) 0%, #a855f7 100%);
  }
  .stat-icon.concluidas {
    background: linear-gradient(135deg, var(--success-green) 0%, #34d399 100%);
  }
  .stat-icon.custo {
    background: linear-gradient(135deg, var(--danger-red) 0%, #f87171 100%);
  }

  /* Container Principal */
  .main-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--gray-200);
    overflow: hidden;
  }

  /* Navegação por Tabs */
  .nav-tabs-container {
    background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
    border-bottom: 1px solid var(--gray-200);
    padding: 0 2rem;
  }

  .nav-tabs {
    display: flex;
    gap: 0;
    border: none;
    margin: 0;
  }

  .nav-tab {
    padding: 1.25rem 2rem;
    border: none;
    background: transparent;
    color: var(--gray-600);
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-tab:hover {
    color: var(--primary-green);
    background: rgba(46, 125, 50, 0.05);
  }

  .nav-tab.active {
    color: var(--primary-green);
    border-bottom-color: var(--primary-green);
    background: rgba(46, 125, 50, 0.05);
  }

  .nav-tab .badge {
    background: var(--primary-green);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .nav-tab .badge.alert {
    background-color: var(--accent-yellow);
    color: var(--gray-900);
  }

  /* Conteúdo das Tabs */
  .tab-content {
    padding: 2rem;
  }
  .tab-pane {
    display: none;
  }
  .tab-pane.active {
    display: block;
    animation: fadeInUp 0.4s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilos para tabelas e listas */
  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-700);
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .section-title i {
    color: var(--primary-green);
  }

  .table-wrapper {
    overflow-x: auto;
  }
  .styled-table {
    width: 100%;
    border-collapse: collapse;
  }
  .styled-table thead {
    background-color: var(--gray-50);
    border-bottom: 2px solid var(--gray-200);
  }
  .styled-table th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .styled-table tbody tr {
    border-bottom: 1px solid var(--gray-200);
    transition: background-color 0.2s ease;
  }
  .styled-table tbody tr:last-child {
    border-bottom: none;
  }
  .styled-table tbody tr:hover {
    background-color: var(--gray-50);
  }
  .styled-table td {
    padding: 1rem 1.5rem;
    vertical-align: middle;
    font-size: 0.875rem;
  }

  .plate-tag {
    font-family: "Courier New", monospace;
    background: var(--gray-200);
    color: var(--gray-700);
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: bold;
  }

  /* Status Badges */
  .status {
    padding: 5px 12px;
    border-radius: 9999px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: white;
    display: inline-block;
  }
  .status-disponível {
    background-color: var(--success-green);
  }
  .status-em_rota,
  .status-em_viagem {
    background-color: #3b82f6;
  }
  .status-em_manutenção {
    background-color: #a855f7; /* Roxo mais claro */
  }
  .status-concluída {
    background-color: var(--gray-600);
  }
  .status-agendada {
    background-color: #6366f1;
  }
  .status-em_andamento {
    background-color: var(--purple-500);
  }
  .status-aguardando_aprovação {
    background-color: var(--accent-yellow);
    color: var(--gray-900);
  }

  /* Botões de Ação */
  .btn-action {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-decoration: none;
  }
  .btn-action.primary {
    background: var(--primary-green);
    color: white;
  }
  .btn-action.primary:hover {
    background: var(--primary-green-dark);
  }
  .btn-action.secondary {
    background: var(--purple-500);
    color: white;
  }
  .btn-action.secondary:hover {
    background: #7c3aed;
  }
  .btn-action.warning {
    background: var(--accent-yellow);
    color: var(--gray-900);
  }
  .btn-action.warning:hover {
    background: #d97706;
  }
  .btn-action.danger {
    background-color: var(--danger-red);
    color: white;
  }
  .btn-action.danger:hover {
    background-color: #b91c1c;
  }
  .btn-action.success {
    background-color: var(--success-green);
    color: white;
  }
  .btn-action.success:hover {
    background-color: #059669;
  }

  /* Barras de Progresso */
  .progress-bar-container {
    background-color: var(--gray-200);
    border-radius: 9999px;
    height: 8px;
    width: 100%;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 0.5s ease-in-out;
  }

  /* Modal Styling */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    z-index: 1050;
    animation: fadeIn 0.3s;
  }
  .modal.flex {
    display: flex;
  }
  .modal-content {
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 2rem;
    width: 100%;
    animation: slideIn 0.3s;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }
  .modal-content.max-w-md {
    max-width: 500px;
  }
  .modal-content.max-w-xl {
    max-width: 650px;
  }
  .modal-content.max-w-2xl {
    max-width: 800px;
  }
  .modal-content.max-w-3xl {
    max-width: 950px;
  }
  .modal-content.max-w-4xl {
    max-width: 1100px;
  }
  .modal-content.max-w-6xl {
    max-width: 1400px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: 1.5rem;
  }
  .modal-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-800);
  }
  .modal-header .btn-close {
    background: transparent;
    border: none;
    font-size: 1.75rem;
    color: var(--gray-400);
    cursor: pointer;
  }
  .modal-body {
    overflow-y: auto;
    flex-grow: 1;
  }
  .modal-footer {
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-200);
    margin-top: 1.5rem;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  @keyframes slideIn {
    from {
      transform: translateY(-20px) scale(0.98);
      opacity: 0;
    }
    to {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-600);
  }

  .empty-state i {
    font-size: 4rem;
    color: var(--gray-300);
    margin-bottom: 1.5rem;
  }

  .empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.75rem;
  }

  .empty-state p {
    font-size: 0.875rem;
    color: var(--gray-600);
    max-width: 400px;
    margin: 0 auto;
  }

  /* Animação de contadores */
  @keyframes count-up {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .stat-number {
    animation: count-up 0.5s ease-out forwards;
  }

  /* Estilos para o Dropdown de Busca */
  .searchable-dropdown {
    position: relative;
  }
  .searchable-dropdown-panel {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: white;
    border: 1px solid var(--gray-300);
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
  }
  .searchable-dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
  }
  .searchable-dropdown-item:hover {
    background-color: var(--gray-100);
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      text-align: center;
    }
    .header-actions {
      justify-content: center;
      width: 100%;
      flex-direction: column;
    }
    .btn-header {
      width: 100%;
      justify-content: center;
    }
    .nav-tabs-container {
      padding: 0 0.5rem;
    }
    .nav-tabs {
      flex-wrap: wrap;
    }
    .nav-tab {
      padding: 1rem;
      font-size: 0.8rem;
    }
    .tab-content {
      padding: 1.5rem;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="dashboard-container">
  <div class="main-header">
    <div class="header-content">
      <div class="header-title">
        <h1><i class="fas fa-tools"></i> Dashboard de Manutenção</h1>
        <p class="header-subtitle">
          Gestão completa de planos, alertas e serviços da frota.
        </p>
      </div>
      <div class="header-actions">
        <button
          type="button"
          onclick="abrirModal('modal-ordem-servico-lista')"
          class="btn-header primary"
        >
          <i class="fas fa-file-invoice"></i>
          <span>Ordens de Serviço</span>
        </button>
        <button
          type="button"
          onclick="abrirModalNovaManutencao(null, null, null)"
          class="btn-header"
        >
          <i class="fas fa-screwdriver-wrench"></i>
          <span>Registrar Manutenção</span>
        </button>
        <a href="{{ url_for('gerenciar_planos_page') }}" class="btn-header">
          <i class="fas fa-tasks"></i>
          <span>Gerenciar Planos</span>
        </a>
        <a href="{{ url_for('gerenciar_insumos_page') }}" class="btn-header">
          <i class="fas fa-box-open"></i>
          <span>Gerenciar Insumos</span>
        </a>
        <button onclick="abrirModalHistoricoCompleto()" class="btn-header">
          <i class="fas fa-history"></i>
          <span>Ver Histórico</span>
        </button>
      </div>
    </div>
  </div>

  <div class="stats-section">
    <div class="stats-grid">
      <div class="stat-card alertas">
        <div class="stat-header">
          <div class="stat-info">
            <h3>Alertas Atuais</h3>
            <p class="stat-number">{{ alertas|length }}</p>
          </div>
          <div class="stat-icon alertas">
            <i class="fas fa-triangle-exclamation"></i>
          </div>
        </div>
      </div>
      <div class="stat-card em-manutencao">
        <div class="stat-header">
          <div class="stat-info">
            <h3>Em Manutenção</h3>
            <p class="stat-number">{{ manutencoes_ativas|length }}</p>
          </div>
          <div class="stat-icon em-manutencao">
            <i class="fas fa-tools"></i>
          </div>
        </div>
      </div>
      <div class="stat-card concluidas">
        <div class="stat-header">
          <div class="stat-info">
            <h3>Concluídas no Mês</h3>
            <p class="stat-number">{{ kpis.concluidas_no_mes }}</p>
          </div>
          <div class="stat-icon concluidas">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>
      <div class="stat-card custo">
        <div class="stat-header">
          <div class="stat-info">
            <h3>Custo do Mês</h3>
            <p class="stat-number currency">
              R$ {{ "{:,.2f}".format(kpis.custo_mes_atual).replace(",",
              "X").replace(".", ",").replace("X", ".") }}
            </p>
          </div>
          <div class="stat-icon custo"><i class="fas fa-dollar-sign"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="nav-tabs-container">
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="em-andamento">
          <i class="fas fa-spinner fa-spin"></i>
          Ativas & Agendadas {% if manutencoes_ativas|length > 0 %}<span
            class="badge"
            >{{ manutencoes_ativas|length }}</span
          >{% endif %}
        </button>
        <button class="nav-tab" data-tab="alertas-frota">
          <i class="fas fa-triangle-exclamation"></i>
          Alertas da Frota {% if alertas|length > 0 %}<span class="badge alert"
            >{{ alertas|length }}</span
          >{% endif %}
        </button>
        <button class="nav-tab" data-tab="frota-completa">
          <i class="fas fa-truck"></i>
          Gerenciamento Completo
        </button>
        <button class="nav-tab" data-tab="finalizados">
          <i class="fas fa-check-double"></i>
          Finalizados
        </button>
        <button class="nav-tab" data-tab="alertas-estoque">
          <i class="fas fa-boxes-stacked"></i>
          Alertas de Estoque {% if alertas_de_estoque|length > 0 %}<span
            class="badge alert"
            >{{ alertas_de_estoque|length }}</span
          >{% endif %}
        </button>
      </div>
    </div>

    <div class="tab-content">
      <div class="tab-pane active" id="em-andamento">
        <h2 class="section-title">
          <i class="fas fa-tools"></i>Veículos em Manutenção ou Agendados
        </h2>
        {% if manutencoes_ativas %}
        <div class="table-wrapper">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Veículo (Placa)</th>
                <th>Tipo</th>
                <th>Data de Entrada / Agendamento</th>
                <th>Status</th>
                <th class="text-center">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for manutencao in manutencoes_ativas %}
              <tr>
                <td>
                  <strong
                    >{{ manutencao.veiculo.modelo if manutencao.veiculo else
                    'Item Removido' }}</strong
                  ><br />
                  <span class="plate-tag"
                    >{{ manutencao.veiculo.placa if manutencao.veiculo else
                    'N/A' }}</span
                  >
                </td>
                <td>{{ manutencao.tipo_manutencao }}</td>
                <td>{{ manutencao.data_entrada.strftime('%d/%m/%Y') }}</td>
                <td>
                  <span
                    class="status status-{{ manutencao.status.lower().replace(' ', '_') }}"
                    >{{ manutencao.status }}</span
                  >
                </td>
                <td class="text-center">
                  <div class="flex justify-center items-center gap-2">
                    <button
                      onclick="abrirModalGerenciarManutencao('{{ manutencao.id }}', '{{ manutencao.veiculo.placa if manutencao.veiculo }}')"
                      class="btn-action secondary"
                    >
                      <i class="fas fa-edit"></i> Gerenciar
                    </button>
                    <button
                      onclick="excluirManutencao('{{ manutencao.id }}', '{{ manutencao.veiculo.placa if manutencao.veiculo }}')"
                      class="btn-action danger"
                      title="Excluir Lançamento"
                    >
                      <i class="fas fa-trash-alt"></i> Excluir
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-car-side"></i>
          <h3>Nenhum veículo em manutenção</h3>
          <p>Todos os veículos estão operacionais. Bom trabalho!</p>
        </div>
        {% endif %}
      </div>

      <div class="tab-pane" id="alertas-frota">
        <h2 class="section-title">
          <i class="fas fa-bell"></i>Alertas e Próximas Manutenções
        </h2>
        {% if alertas %}
        <div class="table-wrapper">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Veículo (Placa)</th>
                <th>Plano de Manutenção</th>
                <th style="width: 25%">Progresso (KM)</th>
                <th>Detalhe</th>
                <th class="text-center">Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for alerta in alertas %}
              <tr>
                <td>
                  <strong>{{ alerta.veiculo.modelo }}</strong><br />
                  <span class="plate-tag">{{ alerta.veiculo.placa }}</span>
                </td>
                <td>{{ alerta.plano.descricao }}</td>
                <td>
                  {% set km_desde_ultima = alerta.veiculo.km_rodados -
                  (alerta.km_ultima_manutencao or 0) %} {% set progresso =
                  (km_desde_ultima * 100 / alerta.intervalo_km) | int if
                  alerta.intervalo_km and alerta.intervalo_km > 0 else 0 %} {%
                  set cor_barra = 'bg-red-500' if progresso >= 100 else
                  ('bg-yellow-500' if progresso >= 85 else 'bg-green-500') %}
                  <div class="progress-bar-container">
                    <div
                      class="progress-bar {{ cor_barra }}"
                      style="width: {{ progresso }}%;"
                    ></div>
                  </div>
                  <span class="text-xs text-gray-600"
                    >{{ "{:,.0f}".format(km_desde_ultima).replace(",", ".") }} /
                    {{ "{:,.0f}".format(alerta.intervalo_km).replace(",", ".")
                    }} km</span
                  >
                </td>
                <td class="font-semibold text-red-600">
                  {{ alerta.mensagem }}
                </td>
                <td class="text-center">
                  <button
                    onclick="abrirModalNovaManutencao('{{ alerta.veiculo.id }}', '{{ alerta.veiculo.placa }}', '{{ alerta.veiculo.km_rodados }}', '{{ alerta.plano.id }}')"
                    class="btn-action primary"
                  >
                    <i class="fas fa-calendar-plus"></i> Agendar
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-check-circle"></i>
          <h3>Nenhum alerta de manutenção</h3>
          <p>Todos os planos de manutenção estão em dia. Excelente!</p>
        </div>
        {% endif %}
      </div>

      <div class="tab-pane" id="frota-completa">
        <h2 class="section-title">
          <i class="fas fa-truck-moving"></i>Gerenciamento da Frota
        </h2>

        <div class="mb-4 flex gap-4 items-center">
          <div class="relative flex-grow">
            <i
              class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
            ></i>
            <input
              type="text"
              id="filtro-frota"
              placeholder="Buscar por modelo ou placa..."
              class="w-full md:w-1/2 pl-10 p-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            />
          </div>
          <button
            onclick="limparFiltroFrota()"
            class="text-sm text-gray-600 hover:text-red-600 font-semibold"
          >
            Limpar Filtro
          </button>
        </div>

        <div class="table-wrapper">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Veículo / Carreta</th>
                <th>Placa</th>
                <th>Status</th>
                <th style="width: 25%">Progresso Próxima Manutenção</th>
                <th class="text-center">Ações</th>
              </tr>
            </thead>
            <tbody id="tabela-frota-completa">
              {% for veiculo in todos_veiculos %}
              <tr>
                <td class="font-medium text-gray-900">{{ veiculo.modelo }}</td>
                <td><span class="plate-tag">{{ veiculo.placa }}</span></td>
                <td>
                  <span
                    class="status status-{{ veiculo.status.lower().replace(' ', '_') }}"
                    >{{ veiculo.status }}</span
                  >
                </td>
                <td>
                  {% if veiculo.proxima_manutencao %}
                  <div class="text-sm font-medium text-gray-800">
                    {{ veiculo.proxima_manutencao.descricao }}
                  </div>
                  {% set progresso = veiculo.proxima_manutencao.progresso %} {%
                  set cor_barra = 'bg-red-500' if progresso >= 100 else
                  ('bg-yellow-500' if progresso >= 85 else 'bg-green-500') %}
                  <div class="progress-bar-container mt-1">
                    <div
                      class="progress-bar {{ cor_barra }}"
                      style="width: {{ progresso }}%;"
                    ></div>
                  </div>
                  <div class="text-xs text-gray-600 flex justify-between">
                    <span
                      >{{
                      "{:,.0f}".format(veiculo.proxima_manutencao.km_desde_ultima
                      or 0).replace(",", ".") }} / {{
                      "{:,.0f}".format(veiculo.proxima_manutencao.intervalo_km
                      or 0).replace(",", ".") }} km</span
                    >
                    <span class="font-bold">{{ progresso }}%</span>
                  </div>
                  {% else %}
                  <span class="text-xs text-gray-500"
                    >N/A (Carreta ou sem plano)</span
                  >
                  {% endif %}
                </td>
                <td class="text-center">
                  <button
                    type="button"
                    class="btn-action primary"
                    onclick="abrirModalDetalhesVeiculo({{ veiculo.id }})"
                  >
                    Detalhes
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane" id="finalizados">
        <h2 class="section-title">
          <i class="fas fa-check-double"></i>Manutenções Concluídas
        </h2>
        {% if manutencoes_concluidas %}
        <div class="table-wrapper">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Veículo (Placa)</th>
                <th>Data de Conclusão</th>
                <th>Custo Total</th>
                <th class="text-center">Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for manutencao in manutencoes_concluidas %}
              <tr>
                <td>
                  <strong
                    >{{ manutencao.veiculo.modelo if manutencao.veiculo else
                    'N/A' }}</strong
                  ><br />
                  <span class="plate-tag"
                    >{{ manutencao.veiculo.placa if manutencao.veiculo else
                    'N/A' }}</span
                  >
                </td>
                <td>
                  {{ manutencao.data_saida.strftime('%d/%m/%Y %H:%M') if
                  manutencao.data_saida else 'N/A' }}
                </td>
                <td>
                  R$ {{ "{:,.2f}".format(manutencao.custo_total or
                  0).replace(",", "X").replace(".", ",").replace("X", ".") }}
                </td>
                <td class="text-center">
                  <button
                    onclick="reabrirServico({{ manutencao.id }})"
                    class="btn-action warning"
                  >
                    <i class="fas fa-undo"></i> Reabrir
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-folder-open"></i>
          <h3>Nenhum serviço concluído</h3>
          <p>O histórico de manutenções finalizadas aparecerá aqui.</p>
        </div>
        {% endif %}
      </div>

      <div class="tab-pane" id="alertas-estoque">
        <h2 class="section-title">
          <i class="fas fa-exclamation-triangle"></i>Alertas de Estoque Baixo
        </h2>
        {% if alertas_de_estoque %}
        <div class="table-wrapper">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Insumo</th>
                <th class="text-center">Estoque Atual</th>
                <th class="text-center">Estoque Mínimo</th>
                <th class="text-center">Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for insumo in alertas_de_estoque %}
              <tr>
                <td class="font-semibold">{{ insumo.descricao }}</td>
                <td class="text-center font-bold text-red-600">
                  {{ insumo.quantidade_em_estoque|int }}
                </td>
                <td class="text-center text-gray-600">
                  {{ insumo.ponto_ressuprimento|int }}
                </td>
                <td class="text-center">
                  <a
                    href="{{ url_for('gerenciar_insumos_page') }}"
                    class="btn-action warning"
                  >
                    <i class="fas fa-dolly-flatbed"></i> Gerenciar
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-check-circle"></i>
          <h3>Nenhum alerta de estoque</h3>
          <p>Todos os insumos estão com níveis adequados.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div id="modal-ordem-servico-lista" class="modal">
  <div class="modal-content max-w-3xl">
    <div class="modal-header">
      <h2>Serviços Ativos e Pendentes</h2>
      <button
        onclick="fecharModal('modal-ordem-servico-lista')"
        class="btn-close"
      >
        &times;
      </button>
    </div>
    <div class="modal-body">
      <p class="text-sm text-gray-600 mb-4">
        Selecione uma manutenção para gerar a OS ou aprovar a finalização do
        mecânico.
      </p>
      {% if manutencoes_ativas or manutencoes_para_aprovar %}
      <div class="table-wrapper">
        <table class="styled-table">
          <thead>
            <tr>
              <th>Veículo (Placa)</th>
              <th>Data de Entrada</th>
              <th>Status</th>
              <th class="text-center" style="width: 40%">Ações</th>
            </tr>
          </thead>
          <tbody>
            {# Loop para manutenções que aguardam aprovação #} {% for manutencao
            in manutencoes_para_aprovar %}
            <tr class="bg-yellow-50">
              <td>
                <strong
                  >{{ manutencao.veiculo.modelo if manutencao.veiculo else 'N/A'
                  }}</strong
                ><br />
                <span class="plate-tag"
                  >{{ manutencao.veiculo.placa if manutencao.veiculo else 'N/A'
                  }}</span
                >
              </td>
              <td>{{ manutencao.data_entrada.strftime('%d/%m/%Y') }}</td>
              <td>
                <span class="status status-aguardando_aprovação"
                  >{{ manutencao.status }}</span
                >
              </td>
              <td class="text-center space-x-2">
                <button
                  onclick="aprovarFinalizacao({{ manutencao.id }}, '{{ manutencao.veiculo.placa if manutencao.veiculo }}')"
                  class="btn-action success"
                >
                  <i class="fas fa-check"></i> Aprovar
                </button>
                <a
                  href="{{ url_for('gerar_ordem_servico_pdf', manutencao_id=manutencao.id) }}"
                  target="_blank"
                  class="btn-action primary"
                >
                  <i class="fas fa-print"></i> Ver OS
                </a>
              </td>
            </tr>
            {% endfor %} {# Loop para manutenções ativas e agendadas #} {% for
            manutencao in manutencoes_ativas %}
            <tr>
              <td>
                <strong
                  >{{ manutencao.veiculo.modelo if manutencao.veiculo else 'N/A'
                  }}</strong
                ><br />
                <span class="plate-tag"
                  >{{ manutencao.veiculo.placa if manutencao.veiculo else 'N/A'
                  }}</span
                >
              </td>
              <td>{{ manutencao.data_entrada.strftime('%d/%m/%Y') }}</td>
              <td>
                <span
                  class="status status-{{ manutencao.status.lower().replace(' ', '_') }}"
                  >{{ manutencao.status }}</span
                >
              </td>
              <td class="text-center">
                <a
                  href="{{ url_for('gerar_ordem_servico_pdf', manutencao_id=manutencao.id) }}"
                  target="_blank"
                  class="btn-action primary"
                >
                  <i class="fas fa-print"></i> Gerar OS
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-check-circle"></i>
        <h3>Nenhuma manutenção ativa ou pendente</h3>
        <p>Não há Ordens de Serviço para gerar ou aprovar no momento.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div id="modal-detalhes-veiculo" class="modal">
  <div class="modal-content max-w-3xl">
    <div class="modal-header">
      <div>
        <h2 id="detalhes-modal-modelo">Painel de Detalhes do Veículo</h2>
        <p class="text-gray-600" id="detalhes-modal-placa"></p>
      </div>
      <button onclick="fecharModal('modal-detalhes-veiculo')" class="btn-close">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <div class="bg-gray-50 border rounded-lg p-4 mb-6">
        <div class="flex items-center gap-4 mt-2 text-sm">
          <div>
            <strong>Status:</strong>
            <span id="detalhes-modal-status-badge"></span>
          </div>
          <div>
            <strong>KM Atual:</strong>
            <span id="detalhes-modal-km" class="font-semibold"></span> km
          </div>
        </div>
      </div>
      <div class="mb-6">
        <h4 class="font-bold text-gray-800 mb-3">
          Acompanhamento de Planos de Manutenção
        </h4>
        <div
          id="detalhes-planos-progresso"
          class="space-y-4 max-h-60 overflow-y-auto pr-2"
        ></div>
      </div>
      <div class="border-t pt-6">
        <h4 class="font-bold text-gray-800 mb-3">Ações Disponíveis</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <button
            id="detalhes-btn-planos"
            class="text-left bg-white hover:bg-gray-100 border p-4 rounded-lg transition"
          >
            <i class="fas fa-cogs text-indigo-500 text-xl mb-2"></i>
            <h4 class="font-bold text-gray-800">Gerenciar Planos</h4>
            <p class="text-sm text-gray-600">
              Atribuir ou editar planos de manutenção.
            </p>
          </button>
          <button
            id="detalhes-btn-historico"
            class="text-left bg-white hover:bg-gray-100 border p-4 rounded-lg transition"
          >
            <i class="fas fa-history text-indigo-500 text-xl mb-2"></i>
            <h4 class="font-bold text-gray-800">Ver Histórico</h4>
            <p class="text-sm text-gray-600">Consultar manutenções passadas.</p>
          </button>
          <div id="detalhes-container-btn-finalizar" style="display: none">
            <button
              id="detalhes-btn-finalizar"
              class="w-full h-full text-left bg-green-50 hover:bg-green-100 border border-green-200 p-4 rounded-lg transition"
            >
              <i class="fas fa-flag-checkered text-green-600 text-xl mb-2"></i>
              <h4 class="font-bold text-green-800">Finalizar Manutenção</h4>
              <p class="text-sm text-green-700">
                Registrar conclusão, serviços e custos.
              </p>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal-nova" class="modal">
  <div class="modal-content max-w-md">
    <div class="modal-header">
      <h2>Registrar Manutenção</h2>
      <button onclick="fecharModal('modal-nova')" class="btn-close">
        &times;
      </button>
    </div>
    <form
      id="form-nova-manutencao"
      action="{{ url_for('iniciar_manutencao_oficina') }}"
      method="POST"
    >
      <div class="modal-body" x-data="searchableDropdown()">
        <input
          type="hidden"
          id="nova-veiculo-id"
          name="veiculo_id"
          x-model="selectedItem.id"
        />
        <input type="hidden" id="nova-plano-id" name="plano_id" />
        <div
          id="veiculo-selecionado-display"
          class="mb-4"
          style="display: none"
        >
          <strong>Veículo:</strong>
          <span id="nova-veiculo-placa" class="font-mono"></span>
        </div>

        <div id="veiculo-selecao-dropdown" class="mb-4" style="display: none">
          <label for="search-input" class="block text-gray-700"
            >Selecione o Veículo/Carreta*</label
          >
          <div class="searchable-dropdown" @click.away="isOpen = false">
            <input
              type="text"
              id="search-input"
              class="w-full p-2 border rounded"
              placeholder="Digite para buscar a placa ou modelo..."
              x-model="searchTerm"
              @focus="isOpen = true"
              @input="isOpen = true"
              autocomplete="off"
              required
            />
            <div x-show="isOpen" x-transition class="searchable-dropdown-panel">
              <template x-if="filteredItems.length === 0">
                <div class="searchable-dropdown-item text-gray-500">
                  Nenhum item encontrado.
                </div>
              </template>
              <template x-for="item in filteredItems" :key="item.id">
                <div
                  @click="selectItem(item)"
                  class="searchable-dropdown-item"
                  x-text="item.display_name"
                ></div>
              </template>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label for="nova-status" class="block text-gray-700">Status</label>
          <select
            name="status"
            id="nova-status"
            class="w-full p-2 border rounded"
          >
            <option value="Em Andamento">Iniciar (Em Andamento)</option>
            <option value="Agendada">Apenas Agendar</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="nova-hodometro" class="block text-gray-700"
            >Hodômetro de Entrada*</label
          >
          <input
            type="number"
            id="nova-hodometro"
            name="hodometro"
            class="w-full p-2 border rounded"
            required
          />
        </div>
        <div class="mb-4">
          <label for="nova-descricao" class="block text-gray-700"
            >Descrição do Problema (para corretivas)</label
          >
          <textarea
            id="nova-descricao"
            name="descricao"
            rows="3"
            class="w-full p-2 border rounded"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          onclick="fecharModal('modal-nova')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
        >
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="modal-finalizar" class="modal">
  <div class="modal-content max-w-md">
    <div class="modal-header">
      <h2 class="text-2xl font-bold mb-4">Finalizar Manutenção</h2>
      <button onclick="fecharModal('modal-finalizar')" class="btn-close">
        &times;
      </button>
    </div>
    <form
      id="form-finalizar-manutencao"
      action="{{ url_for('finalizar_manutencao_oficina') }}"
      method="POST"
    >
      <div class="modal-body">
        <input
          type="hidden"
          id="finalizar-manutencao-id"
          name="manutencao_id"
        />
        <p class="mb-4">
          <strong>Veículo:</strong>
          <span id="finalizar-veiculo-placa" class="font-mono"></span>
        </p>
        <div class="mb-4">
          <label for="finalizar-servicos" class="block text-gray-700"
            >Serviços Executados</label
          >
          <textarea
            id="finalizar-servicos"
            name="servicos_executados"
            rows="4"
            class="w-full p-2 border rounded"
            required
          ></textarea>
        </div>
        <div class="mb-4">
          <label for="custo_total" class="block text-gray-700"
            >Custo Total (R$)</label
          >
          <input
            type="number"
            step="0.01"
            id="custo_total"
            name="custo_total"
            class="w-full p-2 border rounded"
            placeholder="Ex: 150.50"
          />
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          onclick="fecharModal('modal-finalizar')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
        >
          Concluir Serviço
        </button>
      </div>
    </form>
  </div>
</div>

<div id="modal-historico" class="modal">
  <div class="modal-content max-w-3xl">
    <div class="modal-header">
      <h2>
        Histórico do Veículo:
        <span id="historico-veiculo-placa" class="font-mono"></span>
      </h2>
      <button
        type="button"
        onclick="fecharModal('modal-historico')"
        class="btn-close"
      >
        &times;
      </button>
    </div>
    <div id="historico-content" class="modal-body"></div>
  </div>
</div>

<div id="modal-planos" class="modal">
  <div class="modal-content max-w-4xl">
    <div class="modal-header">
      <h2>
        Gerenciar Planos para:
        <span id="planos-veiculo-placa" class="font-mono"></span>
      </h2>
      <button
        type="button"
        onclick="fecharModal('modal-planos')"
        class="btn-close"
      >
        &times;
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="planos-veiculo-id" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border rounded-lg p-4 bg-gray-50">
          <h3 class="font-bold text-lg mb-2">Planos Disponíveis</h3>
          <input
            type="text"
            id="filtro-planos-disponiveis"
            class="w-full p-2 border rounded mb-2"
            placeholder="Filtrar planos..."
          />
          <div id="container-criar-plano" class="hidden mt-2">
            <button
              type="button"
              id="btn-criar-plano"
              class="w-full text-left p-2 border border-dashed rounded text-sm text-green-700 hover:bg-green-50 font-semibold"
            ></button>
          </div>
          <div
            id="lista-planos-disponiveis"
            class="space-y-2 max-h-80 overflow-y-auto pr-2"
          ></div>
        </div>
        <div class="border rounded-lg p-4">
          <h3 class="font-bold text-lg mb-2">Planos Atribuídos ao Veículo</h3>
          <div
            id="lista-planos-atribuidos"
            class="space-y-2 max-h-80 overflow-y-auto pr-2"
          ></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        onclick="fecharModal('modal-planos')"
        class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded"
      >
        Cancelar
      </button>
      <button
        type="button"
        id="btn-salvar-planos"
        onclick="salvarPlanosDoVeiculo()"
        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-40 text-center"
      >
        <span class="btn-text">Salvar Alterações</span>
        <span class="spinner hidden animate-spin fas fa-spinner"></span>
      </button>
    </div>
  </div>
</div>

<div id="modal-registrar-historico-inicial" class="modal">
  <div class="modal-content max-w-md">
    <div class="modal-header">
      <h2>Ponto de Partida do Plano</h2>
      <button
        onclick="fecharModal('modal-registrar-historico-inicial')"
        class="btn-close"
      >
        &times;
      </button>
    </div>
    <form id="form-hist-inicial">
      <div class="modal-body">
        <p class="text-sm text-gray-600 mb-4">
          Informe a data e o KM da última vez que este serviço (<strong
            id="hist-inicial-plano-desc"
          ></strong
          >) foi realizado. Isso define o início da contagem para o próximo
          alerta.
        </p>
        <input type="hidden" id="hist-inicial-plano-ref" />
        <div class="mb-4">
          <input
            type="checkbox"
            id="hist-inicial-feito-hoje"
            onchange="preencherComDadosAtuais(this.checked)"
          />
          <label for="hist-inicial-feito-hoje" class="ml-2 font-medium"
            >Marcar como feito hoje com KM atual.</label
          >
        </div>
        <div class="mb-4">
          <label for="hist-inicial-data" class="block text-gray-700"
            >Data da Última Manutenção</label
          >
          <input
            type="date"
            id="hist-inicial-data"
            class="w-full p-2 border rounded mt-1"
            required
          />
        </div>
        <div class="mb-4">
          <label for="hist-inicial-km" class="block text-gray-700"
            >KM na Última Manutenção</label
          >
          <input
            type="number"
            id="hist-inicial-km"
            class="w-full p-2 border rounded mt-1"
            required
          />
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          onclick="fecharModal('modal-registrar-historico-inicial')"
          class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
        >
          Confirmar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="modal-gerenciar-manutencao" class="modal">
  <div class="modal-content max-w-4xl">
    <div class="modal-header">
      <h2>
        Gerenciar Manutenção:
        <span id="gerenciar-manutencao-placa" class="font-mono"></span>
      </h2>
      <div>
        <button
          onclick="finalizarDesdeGerenciar()"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm mr-4"
        >
          <i class="fas fa-flag-checkered"></i> Finalizar Manutenção
        </button>
        <button
          onclick="fecharModal('modal-gerenciar-manutencao')"
          class="btn-close"
        >
          &times;
        </button>
      </div>
    </div>
    <div class="modal-body">
      <input type="hidden" id="gerenciar-manutencao-id" />
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-2">
        <div class="bg-gray-50 p-4 rounded-lg border">
          <h3 class="font-bold text-lg mb-4">Adicionar Peça / Serviço</h3>
          <form id="form-adicionar-item" class="space-y-3">
            <div>
              <label
                for="item-data"
                class="block text-sm font-medium text-gray-700"
                >Data</label
              >
              <input
                type="date"
                id="item-data"
                class="w-full p-2 border rounded mt-1"
                required
              />
            </div>
            <div>
              <label
                for="item-descricao"
                class="block text-sm font-medium text-gray-700"
                >Descrição (Peça ou Serviço)</label
              >
              <input
                type="text"
                id="item-descricao"
                class="w-full p-2 border rounded mt-1"
                placeholder="Ex: Filtro de Ar"
                required
              />
            </div>
            <div class="flex gap-4">
              <div class="w-1/2">
                <label
                  for="item-qtd"
                  class="block text-sm font-medium text-gray-700"
                  >Quantidade</label
                >
                <input
                  type="number"
                  step="0.01"
                  id="item-qtd"
                  value="1"
                  class="w-full p-2 border rounded mt-1"
                  required
                />
              </div>
              <div class="w-1/2">
                <label
                  for="item-custo"
                  class="block text-sm font-medium text-gray-700"
                  >Custo Unit. (R$)</label
                >
                <input
                  type="number"
                  step="0.01"
                  id="item-custo"
                  placeholder="150.50"
                  class="w-full p-2 border rounded mt-1"
                  required
                />
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-2"
            >
              <i class="fas fa-plus"></i> Adicionar Item
            </button>
          </form>
        </div>
        <div>
          <h3 class="font-bold text-lg mb-4">Itens Lançados</h3>
          <div
            id="lista-itens-manutencao"
            class="space-y-2 max-h-80 overflow-y-auto pr-2"
          >
            <p class="text-gray-500">
              Nenhum item lançado para esta manutenção.
            </p>
          </div>
          <div
            class="mt-4 pt-4 border-t font-bold text-lg flex justify-between"
          >
            <span>Custo Total:</span>
            <span id="custo-total-manutencao">R$ 0,00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal-historico-completo" class="modal">
  <div class="modal-content max-w-6xl">
    <div class="modal-header">
      <h2>Histórico de Manutenções Concluídas</h2>
      <button
        onclick="fecharModal('modal-historico-completo')"
        class="btn-close"
      >
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form
        id="form-filtrar-historico"
        class="bg-gray-50 p-4 rounded-lg border grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"
      >
        <div>
          <label for="filtro-placa" class="text-sm font-medium">Placa</label>
          <input
            type="text"
            id="filtro-placa"
            class="w-full p-2 border rounded mt-1"
            placeholder="ABC1234"
          />
        </div>
        <div>
          <label for="filtro-data-inicio" class="text-sm font-medium"
            >Data Início</label
          >
          <input
            type="date"
            id="filtro-data-inicio"
            class="w-full p-2 border rounded mt-1"
          />
        </div>
        <div>
          <label for="filtro-data-fim" class="text-sm font-medium"
            >Data Fim</label
          >
          <input
            type="date"
            id="filtro-data-fim"
            class="w-full p-2 border rounded mt-1"
          />
        </div>
        <div>
          <label for="filtro-tipo" class="text-sm font-medium">Tipo</label>
          <select id="filtro-tipo" class="w-full p-2 border rounded mt-1">
            <option value="">Todos</option>
            <option value="Preventiva">Preventiva</option>
            <option value="Corretiva">Corretiva</option>
          </select>
        </div>
        <div class="md:col-span-4 text-right">
          <button
            type="submit"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
          >
            <i class="fas fa-filter"></i> Filtrar
          </button>
        </div>
      </form>
      <div
        id="historico-completo-content"
        class="max-h-[60vh] overflow-y-auto"
      ></div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script
  src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
  defer
></script>
<script>
    // --- FUNÇÃO DE EXCLUSÃO (SEM TOKEN) ---
    async function excluirManutencao(manutencaoId, veiculoPlaca) {
        if (!confirm(`Tem certeza que deseja excluir permanentemente a manutenção #${manutencaoId} para o veículo ${veiculoPlaca}? Esta ação não pode ser desfeita.`)) {
            return;
        }
        try {
            const response = await fetch(`/api/manutencao/excluir/${manutencaoId}`, {
                method: 'POST'
            });
            const result = await response.json();

            if (result.success) {
                alert(result.message);
                window.location.reload();
            } else {
                alert('Erro: ' + result.message);
            }
        } catch (error) {
            console.error('Erro ao excluir manutenção:', error);
            alert('Erro de comunicação ao tentar excluir a manutenção.');
        }
    }


    // --- FUNÇÕES DE APROVAÇÃO E REABERTURA (SEM TOKEN) ---
    async function aprovarFinalizacao(manutencaoId, veiculoPlaca) {
        if (!confirm(`Tem certeza que deseja aprovar a finalização da manutenção para o veículo ${veiculoPlaca}? Esta ação dará baixa no estoque.`)) {
            return;
        }
        try {
            const response = await fetch(`/api/manutencao/aprovar_finalizacao/${manutencaoId}`, {
                method: 'POST'
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                window.location.reload();
            }
        } catch (error) {
            alert('Erro de comunicação ao aprovar a finalização.');
        }
    }

    async function reabrirServico(manutencaoId) {
        if (!confirm(`Tem certeza que deseja reabrir a manutenção #${manutencaoId}? O status voltará para "Em Andamento".`)) {
            return;
        }
        try {
            const response = await fetch(`/api/manutencao/reabrir/${manutencaoId}`, {
                method: 'POST'
            });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                window.location.reload();
            }
        } catch (error) {
            console.error('Erro ao reabrir serviço:', error);
            alert('Erro de comunicação ao reabrir o serviço.');
        }
    }


  // --- SCRIPTS EXISTENTES ---
  const TODOS_VEICULOS_E_CARRETAS = {{ todos_veiculos|tojson|safe }};
  const FROTA_PARA_MODAL = {{ frota_para_modal|tojson|safe }};

  document.addEventListener('DOMContentLoaded', function() {
      // Configurar navegação por tabs
      const tabButtons = document.querySelectorAll('.nav-tab');
      const tabPanes = document.querySelectorAll('.tab-pane');

      tabButtons.forEach(button => {
          button.addEventListener('click', function() {
              const targetTab = this.dataset.tab;
              tabButtons.forEach(btn => btn.classList.remove('active'));
              tabPanes.forEach(pane => pane.classList.remove('active'));
              this.classList.add('active');
              document.getElementById(targetTab).classList.add('active');
          });
      });

      // Lógica do filtro da frota
      const filtroInput = document.getElementById('filtro-frota');
      const tabelaBody = document.getElementById('tabela-frota-completa');
      if (filtroInput && tabelaBody) {
          const linhas = tabelaBody.getElementsByTagName('tr');
          filtroInput.addEventListener('keyup', function() {
              const termo = this.value.toLowerCase().trim();
              for (let i = 0; i < linhas.length; i++) {
                  const textoModelo = linhas[i].cells[0].textContent.toLowerCase();
                  const textoPlaca = linhas[i].cells[1].textContent.toLowerCase();
                  if (textoModelo.includes(termo) || textoPlaca.includes(termo)) {
                      linhas[i].style.display = '';
                  } else {
                      linhas[i].style.display = 'none';
                  }
              }
          });
      }
  });

  function limparFiltroFrota() {
      const filtroInput = document.getElementById('filtro-frota');
      if (filtroInput) {
          filtroInput.value = '';
          filtroInput.dispatchEvent(new Event('keyup'));
      }
  }

  // Lógica do dropdown de busca com Alpine.js
    function searchableDropdown() {
        return {
            isOpen: false,
            searchTerm: '',
            selectedItem: { id: null, display_name: '', tipo: '', km_rodados: '' },
            allItems: FROTA_PARA_MODAL,

            get filteredItems() {
                if (this.searchTerm === '') {
                    return this.allItems;
                }
                return this.allItems.filter(item =>
                    item.display_name.toLowerCase().includes(this.searchTerm.toLowerCase())
                );
            },

            selectItem(item) {
                this.selectedItem = item;
                this.searchTerm = item.display_name;
                this.isOpen = false;

                const hodometroInput = document.getElementById('nova-hodometro');
                hodometroInput.value = item.km_rodados || '0';
                hodometroInput.readOnly = (item.tipo === 'carreta');
            },

            reset() {
                this.selectedItem = { id: null, display_name: '', tipo: '', km_rodados: '' };
                this.searchTerm = '';
                this.isOpen = false;
            }
        }
    }

    // --- LÓGICA ORIGINAL DA OFICINA (MODAIS E AÇÕES) ---
    const hoje = new Date().toISOString().slice(0, 10);
    let todosOsPlanosGerais = [];
    let planosAtribuidosCache = [];

    document.addEventListener('keydown', (event) => {
        if (event.key === "Escape") {
            document.querySelectorAll('.modal.flex').forEach(modal => fecharModal(modal.id));
        }
    });

    function fecharModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('flex');
    }

    function abrirModal(modalId) {
        document.querySelectorAll('.modal.flex').forEach(m => fecharModal(m.id));
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('flex');
    }

    function abrirModalSobreposto(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('flex');
    }

    function abrirModalDetalhesVeiculo(veiculoId) {
        const veiculo = TODOS_VEICULOS_E_CARRETAS.find(v => v.id == veiculoId);
        if (!veiculo) {
            alert("Erro: Veículo com ID " + veiculoId + " não encontrado!");
            return;
        }

        document.getElementById('detalhes-modal-modelo').textContent = veiculo.modelo;
        document.getElementById('detalhes-modal-placa').textContent = veiculo.placa;
        document.getElementById('detalhes-modal-km').textContent = parseInt(veiculo.km_rodados).toLocaleString('pt-BR');

        const statusBadge = document.getElementById('detalhes-modal-status-badge');
        statusBadge.className = `status status-${veiculo.status.toLowerCase().replace(' ', '_')}`;
        statusBadge.textContent = veiculo.status;

        const btnPlanos = document.getElementById('detalhes-btn-planos');
        if (veiculo.modelo.includes('Carreta')) {
            btnPlanos.style.display = 'none';
        } else {
            btnPlanos.style.display = 'block';
            btnPlanos.onclick = () => abrirModalGerenciarPlanos(veiculo.id, veiculo.placa);
        }

        document.getElementById('detalhes-btn-historico').onclick = () => {
            const url = `{{ url_for('api_historico_veiculo', veiculo_id=0) }}`.replace('0', veiculo.id);
            abrirModalHistorico(veiculo.placa, url);
        };

        const containerFinalizar = document.getElementById('detalhes-container-btn-finalizar');
        if (veiculo.status === 'Em Manutenção' && veiculo.manutencao_id) {
            document.getElementById('detalhes-btn-finalizar').onclick = () => abrirModalFinalizar(veiculo.manutencao_id, veiculo.placa);
            containerFinalizar.style.display = 'block';
        } else {
            containerFinalizar.style.display = 'none';
        }

        const planosContainer = document.getElementById('detalhes-planos-progresso');
        planosContainer.innerHTML = '';

        if (veiculo.planos_progresso && veiculo.planos_progresso.length > 0) {
            veiculo.planos_progresso.forEach(plano => {
                const progresso = plano.progresso;
                const cor_barra = progresso >= 100 ? 'bg-red-500' : (progresso >= 85 ? 'bg-yellow-500' : 'bg-green-500');
                const kmDesdeUltimaFmt = parseInt(plano.km_desde_ultima).toLocaleString('pt-BR');
                const intervaloKmFmt = parseInt(plano.intervalo_km).toLocaleString('pt-BR');

                const planoHTML = `
                    <div>
                        <div class="text-sm font-medium text-gray-800">${plano.descricao}</div>
                        <div class="progress-bar-container mt-1">
                            <div class="progress-bar ${cor_barra}" style="width: ${progresso}%;"></div>
                        </div>
                        <div class="text-xs text-gray-600 flex justify-between">
                            <span>${kmDesdeUltimaFmt} / ${intervaloKmFmt} km</span>
                            <span class="font-bold">${progresso}%</span>
                        </div>
                    </div>
                `;
                planosContainer.innerHTML += planoHTML;
            });
        } else {
            planosContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum plano de manutenção configurado para este veículo.</p>';
        }

        abrirModal('modal-detalhes-veiculo');
    }

    function abrirModalNovaManutencao(veiculoId, veiculoPlaca, hodometro, planoId = '') {
        const form = document.getElementById('form-nova-manutencao');
        if (!form) return;
        form.reset();

        const alpineComponent = document.querySelector('[x-data="searchableDropdown()"]');
        if (alpineComponent.__x) {
            alpineComponent.__x.getUnwrappedDataForMagic('data').reset();
        }

        const veiculoIdInput = document.getElementById('nova-veiculo-id');
        const planoIdInput = document.getElementById('nova-plano-id');
        const hodometroInput = document.getElementById('nova-hodometro');
        const displayVeiculo = document.getElementById('veiculo-selecionado-display');
        const placaSpan = document.getElementById('nova-veiculo-placa');
        const dropdownVeiculo = document.getElementById('veiculo-selecao-dropdown');
        const searchInput = document.getElementById('search-input');

        planoIdInput.value = planoId || '';

        if (veiculoId) {
            displayVeiculo.style.display = 'block';
            dropdownVeiculo.style.display = 'none';
            placaSpan.textContent = `${veiculoPlaca}`;
            veiculoIdInput.value = veiculoId;
            hodometroInput.value = Math.round(hodometro || 0);
            hodometroInput.readOnly = false;
        } else {
            displayVeiculo.style.display = 'none';
            dropdownVeiculo.style.display = 'block';
            veiculoIdInput.value = '';
            hodometroInput.value = '';
        }

        const statusSelect = document.getElementById('nova-status');
        const descricaoField = document.getElementById('nova-descricao').closest('div');
        if (!planoId) {
            statusSelect.value = 'Em Andamento';
            statusSelect.closest('div').style.display = 'block';
            descricaoField.style.display = 'block';
        } else {
            statusSelect.closest('div').style.display = 'block';
            descricaoField.style.display = 'none';
        }
        abrirModal('modal-nova');
    }

    function abrirModalFinalizar(manutencaoId, veiculoPlaca, custoCalculado) {
        const form = document.getElementById('form-finalizar-manutencao');
        form.reset();
        document.getElementById('finalizar-manutencao-id').value = manutencaoId;
        document.getElementById('finalizar-veiculo-placa').textContent = veiculoPlaca;
        const custoTotalInput = document.getElementById('custo_total');

        if (custoCalculado) {
            const valorNumerico = parseFloat(custoCalculado.replace('R$', '').trim().replace('.', '').replace(',', '.'));
            if (!isNaN(valorNumerico)) {
                custoTotalInput.value = valorNumerico.toFixed(2);
            }
        }
        abrirModal('modal-finalizar');
    }

    function finalizarDesdeGerenciar() {
        const manutencaoId = document.getElementById('gerenciar-manutencao-id').value;
        const placa = document.getElementById('gerenciar-manutencao-placa').textContent;
        const custoTexto = document.getElementById('custo-total-manutencao').textContent;
        abrirModalFinalizar(manutencaoId, placa, custoTexto);
    }

    async function abrirModalHistorico(veiculoPlaca, url) {
        document.getElementById('historico-veiculo-placa').textContent = veiculoPlaca;
        const historicoContent = document.getElementById('historico-content');
        historicoContent.innerHTML = '<p class="p-4">Carregando histórico...</p>';
        abrirModal('modal-historico');

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
            const historico = await response.json();
            if (!historico || historico.length === 0) {
                historicoContent.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum histórico de manutenção encontrado.</p>';
                return;
            }
            let tableHtml = `<table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-2 px-3 text-left">Data</th><th class="py-2 px-3 text-left">Tipo</th><th class="py-2 px-3 text-left">KM</th><th class="py-2 px-3 text-left">Serviços</th><th class="py-2 px-3 text-right">Custo</th><th class="py-2 px-3 text-center">Status</th></tr></thead><tbody>`;
            historico.forEach(m => {
                const data = m.data_saida ? new Date(m.data_saida).toLocaleDateString('pt-BR') : (m.data_entrada ? new Date(m.data_entrada).toLocaleDateString('pt-BR') : 'N/A');
                const custo = m.custo_total ? 'R$ ' + parseFloat(m.custo_total).toFixed(2).replace('.', ',') : 'N/A';
                const km = m.odometro ? parseInt(m.odometro).toLocaleString('pt-BR') + ' km' : 'N/A';
                const statusClass = `status-${m.status.toLowerCase().replace(' ', '_')}`;
                tableHtml += `<tr class="border-t"><td class="py-2 px-3">${data}</td><td class="py-2 px-3 font-semibold">${m.plano_descricao || m.tipo_manutencao || 'Corretiva'}</td><td class="py-2 px-3">${km}</td><td class="py-2 px-3 text-sm text-gray-600">${m.servicos_executados || m.descricao_problema || 'N/A'}</td><td class="py-2 px-3 text-right">${custo}</td><td class="py-2 px-3 text-center"><span class="status ${statusClass}">${m.status}</span></td></tr>`;
            });
            tableHtml += '</tbody></table>';
            historicoContent.innerHTML = tableHtml;
        } catch (error) {
            console.error("Erro ao carregar histórico:", error);
            historicoContent.innerHTML = `<p class="text-center text-red-500 p-4">Erro ao carregar histórico. Tente novamente mais tarde.</p>`;
        }
    }

    async function abrirModalGerenciarPlanos(veiculoId, veiculoPlaca) {
        document.getElementById('planos-veiculo-id').value = veiculoId;
        document.getElementById('planos-veiculo-placa').textContent = veiculoPlaca;
        const listaDisponiveis = document.getElementById('lista-planos-disponiveis');
        const listaAtribuidos = document.getElementById('lista-planos-atribuidos');
        listaDisponiveis.innerHTML = '<p>Carregando...</p>';
        listaAtribuidos.innerHTML = '<p>Carregando...</p>';
        abrirModal('modal-planos');

        try {
            const [planosResponse, atribuidosResponse] = await Promise.all([
                fetch("{{ url_for('api_get_todos_planos') }}"),
                fetch(`{{ url_for('api_gerenciar_planos_veiculo', veiculo_id=0) }}`.replace('0', veiculoId))
            ]);
            todosOsPlanosGerais = await planosResponse.json();
            planosAtribuidosCache = await atribuidosResponse.json();
            renderizarListasDePlanos();
        } catch (error) {
            console.error("Erro ao carregar planos:", error);
            listaDisponiveis.innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
            listaAtribuidos.innerHTML = '';
        }
    }

    function renderizarListasDePlanos() {
        const filtroInput = document.getElementById('filtro-planos-disponiveis');
        const filtro = filtroInput.value.toLowerCase().trim();
        const descricoesAtribuidas = new Set(planosAtribuidosCache.map(p => p.descricao.toLowerCase()));

        const disponiveisContainer = document.getElementById('lista-planos-disponiveis');
        const atribuidosContainer = document.getElementById('lista-planos-atribuidos');

        disponiveisContainer.innerHTML = '';
        atribuidosContainer.innerHTML = '';

        const planosFiltrados = todosOsPlanosGerais.filter(p => !descricoesAtribuidas.has(p.descricao.toLowerCase()) && p.descricao.toLowerCase().includes(filtro));

        planosFiltrados.forEach(plano => {
            const div = document.createElement('div');
            div.className = 'bg-white p-2 border rounded flex justify-between items-center cursor-pointer hover:bg-green-50';
            div.innerHTML = `<span>${plano.descricao}</span><button class="text-green-500 font-bold text-lg">+</button>`;
            div.onclick = () => moverPlano(plano.descricao, 'atribuir');
            disponiveisContainer.appendChild(div);
        });

        const containerCriar = document.getElementById('container-criar-plano');
        const btnCriar = document.getElementById('btn-criar-plano');
        const descricoesExistentes = new Set(todosOsPlanosGerais.map(p => p.descricao.toLowerCase()));

        if (filtro && !descricoesExistentes.has(filtro)) {
            btnCriar.innerHTML = `<i class="fas fa-plus mr-2"></i> Criar novo plano: "<strong>${filtroInput.value}</strong>"`;
            containerCriar.classList.remove('hidden');
        } else {
            containerCriar.classList.add('hidden');
        }

        if (planosAtribuidosCache.length === 0) {
            atribuidosContainer.innerHTML = '<p class="text-gray-500 text-sm">Clique em um plano à esquerda para atribuí-lo.</p>';
        } else {
            planosAtribuidosCache.forEach(plano => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 border rounded shadow-sm';
                div.dataset.planoDescricao = plano.descricao;
                div.dataset.kmUltima = plano.km_ultima_manutencao || '';
                div.dataset.dataUltima = plano.data_ultima_manutencao || '';
                const uniqueId = `padrao-${plano.descricao.replace(/\s+/g, '-')}`;
                const historicoRegistrado = plano.km_ultima_manutencao != null || plano.data_ultima_manutencao != null;
                const textoBotaoHistorico = historicoRegistrado ? 'Editar Ponto de Partida' : 'Registrar Ponto de Partida';

                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <strong class="text-gray-800">${plano.descricao}</strong>
                        <div>
                            <button onclick="abrirModalRegistroInicial('${plano.descricao}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-3">${textoBotaoHistorico}</button>
                            <button onclick="moverPlano('${plano.descricao}', 'remover')" class="text-red-500 hover:text-red-700 text-sm">Remover</button>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-2">
                        <input type="number" value="${plano.intervalo_km || ''}" placeholder="Intervalo KM" class="w-1/2 p-1 border rounded text-sm interval-km">
                        <input type="number" value="${plano.intervalo_meses || ''}" placeholder="Intervalo Meses" class="w-1/2 p-1 border rounded text-sm interval-meses">
                    </div>
                    <div class="mt-2 text-right">
                        <input type="checkbox" id="${uniqueId}" class="atualizar-padrao-checkbox rounded">
                        <label for="${uniqueId}" class="text-xs text-gray-600 ml-1 select-none cursor-pointer">Sincronizar como Padrão</label>
                    </div>
                `;
                atribuidosContainer.appendChild(div);
            });
        }
    }

    document.getElementById('btn-criar-plano').addEventListener('click', function () {
        const filtroInput = document.getElementById('filtro-planos-disponiveis');
        const novaDescricao = filtroInput.value.trim();

        if (novaDescricao) {
            todosOsPlanosGerais.push({
                descricao: novaDescricao,
                intervalo_km_padrao: '',
                intervalo_meses_padrao: ''
            });
            moverPlano(novaDescricao, 'atribuir');
            filtroInput.value = '';
            renderizarListasDePlanos();
        }
    });

    function moverPlano(descricao, acao) {
        if (acao === 'atribuir') {
            const plano = todosOsPlanosGerais.find(p => p.descricao === descricao);
            planosAtribuidosCache.push({
                descricao: plano.descricao,
                intervalo_km: plano.intervalo_km_padrao || '',
                intervalo_meses: plano.intervalo_meses_padrao || ''
            });
        } else if (acao === 'remover') {
            planosAtribuidosCache = planosAtribuidosCache.filter(p => p.descricao !== descricao);
        }
        renderizarListasDePlanos();
    }

    document.getElementById('filtro-planos-disponiveis').addEventListener('input', renderizarListasDePlanos);

    async function salvarPlanosDoVeiculo() {
        const veiculoId = document.getElementById('planos-veiculo-id').value;
        const planosParaSalvar = [];

        document.querySelectorAll('#lista-planos-atribuidos > div[data-plano-descricao]').forEach(div => {
            const checkbox = div.querySelector('.atualizar-padrao-checkbox');
            planosParaSalvar.push({
                descricao: div.dataset.planoDescricao,
                intervalo_km: parseInt(div.querySelector('.interval-km').value) || null,
                intervalo_meses: parseInt(div.querySelector('.interval-meses').value) || null,
                km_ultima_manutencao: div.dataset.kmUltima ? parseInt(div.dataset.kmUltima) : null,
                data_ultima_manutencao: div.dataset.dataUltima || null,
                atualizar_padrao: checkbox ? checkbox.checked : false
            });
        });

        const button = document.getElementById('btn-salvar-planos');
        button.disabled = true;
        button.querySelector('.btn-text').classList.add('hidden');
        button.querySelector('.spinner').classList.remove('hidden');

        try {
            const response = await fetch(`{{ url_for('api_gerenciar_planos_veiculo', veiculo_id=0) }}`.replace('0', veiculoId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(planosParaSalvar)
            });
            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.message || 'Falha ao salvar os planos.');
            }
            setTimeout(() => {
                fecharModal('modal-planos');
                window.location.reload();
            }, 500);
        } catch (error) {
            alert(error.message);
        } finally {
            button.disabled = false;
            button.querySelector('.btn-text').classList.remove('hidden');
            button.querySelector('.spinner').classList.add('hidden');
        }
    }

    async function abrirModalGerenciarManutencao(manutencaoId, veiculoPlaca) {
        document.getElementById('gerenciar-manutencao-id').value = manutencaoId;
        document.getElementById('gerenciar-manutencao-placa').textContent = veiculoPlaca;
        document.getElementById('form-adicionar-item').reset();
        document.getElementById('item-data').value = hoje;
        await carregarItensManutencao(manutencaoId);
        abrirModal('modal-gerenciar-manutencao');
    }

    async function carregarItensManutencao(manutencaoId) {
        const container = document.getElementById('lista-itens-manutencao');
        const custoTotalEl = document.getElementById('custo-total-manutencao');
        container.innerHTML = '<p>Carregando itens...</p>';

        try {
            const response = await fetch(`/api/manutencao/${manutencaoId}/itens`);
            const itens = await response.json();
            container.innerHTML = '';
            let custoTotal = 0;
            if (itens.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhum item lançado para esta manutenção.</p>';
            } else {
                itens.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-white p-2 border rounded flex justify-between items-center text-sm';
                    itemDiv.innerHTML = `<div><p class="font-semibold">${item.descricao}</p><p class="text-xs text-gray-600">${item.data} - ${item.quantidade} x R$ ${item.custo_unitario.toFixed(2).replace('.', ',')}</p></div><div class="font-bold">R$ ${item.custo_total_item.toFixed(2).replace('.', ',')}</div>`;
                    container.appendChild(itemDiv);
                    custoTotal += item.custo_total_item;
                });
            }
            custoTotalEl.textContent = `R$ ${custoTotal.toFixed(2).replace('.', ',')}`;
        } catch (error) {
            console.error("Erro ao carregar itens:", error);
            container.innerHTML = '<p class="text-red-500">Erro ao carregar itens.</p>';
        }
    }

    document.getElementById('form-adicionar-item').addEventListener('submit', async function (e) {
        e.preventDefault();
        const manutencaoId = document.getElementById('gerenciar-manutencao-id').value;
        const button = this.querySelector('button[type="submit"]');
        button.disabled = true;
        button.innerHTML = 'Adicionando...';
        const itemData = {
            data: document.getElementById('item-data').value,
            descricao: document.getElementById('item-descricao').value,
            quantidade: document.getElementById('item-qtd').value,
            custo_unitario: document.getElementById('item-custo').value,
        };
        try {
            const response = await fetch(`/api/manutencao/${manutencaoId}/adicionar_item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(itemData)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erro no servidor');
            this.reset();
            document.getElementById('item-data').value = hoje;
            await carregarItensManutencao(manutencaoId);
        } catch (error) {
            alert(`Erro ao adicionar item: ${error.message}`);
        } finally {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-plus"></i> Adicionar Item';
        }
    });

    function abrirModalHistoricoCompleto() {
        document.getElementById('form-filtrar-historico').reset();
        document.getElementById('historico-completo-content').innerHTML = '';
        abrirModal('modal-historico-completo');
        filtrarHistoricoManutencoes();
    }

    document.getElementById('form-filtrar-historico').addEventListener('submit', function (e) {
        e.preventDefault();
        filtrarHistoricoManutencoes();
    });

    async function filtrarHistoricoManutencoes() {
        const placa = document.getElementById('filtro-placa').value;
        const data_inicio = document.getElementById('filtro-data-inicio').value;
        const data_fim = document.getElementById('filtro-data-fim').value;
        const tipo = document.getElementById('filtro-tipo').value;
        const params = new URLSearchParams({ placa, data_inicio, data_fim, tipo });
        const url = `{{ url_for('get_historico_manutencoes') }}?${params.toString()}`;
        const container = document.getElementById('historico-completo-content');
        container.innerHTML = '<p class="text-center p-4">Carregando histórico...</p>';

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro ao buscar dados.');
            const historico = await response.json();
            if (historico.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">Nenhum registro encontrado para os filtros aplicados.</p>';
                return;
            }
            let tableHtml = `<table class="min-w-full bg-white text-sm"><thead class="bg-gray-100"><tr><th class="py-2 px-3 text-left">Veículo</th><th class="py-2 px-3 text-left">Data Conclusão</th><th class="py-2 px-3 text-left">Tipo</th><th class="py-2 px-3 text-left">Serviços Executados</th><th class="py-2 px-3 text-right">Custo</th></tr></thead><tbody>`;
            historico.forEach(m => {
                tableHtml += `<tr class="border-t"><td class="py-2 px-3 font-semibold">${m.veiculo}</td><td class="py-2 px-3">${m.data_saida}</td><td class="py-2 px-3">${m.tipo}</td><td class="py-2 px-3 text-gray-600">${m.servicos}</td><td class="py-2 px-3 text-right font-mono">R$ ${m.custo.toFixed(2).replace('.', ',')}</td></tr>`;
            });
            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        } catch (error) {
            console.error("Erro ao filtrar histórico:", error);
            container.innerHTML = '<p class="text-center text-red-500 p-4">Ocorreu um erro ao carregar o histórico.</p>';
        }
    }
    function abrirModalRegistroInicial(descricaoPlano) {
        document.getElementById('form-hist-inicial').reset();
        document.getElementById('hist-inicial-plano-ref').value = descricaoPlano;
        document.getElementById('hist-inicial-plano-desc').textContent = descricaoPlano;

        const planoDiv = document.querySelector(`#lista-planos-atribuidos > div[data-plano-descricao="${descricaoPlano}"]`);
        if (planoDiv) {
            document.getElementById('hist-inicial-data').value = planoDiv.dataset.dataUltima || '';
            document.getElementById('hist-inicial-km').value = planoDiv.dataset.kmUltima || '';
        }

        abrirModalSobreposto('modal-registrar-historico-inicial');
    }

    document.getElementById('form-hist-inicial').addEventListener('submit', function(e) {
        e.preventDefault();
        const descricaoPlano = document.getElementById('hist-inicial-plano-ref').value;
        const data = document.getElementById('hist-inicial-data').value;
        const km = document.getElementById('hist-inicial-km').value;

        const planoNoCache = planosAtribuidosCache.find(p => p.descricao === descricaoPlano);

        if (planoNoCache) {
            planoNoCache.data_ultima_manutencao = data;
            planoNoCache.km_ultima_manutencao = km;
        }

        fecharModal('modal-registrar-historico-inicial');
        renderizarListasDePlanos();
    });

    function preencherComDadosAtuais(isChecked) {
        if (isChecked) {
            document.getElementById('hist-inicial-data').value = hoje;
            const veiculoId = document.getElementById('planos-veiculo-id').value;
            const veiculo = TODOS_VEICULOS_E_CARRETAS.find(v => v.id == veiculoId);
            if (veiculo) {
                document.getElementById('hist-inicial-km').value = veiculo.km_rodados;
            }
        }
    }
</script>
{% endblock %}
