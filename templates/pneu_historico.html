{% extends "base.html" %}

{% block title %}Histórico do Pneu - {{ pneu.numero_fogo }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-history me-2"></i>Histórico do Pneu: <strong>{{ pneu.numero_fogo }}</strong>
        </h1>
        <a href="{{ url_for('borracharia_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Voltar ao Dashboard
        </a>
    </div>

    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"> <i class="fas fa-info-circle me-2"></i>Detalhes do Pneu</h5>
                    {% if pneu.status == 'Em Estoque' %}
                    <div class="btn-group">
                        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#enviarRecapagemModal">
                            <i class="fas fa-tools me-1"></i> Enviar p/ Recapagem
                        </button>
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#descartarPneuModal">
                            <i class="fas fa-trash-alt me-1"></i> Descartar
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Marca/Modelo:</strong><br>{{ pneu.marca }} / {{ pneu.modelo }}</p>
                            <p><strong>Dimensão:</strong><br>{{ pneu.dimensao }}</p>
                        </div>
                        <div class="col-md-6">
                             <p><strong>DOT (Fabricação):</strong><br>{{ pneu.dot }} ({{ pneu.data_fabricacao.strftime('%b/%Y') if pneu.data_fabricacao else 'N/A' }})</p>
                             <p><strong>Status Atual:</strong><br>
                                {% if pneu.status == 'Em Uso' %}
                                <span class="badge bg-info">Em Uso</span>
                                {% elif pneu.status == 'Em Estoque' %}
                                <span class="badge bg-primary">Em Estoque</span>
                                {% elif pneu.status == 'Recapando' %}
                                <span class="badge bg-warning text-dark">Recapando</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ pneu.status }}</span>
                                {% endif %}
                             </p>
                        </div>
                    </div>
                     {% if pneu.veiculo %}
                        <p><strong>Localização Atual:</strong><br>Veículo <span class="fw-bold">{{ pneu.veiculo.placa }}</span>, na posição <span class="fw-bold">{{ pneu.posicao }}</span></p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-5 mb-4">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Métricas de Desempenho</h5>
                </div>
                 <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>KM Total Rodado:</strong> <span class="float-end fw-bold">{{ "%.0f"|format(pneu.km_total) }} km</span></li>
                    <li class="list-group-item"><strong>Nº de Recapagens:</strong> <span class="float-end fw-bold">{{ pneu.numero_recapagens }}</span></li>
                    <li class="list-group-item"><strong>Custo de Compra:</strong> <span class="float-end">R$ {{ "%.2f"|format(pneu.valor_compra)|replace('.', ',') }}</span></li>
                    <li class="list-group-item bg-success-light"><strong>Custo por KM (CPK):</strong> <span class="float-end fs-5 fw-bold text-success">R$ {{ "%.4f"|format(cpk)|replace('.', ',') }}</span></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-stream me-2"></i>Linha do Tempo de Eventos</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Data/Hora</th>
                            <th>Evento</th>
                            <th>Detalhes</th>
                            <th class="text-end">Custo</th>
                            <th class="text-end">Sulco (mm)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for evento in pneu.historico|sort(attribute='data_evento', reverse=True) %}
                        <tr>
                            <td>{{ evento.data_evento.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td><h5><span class="badge bg-secondary font-monospace">{{ evento.evento }}</span></h5></td>
                            <td>
                                <small class="d-block">
                                {% if evento.veiculo_id and evento.pneu.veiculo %}
                                    Veículo: <strong>{{ evento.pneu.veiculo.placa }}</strong> |
                                {% endif %}
                                {% if evento.km_veiculo %}
                                    KM Veículo: <strong>{{ "%.0f"|format(evento.km_veiculo) }}</strong> |
                                {% endif %}
                                {% if evento.posicao %}
                                    Posição: <strong>{{ evento.posicao }}</strong>
                                {% endif %}
                                </small>
                                {% if evento.observacoes %}
                                   <p class="mb-0 mt-1 fst-italic text-muted">Obs: {{ evento.observacoes }}</p>
                                {% endif %}
                            </td>
                            <td class="text-end">R$ {{ "%.2f"|format(evento.custo)|replace('.', ',') }}</td>
                            <td class="text-end fw-bold">{{ evento.sulco_mm or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="enviarRecapagemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enviar Pneu para Recapagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEnviarRecapagem">
                <div class="modal-body">
                    <p>Você está enviando o pneu <strong>{{ pneu.numero_fogo }}</strong> para recapagem. O status será alterado para "Recapando".</p>
                    <input type="hidden" name="pneu_id" value="{{ pneu.id }}">
                    <div class="mb-3">
                        <label for="recap_observacoes" class="form-label">Observações (Opcional)</label>
                        <textarea class="form-control" id="recap_observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Confirmar Envio</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="descartarPneuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Descartar Pneu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formDescartarPneu">
                 <div class="modal-body">
                    <p>Você está descartando permanentemente o pneu <strong>{{ pneu.numero_fogo }}</strong>. Esta ação não pode ser desfeita.</p>
                    <input type="hidden" name="pneu_id" value="{{ pneu.id }}">
                    <div class="mb-3">
                        <label for="descarte_motivo" class="form-label">Motivo do Descarte</label>
                        <textarea class="form-control" id="descarte_motivo" name="motivo_descarte" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Descarte</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica para o formulário de Envio para Recapagem
    const formEnviarRecapagem = document.getElementById('formEnviarRecapagem');
    if (formEnviarRecapagem) {
        formEnviarRecapagem.addEventListener('submit', async function(e) {
            e.preventDefault();
            const response = await fetch("{{ url_for('api_enviar_recapagem') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pneu_id: this.pneu_id.value,
                    observacoes: this.observacoes.value
                })
            });
            if (response.ok) {
                window.location.href = "{{ url_for('borracharia_dashboard') }}";
            } else {
                alert('Erro ao enviar pneu para recapagem.');
            }
        });
    }

    // Lógica para o formulário de Descarte
    const formDescartarPneu = document.getElementById('formDescartarPneu');
    if (formDescartarPneu) {
        formDescartarPneu.addEventListener('submit', async function(e) {
            e.preventDefault();
            const response = await fetch("{{ url_for('api_descartar_pneu') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pneu_id: this.pneu_id.value,
                    motivo_descarte: this.motivo_descarte.value
                })
            });
            if (response.ok) {
                window.location.href = "{{ url_for('borracharia_dashboard') }}";
            } else {
                alert('Erro ao descartar pneu.');
            }
        });
    }
});
</script>
{% endblock %}