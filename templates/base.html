<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TrackBras{% endblock %}</title>

    <link rel="manifest" href="{{ url_for('manifest') }}">
    <meta name="theme-color" content="#2e7d32">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="//unpkg.com/alpinejs" defer></script>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
         body {
             background-color: #f0f2f5;
             font-family: 'Inter', sans-serif;
             color: #1e293b;
             overflow-x: hidden;
         }

         .nav-panel::-webkit-scrollbar { display: none; }
         .nav-panel { -ms-overflow-style: none; scrollbar-width: none; }
         
         [x-cloak] { display: none !important; }
         
         @keyframes scroll-left {
             0% { transform: translateX(100%); }
             100% { transform: translateX(-100%); }
         }

         .marquee-container {
             mask-image: linear-gradient(to right, 
                 transparent 0, 
                 black 20px, 
                 black calc(100% - 20px), 
                 transparent 100%
             );
         }
         
         .marquee-text {
             animation: scroll-left 10s linear infinite;
             white-space: nowrap;
         }

         /* CSS Global para Tabelas Responsivas */
         @media (max-width: 767px) {
             .responsive-table thead { display: none; }
             .responsive-table tbody, .responsive-table tr, .responsive-table td {
                 display: block;
                 width: 100%;
             }
             .responsive-table tr {
                 background: white;
                 border: 1px solid #e2e8f0;
                 border-radius: 0.5rem;
                 margin-bottom: 1rem;
                 box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
                 padding: 0.5rem;
             }
             .responsive-table td {
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
                 padding: 0.75rem;
                 text-align: right;
             }
             .responsive-table td:not(:last-child) {
                 border-bottom: 1px solid #f1f5f9;
             }
             .responsive-table td::before {
                 content: attr(data-label);
                 font-weight: 600;
                 text-align: left;
                 margin-right: 1rem;
                 color: #475569;
             }
             .responsive-table .action-buttons {
                 justify-content: flex-end;
             }
             .responsive-table td[data-label="Ações"]::before {
                 content: none;
             }
         }
    </style>
    {% block styles %}{% endblock %}
</head>
<body x-data="pageData()">

    <div class="flex h-screen">

        <div class="hidden md:flex flex-col w-64 bg-gradient-to-b from-[#2e7d32] to-[#1b5e20] text-white flex-shrink-0">
            <div class="flex flex-col items-center justify-center h-24 border-b border-white/10 p-2">
                <a href="{{ url_for('painel') }}" class="flex items-center gap-3">
                    <img src="{{ url_for('static', filename='brasão.png') }}" alt="Logo TrackBras" class="h-10 w-10 rounded-full object-cover">
                    <span class="font-bold text-xl">TrackBras</span>
                </a>
                <div x-ref="companyNameContainer" class="w-full text-center mt-2 text-white text-sm overflow-hidden marquee-container">
                     <div x-ref="companyNameText" 
                          x-init="$nextTick(() => { 
                               if ($refs.companyNameText.scrollWidth > $refs.companyNameContainer.clientWidth) { 
                                   $refs.companyNameText.classList.add('marquee-text');
                               } 
                          })"
                          class="inline-block">
                        {% if current_user.is_authenticated and current_user.empresa %}
                            <span>{{ current_user.empresa.nome_fantasia or current_user.empresa.razao_social }}</span>
                        {% endif %}
                     </div>
                </div>
            </div>

            <div class="p-4 relative">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-white/50"></i>
                    <input type="search" x-model="searchTerm" @focus="searchOpen = true" @keydown.escape="searchOpen = false; searchTerm = ''" placeholder="Buscar telas..." class="w-full bg-white/10 border border-white/20 rounded-lg py-2 pl-10 pr-4 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-yellow-300">
                </div>
                <div x-show="searchOpen && searchTerm.length > 0" @click.away="searchOpen = false" class="absolute top-full left-0 right-0 mt-2 p-2 bg-[#344155] rounded-lg shadow-lg z-50 max-h-80 overflow-y-auto" x-cloak>
                    <ul class="space-y-1">
                        <template x-if="filteredLinks.length === 0">
                            <li class="px-3 py-2 text-white/60">Nenhum resultado encontrado.</li>
                        </template>
                        <template x-for="link in filteredLinks" :key="link.href">
                            <li>
                                <a :href="link.href" class="block px-3 py-2 rounded-md hover:bg-slate-700 hover:text-white transition-colors" x-text="link.title"></a>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>

            <nav class="flex-1 px-4 pb-4 space-y-2 nav-panel overflow-y-auto" x-data="{ openSection: '' }">
                <div>
                    <button @click="openSection = (openSection === 'cadastros' ? '' : 'cadastros')" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-white/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-plus-square w-5 text-center"></i>
                            <span>Cadastros</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': openSection === 'cadastros' }"></i>
                    </button>
                    <div x-show="openSection === 'cadastros'" x-collapse class="pl-6 pt-2 space-y-1">
                        <a href="{{ url_for('cadastrar_motorista') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Motorista</a>
                        <a href="{{ url_for('cadastrar_veiculo') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Veículo</a>
                        <a href="{{ url_for('cadastrar_cliente') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Cliente</a>
                    </div>
                </div>

                <div>
                    <button @click="openSection = (openSection === 'consultas' ? '' : 'consultas')" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-white/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-search-plus w-5 text-center"></i>
                            <span>Consultas</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': openSection === 'consultas' }"></i>
                    </button>
                    <div x-show="openSection === 'consultas'" x-collapse class="pl-6 pt-2 space-y-1">
                        <a href="{{ url_for('consultar_clientes') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Clientes</a>
                        <a href="{{ url_for('consultar_motoristas') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Motoristas</a>
                        <a href="{{ url_for('consultar_veiculos') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Veículos</a>
                        <a href="{{ url_for('consultar_viagens') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Viagens</a>
                    </div>
                </div>

                <div>
                    <button @click="openSection = (openSection === 'operacoes' ? '' : 'operacoes')" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-white/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-cogs w-5 text-center"></i>
                            <span>Operações</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': openSection === 'operacoes' }"></i>
                    </button>
                    <div x-show="openSection === 'operacoes'" x-collapse class="pl-6 pt-2 space-y-1">
                        <a href="{{ url_for('oficina') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Oficina</a>
                        <a href="{{ url_for('iniciar_viagem_page') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Criar Viagem</a>
                        <a href="{{ url_for('importar_nfe_page') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Importar Viagem (NF-e)</a>
                        <a href="{{ url_for('consultar_cobrancas') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Financeiro (Clientes)</a>
                        <a href="{{ url_for('folha_pagamento_dashboard') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors font-semibold">Folha de Pagamento</a>
                    </div>
                </div>

                <div>
                    <button @click="openSection = (openSection === 'relatorios' ? '' : 'relatorios')" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-white/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-bar w-5 text-center"></i>
                            <span>Relatórios</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform" :class="{ 'rotate-180': openSection === 'relatorios' }"></i>
                    </button>
                    <div x-show="openSection === 'relatorios'" x-collapse class="pl-6 pt-2 space-y-1">
                        <a href="{{ url_for('relatorios') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Relatório Estratégico</a>
                        <a href="{{ url_for('relatorio_financeiro_dre') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">DRE Financeiro</a>
                        <a href="{{ url_for('relatorio_desempenho_veiculos') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Desempenho Veículos</a>
                        <a href="{{ url_for('relatorio_contas_a_receber') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors">Contas a Receber</a>
                    </div>
                </div>
                </nav>

            <div class="p-4 border-t border-white/10">
                <a href="{{ url_for('configuracoes') }}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <i class="fas fa-user-cog w-5 text-center"></i>
                    <span>Configurações</span>
                </a>
                <a href="{{ url_for('logout') }}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/10 transition-colors">
                    <i class="fas fa-sign-out-alt w-5 text-center"></i>
                    <span>Sair</span>
                </a>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-md z-10 md:hidden">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <a href="{{ url_for('index') }}" class="flex items-center gap-2">
                        <img src="{{ url_for('static', filename='brasão.png') }}" alt="Logo TrackBras" class="h-8 w-8 rounded-full">
                    </a>
                </div>
            </header>
            
            <div x-show="isMobileMenuOpen" 
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click="isMobileMenuOpen = false" 
                 class="fixed inset-0 bg-black/50 z-[1900]" x-cloak></div>

            <div x-show="isMobileMenuOpen"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="-translate-x-full"
                 x-transition:enter-end="translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="translate-x-0"
                 x-transition:leave-end="-translate-x-full"
                 class="fixed top-0 left-0 h-full w-80 bg-gradient-to-b from-[#2e7d32] to-[#1b5e20] text-white z-[2000] p-6 nav-panel overflow-y-auto shadow-xl"
                 x-cloak>
                 <h3 class="text-2xl font-bold mb-6">Menu</h3>
                 <div class="space-y-6">
                     <div>
                         <h4 class="font-semibold mb-2 text-white">Cadastros</h4>
                         <ul class="space-y-2">
                             <li><a href="{{ url_for('cadastrar_motorista') }}" class="block p-2 rounded hover:bg-white/10 transition">Motorista</a></li>
                             <li><a href="{{ url_for('cadastrar_veiculo') }}" class="block p-2 rounded hover:bg-white/10 transition">Veículo</a></li>
                             <li><a href="{{ url_for('cadastrar_cliente') }}" class="block p-2 rounded hover:bg-white/10 transition">Cliente</a></li>
                         </ul>
                     </div>
                     <div>
                         <h4 class="font-semibold mb-2 text-white">Consultas</h4>
                         <ul class="space-y-2">
                            <li><a href="{{ url_for('consultar_clientes') }}" class="block p-2 rounded hover:bg-white/10 transition">Clientes</a></li>
                            <li><a href="{{ url_for('consultar_motoristas') }}" class="block p-2 rounded hover:bg-white/10 transition">Motoristas</a></li>
                            <li><a href="{{ url_for('consultar_veiculos') }}" class="block p-2 rounded hover:bg-white/10 transition">Veículos</a></li>
                            <li><a href="{{ url_for('consultar_viagens') }}" class="block p-2 rounded hover:bg-white/10 transition">Viagens</a></li>
                         </ul>
                     </div>
                     <div>
                         <h4 class="font-semibold mb-2 text-white">Operações</h4>
                         <ul class="space-y-2">
                             <li><a href="{{ url_for('oficina') }}" class="block p-2 rounded-lg hover:bg-white/10 text-white/80 hover:text-white transition-colors"">Oficina</a></li>
                             <li><a href="{{ url_for('iniciar_viagem_page') }}" class="block p-2 rounded hover:bg-white/10 transition">Criar Viagem</a></li>
                             <li><a href="{{ url_for('importar_nfe_page') }}" class="block p-2 rounded hover:bg-white/10 transition">Importar Viagem (NF-e)</a></li>
                             <li><a href="{{ url_for('consultar_cobrancas') }}" class="block p-2 rounded hover:bg-white/10 transition">Financeiro (Clientes)</a></li>
                             <li><a href="{{ url_for('folha_pagamento_dashboard') }}" class="block p-2 rounded hover:bg-white/10 transition font-semibold">Folha de Pagamento</a></li>
                         </ul>
                     </div>
                     <div>
                        <h4 class="font-semibold mb-2 text-white">Relatórios</h4>
                        <ul class="space-y-2">
                            <li><a href="{{ url_for('relatorios') }}" class="block p-2 rounded hover:bg-white/10 transition">Relatório Estratégico</a></li>
                            <li><a href="{{ url_for('relatorio_financeiro_dre') }}" class="block p-2 rounded hover:bg-white/10 transition">DRE Financeiro</a></li>
                            <li><a href="{{ url_for('relatorio_desempenho_veiculos') }}" class="block p-2 rounded hover:bg-white/10 transition">Desempenho Veículos</a></li>
                            <li><a href="{{ url_for('relatorio_contas_a_receber') }}" class="block p-2 rounded hover:bg-white/10 transition">Contas a Receber</a></li>
                        </ul>
                     </div>
                     <div class="border-t border-white/20 pt-6 space-y-2">
                          <a href="{{ url_for('configuracoes') }}" class="block p-2 rounded hover:bg-white/10 transition">Configurações</a>
                          <a href="{{ url_for('logout') }}" class="block p-2 rounded hover:bg-white/10 transition">Sair</a>
                     </div>
                 </div>
            </div>

            <main class="w-full flex-1 p-4 md:p-6 overflow-y-auto">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="fixed top-20 right-4 z-[1050]">
                            {% for category, message in messages %}
                                <div class="bg-{{ 'red-500' if category == 'error' else 'green-500' if category == 'success' else 'blue-500' }} text-white px-4 py-2 rounded-lg shadow-lg mb-2" role="alert">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script>
        function pageData() {
            return {
                isMobileMenuOpen: false,
                searchTerm: '',
                searchOpen: false,
                searchableLinks: [
                    { title: 'Cadastrar Motorista', href: "{{ url_for('cadastrar_motorista') }}", tags: ['cadastro', 'novo'] },
                    { title: 'Cadastrar Veículo', href: "{{ url_for('cadastrar_veiculo') }}", tags: ['cadastro', 'novo'] },
                    { title: 'Cadastrar Cliente', href: "{{ url_for('cadastrar_cliente') }}", tags: ['cadastro', 'novo'] },
                    { title: 'Consultar Clientes', href: "{{ url_for('consultar_clientes') }}", tags: ['consulta', 'ver', 'lista'] },
                    { title: 'Consultar Motoristas', href: "{{ url_for('consultar_motoristas') }}", tags: ['consulta', 'ver', 'lista'] },
                    { title: 'Consultar Veículos', href: "{{ url_for('consultar_veiculos') }}", tags: ['consulta', 'ver', 'lista'] },
                    { title: 'Consultar Viagens', href: "{{ url_for('consultar_viagens') }}", tags: ['consulta', 'ver', 'lista'] },
                    { title: 'Criar Viagem', href: "{{ url_for('iniciar_viagem_page') }}", tags: ['operações', 'novo', 'iniciar'] },
                    { title: 'Importar Viagem por NF-e', href: "{{ url_for('importar_nfe_page') }}", tags: ['operações', 'novo', 'nfe', 'xml', 'automático'] },
                    { title: 'Financeiro (Clientes)', href: "{{ url_for('consultar_cobrancas') }}", tags: ['operações', 'dinheiro', 'cobrança', 'cliente'] },
                    // ▼▼▼ NOVO LINK NA BUSCA ▼▼▼
                    { title: 'Folha de Pagamento', href: "{{ url_for('folha_pagamento_dashboard') }}", tags: ['operações', 'financeiro', 'salário', 'motorista', 'pagamento'] },
                    { title: 'Configurações', href: "{{ url_for('configuracoes') }}", tags: ['sistema', 'ajustes'] },
                    // =================================================================
                    // ▼▼▼ LINKS DE RELATÓRIOS ATUALIZADOS NA BUSCA ▼▼▼
                    // =================================================================
                    { title: 'Relatório Estratégico', href: "{{ url_for('relatorios') }}", tags: ['relatório', 'ver', 'dashboard', 'estratégia'] },
                    { title: 'DRE Financeiro', href: "{{ url_for('relatorio_financeiro_dre') }}", tags: ['relatório', 'financeiro', 'dre', 'resultado'] },
                    { title: 'Desempenho de Veículos', href: "{{ url_for('relatorio_desempenho_veiculos') }}", tags: ['relatório', 'veículo', 'desempenho', 'custo'] },
                    { title: 'Contas a Receber', href: "{{ url_for('relatorio_contas_a_receber') }}", tags: ['relatório', 'financeiro', 'cobrança', 'receber'] }
                ],
                get filteredLinks() {
                    if (this.searchTerm === '') {
                        return [];
                    }
                    return this.searchableLinks.filter(link => {
                        const term = this.searchTerm.toLowerCase();
                        const titleMatch = link.title.toLowerCase().includes(term);
                        const tagMatch = link.tags.some(tag => tag.toLowerCase().includes(term));
                        return titleMatch || tagMatch;
                    });
                }
            };
        }
    </script>
    {% block scripts %}
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
        
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const flashMessagesContainer = document.querySelector('.fixed.top-20.right-4');
                if (flashMessagesContainer) {
                    setTimeout(() => {
                        flashMessagesContainer.style.transition = 'opacity 0.5s ease';
                        flashMessagesContainer.style.opacity = '0';
                        setTimeout(() => {
                            flashMessagesContainer.remove();
                        }, 500);
                    }, 5000);
                }
            });
        </script>

    {% endblock %}

</body>
</html>